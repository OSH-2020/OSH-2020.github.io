{"config":{"lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Operating Systems (H) 2020 Spring \u00b6 Course Info \u00b6 Meeting time: Monday 15:55~17:30 and Wednesday 9:45~11:20 Classroom: 3A407 Instructor: \u90a2\u51ef Teaching Assistants: \u4ed8\u4f73\u4f1f \u3001 \u9676\u67ef\u5b87 \u3001 \u5f6d\u5b9a\u6f9c Announcements \u00b6 Jul 15, 2020: \u8bf7\u5404\u7ec4\u5728 7 \u6708 22 \u65e5\uff08\u661f\u671f\u4e09\uff09\u665a 11:00 \u524d\u63d0\u4ea4\u5927\u4f5c\u4e1a\u7684\u7ed3\u9898\u62a5\u544a\u548c\u5c55\u793a slides\u3002 Jul 15, 2020: \u8bf7\u5c06\u4eca\u65e5\u7b54\u8fa9\u7ed3\u675f\u540e\u7684 Peer-Review Score Sheet \u4f7f\u7528 \u90ae\u4ef6 \u53d1\u9001\u7ed9\u9676\u67ef\u5b87\u52a9\u6559\u3002 May 23, 2020: \u5b9e\u9a8c\u56db\u7684 cgroup \u90e8\u5206 \u6709\u66f4\u65b0\u3002 Apr 30, 2020: \u5b9e\u9a8c\u56db \u5df2\u53d1\u5e03\u3002 Apr 10, 2020: \u5b9e\u9a8c\u4e09 \u5df2\u53d1\u5e03\u3002 Apr 5, 2020: \u4e2d\u671f\u7b54\u8fa9\u9884\u8ba1\u65f6\u95f4\u5728 4 \u6708 13 \u65e5\u548c 4 \u6708 15 \u65e5\u8bfe\u4e0a\uff0c\u8bf7\u5404\u7ec4\u505a\u597d\u51c6\u5907\u3002 Apr 5, 2020: 4 \u6708 8 \u65e5\uff08\u5468\u4e09\uff09\u665a\u4e0a 8:00 \u52a9\u6559\u5c06\u8fdb\u884c\u5b9e\u9a8c\u4e00\u603b\u7ed3\u4e0e\u9488\u5bf9\u5b9e\u9a8c\u4e8c\u95ee\u9898\u7684\u7b54\u7591\u8bfe\uff0cZoom \u4f1a\u8bae\u53f7\u4f1a\u5728\u7b54\u7591\u8bfe\u5f00\u59cb\u524d\u53d1\u5e03\u5728\u8bfe\u7a0b\u7fa4\u4e2d\uff0c\u6b22\u8fce\u5404\u4f4d\u540c\u5b66\u53c2\u52a0\u3002 Mar 29, 2020: \u5b9e\u9a8c\u4e8c\u7684\u622a\u6b62\u65e5\u671f\u63a8\u8fdf\u81f3 4 \u6708 12 \u65e5\uff08\u661f\u671f\u65e5\uff09\uff0c\u8bf7\u5927\u5bb6\u5408\u7406\u5b89\u6392\u65f6\u95f4\u5b8c\u6210\u3002 Mar 28, 2020: \u5b9e\u9a8c\u4e00\u7684\u6210\u7ee9\u5df2\u63d0\u4ea4\u81f3\u5927\u5bb6\u4ed3\u5e93\u91cc\u7684 lab1-score \u5206\u652f\uff0c\u9605\u540e\u53ef\u4ee5\u5220\u9664\u3002 Mar 20, 2020: \u5b9e\u9a8c\u4e8c \u5df2\u53d1\u5e03\u3002 \u6839\u636e\u5927\u5bb6\u7684\u5b8c\u6210\u60c5\u51b5\uff0c\u6b64\u5b9e\u9a8c\u6709\u53ef\u80fd\u5ef6\u671f\u4e00\u5468\uff0c\u4f46\u8fd8\u662f\u5c3d\u91cf\u6309\u65f6\u505a\u5b8c\u3002 Mar 15, 2020: \u5b9e\u9a8c\u4e00\u7b54\u7591\u8bfe\u65f6\u95f4\uff1a3 \u6708 18 \u65e5\uff08\u661f\u671f\u4e09\uff09\u665a 7:30\u3002\u5f00\u59cb\u524d Zoom \u4f1a\u8bae\u53f7\u4f1a\u5728\u8bfe\u7a0b\u4ea4\u6d41\u7fa4\u7ec4\u4e2d\u516c\u5e03\u3002 Mar 15, 2020: \u66f4\u65b0\u4e86\u5927\u4f5c\u4e1a\u8c03\u7814\u62a5\u544a\u548c\u53ef\u884c\u6027\u62a5\u544a\u7684\u622a\u6b62\u65f6\u95f4\u7b49\u5185\u5bb9\u3002 Mar 4, 2020: \u8bf7\u5404\u7ec4\u6839\u636e \u6587\u6863 \u521b\u5efa\u5927\u4f5c\u4e1a\u4ed3\u5e93\u3002 Mar 1, 2020: \u5b9e\u9a8c\u4e00 \u5df2\u53d1\u5e03\u3002 Feb 15, 2020: \u8bfe\u7a0b\u4ea4\u6d41 QQ \u7fa4\u7ec4\uff1a1055162953\u3002 Feb 15, 2020: Welcome to Operating Systems (H)! Coursework \u00b6 \u7eb8\u8d28\u4f5c\u4e1a\u8981\u6c42\uff1a \u672a\u7279\u522b\u8bf4\u660e\uff0c\u63d0\u4ea4\u622a\u6b62\u65f6\u95f4\u4e3a\u6240\u8ff0\u65e5\u671f\u8bfe\u7a0b\u524d\uff1b \u7f51\u7edc\u63d0\u4ea4\u8981\u6c42\uff1a \u672a\u7279\u522b\u8bf4\u660e\uff0c\u63d0\u4ea4\u622a\u6b62\u65f6\u95f4\u4e3a\u6240\u8ff0\u65e5\u671f 23:00 \u524d\uff1b No Date Task Due #0 - \u5927\u4f5c\u4e1a - #1 Mar 2 Lab 1 23:00, Sunday, Mar 22 #2 - \u5927\u4f5c\u4e1a-\u8c03\u7814\u62a5\u544a \u4e0d\u665a\u4e8e\u53ef\u884c\u6027\u62a5\u544a\u63d0\u4ea4\u3002\u5efa\u8bae\u5728 23:00, Sunday, Mar 22 \u524d\u5b8c\u6210\u3002 #3 - \u5927\u4f5c\u4e1a-\u53ef\u884c\u6027\u62a5\u544a 23:00, Sunday, Mar 29 #4 Mar 20 Lab 2 23:00, Sunday, Apr 12 #5 Apr 10 Lab 3 23:00, Tuesday, May 5 #6 Apr 30 Lab 4 23:00, Sunday, May 31 #7 Jul 15 \u5927\u4f5c\u4e1a-\u7ed3\u9898\u62a5\u544a 23:00, Wednesday, Jul 22 #8 Jul 15 \u6240\u6709\u63d0\u4ea4\u4f5c\u4e1a/\u5b9e\u9a8c\u6700\u540e\u622a\u6b62 23:59:59, Monday, Aug 10 Resources \u00b6 Reference Book: Operating System Concepts Silberschatz, Galvin, Gagne. ISBN-10: 0470128720 Wiley Operating Systems Design & Implementation A.S. Tanenbaum, etc. ISBN-10: 0136386776 Prentice Hall FAQ \u00b6","title":"\u9996\u9875"},{"location":"#operating-systems-h-2020-spring","text":"","title":"Operating Systems (H) 2020 Spring"},{"location":"#course-info","text":"Meeting time: Monday 15:55~17:30 and Wednesday 9:45~11:20 Classroom: 3A407 Instructor: \u90a2\u51ef Teaching Assistants: \u4ed8\u4f73\u4f1f \u3001 \u9676\u67ef\u5b87 \u3001 \u5f6d\u5b9a\u6f9c","title":"Course Info"},{"location":"#announcements","text":"Jul 15, 2020: \u8bf7\u5404\u7ec4\u5728 7 \u6708 22 \u65e5\uff08\u661f\u671f\u4e09\uff09\u665a 11:00 \u524d\u63d0\u4ea4\u5927\u4f5c\u4e1a\u7684\u7ed3\u9898\u62a5\u544a\u548c\u5c55\u793a slides\u3002 Jul 15, 2020: \u8bf7\u5c06\u4eca\u65e5\u7b54\u8fa9\u7ed3\u675f\u540e\u7684 Peer-Review Score Sheet \u4f7f\u7528 \u90ae\u4ef6 \u53d1\u9001\u7ed9\u9676\u67ef\u5b87\u52a9\u6559\u3002 May 23, 2020: \u5b9e\u9a8c\u56db\u7684 cgroup \u90e8\u5206 \u6709\u66f4\u65b0\u3002 Apr 30, 2020: \u5b9e\u9a8c\u56db \u5df2\u53d1\u5e03\u3002 Apr 10, 2020: \u5b9e\u9a8c\u4e09 \u5df2\u53d1\u5e03\u3002 Apr 5, 2020: \u4e2d\u671f\u7b54\u8fa9\u9884\u8ba1\u65f6\u95f4\u5728 4 \u6708 13 \u65e5\u548c 4 \u6708 15 \u65e5\u8bfe\u4e0a\uff0c\u8bf7\u5404\u7ec4\u505a\u597d\u51c6\u5907\u3002 Apr 5, 2020: 4 \u6708 8 \u65e5\uff08\u5468\u4e09\uff09\u665a\u4e0a 8:00 \u52a9\u6559\u5c06\u8fdb\u884c\u5b9e\u9a8c\u4e00\u603b\u7ed3\u4e0e\u9488\u5bf9\u5b9e\u9a8c\u4e8c\u95ee\u9898\u7684\u7b54\u7591\u8bfe\uff0cZoom \u4f1a\u8bae\u53f7\u4f1a\u5728\u7b54\u7591\u8bfe\u5f00\u59cb\u524d\u53d1\u5e03\u5728\u8bfe\u7a0b\u7fa4\u4e2d\uff0c\u6b22\u8fce\u5404\u4f4d\u540c\u5b66\u53c2\u52a0\u3002 Mar 29, 2020: \u5b9e\u9a8c\u4e8c\u7684\u622a\u6b62\u65e5\u671f\u63a8\u8fdf\u81f3 4 \u6708 12 \u65e5\uff08\u661f\u671f\u65e5\uff09\uff0c\u8bf7\u5927\u5bb6\u5408\u7406\u5b89\u6392\u65f6\u95f4\u5b8c\u6210\u3002 Mar 28, 2020: \u5b9e\u9a8c\u4e00\u7684\u6210\u7ee9\u5df2\u63d0\u4ea4\u81f3\u5927\u5bb6\u4ed3\u5e93\u91cc\u7684 lab1-score \u5206\u652f\uff0c\u9605\u540e\u53ef\u4ee5\u5220\u9664\u3002 Mar 20, 2020: \u5b9e\u9a8c\u4e8c \u5df2\u53d1\u5e03\u3002 \u6839\u636e\u5927\u5bb6\u7684\u5b8c\u6210\u60c5\u51b5\uff0c\u6b64\u5b9e\u9a8c\u6709\u53ef\u80fd\u5ef6\u671f\u4e00\u5468\uff0c\u4f46\u8fd8\u662f\u5c3d\u91cf\u6309\u65f6\u505a\u5b8c\u3002 Mar 15, 2020: \u5b9e\u9a8c\u4e00\u7b54\u7591\u8bfe\u65f6\u95f4\uff1a3 \u6708 18 \u65e5\uff08\u661f\u671f\u4e09\uff09\u665a 7:30\u3002\u5f00\u59cb\u524d Zoom \u4f1a\u8bae\u53f7\u4f1a\u5728\u8bfe\u7a0b\u4ea4\u6d41\u7fa4\u7ec4\u4e2d\u516c\u5e03\u3002 Mar 15, 2020: \u66f4\u65b0\u4e86\u5927\u4f5c\u4e1a\u8c03\u7814\u62a5\u544a\u548c\u53ef\u884c\u6027\u62a5\u544a\u7684\u622a\u6b62\u65f6\u95f4\u7b49\u5185\u5bb9\u3002 Mar 4, 2020: \u8bf7\u5404\u7ec4\u6839\u636e \u6587\u6863 \u521b\u5efa\u5927\u4f5c\u4e1a\u4ed3\u5e93\u3002 Mar 1, 2020: \u5b9e\u9a8c\u4e00 \u5df2\u53d1\u5e03\u3002 Feb 15, 2020: \u8bfe\u7a0b\u4ea4\u6d41 QQ \u7fa4\u7ec4\uff1a1055162953\u3002 Feb 15, 2020: Welcome to Operating Systems (H)!","title":"Announcements"},{"location":"#coursework","text":"\u7eb8\u8d28\u4f5c\u4e1a\u8981\u6c42\uff1a \u672a\u7279\u522b\u8bf4\u660e\uff0c\u63d0\u4ea4\u622a\u6b62\u65f6\u95f4\u4e3a\u6240\u8ff0\u65e5\u671f\u8bfe\u7a0b\u524d\uff1b \u7f51\u7edc\u63d0\u4ea4\u8981\u6c42\uff1a \u672a\u7279\u522b\u8bf4\u660e\uff0c\u63d0\u4ea4\u622a\u6b62\u65f6\u95f4\u4e3a\u6240\u8ff0\u65e5\u671f 23:00 \u524d\uff1b No Date Task Due #0 - \u5927\u4f5c\u4e1a - #1 Mar 2 Lab 1 23:00, Sunday, Mar 22 #2 - \u5927\u4f5c\u4e1a-\u8c03\u7814\u62a5\u544a \u4e0d\u665a\u4e8e\u53ef\u884c\u6027\u62a5\u544a\u63d0\u4ea4\u3002\u5efa\u8bae\u5728 23:00, Sunday, Mar 22 \u524d\u5b8c\u6210\u3002 #3 - \u5927\u4f5c\u4e1a-\u53ef\u884c\u6027\u62a5\u544a 23:00, Sunday, Mar 29 #4 Mar 20 Lab 2 23:00, Sunday, Apr 12 #5 Apr 10 Lab 3 23:00, Tuesday, May 5 #6 Apr 30 Lab 4 23:00, Sunday, May 31 #7 Jul 15 \u5927\u4f5c\u4e1a-\u7ed3\u9898\u62a5\u544a 23:00, Wednesday, Jul 22 #8 Jul 15 \u6240\u6709\u63d0\u4ea4\u4f5c\u4e1a/\u5b9e\u9a8c\u6700\u540e\u622a\u6b62 23:59:59, Monday, Aug 10","title":"Coursework"},{"location":"#resources","text":"Reference Book: Operating System Concepts Silberschatz, Galvin, Gagne. ISBN-10: 0470128720 Wiley Operating Systems Design & Implementation A.S. Tanenbaum, etc. ISBN-10: 0136386776 Prentice Hall","title":"Resources"},{"location":"#faq","text":"","title":"FAQ"},{"location":"faq/","text":"\u5e38\u95ee\u95ee\u9898 \u00b6 \u5b9e\u9a8c\u4e00 \u00b6 Q1: \u4e3a\u4ec0\u4e48\u6211\u63d0\u4ea4\u7684\u5185\u6838\u7528 ls -l \u770b\u5927\u5c0f\u5c0f\u5f97\u4e0d\u6b63\u5e38\uff1f\u4e3a\u4ec0\u4e48\u6211\u65e0\u6cd5\u8fd0\u884c\u6211\u63d0\u4ea4\u7684\u5185\u6838\uff1f\u2026\u2026 A1: \u5728\u63d0\u4ea4 bzImage \u7684\u65f6\u5019\u9700\u8981\u6ce8\u610f\uff1a \u4e0d\u8981\u63d0\u4ea4\u8f6f\u94fe\u63a5 \u3002 arch/x86_64/boot/bzImage \u662f\u4e00\u4e2a\u6307\u5411 arch/x86/boot/bzImage \u7684\u8f6f\u94fe\u63a5\uff0c\u5982\u679c\u63d0\u4ea4\u7684\u662f\u8f6f\u94fe\u63a5\uff0c\u6211\u4eec\u4f1a\u65e0\u6cd5\u627e\u5230\u4f60\u5b9e\u9645\u7f16\u8bd1\u7684\u5185\u6838\u6587\u4ef6\u3002 Q2: \u4e0b\u8f7d\u5185\u6838\u6e90\u4ee3\u7801\u600e\u4e48\u8fd9\u4e48\u6162\uff1f A2: \u5982\u679c\u4f60\u9047\u5230\u4e86\u7f51\u7edc\u95ee\u9898\uff0c\u53ef\u4ee5\u4ece \u79d1\u5927\u955c\u50cf\u7ad9 \u6216\u8005 \u6e05\u534e TUNA \u955c\u50cf\u7ad9 \u4e0b\u8f7d\u3002 Q3: \u4e3a\u4ec0\u4e48\u53ea\u653e 1 \u548c init \u4e24\u4e2a\u6587\u4ef6\uff0c init \u91cc\u5199 system(\"/1\"); \u4f1a\u51fa\u9519\uff1f\u4e3a\u4ec0\u4e48\u5199 execv() \uff0c\u5374\u53ea\u8fd0\u884c\u4e86\u7b2c\u4e00\u4e2a\u7a0b\u5e8f\uff1f A3: \u4f60\u9700\u8981\u9605\u8bfb\u6587\u6863\uff08 man system , man execv \uff09\u6765\u7406\u89e3\u5e93\u51fd\u6570\u505a\u7684\u4e8b\u60c5\u3002\u5bf9\u4e8e\u8fd9\u4e24\u4e2a\u95ee\u9898\uff0c DESCRIPTION \u4e00\u8282\u90fd\u53ef\u4ee5\u770b\u5230\u7b54\u6848\u3002 Q4: \u6211\u53ef\u4ee5\u5728\u8fd0\u884c\u7a0b\u5e8f 3 \u540e\u628a\u5c4f\u5e55\u5f04\u82b1\u5417\uff1f A4: \u53ef\u4ee5\uff0c\u53ea\u8981\u4e0d kernel panic\u3002 Q5: \u6211\u4e0d\u60f3\u4f7f\u7528 \"0x046c\" \u8fd9\u79cd\u65b9\u6cd5\u8ba1\u65f6\u3002\u6211\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u7684\u65b9\u5f0f\u5417\uff1f A5: \u53ef\u4ee5\u3002 Q6: \u5b9e\u9a8c\u62a5\u544a\u6709\u6a21\u677f\u5417\uff1f A6: \u62a5\u544a\u8981\u70b9\u9f50\u5168\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u5199\u6210\u957f\u7bc7\u5927\u8bba\uff0c\u884c\u6587\u683c\u5f0f\u6ca1\u6709\u5f3a\u5236\u7684\u8981\u6c42\u3002 Q7: \u6211\u7b54\u5bf9\u4e86 %d \u9053\u601d\u8003\u9898\uff0c\u4e3a\u4ec0\u4e48\u7ed9\u6211\u6263\u4e86 %f \u5206\uff1f A7: \u52a9\u6559\u524d\u671f\u53ea\u8bbe\u8ba1\u4e86 6 \u9053\u601d\u8003\u9898\uff086 \u9009 3\uff09\uff0c\u56e0\u6b64\u4e3a\u601d\u8003\u9898\u5206\u914d\u4e86 1.5 \u5206\u7684\u5206\u6570\u3002\u540e\u6765\u589e\u52a0\u5230\u4e86 8 \u9009 4\uff0c\u4f46\u662f\u5206\u6570\u5206\u914d\u5df2\u786e\u5b9a\uff0c\u6240\u4ee5\u5b9e\u9645\u7684\u601d\u8003\u9898\u7ed9\u5206\u65b9\u5f0f\u4e3a\uff1a \u7b54\u5bf9 0 \u6216 1 \u9053\uff1a0 \u5206 \u7b54\u5bf9 1~4 \u9053\uff1a0.5 * (\u7b54\u5bf9\u9898\u6570 - 1) \u5206 \u7b54\u5bf9 4 \u9053\u6216\u4ee5\u4e0a\uff1a1.5 \u5206 \u591a\u7b54\u7684\u9898\u76ee\u7b54\u9519\u4e0d\u6263\u5206\uff0c\u53ea\u8ba1\u7b54\u5bf9\u7684\u6570\u91cf\u3002 \u5b9e\u9a8c\u4e8c \u00b6 Q1: \u53ef\u4ee5\u4f7f\u7528 Rust \u8bed\u8a00\u5417\uff1f A1: \u53ef\u4ee5\u3002\u4f46\u662f\u7531\u4e8e\u4e09\u4e2a\u52a9\u6559\u90fd\u4e0d\u4f1a Rust\uff0c\u56e0\u6b64\u5f53\u4f60\u7684 shell \u56e0\u5e73\u53f0\u6216\u73af\u5883\u539f\u56e0\u51fa\u73b0\u5f02\u5e38\u65f6\uff0c\u65e0\u6cd5\u66ff\u4f60 debug\uff08\u5982\u679c\u6709\uff09\u5e76\u7ed9\u51fa\u90e8\u5206\u5206\uff1b\u5982\u679c\u4f60\u4f7f\u7528 C \u6216\u8005 C++\uff0c\u90a3\u4e48\u5f53\u4f60\u7684 shell \u6709 bug \u7684\u65f6\u5019\u52a9\u6559\u53ef\u4ee5\u5c1d\u8bd5\u4fee\u590d\u5e76\u4e3a\u914c\u60c5\u7ed9\u5206\u3002 Q2: \u53ef\u4ee5\u4f7f\u7528 C++ \u6807\u51c6\u5e93\uff08iostream\uff0cSTL \u7b49\uff09\u5417\uff1f A2: \u53ef\u4ee5\u3002 \u5b9e\u9a8c\u4e09 \u00b6 Q1: \u7b2c\u4e00\u90e8\u5206\u7684\u4efb\u52a1\u9700\u8981\u5904\u7406 send() \u7684\u963b\u585e\u60c5\u51b5\uff0c\u4f46\u662f\u4f3c\u4e4e 1MiB \u957f\u5ea6\u7684\u6570\u636e\u53ef\u4ee5\u4e00\u6b21\u6027 send() \u51fa\u53bb\uff1f A1: \u5728\u7b2c\u4e00\u3001\u4e8c\u90e8\u5206\u7684\u4efb\u52a1\u4e2d\u4f7f\u7528\u7684\u662f\u963b\u585e IO\uff0c\u786e\u5b9e\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u53ef\u4ee5\u4e00\u6b21\u6027\u53d1\u9001\u3002\u4f46\u662f\u5728\u975e\u963b\u585e IO \u4e2d\uff0c\u4e00\u6b21\u6027\u53d1\u9001\u662f\u65e0\u6cd5\u4fdd\u8bc1\u7684\u3002 Q2: nc \u603b\u662f\u8f93\u5165\u6362\u884c\u540e\u624d\u53d1\u9001\uff0c\u8981\u600e\u4e48\u6d4b\u8bd5\uff1f A2: \u53ef\u4ee5\u8f93\u5165 Ctrl-D \u8fdb\u884c Flush\u3002\u5efa\u8bae\u81ea\u5df1\u7528 Python \u5199\u4e00\u4e2a\u7b80\u5355\u7684 TCP \u5ba2\u6237\u7aef\u8fdb\u884c\u6d4b\u8bd5\u3002 Q3: \u4e3a\u4ec0\u4e48\u6d88\u606f\u4e0d\u4f1a\u5728\u4e24\u4e2a\u5ba2\u6237\u7aef\uff08nc \u8fdb\u7a0b\uff09\u4e4b\u95f4\u6765\u56de\u4f20\u64ad\uff1f A3: \u56e0\u4e3a nc \u4ece socket \u6536\u5230\u6570\u636e\u540e\u628a\u6570\u636e\u6253\u5370\u5230\u6807\u51c6\u8f93\u51fa\uff0c\u4ece\u6807\u51c6\u8f93\u5165\u6536\u5230\u6570\u636e\u540e\u628a\u6570\u636e\u901a\u8fc7 socket \u53d1\u9001\uff0c\u800c\u6807\u51c6\u8f93\u5165\u548c\u6807\u51c6\u8f93\u51fa\u5e76\u4e0d\u662f\u76f8\u8fde\u7684\uff0c\u56e0\u6b64\u4e0d\u4f1a\u6765\u56de\u4f20\u64ad\u3002 Q4: \u6761\u4ef6\u53d8\u91cf\u5fc5\u987b\u8981\u548c\u4e92\u65a5\u9501\u4e00\u8d77\u4f7f\u7528\u5417\uff1f\u53ef\u4ee5\u53bb\u6389\u4f8b\u5b50\u4e2d\u7684 ready \u5417\uff1f A4: \u5728\u8c03\u7528 pthread_cond_signal \u524d\u5fc5\u987b\u5bf9\u6761\u4ef6\u53d8\u91cf\u5bf9\u5e94\u7684\u4e92\u65a5\u9501\u52a0\u9501\uff0c\u8fd9\u548c\u6761\u4ef6\u53d8\u91cf\u7684\u5b9e\u73b0\u673a\u5236\u6709\u5173\u3002ready \u662f\u4e0d\u53ef\u4ee5\u53bb\u6389\u7684\uff0c\u5426\u5219\u53ef\u80fd\u51fa\u73b0\u4f2a\u5524\u9192\uff08\u5e76\u6ca1\u6709\u8c03\u7528 pthread_cond_signal \u4f46 pthread_cond_wait \u5374\u8fd4\u56de\uff09\u3002","title":"FAQ"},{"location":"faq/#_1","text":"","title":"\u5e38\u95ee\u95ee\u9898"},{"location":"faq/#_2","text":"Q1: \u4e3a\u4ec0\u4e48\u6211\u63d0\u4ea4\u7684\u5185\u6838\u7528 ls -l \u770b\u5927\u5c0f\u5c0f\u5f97\u4e0d\u6b63\u5e38\uff1f\u4e3a\u4ec0\u4e48\u6211\u65e0\u6cd5\u8fd0\u884c\u6211\u63d0\u4ea4\u7684\u5185\u6838\uff1f\u2026\u2026 A1: \u5728\u63d0\u4ea4 bzImage \u7684\u65f6\u5019\u9700\u8981\u6ce8\u610f\uff1a \u4e0d\u8981\u63d0\u4ea4\u8f6f\u94fe\u63a5 \u3002 arch/x86_64/boot/bzImage \u662f\u4e00\u4e2a\u6307\u5411 arch/x86/boot/bzImage \u7684\u8f6f\u94fe\u63a5\uff0c\u5982\u679c\u63d0\u4ea4\u7684\u662f\u8f6f\u94fe\u63a5\uff0c\u6211\u4eec\u4f1a\u65e0\u6cd5\u627e\u5230\u4f60\u5b9e\u9645\u7f16\u8bd1\u7684\u5185\u6838\u6587\u4ef6\u3002 Q2: \u4e0b\u8f7d\u5185\u6838\u6e90\u4ee3\u7801\u600e\u4e48\u8fd9\u4e48\u6162\uff1f A2: \u5982\u679c\u4f60\u9047\u5230\u4e86\u7f51\u7edc\u95ee\u9898\uff0c\u53ef\u4ee5\u4ece \u79d1\u5927\u955c\u50cf\u7ad9 \u6216\u8005 \u6e05\u534e TUNA \u955c\u50cf\u7ad9 \u4e0b\u8f7d\u3002 Q3: \u4e3a\u4ec0\u4e48\u53ea\u653e 1 \u548c init \u4e24\u4e2a\u6587\u4ef6\uff0c init \u91cc\u5199 system(\"/1\"); \u4f1a\u51fa\u9519\uff1f\u4e3a\u4ec0\u4e48\u5199 execv() \uff0c\u5374\u53ea\u8fd0\u884c\u4e86\u7b2c\u4e00\u4e2a\u7a0b\u5e8f\uff1f A3: \u4f60\u9700\u8981\u9605\u8bfb\u6587\u6863\uff08 man system , man execv \uff09\u6765\u7406\u89e3\u5e93\u51fd\u6570\u505a\u7684\u4e8b\u60c5\u3002\u5bf9\u4e8e\u8fd9\u4e24\u4e2a\u95ee\u9898\uff0c DESCRIPTION \u4e00\u8282\u90fd\u53ef\u4ee5\u770b\u5230\u7b54\u6848\u3002 Q4: \u6211\u53ef\u4ee5\u5728\u8fd0\u884c\u7a0b\u5e8f 3 \u540e\u628a\u5c4f\u5e55\u5f04\u82b1\u5417\uff1f A4: \u53ef\u4ee5\uff0c\u53ea\u8981\u4e0d kernel panic\u3002 Q5: \u6211\u4e0d\u60f3\u4f7f\u7528 \"0x046c\" \u8fd9\u79cd\u65b9\u6cd5\u8ba1\u65f6\u3002\u6211\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u7684\u65b9\u5f0f\u5417\uff1f A5: \u53ef\u4ee5\u3002 Q6: \u5b9e\u9a8c\u62a5\u544a\u6709\u6a21\u677f\u5417\uff1f A6: \u62a5\u544a\u8981\u70b9\u9f50\u5168\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u5199\u6210\u957f\u7bc7\u5927\u8bba\uff0c\u884c\u6587\u683c\u5f0f\u6ca1\u6709\u5f3a\u5236\u7684\u8981\u6c42\u3002 Q7: \u6211\u7b54\u5bf9\u4e86 %d \u9053\u601d\u8003\u9898\uff0c\u4e3a\u4ec0\u4e48\u7ed9\u6211\u6263\u4e86 %f \u5206\uff1f A7: \u52a9\u6559\u524d\u671f\u53ea\u8bbe\u8ba1\u4e86 6 \u9053\u601d\u8003\u9898\uff086 \u9009 3\uff09\uff0c\u56e0\u6b64\u4e3a\u601d\u8003\u9898\u5206\u914d\u4e86 1.5 \u5206\u7684\u5206\u6570\u3002\u540e\u6765\u589e\u52a0\u5230\u4e86 8 \u9009 4\uff0c\u4f46\u662f\u5206\u6570\u5206\u914d\u5df2\u786e\u5b9a\uff0c\u6240\u4ee5\u5b9e\u9645\u7684\u601d\u8003\u9898\u7ed9\u5206\u65b9\u5f0f\u4e3a\uff1a \u7b54\u5bf9 0 \u6216 1 \u9053\uff1a0 \u5206 \u7b54\u5bf9 1~4 \u9053\uff1a0.5 * (\u7b54\u5bf9\u9898\u6570 - 1) \u5206 \u7b54\u5bf9 4 \u9053\u6216\u4ee5\u4e0a\uff1a1.5 \u5206 \u591a\u7b54\u7684\u9898\u76ee\u7b54\u9519\u4e0d\u6263\u5206\uff0c\u53ea\u8ba1\u7b54\u5bf9\u7684\u6570\u91cf\u3002","title":"\u5b9e\u9a8c\u4e00"},{"location":"faq/#_3","text":"Q1: \u53ef\u4ee5\u4f7f\u7528 Rust \u8bed\u8a00\u5417\uff1f A1: \u53ef\u4ee5\u3002\u4f46\u662f\u7531\u4e8e\u4e09\u4e2a\u52a9\u6559\u90fd\u4e0d\u4f1a Rust\uff0c\u56e0\u6b64\u5f53\u4f60\u7684 shell \u56e0\u5e73\u53f0\u6216\u73af\u5883\u539f\u56e0\u51fa\u73b0\u5f02\u5e38\u65f6\uff0c\u65e0\u6cd5\u66ff\u4f60 debug\uff08\u5982\u679c\u6709\uff09\u5e76\u7ed9\u51fa\u90e8\u5206\u5206\uff1b\u5982\u679c\u4f60\u4f7f\u7528 C \u6216\u8005 C++\uff0c\u90a3\u4e48\u5f53\u4f60\u7684 shell \u6709 bug \u7684\u65f6\u5019\u52a9\u6559\u53ef\u4ee5\u5c1d\u8bd5\u4fee\u590d\u5e76\u4e3a\u914c\u60c5\u7ed9\u5206\u3002 Q2: \u53ef\u4ee5\u4f7f\u7528 C++ \u6807\u51c6\u5e93\uff08iostream\uff0cSTL \u7b49\uff09\u5417\uff1f A2: \u53ef\u4ee5\u3002","title":"\u5b9e\u9a8c\u4e8c"},{"location":"faq/#_4","text":"Q1: \u7b2c\u4e00\u90e8\u5206\u7684\u4efb\u52a1\u9700\u8981\u5904\u7406 send() \u7684\u963b\u585e\u60c5\u51b5\uff0c\u4f46\u662f\u4f3c\u4e4e 1MiB \u957f\u5ea6\u7684\u6570\u636e\u53ef\u4ee5\u4e00\u6b21\u6027 send() \u51fa\u53bb\uff1f A1: \u5728\u7b2c\u4e00\u3001\u4e8c\u90e8\u5206\u7684\u4efb\u52a1\u4e2d\u4f7f\u7528\u7684\u662f\u963b\u585e IO\uff0c\u786e\u5b9e\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u53ef\u4ee5\u4e00\u6b21\u6027\u53d1\u9001\u3002\u4f46\u662f\u5728\u975e\u963b\u585e IO \u4e2d\uff0c\u4e00\u6b21\u6027\u53d1\u9001\u662f\u65e0\u6cd5\u4fdd\u8bc1\u7684\u3002 Q2: nc \u603b\u662f\u8f93\u5165\u6362\u884c\u540e\u624d\u53d1\u9001\uff0c\u8981\u600e\u4e48\u6d4b\u8bd5\uff1f A2: \u53ef\u4ee5\u8f93\u5165 Ctrl-D \u8fdb\u884c Flush\u3002\u5efa\u8bae\u81ea\u5df1\u7528 Python \u5199\u4e00\u4e2a\u7b80\u5355\u7684 TCP \u5ba2\u6237\u7aef\u8fdb\u884c\u6d4b\u8bd5\u3002 Q3: \u4e3a\u4ec0\u4e48\u6d88\u606f\u4e0d\u4f1a\u5728\u4e24\u4e2a\u5ba2\u6237\u7aef\uff08nc \u8fdb\u7a0b\uff09\u4e4b\u95f4\u6765\u56de\u4f20\u64ad\uff1f A3: \u56e0\u4e3a nc \u4ece socket \u6536\u5230\u6570\u636e\u540e\u628a\u6570\u636e\u6253\u5370\u5230\u6807\u51c6\u8f93\u51fa\uff0c\u4ece\u6807\u51c6\u8f93\u5165\u6536\u5230\u6570\u636e\u540e\u628a\u6570\u636e\u901a\u8fc7 socket \u53d1\u9001\uff0c\u800c\u6807\u51c6\u8f93\u5165\u548c\u6807\u51c6\u8f93\u51fa\u5e76\u4e0d\u662f\u76f8\u8fde\u7684\uff0c\u56e0\u6b64\u4e0d\u4f1a\u6765\u56de\u4f20\u64ad\u3002 Q4: \u6761\u4ef6\u53d8\u91cf\u5fc5\u987b\u8981\u548c\u4e92\u65a5\u9501\u4e00\u8d77\u4f7f\u7528\u5417\uff1f\u53ef\u4ee5\u53bb\u6389\u4f8b\u5b50\u4e2d\u7684 ready \u5417\uff1f A4: \u5728\u8c03\u7528 pthread_cond_signal \u524d\u5fc5\u987b\u5bf9\u6761\u4ef6\u53d8\u91cf\u5bf9\u5e94\u7684\u4e92\u65a5\u9501\u52a0\u9501\uff0c\u8fd9\u548c\u6761\u4ef6\u53d8\u91cf\u7684\u5b9e\u73b0\u673a\u5236\u6709\u5173\u3002ready \u662f\u4e0d\u53ef\u4ee5\u53bb\u6389\u7684\uff0c\u5426\u5219\u53ef\u80fd\u51fa\u73b0\u4f2a\u5524\u9192\uff08\u5e76\u6ca1\u6709\u8c03\u7528 pthread_cond_signal \u4f46 pthread_cond_wait \u5374\u8fd4\u56de\uff09\u3002","title":"\u5b9e\u9a8c\u4e09"},{"location":"lab-1/","text":"Lab 1 \u00b6 \u5f00\u59cb\u4e4b\u524d\u7684\u51c6\u5907 \u00b6 Linux \u7684\u5b89\u88c5\u4e0e\u4f7f\u7528 \u5b66\u4e60\u4f7f\u7528 Git \u5b66\u4e60 GitHub \u7684\u7b80\u5355\u4f7f\u7528\uff0c\u642d\u5efa\u5b9e\u9a8c\u79c1\u6709\u4ed3\u5e93 \u7136\u540e\u4f60\u9700\u8981\u5b89\u88c5 qemu \uff0c\u4ee5\u53ca\u5176\u4ed6\u4e00\u4e9b\u5f00\u53d1\u9700\u8981\u7684\u7ec4\u4ef6\u3002\u4ee5 Ubuntu 18.04 \u4e3a\u4f8b\uff1a sudo apt install git \\ qemu-system-x86 build-essential flex bison bc \\ ncurses-dev libssl-dev libelf-dev \\ nasm \u6ce8\u610f\uff1a \u5173\u4e8e\u5de5\u5177\u4e0e\u7cfb\u7edf\u7684\u4f7f\u7528\u53ea\u9700\u8981\u6bd4\u8f83\u57fa\u7840\u7684\u7528\u6cd5\u5373\u53ef\u3002 \u63a8\u8350\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u5c1d\u8bd5\u719f\u6089 Linux \u73af\u5883\uff0c\u4e3a\u540e\u7eed\u5b9e\u9a8c\u505a\u597d\u51c6\u5907\u3002 \u5b9e\u9a8c\u5185\u5bb9 \u00b6 \u4f60\u9700\u8981\u9605\u8bfb\u4ee5\u4e0b\u5185\u5bb9\uff0c\u5e76\u4e14\u6309\u7167\u300c\u5b9e\u9a8c\u8981\u6c42\u300d\u90e8\u5206\u6765\u5b8c\u6210\u3002 \u7f16\u8bd1 Linux \u5185\u6838\u5e76\u5728 QEMU \u4e2d\u6d4b\u8bd5 \u6784\u5efa\u521d\u59cb\u5185\u5b58\u76d8 (initrd, init ram disk) \u4f7f\u7528\u6c47\u7f16\u8bed\u8a00\uff0c\u7f16\u5199 x86 \u88f8\u91d1\u5c5e (bare-metal) \u7a0b\u5e8f \u52a9\u6559\u63d0\u4f9b\u7684\u4e09\u4e2a\u6d4b\u8bd5\u7a0b\u5e8f\uff1a binaries.zip \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u8bf7\u6309\u7167\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\u7ec4\u7ec7\u4f60\u7684 GitHub \u4ed3\u5e93\uff1a . // Git \u6839\u76ee\u5f55 \u251c\u2500\u2500 lab1 // \u5b9e\u9a8c\u4e00\u6839\u76ee\u5f55 \u2502 \u251c\u2500\u2500 docs // \u5b9e\u9a8c\u4e00\u5b9e\u9a8c\u62a5\u544a\u6839\u76ee\u5f55 \u2502 \u2502 \u2514\u2500\u2500 *.md // \u6587\u4ef6\u540d\u81ea\u62df\uff0c\u53ef\u4ee5\u5199\u5728\u4e00\u4e2a\u6216\u591a\u4e2a Markdown \u6587\u4ef6\u4e2d \u2502 \u251c\u2500\u2500 linux \u2502 \u2502 \u251c\u2500\u2500 bzImage \u2502 \u2502 \u251c\u2500\u2500 initrd.cpio.gz \u2502 \u2502 \u2514\u2500\u2500 .config //\uff08\u53ef\u9009\uff09 \u2502 \u2514\u2500\u2500 mbr \u2502 \u2514\u2500\u2500 mbr.asm \u251c\u2500\u2500 .gitignore // \u4f7f\u7528\u6b64\u6587\u4ef6\u5ffd\u7565\u4f60\u4e0d\u60f3\u63d0\u4ea4\u7684\u6587\u4ef6 \u2514\u2500\u2500 README.md // \u6574\u4e2a\u4ed3\u5e93\u7684 README \u6587\u4ef6\uff0c\u53ef\u4ee5\u5c06\u59d3\u540d\u5b66\u53f7\u5199\u5728\u5176\u4e2d \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206 10 \u5206\u3002\u4f60\u9700\u8981\u5b8c\u6210\uff1a \u5173\u4e8e Git \u4e0e GitHub \u4ed3\u5e93\uff1a \u6b63\u786e\u521b\u5efa\u4e86\u4ed3\u5e93\uff0c\u52a9\u6559\u53ef\u8bbf\u95ee\uff0c\u4e14 \u4ed3\u5e93\u6743\u9650\u4e3a\u79c1\u6709 (private) \u3002\uff08 \u5fc5\u987b\u5b8c\u6210 \uff09 Git \u8bb0\u5f55\u80fd\u591f\u6e05\u6670\u663e\u793a\u4f60\u7684\u5b9e\u9a8c\u8fdb\u5ea6\uff0c\u6ca1\u6709\u51fa\u73b0\u4ee5\u4e0b\u7684\u60c5\u51b5\u3002\uff081 \u5206\uff09 \u5f88\u5927\u4e00\u90e8\u5206\u7684 commit \u7531 GitHub \u7f51\u9875\u7248\u751f\u6210\uff0c\u5373\u901a\u8fc7\u7f51\u9875\u7248\u6587\u4ef6\u4e0a\u4f20\u7684\u65b9\u5f0f\u63d0\u4ea4\u5b9e\u9a8c\u7684\u6587\u4ef6\u3002 \u53ea\u6709\u4e00\u4e2a\uff0c\u6216\u4e24\u4e09\u4e2a commit\u3002 \u4e0a\u4f20\u4e86\u5927\u91cf\u4e0e\u5b9e\u9a8c\u8981\u6c42\u65e0\u5173\u7684\u6587\u4ef6\uff0c\u6ca1\u6709\u8bbe\u7f6e .gitignore \u3002 \u5173\u4e8e Linux \u5185\u6838\uff1a \u6b63\u786e\u7f16\u8bd1\u4e86\u5185\u6838\uff0c\u5e76\u5c06\u7f16\u8bd1\u51fa\u7684 arch/x86/boot/bzImage \u653e\u5728\u4f60\u7684\u4ed3\u5e93\u4e2d\u7684 lab1/linux/ \u4e0b\u9762\u3002\uff081 \u5206\uff09 \u4f60\u88c1\u526a\u4e86\u5185\u6838\uff0c\u88c1\u526a\u5f97\u5230\u7684\u5185\u6838\u5927\u5c0f\u4e0d\u8d85\u8fc7 8 MiB (= 8388608 bytes)\uff0c\u5e76\u4e14\u5b83\u53ef\u4ee5\u5b8c\u6210\u4ee5\u4e0b\u300c\u5173\u4e8e initrd \u4e0e init \u7a0b\u5e8f\u300d\u4e2d\u7684\u5168\u90e8\u4efb\u52a1\u3002\uff081 \u5206\uff09 \u5982\u679c\u4f60\u6ca1\u6709\u5b8c\u6210\u300c\u5173\u4e8e initrd \u4e0e init \u7a0b\u5e8f\u300d\u4e2d\u7684\u5168\u90e8\u4efb\u52a1\uff0c\u52a9\u6559\u4f1a\u4f7f\u7528\u81ea\u5df1\u7684 initrd \u8fdb\u884c\u6d4b\u8bd5\u3002 \u5728\u4e0a\u4e00\u6761\u7684\u57fa\u7840\u4e0a\uff0c\u88c1\u526a\u5f97\u5230\u7684\u5185\u6838\u5927\u5c0f\u4e0d\u8d85\u8fc7 4 MiB (= 4194304 bytes)\u3002\uff080.5 \u5206\uff09 \u5173\u4e8e initrd \u4e0e init \u7a0b\u5e8f\uff1a \u6784\u9020\u4e86\u683c\u5f0f\u6b63\u786e\u7684 initrd.cpio.gz \u6587\u4ef6\uff0c\u5e76\u5c06\u5bf9\u5e94\u6587\u4ef6\u653e\u5728\u4f60\u7684\u4ed3\u5e93\u4e2d\u7684 lab1/linux/initrd.cpio.gz \u3002\uff080.5 \u5206\uff09 \u4f7f\u7528\u4f60\u7f16\u8bd1\u7684\u5185\u6838\u548c initrd.cpio.gz \uff0c\u5176\u4e2d\u7684 /init \u80fd\u591f\u6210\u529f\u6267\u884c\u52a9\u6559\u63d0\u4f9b\u7684\u7a0b\u5e8f 1\u3002\uff080.5 \u5206\uff09 (*) \u4f7f\u7528\u4f60\u7f16\u8bd1\u7684\u5185\u6838\u548c initrd.cpio.gz \uff0c\u5176\u4e2d\u7684 /init \u80fd\u591f\u6210\u529f\u4f9d\u6b21\u6267\u884c\u52a9\u6559\u63d0\u4f9b\u7684\u7a0b\u5e8f 1\u30012\u30013\uff0c\u5e76\u4e14\u7a0b\u5e8f 3 \u6267\u884c\u5b8c\u6210\u540e\u4e0d\u51fa\u73b0\u5185\u6838\u6050\u614c (Kernel Panic)\u3002\uff081.5 \u5206\uff09 \u5173\u4e8e x86 \u88f8\u91d1\u5c5e MBR \u7a0b\u5e8f\uff1a \u6c47\u7f16\u6e90\u6587\u4ef6\u5728\u4ed3\u5e93\u4e2d\u7684 lab1/mbr/mbr.asm \u4e0b\uff0c\u6e90\u6587\u4ef6\u6c47\u7f16\u5f97\u5230\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u53ef\u4ee5\u5728 QEMU \u73af\u5883\u4e0b\u5411\u5c4f\u5e55\u8f93\u51fa\u6587\u5b57\u3002\uff081 \u5206\uff09 (*) \u6c47\u7f16\u7a0b\u5e8f\u80fd\u591f\u9996\u5148\u6e05\u7a7a\u5c4f\u5e55\uff0c\u4e4b\u540e\u6bcf\u9694\u5927\u7ea6 1 \u79d2\uff08\u4e0d\u9700\u8981\u975e\u5e38\u7cbe\u786e\uff09\uff0c\u5411\u5c4f\u5e55\u4e0a\u8f93\u51fa\u4e00\u884c\u6587\u5b57\u3002\uff081.5 \u5206\uff09 \u601d\u8003\u9898\uff1a \u5728\u4e0b\u9762\u7ed9\u51fa\u7684\u601d\u8003\u9898\u4e2d\u4efb\u9009 4 \u9053\u5e76\u5b8c\u6210\u5b83\u4eec\u3002\uff081.5 \u5206\uff09 \u5bf9\u4e8e\u542b (*) \u7a0b\u5e8f\u7684\u8fd0\u884c\u53c2\u8003\u6548\u679c\uff0c\u52a9\u6559\u5f55\u5236\u4e86\u89c6\u9891\uff0c\u653e\u5728\u4e86 B \u7ad9 \u548c YouTube \u4e0a\u3002 \u6ce8\u610f\uff1a\u4f60\u9700\u8981\u5199\u5b9e\u9a8c\u62a5\u544a\uff0c\u5e76\u4e14\u62a5\u544a\u9700\u8981\u8981\u70b9\u9f50\u5168\u3002\u5728\u8981\u70b9\u9f50\u5168\u7684\u60c5\u51b5\u4e0b\u53ef\u4ee5\u7cbe\u7b80\uff0c\u53ef\u4ee5\u63cf\u8ff0\u4f60\u5728\u5b8c\u6210\u5b9e\u9a8c\u65f6\u9047\u5230\u7684\u95ee\u9898\u4e0e\u89e3\u51b3\u65b9\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u63d0\u4f9b\u5efa\u8bae\u7b49\u3002\u5982\u679c\u5bf9\u4ee5\u4e0a\u6bcf\u4e2a\u7ed9\u5206\u5927\u9879\uff08\u9664 Git \u76f8\u5173\u5185\u5bb9\u5916\uff09\u6ca1\u6709\u5bf9\u5e94\u7684\u5b9e\u9a8c\u62a5\u544a\uff0c\u4f60\u53ef\u80fd\u4e0d\u4f1a\u5f97\u5230\u8fd9\u4e00\u90e8\u5206\u7684\u5206\u6570\u3002 \u601d\u8003\u9898 \u00b6 \u5728\u4f7f\u7528 make menuconfig \u8c03\u6574 Linux \u7f16\u8bd1\u9009\u9879\u7684\u65f6\u5019\uff0c\u4f60\u4f1a\u770b\u5230\u6709\u4e9b\u9009\u9879\u662f\u4f7f\u7528 [M] \u6807\u8bb0\u7684\u3002\u5b83\u4eec\u662f\u4ec0\u4e48\u610f\u601d\uff1f\u5728\u4f60\u7684 init \u542f\u52a8\u4e4b\u524d\u7684\u6574\u4e2a\u6d41\u7a0b\u4e2d\u5b83\u4eec\u4f1a\u88ab\u52a0\u8f7d\u5417\uff1f\u5982\u679c\u4e0d\uff0c\u5728\u6b63\u5e38\u7684 Linux \u7cfb\u7edf\u4e2d\uff0c\u5b83\u4eec\u662f\u600e\u4e48\u88ab\u52a0\u8f7d\u7684\uff1f \u5728\u300c\u6784\u5efa initrd \u300d\u7684\u6559\u7a0b\u4e2d\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u793a\u4f8b\u7684 init \u7a0b\u5e8f\u3002\u4e3a\u4ec0\u4e48\u5c4f\u5e55\u4e0a\u8f93\u51fa \"Hello, Linux!\" \u4e4b\u540e\uff0cLinux \u5185\u6838\u5c31\u7acb\u523b kernel panic \u4e86\uff1f \u4e3a\u4ec0\u4e48\u6211\u4eec\u7f16\u5199 C \u8bed\u8a00\u7248\u672c\u7684 init \u7a0b\u5e8f\u5728\u7f16\u8bd1\u65f6\u9700\u8981\u9759\u6001\u94fe\u63a5\uff1f\u6211\u4eec\u80fd\u591f\u5728\u8fd9\u91cc\u4f7f\u7528\u52a8\u6001\u94fe\u63a5\u5417\uff1f \u5728 Vlab \u5e73\u53f0\u4e0a\uff0c\u5373\u4f7f\u662f\u771f\u6b63\u7684 root \u4e5f\u65e0\u6cd5\u4f7f\u7528 mknod \u7b49\u547d\u4ee4\uff0c\u67e5\u627e\u8d44\u6599\uff0c\u5c1d\u8bd5\u7b80\u8981\u8bf4\u660e\u4e3a\u4ec0\u4e48 fakeroot \u73af\u5883\u5374\u80fd\u591f\u6b63\u5e38\u4f7f\u7528\u8fd9\u4e9b\u547d\u4ee4\u3002 \u5728\u4ecb\u7ecd BusyBox \u7684\u4e00\u8282\uff0c\u6211\u4eec\u53d1\u73b0 init \u7a0b\u5e8f\u53ef\u4ee5\u662f\u4e00\u6bb5\u7b2c\u4e00\u884c\u662f #!/bin/sh \u7684 shell \u811a\u672c\u3002\u5c1d\u8bd5\u89e3\u91ca\u4e3a\u4ec0\u4e48\u5b83\u53ef\u4ee5\u4f5c\u4e3a\u7cfb\u7edf\u7b2c\u4e00\u4e2a\u542f\u52a8\u7684\u7a0b\u5e8f\uff0c\u5e76\u4e14\u8bf4\u660e\u8fd9\u6837\u505a\u9700\u8981\u4ec0\u4e48\u6761\u4ef6\u3002 \u6211\u4eec\u7684 MBR \u6837\u4f8b\u7a0b\u5e8f\u4f7f\u7528\u4e86 BIOS \u8c03\u7528 ( int 0x10 ) \u4ee5\u663e\u793a\u6587\u672c\u3002Linux \u7684 init \u7a0b\u5e8f\u4e5f\u53ef\u4ee5\u7528\u8fd9\u79cd\u529e\u6cd5\u8f93\u51fa\u6587\u672c\u5417\uff1f\u4e3a\u4ec0\u4e48\uff1f MBR \u80fd\u591f\u7528\u4e8e\u7f16\u7a0b\u7684\u90e8\u5206\u53ea\u6709 510 \u5b57\u8282\uff0c\u800c\u76ee\u524d\u7684\u7cfb\u7edf\u5f15\u5bfc\u5668\uff08\u5982 GRUB2\uff09\u53ef\u4ee5\u5b9e\u73b0\u5f88\u591a\u590d\u6742\u7684\u529f\u80fd\uff1a\u5982\u4ece\u4e0d\u540c\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u8bfb\u53d6\u6587\u4ef6\u3001\u5f15\u5bfc\u4e0d\u540c\u7684\u7cfb\u7edf\u542f\u52a8\u3001\u63d0\u4f9b\u7f8e\u89c2\u7684\u5f15\u5bfc\u9009\u62e9\u754c\u9762\u7b49\uff0c\u7528 510 \u5b57\u8282\u663e\u7136\u662f\u65e0\u6cd5\u505a\u5230\u8fd9\u4e9b\u529f\u80fd\u7684\u3002\u5b83\u4eec\u662f\u600e\u4e48\u505a\u5230\u7684\uff1f \u76ee\u524d\uff0c\u8d8a\u6765\u8d8a\u591a\u7684 PC \u4f7f\u7528 UEFI \u542f\u52a8\u3002\u8bf7\u7b80\u8ff0\u4f7f\u7528 UEFI \u65f6\u7cfb\u7edf\u542f\u52a8\u7684\u6d41\u7a0b\uff0c\u5e76\u4e0e\u4f20\u7edf BIOS \u7684\u542f\u52a8\u6d41\u7a0b\u6bd4\u8f83\u3002","title":"\u4ecb\u7ecd"},{"location":"lab-1/#lab-1","text":"","title":"Lab 1"},{"location":"lab-1/#_1","text":"Linux \u7684\u5b89\u88c5\u4e0e\u4f7f\u7528 \u5b66\u4e60\u4f7f\u7528 Git \u5b66\u4e60 GitHub \u7684\u7b80\u5355\u4f7f\u7528\uff0c\u642d\u5efa\u5b9e\u9a8c\u79c1\u6709\u4ed3\u5e93 \u7136\u540e\u4f60\u9700\u8981\u5b89\u88c5 qemu \uff0c\u4ee5\u53ca\u5176\u4ed6\u4e00\u4e9b\u5f00\u53d1\u9700\u8981\u7684\u7ec4\u4ef6\u3002\u4ee5 Ubuntu 18.04 \u4e3a\u4f8b\uff1a sudo apt install git \\ qemu-system-x86 build-essential flex bison bc \\ ncurses-dev libssl-dev libelf-dev \\ nasm \u6ce8\u610f\uff1a \u5173\u4e8e\u5de5\u5177\u4e0e\u7cfb\u7edf\u7684\u4f7f\u7528\u53ea\u9700\u8981\u6bd4\u8f83\u57fa\u7840\u7684\u7528\u6cd5\u5373\u53ef\u3002 \u63a8\u8350\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\u5c1d\u8bd5\u719f\u6089 Linux \u73af\u5883\uff0c\u4e3a\u540e\u7eed\u5b9e\u9a8c\u505a\u597d\u51c6\u5907\u3002","title":"\u5f00\u59cb\u4e4b\u524d\u7684\u51c6\u5907"},{"location":"lab-1/#_2","text":"\u4f60\u9700\u8981\u9605\u8bfb\u4ee5\u4e0b\u5185\u5bb9\uff0c\u5e76\u4e14\u6309\u7167\u300c\u5b9e\u9a8c\u8981\u6c42\u300d\u90e8\u5206\u6765\u5b8c\u6210\u3002 \u7f16\u8bd1 Linux \u5185\u6838\u5e76\u5728 QEMU \u4e2d\u6d4b\u8bd5 \u6784\u5efa\u521d\u59cb\u5185\u5b58\u76d8 (initrd, init ram disk) \u4f7f\u7528\u6c47\u7f16\u8bed\u8a00\uff0c\u7f16\u5199 x86 \u88f8\u91d1\u5c5e (bare-metal) \u7a0b\u5e8f \u52a9\u6559\u63d0\u4f9b\u7684\u4e09\u4e2a\u6d4b\u8bd5\u7a0b\u5e8f\uff1a binaries.zip","title":"\u5b9e\u9a8c\u5185\u5bb9"},{"location":"lab-1/#_3","text":"\u8bf7\u6309\u7167\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\u7ec4\u7ec7\u4f60\u7684 GitHub \u4ed3\u5e93\uff1a . // Git \u6839\u76ee\u5f55 \u251c\u2500\u2500 lab1 // \u5b9e\u9a8c\u4e00\u6839\u76ee\u5f55 \u2502 \u251c\u2500\u2500 docs // \u5b9e\u9a8c\u4e00\u5b9e\u9a8c\u62a5\u544a\u6839\u76ee\u5f55 \u2502 \u2502 \u2514\u2500\u2500 *.md // \u6587\u4ef6\u540d\u81ea\u62df\uff0c\u53ef\u4ee5\u5199\u5728\u4e00\u4e2a\u6216\u591a\u4e2a Markdown \u6587\u4ef6\u4e2d \u2502 \u251c\u2500\u2500 linux \u2502 \u2502 \u251c\u2500\u2500 bzImage \u2502 \u2502 \u251c\u2500\u2500 initrd.cpio.gz \u2502 \u2502 \u2514\u2500\u2500 .config //\uff08\u53ef\u9009\uff09 \u2502 \u2514\u2500\u2500 mbr \u2502 \u2514\u2500\u2500 mbr.asm \u251c\u2500\u2500 .gitignore // \u4f7f\u7528\u6b64\u6587\u4ef6\u5ffd\u7565\u4f60\u4e0d\u60f3\u63d0\u4ea4\u7684\u6587\u4ef6 \u2514\u2500\u2500 README.md // \u6574\u4e2a\u4ed3\u5e93\u7684 README \u6587\u4ef6\uff0c\u53ef\u4ee5\u5c06\u59d3\u540d\u5b66\u53f7\u5199\u5728\u5176\u4e2d \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206 10 \u5206\u3002\u4f60\u9700\u8981\u5b8c\u6210\uff1a \u5173\u4e8e Git \u4e0e GitHub \u4ed3\u5e93\uff1a \u6b63\u786e\u521b\u5efa\u4e86\u4ed3\u5e93\uff0c\u52a9\u6559\u53ef\u8bbf\u95ee\uff0c\u4e14 \u4ed3\u5e93\u6743\u9650\u4e3a\u79c1\u6709 (private) \u3002\uff08 \u5fc5\u987b\u5b8c\u6210 \uff09 Git \u8bb0\u5f55\u80fd\u591f\u6e05\u6670\u663e\u793a\u4f60\u7684\u5b9e\u9a8c\u8fdb\u5ea6\uff0c\u6ca1\u6709\u51fa\u73b0\u4ee5\u4e0b\u7684\u60c5\u51b5\u3002\uff081 \u5206\uff09 \u5f88\u5927\u4e00\u90e8\u5206\u7684 commit \u7531 GitHub \u7f51\u9875\u7248\u751f\u6210\uff0c\u5373\u901a\u8fc7\u7f51\u9875\u7248\u6587\u4ef6\u4e0a\u4f20\u7684\u65b9\u5f0f\u63d0\u4ea4\u5b9e\u9a8c\u7684\u6587\u4ef6\u3002 \u53ea\u6709\u4e00\u4e2a\uff0c\u6216\u4e24\u4e09\u4e2a commit\u3002 \u4e0a\u4f20\u4e86\u5927\u91cf\u4e0e\u5b9e\u9a8c\u8981\u6c42\u65e0\u5173\u7684\u6587\u4ef6\uff0c\u6ca1\u6709\u8bbe\u7f6e .gitignore \u3002 \u5173\u4e8e Linux \u5185\u6838\uff1a \u6b63\u786e\u7f16\u8bd1\u4e86\u5185\u6838\uff0c\u5e76\u5c06\u7f16\u8bd1\u51fa\u7684 arch/x86/boot/bzImage \u653e\u5728\u4f60\u7684\u4ed3\u5e93\u4e2d\u7684 lab1/linux/ \u4e0b\u9762\u3002\uff081 \u5206\uff09 \u4f60\u88c1\u526a\u4e86\u5185\u6838\uff0c\u88c1\u526a\u5f97\u5230\u7684\u5185\u6838\u5927\u5c0f\u4e0d\u8d85\u8fc7 8 MiB (= 8388608 bytes)\uff0c\u5e76\u4e14\u5b83\u53ef\u4ee5\u5b8c\u6210\u4ee5\u4e0b\u300c\u5173\u4e8e initrd \u4e0e init \u7a0b\u5e8f\u300d\u4e2d\u7684\u5168\u90e8\u4efb\u52a1\u3002\uff081 \u5206\uff09 \u5982\u679c\u4f60\u6ca1\u6709\u5b8c\u6210\u300c\u5173\u4e8e initrd \u4e0e init \u7a0b\u5e8f\u300d\u4e2d\u7684\u5168\u90e8\u4efb\u52a1\uff0c\u52a9\u6559\u4f1a\u4f7f\u7528\u81ea\u5df1\u7684 initrd \u8fdb\u884c\u6d4b\u8bd5\u3002 \u5728\u4e0a\u4e00\u6761\u7684\u57fa\u7840\u4e0a\uff0c\u88c1\u526a\u5f97\u5230\u7684\u5185\u6838\u5927\u5c0f\u4e0d\u8d85\u8fc7 4 MiB (= 4194304 bytes)\u3002\uff080.5 \u5206\uff09 \u5173\u4e8e initrd \u4e0e init \u7a0b\u5e8f\uff1a \u6784\u9020\u4e86\u683c\u5f0f\u6b63\u786e\u7684 initrd.cpio.gz \u6587\u4ef6\uff0c\u5e76\u5c06\u5bf9\u5e94\u6587\u4ef6\u653e\u5728\u4f60\u7684\u4ed3\u5e93\u4e2d\u7684 lab1/linux/initrd.cpio.gz \u3002\uff080.5 \u5206\uff09 \u4f7f\u7528\u4f60\u7f16\u8bd1\u7684\u5185\u6838\u548c initrd.cpio.gz \uff0c\u5176\u4e2d\u7684 /init \u80fd\u591f\u6210\u529f\u6267\u884c\u52a9\u6559\u63d0\u4f9b\u7684\u7a0b\u5e8f 1\u3002\uff080.5 \u5206\uff09 (*) \u4f7f\u7528\u4f60\u7f16\u8bd1\u7684\u5185\u6838\u548c initrd.cpio.gz \uff0c\u5176\u4e2d\u7684 /init \u80fd\u591f\u6210\u529f\u4f9d\u6b21\u6267\u884c\u52a9\u6559\u63d0\u4f9b\u7684\u7a0b\u5e8f 1\u30012\u30013\uff0c\u5e76\u4e14\u7a0b\u5e8f 3 \u6267\u884c\u5b8c\u6210\u540e\u4e0d\u51fa\u73b0\u5185\u6838\u6050\u614c (Kernel Panic)\u3002\uff081.5 \u5206\uff09 \u5173\u4e8e x86 \u88f8\u91d1\u5c5e MBR \u7a0b\u5e8f\uff1a \u6c47\u7f16\u6e90\u6587\u4ef6\u5728\u4ed3\u5e93\u4e2d\u7684 lab1/mbr/mbr.asm \u4e0b\uff0c\u6e90\u6587\u4ef6\u6c47\u7f16\u5f97\u5230\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u53ef\u4ee5\u5728 QEMU \u73af\u5883\u4e0b\u5411\u5c4f\u5e55\u8f93\u51fa\u6587\u5b57\u3002\uff081 \u5206\uff09 (*) \u6c47\u7f16\u7a0b\u5e8f\u80fd\u591f\u9996\u5148\u6e05\u7a7a\u5c4f\u5e55\uff0c\u4e4b\u540e\u6bcf\u9694\u5927\u7ea6 1 \u79d2\uff08\u4e0d\u9700\u8981\u975e\u5e38\u7cbe\u786e\uff09\uff0c\u5411\u5c4f\u5e55\u4e0a\u8f93\u51fa\u4e00\u884c\u6587\u5b57\u3002\uff081.5 \u5206\uff09 \u601d\u8003\u9898\uff1a \u5728\u4e0b\u9762\u7ed9\u51fa\u7684\u601d\u8003\u9898\u4e2d\u4efb\u9009 4 \u9053\u5e76\u5b8c\u6210\u5b83\u4eec\u3002\uff081.5 \u5206\uff09 \u5bf9\u4e8e\u542b (*) \u7a0b\u5e8f\u7684\u8fd0\u884c\u53c2\u8003\u6548\u679c\uff0c\u52a9\u6559\u5f55\u5236\u4e86\u89c6\u9891\uff0c\u653e\u5728\u4e86 B \u7ad9 \u548c YouTube \u4e0a\u3002 \u6ce8\u610f\uff1a\u4f60\u9700\u8981\u5199\u5b9e\u9a8c\u62a5\u544a\uff0c\u5e76\u4e14\u62a5\u544a\u9700\u8981\u8981\u70b9\u9f50\u5168\u3002\u5728\u8981\u70b9\u9f50\u5168\u7684\u60c5\u51b5\u4e0b\u53ef\u4ee5\u7cbe\u7b80\uff0c\u53ef\u4ee5\u63cf\u8ff0\u4f60\u5728\u5b8c\u6210\u5b9e\u9a8c\u65f6\u9047\u5230\u7684\u95ee\u9898\u4e0e\u89e3\u51b3\u65b9\u6cd5\uff0c\u4e5f\u53ef\u4ee5\u63d0\u4f9b\u5efa\u8bae\u7b49\u3002\u5982\u679c\u5bf9\u4ee5\u4e0a\u6bcf\u4e2a\u7ed9\u5206\u5927\u9879\uff08\u9664 Git \u76f8\u5173\u5185\u5bb9\u5916\uff09\u6ca1\u6709\u5bf9\u5e94\u7684\u5b9e\u9a8c\u62a5\u544a\uff0c\u4f60\u53ef\u80fd\u4e0d\u4f1a\u5f97\u5230\u8fd9\u4e00\u90e8\u5206\u7684\u5206\u6570\u3002","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab-1/#_4","text":"\u5728\u4f7f\u7528 make menuconfig \u8c03\u6574 Linux \u7f16\u8bd1\u9009\u9879\u7684\u65f6\u5019\uff0c\u4f60\u4f1a\u770b\u5230\u6709\u4e9b\u9009\u9879\u662f\u4f7f\u7528 [M] \u6807\u8bb0\u7684\u3002\u5b83\u4eec\u662f\u4ec0\u4e48\u610f\u601d\uff1f\u5728\u4f60\u7684 init \u542f\u52a8\u4e4b\u524d\u7684\u6574\u4e2a\u6d41\u7a0b\u4e2d\u5b83\u4eec\u4f1a\u88ab\u52a0\u8f7d\u5417\uff1f\u5982\u679c\u4e0d\uff0c\u5728\u6b63\u5e38\u7684 Linux \u7cfb\u7edf\u4e2d\uff0c\u5b83\u4eec\u662f\u600e\u4e48\u88ab\u52a0\u8f7d\u7684\uff1f \u5728\u300c\u6784\u5efa initrd \u300d\u7684\u6559\u7a0b\u4e2d\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u793a\u4f8b\u7684 init \u7a0b\u5e8f\u3002\u4e3a\u4ec0\u4e48\u5c4f\u5e55\u4e0a\u8f93\u51fa \"Hello, Linux!\" \u4e4b\u540e\uff0cLinux \u5185\u6838\u5c31\u7acb\u523b kernel panic \u4e86\uff1f \u4e3a\u4ec0\u4e48\u6211\u4eec\u7f16\u5199 C \u8bed\u8a00\u7248\u672c\u7684 init \u7a0b\u5e8f\u5728\u7f16\u8bd1\u65f6\u9700\u8981\u9759\u6001\u94fe\u63a5\uff1f\u6211\u4eec\u80fd\u591f\u5728\u8fd9\u91cc\u4f7f\u7528\u52a8\u6001\u94fe\u63a5\u5417\uff1f \u5728 Vlab \u5e73\u53f0\u4e0a\uff0c\u5373\u4f7f\u662f\u771f\u6b63\u7684 root \u4e5f\u65e0\u6cd5\u4f7f\u7528 mknod \u7b49\u547d\u4ee4\uff0c\u67e5\u627e\u8d44\u6599\uff0c\u5c1d\u8bd5\u7b80\u8981\u8bf4\u660e\u4e3a\u4ec0\u4e48 fakeroot \u73af\u5883\u5374\u80fd\u591f\u6b63\u5e38\u4f7f\u7528\u8fd9\u4e9b\u547d\u4ee4\u3002 \u5728\u4ecb\u7ecd BusyBox \u7684\u4e00\u8282\uff0c\u6211\u4eec\u53d1\u73b0 init \u7a0b\u5e8f\u53ef\u4ee5\u662f\u4e00\u6bb5\u7b2c\u4e00\u884c\u662f #!/bin/sh \u7684 shell \u811a\u672c\u3002\u5c1d\u8bd5\u89e3\u91ca\u4e3a\u4ec0\u4e48\u5b83\u53ef\u4ee5\u4f5c\u4e3a\u7cfb\u7edf\u7b2c\u4e00\u4e2a\u542f\u52a8\u7684\u7a0b\u5e8f\uff0c\u5e76\u4e14\u8bf4\u660e\u8fd9\u6837\u505a\u9700\u8981\u4ec0\u4e48\u6761\u4ef6\u3002 \u6211\u4eec\u7684 MBR \u6837\u4f8b\u7a0b\u5e8f\u4f7f\u7528\u4e86 BIOS \u8c03\u7528 ( int 0x10 ) \u4ee5\u663e\u793a\u6587\u672c\u3002Linux \u7684 init \u7a0b\u5e8f\u4e5f\u53ef\u4ee5\u7528\u8fd9\u79cd\u529e\u6cd5\u8f93\u51fa\u6587\u672c\u5417\uff1f\u4e3a\u4ec0\u4e48\uff1f MBR \u80fd\u591f\u7528\u4e8e\u7f16\u7a0b\u7684\u90e8\u5206\u53ea\u6709 510 \u5b57\u8282\uff0c\u800c\u76ee\u524d\u7684\u7cfb\u7edf\u5f15\u5bfc\u5668\uff08\u5982 GRUB2\uff09\u53ef\u4ee5\u5b9e\u73b0\u5f88\u591a\u590d\u6742\u7684\u529f\u80fd\uff1a\u5982\u4ece\u4e0d\u540c\u7684\u6587\u4ef6\u7cfb\u7edf\u4e2d\u8bfb\u53d6\u6587\u4ef6\u3001\u5f15\u5bfc\u4e0d\u540c\u7684\u7cfb\u7edf\u542f\u52a8\u3001\u63d0\u4f9b\u7f8e\u89c2\u7684\u5f15\u5bfc\u9009\u62e9\u754c\u9762\u7b49\uff0c\u7528 510 \u5b57\u8282\u663e\u7136\u662f\u65e0\u6cd5\u505a\u5230\u8fd9\u4e9b\u529f\u80fd\u7684\u3002\u5b83\u4eec\u662f\u600e\u4e48\u505a\u5230\u7684\uff1f \u76ee\u524d\uff0c\u8d8a\u6765\u8d8a\u591a\u7684 PC \u4f7f\u7528 UEFI \u542f\u52a8\u3002\u8bf7\u7b80\u8ff0\u4f7f\u7528 UEFI \u65f6\u7cfb\u7edf\u542f\u52a8\u7684\u6d41\u7a0b\uff0c\u5e76\u4e0e\u4f20\u7edf BIOS \u7684\u542f\u52a8\u6d41\u7a0b\u6bd4\u8f83\u3002","title":"\u601d\u8003\u9898"},{"location":"lab-1/git/","text":"\u5b66\u4e60\u4f7f\u7528 Git \u00b6 \u8bf7\u5927\u5bb6\u501f\u52a9\u6587\u672b\u53c2\u8003\u8d44\u6599\uff0c\u5b66\u4e60\u4f7f\u7528 Git \u7ba1\u7406\u6e90\u4ee3\u7801\u3002 \u91cd\u70b9\u5173\u6ce8\u4e0b\u5217\u5b50\u547d\u4ee4\uff1a init add commit log remote push pull clone branch checkout merge \u53c2\u8003\u8d44\u6599 \u00b6 Pro Git \u7b2c\u4e8c\u7248 Git\u6559\u7a0b \u7334\u5b50\u90fd\u80fd\u61c2\u7684GIT\u6559\u7a0b Git \u7b80\u660e\u6559\u7a0b","title":"\u5b66\u4e60\u4f7f\u7528 Git"},{"location":"lab-1/git/#git","text":"\u8bf7\u5927\u5bb6\u501f\u52a9\u6587\u672b\u53c2\u8003\u8d44\u6599\uff0c\u5b66\u4e60\u4f7f\u7528 Git \u7ba1\u7406\u6e90\u4ee3\u7801\u3002 \u91cd\u70b9\u5173\u6ce8\u4e0b\u5217\u5b50\u547d\u4ee4\uff1a init add commit log remote push pull clone branch checkout merge","title":"\u5b66\u4e60\u4f7f\u7528 Git"},{"location":"lab-1/git/#_1","text":"Pro Git \u7b2c\u4e8c\u7248 Git\u6559\u7a0b \u7334\u5b50\u90fd\u80fd\u61c2\u7684GIT\u6559\u7a0b Git \u7b80\u660e\u6559\u7a0b","title":"\u53c2\u8003\u8d44\u6599"},{"location":"lab-1/github/","text":"\u5b66\u4e60 GitHub \u7684\u7b80\u5355\u4f7f\u7528\uff0c\u642d\u5efa\u5b9e\u9a8c\u79c1\u6709\u4ed3\u5e93 \u00b6 \u4f60\u9700\u8981\u521b\u5efa\u4e00\u4e2a GitHub \u8d26\u53f7\uff0c\u5e76\u4e14\u521b\u5efa\u4e00\u4e2a \u79c1\u6709 (private) \u7684\u4ed3\u5e93 \uff0c\u5e76\u547d\u540d\u4e3a OSH-2020-Labs\u3002 \u5728\u8fd9\u91cc\u4ed3\u5e93\u4e2d\uff0c\u4f60\u9700\u8981\u5c06\u52a9\u6559\u7684\u8d26\u53f7 OSH-2020-TA \u52a0\u5165\u4e3a\u4f60\u7684 collaborator\u3002\u53d1\u9001\u9080\u8bf7\u540e\uff0c\u5411\u4e09\u4f4d\u52a9\u6559\u4e4b\u4e00\u53d1\u9001\u4f60\u7684\u59d3\u540d\u3001\u5b66\u53f7\u3001GitHub \u8d26\u53f7\u540d\u4e0e\u9080\u8bf7\u94fe\u63a5\u3002 \u6211\u4eec\u4e4b\u540e\u7684\u6240\u6709\u5b9e\u9a8c\u90fd\u4f1a\u901a\u8fc7 GitHub \u63d0\u4ea4\u3002 \u53c2\u8003\u8d44\u6599 \u00b6 GitHub Guides","title":"\u5b66\u4e60 GitHub \u7684\u7b80\u5355\u4f7f\u7528\uff0c\u642d\u5efa\u5b9e\u9a8c\u79c1\u6709\u4ed3\u5e93"},{"location":"lab-1/github/#github","text":"\u4f60\u9700\u8981\u521b\u5efa\u4e00\u4e2a GitHub \u8d26\u53f7\uff0c\u5e76\u4e14\u521b\u5efa\u4e00\u4e2a \u79c1\u6709 (private) \u7684\u4ed3\u5e93 \uff0c\u5e76\u547d\u540d\u4e3a OSH-2020-Labs\u3002 \u5728\u8fd9\u91cc\u4ed3\u5e93\u4e2d\uff0c\u4f60\u9700\u8981\u5c06\u52a9\u6559\u7684\u8d26\u53f7 OSH-2020-TA \u52a0\u5165\u4e3a\u4f60\u7684 collaborator\u3002\u53d1\u9001\u9080\u8bf7\u540e\uff0c\u5411\u4e09\u4f4d\u52a9\u6559\u4e4b\u4e00\u53d1\u9001\u4f60\u7684\u59d3\u540d\u3001\u5b66\u53f7\u3001GitHub \u8d26\u53f7\u540d\u4e0e\u9080\u8bf7\u94fe\u63a5\u3002 \u6211\u4eec\u4e4b\u540e\u7684\u6240\u6709\u5b9e\u9a8c\u90fd\u4f1a\u901a\u8fc7 GitHub \u63d0\u4ea4\u3002","title":"\u5b66\u4e60 GitHub \u7684\u7b80\u5355\u4f7f\u7528\uff0c\u642d\u5efa\u5b9e\u9a8c\u79c1\u6709\u4ed3\u5e93"},{"location":"lab-1/github/#_1","text":"GitHub Guides","title":"\u53c2\u8003\u8d44\u6599"},{"location":"lab-1/initrd/","text":"\u6784\u5efa\u521d\u59cb\u5185\u5b58\u76d8 (initrd, init ram disk) \u00b6 \u5728 Linux \u542f\u52a8\u65f6\uff0c\u9700\u8981\u9996\u5148\u52a0\u8f7d initrd \u8fdb\u884c\u521d\u59cb\u5316\u7684\u64cd\u4f5c\u3002\u4ee5\u4e0b\u64cd\u4f5c\u53ef\u4ee5\u6784\u5efa\u4e00\u4e2a\u6700\u5c0f\u5316\u7684 initrd \u3002\u6211\u4eec\u9996\u5148\u521b\u5efa\u4e00\u4e2a C \u7a0b\u5e8f\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a #include <stdio.h> int main () { printf ( \"Hello, Linux! \\n \" ); return 0 ; } \u4fdd\u5b58\u4e3a init.c \u3002\u4e4b\u540e\u7f16\u8bd1\uff0c \u9759\u6001\u94fe\u63a5 \u4e3a\u53ef\u6267\u884c\u7a0b\u5e8f\u3002 gcc -static init.c -o init \u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u76ee\u5f55\u7528\u4e8e\u653e\u7f6e\u6587\u4ef6\u3002\u5728\u65b0\u7684\u76ee\u5f55\u4e0b\u6253\u5305 initrd \uff1a find . | cpio --quiet -H newc -o | gzip -9 -n > ../initrd.cpio.gz \u8fd9\u4f1a\u5728\u76ee\u5f55\u5916\u521b\u5efa\u538b\u7f29\u540e\u7684 initrd.cpio.gz \u5185\u5b58\u76d8\u3002\u540c\u6837\uff0c\u6211\u4eec\u4f7f\u7528 QEMU \u6d4b\u8bd5\u6548\u679c\u3002 qemu-system-x86_64 -kernel linux-5.4.22/arch/x86_64/boot/bzImage -initrd ramdisk/test3/initrd.cpio.gz \u5f53\u4f60\u770b\u5230\u5c4f\u5e55\u4e0a\u51fa\u73b0 \"Hello, Linux!\" \u7684\u65f6\u5019\uff0c\u5c31\u6210\u529f\u4e86\u3002 \uff083/7 \u66f4\u65b0\uff1a\u56e0\u4e3a\u9ed8\u8ba4\u7684\u5206\u8fa8\u7387\u6bd4\u8f83\u5c0f\uff0c\u5728\u6d4b\u8bd5\u7684\u65f6\u5019\u53ef\u80fd\u770b\u4e0d\u5230\u5c4f\u5e55\u4e0a\u7684\u6d88\u606f\u3002\u53ef\u4ee5\u5728\u547d\u4ee4\u540e\u9762\u52a0\u4e0a -append 'vga=0x343' \uff08\u4e0b\u9762\u4f1a\u63d0\u5230\uff09\u63d0\u9ad8\u663e\u793a\u7684\u5c4f\u5e55\u5206\u8fa8\u7387\uff09 \u6d4b\u8bd5\u7a0b\u5e8f \u00b6 \u6211\u4eec\u63d0\u4f9b\u4e86\u4e09\u4e2a\u9759\u6001\u94fe\u63a5\u7684\u6d4b\u8bd5\u7a0b\u5e8f\uff0c\u5728\u5408\u9002\u7684\u73af\u5883\u4e0b\u53ef\u4ee5\u72ec\u7acb\u8fd0\u884c\u3002\u5b83\u4eec\u7684\u529f\u80fd\u5206\u522b\u662f\uff1a \u7a0b\u5e8f 1: \u8c03\u7528 Linux \u4e0b\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u6bcf\u9694 1 \u79d2\u663e\u793a\u4e00\u884c\u4fe1\u606f\u3002\u663e\u793a\u4e94\u6b21\u3002 \u7a0b\u5e8f 2: \u5411\u4e32\u53e3\u8f93\u51fa\u4e00\u6761\u4fe1\u606f\u3002\u6b64\u7a0b\u5e8f\u4f9d\u8d56 /dev/ttyS0 \u8bbe\u5907\u6587\u4ef6\u3002 \u7a0b\u5e8f 3: \u5728 TTY \u4e2d\u4f7f\u7528 Framebuffer \u663e\u793a\u4e00\u5f20\u56fe\u7247\u3002\u9700\u8981 800x600 32ppm \u7684 VGA \u8bbe\u7f6e\u3002\u6b64\u7a0b\u5e8f\u4f9d\u8d56 /dev/fb0 \u8bbe\u5907\u6587\u4ef6\u3002 \u4f60\u9700\u8981\u505a\u7684\u662f\uff1a\u7f16\u5199\u4e00\u4e2a init \u7a0b\u5e8f\uff0c\u6267\u884c\u8fd9\u4e09\u4e2a\u7a0b\u5e8f\u3002\u5177\u4f53\u7684\u8981\u6c42\u89c1\u4ecb\u7ecd\u9875\u9762\u3002 \u4e3a\u4e86\u80fd\u591f\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u4f60\u7684 QEMU \u547d\u4ee4\u9700\u8981\u5c06\u4e32\u53e3\u8bbe\u7f6e\u4e3a\u300c\u6807\u51c6\u8f93\u5165\u8f93\u51fa\u300d( -serial stdio )\uff0c\u5e76\u4e14\u4f7f\u7528\u5185\u6838\u53c2\u6570\u901a\u77e5\u5185\u6838\u8bbe\u7f6e\u6b63\u786e\u7684\u56fe\u5f62\u5206\u8fa8\u7387\u4e0e\u989c\u8272\u4f4d\u6570 ( -append 'vga=0x343' )\u3002 qemu-system-x86_64 -kernel linux-5.4.22/arch/x86_64/boot/bzImage -initrd ramdisk/test3/initrd.cpio.gz -append 'vga=0x343' -serial stdio \u5173\u4e8e\u8bbe\u5907\u6587\u4ef6 \u00b6 /dev/ttyS0 \u548c /dev/fb0 \u4e0d\u662f\u666e\u901a\u7684\u6587\u4ef6\u3002\u5b83\u4eec\u662f\u8bbe\u5907\u6587\u4ef6\uff0c\u9700\u8981\u4f7f\u7528 mknod \u521b\u5efa\u3002 \u5728 Linux \u4e2d\u4e3b\u8981\u6709\u4e24\u7c7b\u8bbe\u5907\u6587\u4ef6\uff1a\u5757\u8bbe\u5907\u6587\u4ef6\uff08\u6709\u7f13\u51b2\uff09\u3001\u5b57\u7b26\u8bbe\u5907\u6587\u4ef6\uff08\u65e0\u7f13\u51b2\uff09\u3002 \u5757\u8bbe\u5907 (b)\uff1a\u4ee5\u5757\u4e3a\u5355\u4f4d\u4e0e\u786c\u4ef6\u8bbe\u5907\u4f20\u8f93\u6587\u4ef6\u3002\u5bf9\u5b83\u7684\u5199\u5165\u64cd\u4f5c\u4f1a\u88ab\u7f13\u5b58\uff0c\u7531\u5185\u6838\u5728\u5408\u9002\u7684\u65f6\u5019\u53d1\u9001\u7ed9\u786c\u4ef6\u3002 \u5b57\u7b26\u8bbe\u5907 (c)\uff1a\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d\u4e0e\u786c\u4ef6\u8bbe\u5907\u4f20\u8f93\u6587\u4ef6\u3002 \u5728\u521b\u5efa\u65f6\uff0c\u8fd8\u9700\u8981\u63d0\u4f9b\u4e3b\u8bbe\u5907\u53f7 (Major) \u548c\u6b21\u8bbe\u5907\u53f7 (Minor)\u3002\u8bbe\u5907\u6587\u4ef6\u4e00\u822c\u4f4d\u4e8e /dev/ \uff0c\u53ef\u4ee5\u4f7f\u7528 ls -l \u67e5\u770b\u5b83\u4eec\u7684\u4fe1\u606f\u3002 $ ls -l /dev/null crw-rw-rw- 1 root root 1, 3 Feb 14 20:27 /dev/null $ ls -l /dev/sda brw-rw---- 1 root disk 8, 0 Feb 14 20:27 /dev/sda \u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u7a7a\u8bbe\u5907 ( /dev/null ) \u4e3a\u5b57\u7b26\u8bbe\u5907 (c)\uff0c\u4e3b\u8bbe\u5907\u53f7\u4e3a 1\uff0c\u6b21\u8bbe\u5907\u53f7\u4e3a 3\u3002\u7b2c\u4e00\u5757\u786c\u76d8\u5bf9\u5e94\u7684\u8bbe\u5907 ( /dev/sda ) \u4e3a\u5757\u8bbe\u5907 (b)\uff0c\u4e3b\u8bbe\u5907\u53f7\u4e3a 8\uff0c\u6b21\u8bbe\u5907\u53f7\u4e3a 0\u3002 \u4e3a\u4e86\u80fd\u591f\u5728\u4f60\u7684 init \u6267\u884c\u7684\u65f6\u5019\u4e3a\u7a0b\u5e8f 2 \u4e0e\u7a0b\u5e8f 3 \u51c6\u5907\u597d\u8fd9\u4e24\u4e2a\u8bbe\u5907\u6587\u4ef6\uff0c\u4f60\u9700\u8981\u505a\u7684\u662f\uff0c\u5728 init \u4e2d\u8c03\u7528 mknod \u7a0b\u5e8f\u6216\u8005\u8c03\u7528 mknod \u7cfb\u7edf\u8c03\u7528\u751f\u6210\u8fd9\u4e24\u4e2a\u6587\u4ef6\u3002\u5df2\u77e5 /dev/ttyS0 \u4e3a\u5b57\u7b26\u8bbe\u5907\u6587\u4ef6\uff0c\u4e3b\u8bbe\u5907\u53f7\u4e3a 4\uff0c\u6b21\u8bbe\u5907\u53f7\u4e3a 64\uff1b /dev/fb0 \u4e3a\u5b57\u7b26\u8bbe\u5907\u6587\u4ef6\uff0c\u4e3b\u8bbe\u5907\u53f7\u4e3a 29\uff0c\u6b21\u8bbe\u5907\u53f7\u4e3a 0\u3002 \u4f60\u53ef\u4ee5\u4f7f\u7528 man 1 mknod \u67e5\u770b mknod \u7a0b\u5e8f\u7684\u5e2e\u52a9\uff0c\u4f7f\u7528 man 2 mknod \u67e5\u770b mknod \u7cfb\u7edf\u8c03\u7528\u7684\u5e2e\u52a9\u3002 \u8fd9\u4e24\u8005\u90fd\u9700\u8981\u6700\u9ad8\u7528\u6237\u6743\u9650 \u3002 \u4ee5\u4e0b\u662f\u4e00\u4e2a\u5728 C \u8bed\u8a00\u4e2d\u4f7f\u7528 mknod() \u7cfb\u7edf\u8c03\u7528\uff0c\u5728\u5f53\u524d\u76ee\u5f55\u521b\u5efa\u7a7a\u8bbe\u5907\u6587\u4ef6 (null) \u7684\u793a\u4f8b\uff1a #include <stdio.h> #include <sys/types.h> #include <sys/stat.h> #include <fcntl.h> #include <unistd.h> #include <sys/sysmacros.h> int main () { if ( mknod ( \"./null\" , S_IFCHR | S_IRUSR | S_IWUSR , makedev ( 1 , 3 )) == - 1 ) { perror ( \"mknod() failed\" ); } return 0 ; } $ gcc mknod_example.c -o mknod_example $ sudo ./mknod_example $ ls -l null crw------- 1 root root 1 , 3 Mar 1 17 :10 null \u5f53\u7136\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5148\u4f7f\u7528 mknod \u521b\u5efa\u8bbe\u5907\u6587\u4ef6\uff0c\u7136\u540e\u518d\u6253\u5305 initrd \u3002\u4f46\u662f\u9700\u8981\u6ce8\u610f\u4e24\u70b9\uff1a Vlab \u5e73\u53f0\u4e0d\u652f\u6301\u7528\u6237\u76f4\u63a5\u4f7f\u7528 mknod \uff0c\u5373\u4f7f\u662f root \uff0c\u4f46\u53ef\u4ee5\u5728 fakeroot \u73af\u5883\u4e2d\u8fdb\u884c\u64cd\u4f5c\uff08\u89c1\u4e0b\u65b9\uff09\u3002 \u8f93\u5165\u9519\u8bef\u7684\u4e3b\u3001\u6b21\u8bbe\u5907\u53f7\uff0c\u521b\u5efa\u7684\u8bbe\u5907\u6587\u4ef6\u53ef\u80fd\u4f1a\u6307\u5411\u9519\u8bef\u7684\u786c\u4ef6\u3002\u8fdb\u884c\u5199\u5165\u64cd\u4f5c\u53ef\u80fd\u4f1a\u635f\u574f\u5bf9\u5e94\u7684\u786c\u4ef6\uff0c\u6216\u4f7f\u4f60\u7684\u6587\u4ef6\u4e22\u5931\u3002\u5f53\u7136\uff0c\u5728 init \u4e2d\u6267\u884c\u64cd\u4f5c\u7684\u8bdd\uff0c\u5728 QEMU \u865a\u62df\u73af\u5883\u4e0b\u5c31\u4e0d\u9700\u8981\u62c5\u5fc3\u8fd9\u4e00\u70b9\u3002 \u5728 fakeroot \u73af\u5883\u4e2d\u6253\u5305 initrd \u00b6 fakeroot \u5c06\u5efa\u7acb\u4e00\u4e2a\u865a\u62df\u7684 root \u73af\u5883\uff0c\u4f7f mknod \u5f97\u4ee5\u5728 Vlab \u5e73\u53f0\u4f7f\u7528\u3002 fakeroot \u7684\u4f7f\u7528\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728\u52a0\u5165\u8bbe\u5907\u6587\u4ef6\u53ca\u6253\u5305\u524d\u8f93\u5165\uff1a fakeroot \u5373\u53ef\u4ee5\u865a\u62df\u7684 root \u8eab\u4efd\u64cd\u4f5c\uff0c\u8f93\u5165\uff1a mknod dev/ttyS0 c 4 64 mknod dev/fb0 c 29 0 find . | cpio --quiet -H newc -o | gzip -9 -n > ../initrd.cpio.gz \u8fd9\u6837\u4fbf\u53ef\u4ee5\u6253\u5305\u597d initrd \uff0c\u518d\u8f93\u5165\uff1a exit \u5373\u53ef\u9000\u51fa\u865a\u62df root \u73af\u5883\u3002 \u4f7f\u7528 BusyBox \u6784\u5efa initrd\uff08\u53ef\u9009\uff09 \u00b6 BusyBox \u662f\u4e00\u4e2a\u5c06\u8bb8\u591a\u5e38\u7528 Unix \u547d\u4ee4\u884c\u5de5\u5177\u6253\u5305\u8fdb\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u9879\u76ee\uff0c\u5728\u5d4c\u5165\u5f0f\u7cfb\u7edf\u7b49\u5b58\u50a8\u7a7a\u95f4\u6709\u9650\u7684\u73af\u5883\u4e2d\u975e\u5e38\u5e38\u89c1\u3002\u4f60\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528 BusyBox \u63d0\u4f9b\u7684\u5de5\u5177\u6765\u7f16\u5199\u4f60\u7684 init \u7a0b\u5e8f\uff0c\u5e76\u6253\u5305 initrd\u3002 \u65b9\u4fbf\u8d77\u89c1\uff0c\u4f60\u53ef\u4ee5\u76f4\u63a5\u4ece\u8fd9\u91cc\u4e0b\u8f7d\u5df2\u7f16\u8bd1\u597d\u7684 BusyBox: https://www.busybox.net/downloads/binaries/1.30.0-i686/busybox BusyBox \u7684\u7279\u70b9\u4e4b\u4e00\u662f\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u67d0\u4e2a\u652f\u6301\u7684\u522b\u540d\u6765\u8fd0\u884c\u5b83\uff0c\u5b83\u5c31\u4f1a\u50cf\u90a3\u6761\u547d\u4ee4\u4e00\u6837\u5de5\u4f5c\uff0c\u4f8b\u5982\uff1a $ wget -qO busybox \"https://www.busybox.net/downloads/binaries/1.30.0-i686/busybox\" $ chmod 755 busybox $ mv busybox ls $ ./ls \u4f60\u4f1a\u53d1\u73b0 BusyBox \u6b64\u65f6\u7684\u529f\u80fd\u5c31\u548c ls \u547d\u4ee4\u4e00\u6a21\u4e00\u6837\u3002 \u521b\u5efa\u7b26\u53f7\u94fe\u63a5\u662f\u6700\u5e38\u89c1\u7684\u4ee5\u522b\u540d\u4f7f\u7528 BusyBox \u7684\u65b9\u5f0f\uff0c\u4e0b\u9762\u7684\u793a\u8303\u5c31\u4ee5 BusyBox \u4e3a\u57fa\u7840\u6784\u5efa\u4e86\u4e00\u4e2a initrd\uff0c\u5e76\u4f7f\u7528 BusyBox \u5185\u7f6e\u7684 shell \u4f5c\u4e3a\u4e00\u4e2a\u53ef\u4ea4\u4e92\u7684 init \u3002 $ mkdir -p rootfs/bin/ $ \u628a busybox \u6587\u4ef6\u653e\u8fdb rootfs/bin/ $ cd rootfs/bin/ $ for item in $( ./busybox --list ) > do > ln -s busybox $item > done \u7136\u540e\u5411 rootfs/init \u4e2d\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9\uff1a #!/bin/sh /bin/sh \u7ed9\u8fd9\u4e2a init \u6587\u4ef6\u52a0\u4e0a\u6267\u884c\u6743\u9650\uff0c\u5e76\u6309\u7167\u524d\u9762\u7684\u6559\u7a0b\u6240\u8ff0\uff0c\u5c06 rootfs/ \u76ee\u5f55\u6253\u5305\u4e3a initrd.cpio.gz \uff0c\u4f7f\u7528 QEMU \u542f\u52a8\uff0c\u4f60\u5c31\u80fd\u5728\u81ea\u5df1\u7f16\u8bd1\u7684 Linux \u7cfb\u7edf\u4e2d\u4f7f\u7528 shell \u6765\u63a2\u7d22\u4e86\u3002 \u5982\u679c\u4f60\u5e0c\u671b\u5728\u8fdb\u5165 shell \u4e4b\u524d\u8fd0\u884c\u989d\u5916\u7684\u547d\u4ee4\uff0c\u4f8b\u5982\u4f7f\u7528 mknod \u521b\u5efa\u5fc5\u8981\u7684\u8bbe\u5907\u6587\u4ef6\uff0c\u4f60\u53ef\u4ee5\u5c06\u5b83\u4eec\u5199\u5728 init \u6587\u4ef6\u4e2d\uff0c\u8fd9\u4e9b\u547d\u4ee4\u5c31\u4f1a\u88ab\u4f9d\u6b21\u6267\u884c\u3002","title":"\u6784\u5efa\u521d\u59cb\u5185\u5b58\u76d8 (initrd, init ram disk)"},{"location":"lab-1/initrd/#initrd-init-ram-disk","text":"\u5728 Linux \u542f\u52a8\u65f6\uff0c\u9700\u8981\u9996\u5148\u52a0\u8f7d initrd \u8fdb\u884c\u521d\u59cb\u5316\u7684\u64cd\u4f5c\u3002\u4ee5\u4e0b\u64cd\u4f5c\u53ef\u4ee5\u6784\u5efa\u4e00\u4e2a\u6700\u5c0f\u5316\u7684 initrd \u3002\u6211\u4eec\u9996\u5148\u521b\u5efa\u4e00\u4e2a C \u7a0b\u5e8f\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a #include <stdio.h> int main () { printf ( \"Hello, Linux! \\n \" ); return 0 ; } \u4fdd\u5b58\u4e3a init.c \u3002\u4e4b\u540e\u7f16\u8bd1\uff0c \u9759\u6001\u94fe\u63a5 \u4e3a\u53ef\u6267\u884c\u7a0b\u5e8f\u3002 gcc -static init.c -o init \u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u76ee\u5f55\u7528\u4e8e\u653e\u7f6e\u6587\u4ef6\u3002\u5728\u65b0\u7684\u76ee\u5f55\u4e0b\u6253\u5305 initrd \uff1a find . | cpio --quiet -H newc -o | gzip -9 -n > ../initrd.cpio.gz \u8fd9\u4f1a\u5728\u76ee\u5f55\u5916\u521b\u5efa\u538b\u7f29\u540e\u7684 initrd.cpio.gz \u5185\u5b58\u76d8\u3002\u540c\u6837\uff0c\u6211\u4eec\u4f7f\u7528 QEMU \u6d4b\u8bd5\u6548\u679c\u3002 qemu-system-x86_64 -kernel linux-5.4.22/arch/x86_64/boot/bzImage -initrd ramdisk/test3/initrd.cpio.gz \u5f53\u4f60\u770b\u5230\u5c4f\u5e55\u4e0a\u51fa\u73b0 \"Hello, Linux!\" \u7684\u65f6\u5019\uff0c\u5c31\u6210\u529f\u4e86\u3002 \uff083/7 \u66f4\u65b0\uff1a\u56e0\u4e3a\u9ed8\u8ba4\u7684\u5206\u8fa8\u7387\u6bd4\u8f83\u5c0f\uff0c\u5728\u6d4b\u8bd5\u7684\u65f6\u5019\u53ef\u80fd\u770b\u4e0d\u5230\u5c4f\u5e55\u4e0a\u7684\u6d88\u606f\u3002\u53ef\u4ee5\u5728\u547d\u4ee4\u540e\u9762\u52a0\u4e0a -append 'vga=0x343' \uff08\u4e0b\u9762\u4f1a\u63d0\u5230\uff09\u63d0\u9ad8\u663e\u793a\u7684\u5c4f\u5e55\u5206\u8fa8\u7387\uff09","title":"\u6784\u5efa\u521d\u59cb\u5185\u5b58\u76d8 (initrd, init ram disk)"},{"location":"lab-1/initrd/#_1","text":"\u6211\u4eec\u63d0\u4f9b\u4e86\u4e09\u4e2a\u9759\u6001\u94fe\u63a5\u7684\u6d4b\u8bd5\u7a0b\u5e8f\uff0c\u5728\u5408\u9002\u7684\u73af\u5883\u4e0b\u53ef\u4ee5\u72ec\u7acb\u8fd0\u884c\u3002\u5b83\u4eec\u7684\u529f\u80fd\u5206\u522b\u662f\uff1a \u7a0b\u5e8f 1: \u8c03\u7528 Linux \u4e0b\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u6bcf\u9694 1 \u79d2\u663e\u793a\u4e00\u884c\u4fe1\u606f\u3002\u663e\u793a\u4e94\u6b21\u3002 \u7a0b\u5e8f 2: \u5411\u4e32\u53e3\u8f93\u51fa\u4e00\u6761\u4fe1\u606f\u3002\u6b64\u7a0b\u5e8f\u4f9d\u8d56 /dev/ttyS0 \u8bbe\u5907\u6587\u4ef6\u3002 \u7a0b\u5e8f 3: \u5728 TTY \u4e2d\u4f7f\u7528 Framebuffer \u663e\u793a\u4e00\u5f20\u56fe\u7247\u3002\u9700\u8981 800x600 32ppm \u7684 VGA \u8bbe\u7f6e\u3002\u6b64\u7a0b\u5e8f\u4f9d\u8d56 /dev/fb0 \u8bbe\u5907\u6587\u4ef6\u3002 \u4f60\u9700\u8981\u505a\u7684\u662f\uff1a\u7f16\u5199\u4e00\u4e2a init \u7a0b\u5e8f\uff0c\u6267\u884c\u8fd9\u4e09\u4e2a\u7a0b\u5e8f\u3002\u5177\u4f53\u7684\u8981\u6c42\u89c1\u4ecb\u7ecd\u9875\u9762\u3002 \u4e3a\u4e86\u80fd\u591f\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u4f60\u7684 QEMU \u547d\u4ee4\u9700\u8981\u5c06\u4e32\u53e3\u8bbe\u7f6e\u4e3a\u300c\u6807\u51c6\u8f93\u5165\u8f93\u51fa\u300d( -serial stdio )\uff0c\u5e76\u4e14\u4f7f\u7528\u5185\u6838\u53c2\u6570\u901a\u77e5\u5185\u6838\u8bbe\u7f6e\u6b63\u786e\u7684\u56fe\u5f62\u5206\u8fa8\u7387\u4e0e\u989c\u8272\u4f4d\u6570 ( -append 'vga=0x343' )\u3002 qemu-system-x86_64 -kernel linux-5.4.22/arch/x86_64/boot/bzImage -initrd ramdisk/test3/initrd.cpio.gz -append 'vga=0x343' -serial stdio","title":"\u6d4b\u8bd5\u7a0b\u5e8f"},{"location":"lab-1/initrd/#_2","text":"/dev/ttyS0 \u548c /dev/fb0 \u4e0d\u662f\u666e\u901a\u7684\u6587\u4ef6\u3002\u5b83\u4eec\u662f\u8bbe\u5907\u6587\u4ef6\uff0c\u9700\u8981\u4f7f\u7528 mknod \u521b\u5efa\u3002 \u5728 Linux \u4e2d\u4e3b\u8981\u6709\u4e24\u7c7b\u8bbe\u5907\u6587\u4ef6\uff1a\u5757\u8bbe\u5907\u6587\u4ef6\uff08\u6709\u7f13\u51b2\uff09\u3001\u5b57\u7b26\u8bbe\u5907\u6587\u4ef6\uff08\u65e0\u7f13\u51b2\uff09\u3002 \u5757\u8bbe\u5907 (b)\uff1a\u4ee5\u5757\u4e3a\u5355\u4f4d\u4e0e\u786c\u4ef6\u8bbe\u5907\u4f20\u8f93\u6587\u4ef6\u3002\u5bf9\u5b83\u7684\u5199\u5165\u64cd\u4f5c\u4f1a\u88ab\u7f13\u5b58\uff0c\u7531\u5185\u6838\u5728\u5408\u9002\u7684\u65f6\u5019\u53d1\u9001\u7ed9\u786c\u4ef6\u3002 \u5b57\u7b26\u8bbe\u5907 (c)\uff1a\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d\u4e0e\u786c\u4ef6\u8bbe\u5907\u4f20\u8f93\u6587\u4ef6\u3002 \u5728\u521b\u5efa\u65f6\uff0c\u8fd8\u9700\u8981\u63d0\u4f9b\u4e3b\u8bbe\u5907\u53f7 (Major) \u548c\u6b21\u8bbe\u5907\u53f7 (Minor)\u3002\u8bbe\u5907\u6587\u4ef6\u4e00\u822c\u4f4d\u4e8e /dev/ \uff0c\u53ef\u4ee5\u4f7f\u7528 ls -l \u67e5\u770b\u5b83\u4eec\u7684\u4fe1\u606f\u3002 $ ls -l /dev/null crw-rw-rw- 1 root root 1, 3 Feb 14 20:27 /dev/null $ ls -l /dev/sda brw-rw---- 1 root disk 8, 0 Feb 14 20:27 /dev/sda \u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u7a7a\u8bbe\u5907 ( /dev/null ) \u4e3a\u5b57\u7b26\u8bbe\u5907 (c)\uff0c\u4e3b\u8bbe\u5907\u53f7\u4e3a 1\uff0c\u6b21\u8bbe\u5907\u53f7\u4e3a 3\u3002\u7b2c\u4e00\u5757\u786c\u76d8\u5bf9\u5e94\u7684\u8bbe\u5907 ( /dev/sda ) \u4e3a\u5757\u8bbe\u5907 (b)\uff0c\u4e3b\u8bbe\u5907\u53f7\u4e3a 8\uff0c\u6b21\u8bbe\u5907\u53f7\u4e3a 0\u3002 \u4e3a\u4e86\u80fd\u591f\u5728\u4f60\u7684 init \u6267\u884c\u7684\u65f6\u5019\u4e3a\u7a0b\u5e8f 2 \u4e0e\u7a0b\u5e8f 3 \u51c6\u5907\u597d\u8fd9\u4e24\u4e2a\u8bbe\u5907\u6587\u4ef6\uff0c\u4f60\u9700\u8981\u505a\u7684\u662f\uff0c\u5728 init \u4e2d\u8c03\u7528 mknod \u7a0b\u5e8f\u6216\u8005\u8c03\u7528 mknod \u7cfb\u7edf\u8c03\u7528\u751f\u6210\u8fd9\u4e24\u4e2a\u6587\u4ef6\u3002\u5df2\u77e5 /dev/ttyS0 \u4e3a\u5b57\u7b26\u8bbe\u5907\u6587\u4ef6\uff0c\u4e3b\u8bbe\u5907\u53f7\u4e3a 4\uff0c\u6b21\u8bbe\u5907\u53f7\u4e3a 64\uff1b /dev/fb0 \u4e3a\u5b57\u7b26\u8bbe\u5907\u6587\u4ef6\uff0c\u4e3b\u8bbe\u5907\u53f7\u4e3a 29\uff0c\u6b21\u8bbe\u5907\u53f7\u4e3a 0\u3002 \u4f60\u53ef\u4ee5\u4f7f\u7528 man 1 mknod \u67e5\u770b mknod \u7a0b\u5e8f\u7684\u5e2e\u52a9\uff0c\u4f7f\u7528 man 2 mknod \u67e5\u770b mknod \u7cfb\u7edf\u8c03\u7528\u7684\u5e2e\u52a9\u3002 \u8fd9\u4e24\u8005\u90fd\u9700\u8981\u6700\u9ad8\u7528\u6237\u6743\u9650 \u3002 \u4ee5\u4e0b\u662f\u4e00\u4e2a\u5728 C \u8bed\u8a00\u4e2d\u4f7f\u7528 mknod() \u7cfb\u7edf\u8c03\u7528\uff0c\u5728\u5f53\u524d\u76ee\u5f55\u521b\u5efa\u7a7a\u8bbe\u5907\u6587\u4ef6 (null) \u7684\u793a\u4f8b\uff1a #include <stdio.h> #include <sys/types.h> #include <sys/stat.h> #include <fcntl.h> #include <unistd.h> #include <sys/sysmacros.h> int main () { if ( mknod ( \"./null\" , S_IFCHR | S_IRUSR | S_IWUSR , makedev ( 1 , 3 )) == - 1 ) { perror ( \"mknod() failed\" ); } return 0 ; } $ gcc mknod_example.c -o mknod_example $ sudo ./mknod_example $ ls -l null crw------- 1 root root 1 , 3 Mar 1 17 :10 null \u5f53\u7136\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5148\u4f7f\u7528 mknod \u521b\u5efa\u8bbe\u5907\u6587\u4ef6\uff0c\u7136\u540e\u518d\u6253\u5305 initrd \u3002\u4f46\u662f\u9700\u8981\u6ce8\u610f\u4e24\u70b9\uff1a Vlab \u5e73\u53f0\u4e0d\u652f\u6301\u7528\u6237\u76f4\u63a5\u4f7f\u7528 mknod \uff0c\u5373\u4f7f\u662f root \uff0c\u4f46\u53ef\u4ee5\u5728 fakeroot \u73af\u5883\u4e2d\u8fdb\u884c\u64cd\u4f5c\uff08\u89c1\u4e0b\u65b9\uff09\u3002 \u8f93\u5165\u9519\u8bef\u7684\u4e3b\u3001\u6b21\u8bbe\u5907\u53f7\uff0c\u521b\u5efa\u7684\u8bbe\u5907\u6587\u4ef6\u53ef\u80fd\u4f1a\u6307\u5411\u9519\u8bef\u7684\u786c\u4ef6\u3002\u8fdb\u884c\u5199\u5165\u64cd\u4f5c\u53ef\u80fd\u4f1a\u635f\u574f\u5bf9\u5e94\u7684\u786c\u4ef6\uff0c\u6216\u4f7f\u4f60\u7684\u6587\u4ef6\u4e22\u5931\u3002\u5f53\u7136\uff0c\u5728 init \u4e2d\u6267\u884c\u64cd\u4f5c\u7684\u8bdd\uff0c\u5728 QEMU \u865a\u62df\u73af\u5883\u4e0b\u5c31\u4e0d\u9700\u8981\u62c5\u5fc3\u8fd9\u4e00\u70b9\u3002","title":"\u5173\u4e8e\u8bbe\u5907\u6587\u4ef6"},{"location":"lab-1/initrd/#fakeroot-initrd","text":"fakeroot \u5c06\u5efa\u7acb\u4e00\u4e2a\u865a\u62df\u7684 root \u73af\u5883\uff0c\u4f7f mknod \u5f97\u4ee5\u5728 Vlab \u5e73\u53f0\u4f7f\u7528\u3002 fakeroot \u7684\u4f7f\u7528\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728\u52a0\u5165\u8bbe\u5907\u6587\u4ef6\u53ca\u6253\u5305\u524d\u8f93\u5165\uff1a fakeroot \u5373\u53ef\u4ee5\u865a\u62df\u7684 root \u8eab\u4efd\u64cd\u4f5c\uff0c\u8f93\u5165\uff1a mknod dev/ttyS0 c 4 64 mknod dev/fb0 c 29 0 find . | cpio --quiet -H newc -o | gzip -9 -n > ../initrd.cpio.gz \u8fd9\u6837\u4fbf\u53ef\u4ee5\u6253\u5305\u597d initrd \uff0c\u518d\u8f93\u5165\uff1a exit \u5373\u53ef\u9000\u51fa\u865a\u62df root \u73af\u5883\u3002","title":"\u5728 fakeroot \u73af\u5883\u4e2d\u6253\u5305 initrd"},{"location":"lab-1/initrd/#busybox-initrd","text":"BusyBox \u662f\u4e00\u4e2a\u5c06\u8bb8\u591a\u5e38\u7528 Unix \u547d\u4ee4\u884c\u5de5\u5177\u6253\u5305\u8fdb\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u7684\u9879\u76ee\uff0c\u5728\u5d4c\u5165\u5f0f\u7cfb\u7edf\u7b49\u5b58\u50a8\u7a7a\u95f4\u6709\u9650\u7684\u73af\u5883\u4e2d\u975e\u5e38\u5e38\u89c1\u3002\u4f60\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528 BusyBox \u63d0\u4f9b\u7684\u5de5\u5177\u6765\u7f16\u5199\u4f60\u7684 init \u7a0b\u5e8f\uff0c\u5e76\u6253\u5305 initrd\u3002 \u65b9\u4fbf\u8d77\u89c1\uff0c\u4f60\u53ef\u4ee5\u76f4\u63a5\u4ece\u8fd9\u91cc\u4e0b\u8f7d\u5df2\u7f16\u8bd1\u597d\u7684 BusyBox: https://www.busybox.net/downloads/binaries/1.30.0-i686/busybox BusyBox \u7684\u7279\u70b9\u4e4b\u4e00\u662f\uff0c\u5982\u679c\u4f60\u4f7f\u7528\u67d0\u4e2a\u652f\u6301\u7684\u522b\u540d\u6765\u8fd0\u884c\u5b83\uff0c\u5b83\u5c31\u4f1a\u50cf\u90a3\u6761\u547d\u4ee4\u4e00\u6837\u5de5\u4f5c\uff0c\u4f8b\u5982\uff1a $ wget -qO busybox \"https://www.busybox.net/downloads/binaries/1.30.0-i686/busybox\" $ chmod 755 busybox $ mv busybox ls $ ./ls \u4f60\u4f1a\u53d1\u73b0 BusyBox \u6b64\u65f6\u7684\u529f\u80fd\u5c31\u548c ls \u547d\u4ee4\u4e00\u6a21\u4e00\u6837\u3002 \u521b\u5efa\u7b26\u53f7\u94fe\u63a5\u662f\u6700\u5e38\u89c1\u7684\u4ee5\u522b\u540d\u4f7f\u7528 BusyBox \u7684\u65b9\u5f0f\uff0c\u4e0b\u9762\u7684\u793a\u8303\u5c31\u4ee5 BusyBox \u4e3a\u57fa\u7840\u6784\u5efa\u4e86\u4e00\u4e2a initrd\uff0c\u5e76\u4f7f\u7528 BusyBox \u5185\u7f6e\u7684 shell \u4f5c\u4e3a\u4e00\u4e2a\u53ef\u4ea4\u4e92\u7684 init \u3002 $ mkdir -p rootfs/bin/ $ \u628a busybox \u6587\u4ef6\u653e\u8fdb rootfs/bin/ $ cd rootfs/bin/ $ for item in $( ./busybox --list ) > do > ln -s busybox $item > done \u7136\u540e\u5411 rootfs/init \u4e2d\u5199\u5165\u4ee5\u4e0b\u5185\u5bb9\uff1a #!/bin/sh /bin/sh \u7ed9\u8fd9\u4e2a init \u6587\u4ef6\u52a0\u4e0a\u6267\u884c\u6743\u9650\uff0c\u5e76\u6309\u7167\u524d\u9762\u7684\u6559\u7a0b\u6240\u8ff0\uff0c\u5c06 rootfs/ \u76ee\u5f55\u6253\u5305\u4e3a initrd.cpio.gz \uff0c\u4f7f\u7528 QEMU \u542f\u52a8\uff0c\u4f60\u5c31\u80fd\u5728\u81ea\u5df1\u7f16\u8bd1\u7684 Linux \u7cfb\u7edf\u4e2d\u4f7f\u7528 shell \u6765\u63a2\u7d22\u4e86\u3002 \u5982\u679c\u4f60\u5e0c\u671b\u5728\u8fdb\u5165 shell \u4e4b\u524d\u8fd0\u884c\u989d\u5916\u7684\u547d\u4ee4\uff0c\u4f8b\u5982\u4f7f\u7528 mknod \u521b\u5efa\u5fc5\u8981\u7684\u8bbe\u5907\u6587\u4ef6\uff0c\u4f60\u53ef\u4ee5\u5c06\u5b83\u4eec\u5199\u5728 init \u6587\u4ef6\u4e2d\uff0c\u8fd9\u4e9b\u547d\u4ee4\u5c31\u4f1a\u88ab\u4f9d\u6b21\u6267\u884c\u3002","title":"\u4f7f\u7528 BusyBox \u6784\u5efa initrd\uff08\u53ef\u9009\uff09"},{"location":"lab-1/kernel/","text":"\u7f16\u8bd1 Linux \u5185\u6838\u5e76\u5728 QEMU \u4e2d\u6d4b\u8bd5 \u00b6 https://www.kernel.org/ \u4e0a\u53ef\u4ee5\u4e0b\u8f7d\u5230 Linux \u5185\u6838\u7684\u6e90\u4ee3\u7801\u3002\u6b64\u6b21\u5b9e\u9a8c\uff0c\u6211\u4eec\u9009\u62e9 Linux 5.4.22 \u7684\u5185\u6838\u8fdb\u884c\u7f16\u8bd1\u3002 \u8bf7\u5728 64 \u4f4d\u7684 Linux \u73af\u5883\u4e2d\u8fdb\u884c\u7f16\u8bd1\u3002 \u4e0b\u8f7d https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.4.22.tar.xz \uff0c\u89e3\u538b\u7f29\u3002 make defconfig \u521b\u5efa\u9ed8\u8ba4\u5185\u6838\u914d\u7f6e\u3002 make menuconfig \u53ef\u4ee5\u5bf9\u5185\u6838\u7684\u8be6\u7ec6\u9009\u9879\u8fdb\u884c\u914d\u7f6e\u3002\u4e3a\u4e86\u5b8c\u6210\u6b64\u6b21\u5b9e\u9a8c\uff0c\u4f60\u9700\u8981\u5728\u8fd9\u91cc\u5bf9\u5185\u6838\u8fdb\u884c\u7f29\u51cf\u3002\u5f53\u7136\uff0c\u5bf9\u4e0d\u719f\u6089 Linux \u7684\u540c\u5b66\u6211\u4eec\u4e0d\u5efa\u8bae\u5728\u7b2c\u4e00\u6b21\u7f16\u8bd1\u65f6\u8fd9\u4e48\u505a\u3002 \u6ce8\u610f\uff1a\u4e3a\u4e86\u6210\u529f\u8fd0\u884c\u4e4b\u540e\u7684\u6d4b\u8bd5\u7a0b\u5e8f 3\uff0c\u5728 defconfig \u7684\u57fa\u7840\u4e0a\u9700\u8981\u5728 menuconfig \u7684\u65f6\u5019\u5f00\u542f Device Drivers -> Graphics support -> Frame buffer Devices -> Support for frame buffer devices -> VESA VGA graphics support\u3002 make bzImage \u5f00\u59cb\u7f16\u8bd1\u5185\u6838\u3002\u5982\u679c\u4f60\u6709\u591a\u6838\u5fc3\u7684\u5904\u7406\u5668\uff0c\u53ef\u4ee5\u52a0\u4e0a -j \u53c2\u6570\u4ee5\u5e76\u884c\u7f16\u8bd1\uff0c\u52a0\u5feb\u901f\u5ea6\u3002\u4f8b\u5982\uff1a make -j $( nproc ) bzImage \u7f16\u8bd1\u5185\u6838\u9700\u8981\u6bd4\u8f83\u957f\u7684\u65f6\u95f4\u3002\u53ef\u4ee5\u4f11\u606f\u4e00\u4e0b\uff0c\u505a\u70b9\u522b\u7684\u4e8b\u60c5\u3002 \u5728\u7f16\u8bd1\u5b8c\u6210\u540e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 QEMU \u6d4b\u8bd5\u6548\u679c\u3002 qemu-system-x86_64 -kernel linux-5.4.22/arch/x86_64/boot/bzImage \u5982\u679c Linux \u5185\u6838\u5728\u5c4f\u5e55\u4e0a\u6709\u8f93\u51fa\uff0c\u90a3\u4e48\u8bf4\u660e\u7f16\u8bd1\u6210\u529f\u4e86\u3002","title":"\u7f16\u8bd1 Linux \u5185\u6838\u5e76\u5728 QEMU \u4e2d\u6d4b\u8bd5"},{"location":"lab-1/kernel/#linux-qemu","text":"https://www.kernel.org/ \u4e0a\u53ef\u4ee5\u4e0b\u8f7d\u5230 Linux \u5185\u6838\u7684\u6e90\u4ee3\u7801\u3002\u6b64\u6b21\u5b9e\u9a8c\uff0c\u6211\u4eec\u9009\u62e9 Linux 5.4.22 \u7684\u5185\u6838\u8fdb\u884c\u7f16\u8bd1\u3002 \u8bf7\u5728 64 \u4f4d\u7684 Linux \u73af\u5883\u4e2d\u8fdb\u884c\u7f16\u8bd1\u3002 \u4e0b\u8f7d https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.4.22.tar.xz \uff0c\u89e3\u538b\u7f29\u3002 make defconfig \u521b\u5efa\u9ed8\u8ba4\u5185\u6838\u914d\u7f6e\u3002 make menuconfig \u53ef\u4ee5\u5bf9\u5185\u6838\u7684\u8be6\u7ec6\u9009\u9879\u8fdb\u884c\u914d\u7f6e\u3002\u4e3a\u4e86\u5b8c\u6210\u6b64\u6b21\u5b9e\u9a8c\uff0c\u4f60\u9700\u8981\u5728\u8fd9\u91cc\u5bf9\u5185\u6838\u8fdb\u884c\u7f29\u51cf\u3002\u5f53\u7136\uff0c\u5bf9\u4e0d\u719f\u6089 Linux \u7684\u540c\u5b66\u6211\u4eec\u4e0d\u5efa\u8bae\u5728\u7b2c\u4e00\u6b21\u7f16\u8bd1\u65f6\u8fd9\u4e48\u505a\u3002 \u6ce8\u610f\uff1a\u4e3a\u4e86\u6210\u529f\u8fd0\u884c\u4e4b\u540e\u7684\u6d4b\u8bd5\u7a0b\u5e8f 3\uff0c\u5728 defconfig \u7684\u57fa\u7840\u4e0a\u9700\u8981\u5728 menuconfig \u7684\u65f6\u5019\u5f00\u542f Device Drivers -> Graphics support -> Frame buffer Devices -> Support for frame buffer devices -> VESA VGA graphics support\u3002 make bzImage \u5f00\u59cb\u7f16\u8bd1\u5185\u6838\u3002\u5982\u679c\u4f60\u6709\u591a\u6838\u5fc3\u7684\u5904\u7406\u5668\uff0c\u53ef\u4ee5\u52a0\u4e0a -j \u53c2\u6570\u4ee5\u5e76\u884c\u7f16\u8bd1\uff0c\u52a0\u5feb\u901f\u5ea6\u3002\u4f8b\u5982\uff1a make -j $( nproc ) bzImage \u7f16\u8bd1\u5185\u6838\u9700\u8981\u6bd4\u8f83\u957f\u7684\u65f6\u95f4\u3002\u53ef\u4ee5\u4f11\u606f\u4e00\u4e0b\uff0c\u505a\u70b9\u522b\u7684\u4e8b\u60c5\u3002 \u5728\u7f16\u8bd1\u5b8c\u6210\u540e\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 QEMU \u6d4b\u8bd5\u6548\u679c\u3002 qemu-system-x86_64 -kernel linux-5.4.22/arch/x86_64/boot/bzImage \u5982\u679c Linux \u5185\u6838\u5728\u5c4f\u5e55\u4e0a\u6709\u8f93\u51fa\uff0c\u90a3\u4e48\u8bf4\u660e\u7f16\u8bd1\u6210\u529f\u4e86\u3002","title":"\u7f16\u8bd1 Linux \u5185\u6838\u5e76\u5728 QEMU \u4e2d\u6d4b\u8bd5"},{"location":"lab-1/linux/","text":"Linux \u7684\u5b89\u88c5\u4e0e\u4f7f\u7528 \u00b6 \u5b89\u88c5 Linux \u64cd\u4f5c\u7cfb\u7edf \u00b6 \u53d1\u884c\u7248\u9009\u62e9 \u00b6 Linux \u53d1\u884c\u7248\u6570\u91cf\u4f17\u591a\uff08\u89c1\u53c2\u8003\u8d44\u6599 1\uff09\uff0c\u5176\u4e2d\u90e8\u5206\u8f83\u4e3a\u4e3b\u6d41\u7684 Linux \u53d1\u884c\u7248\u6709\uff1a Debian Ubuntu Fedora Arch Linux Elementary OS Deepin Gentoo Linux \u4e0d\u540c\u7684\u53d1\u884c\u7248\u6709\u5404\u81ea\u7684\u7279\u70b9\uff0c\u8bbe\u8ba1\u54f2\u5b66\u4e5f\u4e0d\u5c3d\u76f8\u540c\uff0c\u5927\u5bb6\u53ef\u4ee5\u9009\u62e9\u4efb\u610f\u4e00\u6b3e\u81ea\u5df1\u559c\u6b22\u7684 Linux \u53d1\u884c\u7248\u3002\u5982\u679c\u662f\u521d\u6b21\u63a5\u89e6 Linux\uff0c\u6211\u4eec\u63a8\u8350 Ubuntu\uff0c\u5b89\u88c5\u76f8\u5bf9\u5bb9\u6613\uff0c\u4e14\u7f51\u4e0a\u8d44\u6599\u8f83\u591a\u3002 \u5b89\u88c5\u65b9\u5f0f \u00b6 \u5e38\u89c1\u7684\u4e24\u79cd\u5b89\u88c5\u65b9\u5f0f\uff1a \u76f4\u63a5\u5b89\u88c5\u5728\u7269\u7406\u673a\uff08\u88f8\u91d1\u5c5e\uff0cbare metal\uff09\u4e0a \u5b89\u88c5\u5728\u865a\u62df\u673a\u4e2d \u5982\u679c\u6253\u7b97\u5c06 Linux \u76f4\u63a5\u5b89\u88c5\u5728\u7269\u7406\u673a\u4e0a\uff0c\u4e14\u4e0e Windows/macOS \u5171\u5b58\uff0c\u8bf7\u81ea\u884c\u67e5\u627e\u76f8\u5173\u8d44\u6599\u3002\u8fd9\u79cd\u65b9\u6848\u64cd\u4f5c\u76f8\u5bf9\u7e41\u7410\uff0c\u4f46\u7cfb\u7edf\u6027\u80fd\u548c\u4f7f\u7528\u4f53\u9a8c\u76f8\u5bf9\u8f83\u597d\u3002 \u4e0b\u9762\u5217\u51fa\u4e86\u4e00\u4e9b\u5e38\u7528\u7684\u865a\u62df\u5316\u8f6f\u4ef6\uff0c\u8bf7\u5927\u5bb6\u6839\u636e\u81ea\u8eab\u60c5\u51b5\u9009\u62e9\u3002 Oracle VM VirtualBox \uff08\u514d\u8d39\u8f6f\u4ef6\uff0cGPLv2 \u534f\u8bae\uff0c\u652f\u6301 macOS, Windows, Linux \u64cd\u4f5c\u7cfb\u7edf\uff09 Parallels Desktop \uff08\u5546\u4e1a\u8f6f\u4ef6\uff0c\u652f\u6301 macOS\uff09 VMware Fusion \uff08\u5546\u4e1a\u8f6f\u4ef6\uff0c\u652f\u6301 macOS\uff09 VMware Workstation \uff08\u5546\u4e1a\u8f6f\u4ef6\uff0c\u652f\u6301 Windows, Linux\uff09 VMware Player \uff08\u5546\u4e1a\u8f6f\u4ef6\uff0c\u975e\u5546\u4e1a\u7528\u9014\u514d\u8d39\uff0c\u652f\u6301 Windows, Linux\uff09 \u5982\u679c\u4f60\u60f3\u8981\u5728\u865a\u62df\u673a\u4e2d\u5b89\u88c5 Linux\uff0c\u8fd9\u91cc\u6709\u4e24\u7bc7\u535a\u5ba2\u53ef\u4ee5\u53c2\u8003\uff1a \u5728 Windows \u4e0b\u4f7f\u7528 VMware Workstation \u5b89\u88c5 Ubuntu \uff08\u53e6\u6709 \u82f1\u6587\u7248 \uff09 \u5728 macOS \u4e0b\u4f7f\u7528 VMware Fusion \u6216 VirtualBox \u5b89\u88c5 Ubuntu \u684c\u9762\u73af\u5883 \u00b6 \u5e38\u89c1\u7684\u684c\u9762\u73af\u5883\uff1a GNOME (Ubuntu 17.10 \u5f00\u59cb, Debian, Fedora \u9ed8\u8ba4\u684c\u9762\u73af\u5883) KDE Unity (Ubuntu 17.04 \u53ca\u4ee5\u524d\u7248\u672c\u9ed8\u8ba4\u684c\u9762\u73af\u5883) Xfce \u867d\u7136\u53ef\u4ee5\u5728\u7eaf\u547d\u4ee4\u884c (command line) \u6a21\u5f0f\u4e0b\u4f7f\u7528 Linux\uff0c\u4f46\u7531\u4e8e\u540e\u7eed\u5b9e\u9a8c\u9700\u8981\u4f7f\u7528\u6d4f\u89c8\u5668\u6267\u884c\u90e8\u5206\u64cd\u4f5c\uff0c\u56e0\u6b64\u5efa\u8bae\u5927\u5bb6\u5b89\u88c5\u81f3\u5c11\u4e00\u79cd\u684c\u9762\u73af\u5883\u3002 \u8bb8\u591a\u9762\u5411\u684c\u9762\u7528\u6237\u7684\u53d1\u884c\u7248\u90fd\u4f1a\u9ed8\u8ba4\u5b89\u88c5\u684c\u9762\u73af\u5883\uff0c\u5982\u5b89\u88c5 Ubuntu Desktop \u65f6\uff0c\u5b89\u88c5\u7a0b\u5e8f\u4f1a\u9ed8\u8ba4\u5b89\u88c5 GNOME \u684c\u9762\u73af\u5883\u3002\u4e00\u822c\u800c\u8a00\uff0c\u8fd9\u4e9b\u9ed8\u8ba4\u7684\u684c\u9762\u73af\u5883\u5c31\u80fd\u591f\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\u3002 Vlab \u5e73\u53f0 \u00b6 \u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 https://vlab.ustc.edu.cn \u6765\u8fdb\u884c\u5b9e\u9a8c\uff0c\u5177\u4f53\u7684\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003 Vlab \u5e73\u53f0\u7684\u4f7f\u7528\u6587\u6863 \u3002 \u53c2\u8003\u8d44\u6599 \u00b6 \u73b0\u5b58\u7684 Linux \u53d1\u884c\u7248 Linux \u57fa\u672c\u6982\u5ff5\u548c\u5b89\u88c5\u6307\u5357\uff08Linux \u5165\u95e8\u516c\u5f00\u8bfe\uff09 \u4f7f\u7528 Linux \u64cd\u4f5c\u7cfb\u7edf \u00b6 \u8fd9\u4e00\u90e8\u5206\u4e3b\u8981\u76ee\u7684\u662f\u8ba9\u5927\u5bb6\u4e86\u89e3\u4e00\u4e9b\u5e38\u7528\u7684 Linux \u547d\u4ee4\uff0c\u51cf\u5c11\u540e\u7eed\u5b9e\u9a8c\u9047\u5230\u7684\u963b\u529b\u3002 Linux \u547d\u4ee4\u884c\u662f Linux \u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u79cd\u547d\u4ee4\u884c\u754c\u9762 ( command-line interface , CLI ) \u5141\u8bb8\u6211\u4eec\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u3001\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u4ea4\u4e92\u3002\u76f8\u6bd4\u4e8e\u56fe\u5f62\u7528\u6237\u754c\u9762( Graphical User Interface \uff0c GUI )\uff0cCLI \u66f4\u5bb9\u6613\u4f7f\u7528\u7f16\u7a0b\u7684\u65b9\u6cd5\u6765\u8c03\u7528\uff0c\u4e3a\u7a0b\u5e8f\u5316\u63a7\u5236\u6253\u4e0b\u57fa\u7840\u3002 \u90e8\u5206\u5e38\u7528\u547d\u4ee4 \u00b6 \u6587\u4ef6/\u76ee\u5f55\u76f8\u5173\uff1a ls , cd , pwd , mv , cp , rm , mkdir , cat , touch , find , tar , dd \u6587\u672c\u5904\u7406\uff1a echo , grep , sed , wc , tee , sort , vi \u64cd\u4f5c\u7cfb\u7edf\u76f8\u5173\uff1a systemctl , shutdown , reboot , w , ps , kill , df \u5efa\u8bae\u5927\u5bb6\u719f\u6089\u4ee5\u4e0a\u547d\u4ee4\u7684\u57fa\u672c\u7528\u6cd5\uff0c\u4eb2\u81ea\u5c1d\u8bd5\u4e0a\u8ff0\u547d\u4ee4\u3002\u5177\u4f53\u7528\u6cd5\u53ef\u4ee5\u53c2\u8003 Linux \u547d\u4ee4\u5927\u5168\uff08\u89c1\u53c2\u8003\u8d44\u6599 1\uff09\u3002 \u53c2\u8003\u8d44\u6599 \u00b6 Linux \u547d\u4ee4\u5927\u5168 \u56fe\u5f62\u754c\u9762 VS \u547d\u4ee4\u884c\u754c\u9762\uff08Linux \u5165\u95e8\u516c\u5f00\u8bfe\uff09 USTCLUG \u672c\u5b66\u671f\u7684 Linux 101 \u6d3b\u52a8\u8bb2\u4e49 \uff08\u672a\u5b8c\u6210\uff09\u4e0e \u5f80\u5e74\u7684 Slides","title":"Linux \u7684\u5b89\u88c5\u4e0e\u4f7f\u7528"},{"location":"lab-1/linux/#linux","text":"","title":"Linux \u7684\u5b89\u88c5\u4e0e\u4f7f\u7528"},{"location":"lab-1/linux/#linux_1","text":"","title":"\u5b89\u88c5 Linux \u64cd\u4f5c\u7cfb\u7edf"},{"location":"lab-1/linux/#_1","text":"Linux \u53d1\u884c\u7248\u6570\u91cf\u4f17\u591a\uff08\u89c1\u53c2\u8003\u8d44\u6599 1\uff09\uff0c\u5176\u4e2d\u90e8\u5206\u8f83\u4e3a\u4e3b\u6d41\u7684 Linux \u53d1\u884c\u7248\u6709\uff1a Debian Ubuntu Fedora Arch Linux Elementary OS Deepin Gentoo Linux \u4e0d\u540c\u7684\u53d1\u884c\u7248\u6709\u5404\u81ea\u7684\u7279\u70b9\uff0c\u8bbe\u8ba1\u54f2\u5b66\u4e5f\u4e0d\u5c3d\u76f8\u540c\uff0c\u5927\u5bb6\u53ef\u4ee5\u9009\u62e9\u4efb\u610f\u4e00\u6b3e\u81ea\u5df1\u559c\u6b22\u7684 Linux \u53d1\u884c\u7248\u3002\u5982\u679c\u662f\u521d\u6b21\u63a5\u89e6 Linux\uff0c\u6211\u4eec\u63a8\u8350 Ubuntu\uff0c\u5b89\u88c5\u76f8\u5bf9\u5bb9\u6613\uff0c\u4e14\u7f51\u4e0a\u8d44\u6599\u8f83\u591a\u3002","title":"\u53d1\u884c\u7248\u9009\u62e9"},{"location":"lab-1/linux/#_2","text":"\u5e38\u89c1\u7684\u4e24\u79cd\u5b89\u88c5\u65b9\u5f0f\uff1a \u76f4\u63a5\u5b89\u88c5\u5728\u7269\u7406\u673a\uff08\u88f8\u91d1\u5c5e\uff0cbare metal\uff09\u4e0a \u5b89\u88c5\u5728\u865a\u62df\u673a\u4e2d \u5982\u679c\u6253\u7b97\u5c06 Linux \u76f4\u63a5\u5b89\u88c5\u5728\u7269\u7406\u673a\u4e0a\uff0c\u4e14\u4e0e Windows/macOS \u5171\u5b58\uff0c\u8bf7\u81ea\u884c\u67e5\u627e\u76f8\u5173\u8d44\u6599\u3002\u8fd9\u79cd\u65b9\u6848\u64cd\u4f5c\u76f8\u5bf9\u7e41\u7410\uff0c\u4f46\u7cfb\u7edf\u6027\u80fd\u548c\u4f7f\u7528\u4f53\u9a8c\u76f8\u5bf9\u8f83\u597d\u3002 \u4e0b\u9762\u5217\u51fa\u4e86\u4e00\u4e9b\u5e38\u7528\u7684\u865a\u62df\u5316\u8f6f\u4ef6\uff0c\u8bf7\u5927\u5bb6\u6839\u636e\u81ea\u8eab\u60c5\u51b5\u9009\u62e9\u3002 Oracle VM VirtualBox \uff08\u514d\u8d39\u8f6f\u4ef6\uff0cGPLv2 \u534f\u8bae\uff0c\u652f\u6301 macOS, Windows, Linux \u64cd\u4f5c\u7cfb\u7edf\uff09 Parallels Desktop \uff08\u5546\u4e1a\u8f6f\u4ef6\uff0c\u652f\u6301 macOS\uff09 VMware Fusion \uff08\u5546\u4e1a\u8f6f\u4ef6\uff0c\u652f\u6301 macOS\uff09 VMware Workstation \uff08\u5546\u4e1a\u8f6f\u4ef6\uff0c\u652f\u6301 Windows, Linux\uff09 VMware Player \uff08\u5546\u4e1a\u8f6f\u4ef6\uff0c\u975e\u5546\u4e1a\u7528\u9014\u514d\u8d39\uff0c\u652f\u6301 Windows, Linux\uff09 \u5982\u679c\u4f60\u60f3\u8981\u5728\u865a\u62df\u673a\u4e2d\u5b89\u88c5 Linux\uff0c\u8fd9\u91cc\u6709\u4e24\u7bc7\u535a\u5ba2\u53ef\u4ee5\u53c2\u8003\uff1a \u5728 Windows \u4e0b\u4f7f\u7528 VMware Workstation \u5b89\u88c5 Ubuntu \uff08\u53e6\u6709 \u82f1\u6587\u7248 \uff09 \u5728 macOS \u4e0b\u4f7f\u7528 VMware Fusion \u6216 VirtualBox \u5b89\u88c5 Ubuntu","title":"\u5b89\u88c5\u65b9\u5f0f"},{"location":"lab-1/linux/#_3","text":"\u5e38\u89c1\u7684\u684c\u9762\u73af\u5883\uff1a GNOME (Ubuntu 17.10 \u5f00\u59cb, Debian, Fedora \u9ed8\u8ba4\u684c\u9762\u73af\u5883) KDE Unity (Ubuntu 17.04 \u53ca\u4ee5\u524d\u7248\u672c\u9ed8\u8ba4\u684c\u9762\u73af\u5883) Xfce \u867d\u7136\u53ef\u4ee5\u5728\u7eaf\u547d\u4ee4\u884c (command line) \u6a21\u5f0f\u4e0b\u4f7f\u7528 Linux\uff0c\u4f46\u7531\u4e8e\u540e\u7eed\u5b9e\u9a8c\u9700\u8981\u4f7f\u7528\u6d4f\u89c8\u5668\u6267\u884c\u90e8\u5206\u64cd\u4f5c\uff0c\u56e0\u6b64\u5efa\u8bae\u5927\u5bb6\u5b89\u88c5\u81f3\u5c11\u4e00\u79cd\u684c\u9762\u73af\u5883\u3002 \u8bb8\u591a\u9762\u5411\u684c\u9762\u7528\u6237\u7684\u53d1\u884c\u7248\u90fd\u4f1a\u9ed8\u8ba4\u5b89\u88c5\u684c\u9762\u73af\u5883\uff0c\u5982\u5b89\u88c5 Ubuntu Desktop \u65f6\uff0c\u5b89\u88c5\u7a0b\u5e8f\u4f1a\u9ed8\u8ba4\u5b89\u88c5 GNOME \u684c\u9762\u73af\u5883\u3002\u4e00\u822c\u800c\u8a00\uff0c\u8fd9\u4e9b\u9ed8\u8ba4\u7684\u684c\u9762\u73af\u5883\u5c31\u80fd\u591f\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\u3002","title":"\u684c\u9762\u73af\u5883"},{"location":"lab-1/linux/#vlab","text":"\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 https://vlab.ustc.edu.cn \u6765\u8fdb\u884c\u5b9e\u9a8c\uff0c\u5177\u4f53\u7684\u4f7f\u7528\u65b9\u5f0f\u8bf7\u53c2\u8003 Vlab \u5e73\u53f0\u7684\u4f7f\u7528\u6587\u6863 \u3002","title":"Vlab \u5e73\u53f0"},{"location":"lab-1/linux/#_4","text":"\u73b0\u5b58\u7684 Linux \u53d1\u884c\u7248 Linux \u57fa\u672c\u6982\u5ff5\u548c\u5b89\u88c5\u6307\u5357\uff08Linux \u5165\u95e8\u516c\u5f00\u8bfe\uff09","title":"\u53c2\u8003\u8d44\u6599"},{"location":"lab-1/linux/#linux_2","text":"\u8fd9\u4e00\u90e8\u5206\u4e3b\u8981\u76ee\u7684\u662f\u8ba9\u5927\u5bb6\u4e86\u89e3\u4e00\u4e9b\u5e38\u7528\u7684 Linux \u547d\u4ee4\uff0c\u51cf\u5c11\u540e\u7eed\u5b9e\u9a8c\u9047\u5230\u7684\u963b\u529b\u3002 Linux \u547d\u4ee4\u884c\u662f Linux \u7684\u91cd\u8981\u7ec4\u6210\u90e8\u5206\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u79cd\u547d\u4ee4\u884c\u754c\u9762 ( command-line interface , CLI ) \u5141\u8bb8\u6211\u4eec\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u3001\u5e94\u7528\u7a0b\u5e8f\u8fdb\u884c\u4ea4\u4e92\u3002\u76f8\u6bd4\u4e8e\u56fe\u5f62\u7528\u6237\u754c\u9762( Graphical User Interface \uff0c GUI )\uff0cCLI \u66f4\u5bb9\u6613\u4f7f\u7528\u7f16\u7a0b\u7684\u65b9\u6cd5\u6765\u8c03\u7528\uff0c\u4e3a\u7a0b\u5e8f\u5316\u63a7\u5236\u6253\u4e0b\u57fa\u7840\u3002","title":"\u4f7f\u7528 Linux \u64cd\u4f5c\u7cfb\u7edf"},{"location":"lab-1/linux/#_5","text":"\u6587\u4ef6/\u76ee\u5f55\u76f8\u5173\uff1a ls , cd , pwd , mv , cp , rm , mkdir , cat , touch , find , tar , dd \u6587\u672c\u5904\u7406\uff1a echo , grep , sed , wc , tee , sort , vi \u64cd\u4f5c\u7cfb\u7edf\u76f8\u5173\uff1a systemctl , shutdown , reboot , w , ps , kill , df \u5efa\u8bae\u5927\u5bb6\u719f\u6089\u4ee5\u4e0a\u547d\u4ee4\u7684\u57fa\u672c\u7528\u6cd5\uff0c\u4eb2\u81ea\u5c1d\u8bd5\u4e0a\u8ff0\u547d\u4ee4\u3002\u5177\u4f53\u7528\u6cd5\u53ef\u4ee5\u53c2\u8003 Linux \u547d\u4ee4\u5927\u5168\uff08\u89c1\u53c2\u8003\u8d44\u6599 1\uff09\u3002","title":"\u90e8\u5206\u5e38\u7528\u547d\u4ee4"},{"location":"lab-1/linux/#_6","text":"Linux \u547d\u4ee4\u5927\u5168 \u56fe\u5f62\u754c\u9762 VS \u547d\u4ee4\u884c\u754c\u9762\uff08Linux \u5165\u95e8\u516c\u5f00\u8bfe\uff09 USTCLUG \u672c\u5b66\u671f\u7684 Linux 101 \u6d3b\u52a8\u8bb2\u4e49 \uff08\u672a\u5b8c\u6210\uff09\u4e0e \u5f80\u5e74\u7684 Slides","title":"\u53c2\u8003\u8d44\u6599"},{"location":"lab-1/mbr/","text":"\u4f7f\u7528\u6c47\u7f16\u8bed\u8a00\uff0c\u7f16\u5199 x86 \u88f8\u91d1\u5c5e (bare-metal) \u7a0b\u5e8f \u00b6 \u8bf7\u5148\u9605\u8bfb\u3001\u641c\u7d22\u8d44\u6599\uff0c\u719f\u6089 x86 \u6c47\u7f16\u6307\u4ee4\u3002 \u4f60\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u7684 x86 \u6307\u4ee4\uff08\u4e0d\u9650\u5236\u4e8e\u6b64\uff09\uff1a mov (\u6570\u636e\u79fb\u52a8) int (\u547c\u53eb\u4e2d\u65ad\u5904\u7406) jmp (\u8df3\u8f6c) cmp (\u6bd4\u8f83\u64cd\u4f5c\u6570\uff0c\u4fee\u6539 flags\uff0c\u4ee5\u63d0\u4f9b\u7ed9\u6761\u4ef6\u8df3\u8f6c\u6307\u4ee4) je \u7b49\u4e00\u4e9b\u6761\u4ef6\u8df3\u8f6c\u6307\u4ee4 lodsb (\u5c06\u5bc4\u5b58\u5668 si \u6307\u5411\u7684\u5b57\u7b26\u4e32\u5bf9\u5e94\u7684\u5b57\u7b26\u52a0\u8f7d\u5230 al \u4e2d\uff0c\u5e76\u81ea\u589e si) hlt (\u505c\u673a) \u5728\u4f20\u7edf\u7684 PC \u52a0\u8f7d\u65f6\uff0cBIOS \u4f1a\u52a0\u8f7d\u78c1\u76d8\u4e2d\u7684 MBR \u5757\uff0c\u5e76\u5728 16 \u4f4d\u5b9e\u6a21\u5f0f\u4e2d\u6267\u884c\u5176\u4e2d\u7684\u6307\u4ee4\u3002\u4e00\u4e2a\u7b80\u5355\u7684\u3001\u5411\u5c4f\u5e55\u8f93\u51fa\u4e00\u884c\u5b57\u7b26\u4e32\u7684 MBR \u7a0b\u5e8f\u5982\u4e0b\uff1a [ BITS 16 ] ; 16 bits program [ ORG 0x7C00 ] ; starts from 0x7c00, where MBR lies in memory mov si , OSH ; si points to string OSH print_str: lodsb ; load char to al cmp al , 0 ; is it the end of the string? je halt ; if true, then halt the system mov ah , 0x0e ; if false, then set AH = 0x0e int 0x10 ; call BIOS interrupt procedure, print a char to screen jmp print_str ; loop over to print all chars halt: hlt OSH db ` Hello , OSH 2020 Lab1 ! ` , 0 ; our string, null-terminated TIMES 510 - ( $ - $$ ) db 0 ; the size of MBR is 512 bytes, fill remaining bytes to 0 DW 0xAA55 ; magic number, mark it as a valid bootloader to BIOS \uff083/8 \u66f4\u65b0\uff1a\u6837\u4f8b\u7a0b\u5e8f\u6709\u5c0f\u5e45\u4fee\u6539\uff0c\u4fee\u590d\u4e86\u5728\u8f83\u8001\u7248\u672c\u7684 nasm \u4e2d\u65e0\u6cd5\u6c47\u7f16\u7684\u95ee\u9898\u3002\uff09 \u6b64\u6837\u4f8b\u7a0b\u5e8f\u9700\u8981\u4f7f\u7528 nasm \u6c47\u7f16\u3002 nasm example.asm \u4f1a\u751f\u6210 example \u6587\u4ef6\u3002\u8fd9\u4e2a\u6587\u4ef6\u53ef\u4ee5\u76f4\u63a5\u88ab qemu \u52a0\u8f7d\u3002 qemu-system-x86_64 -hda example \u4e3a\u4e86\u5b8c\u6210\u9644\u5c5e\u7684\u5b9e\u9a8c\u8981\u6c42\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u4f7f\u7528 8254 \u8ba1\u65f6\u5668\u3002\u7edd\u5927\u591a\u6570\u7684 BIOS \u90fd\u5c06\u6b64\u8ba1\u65f6\u5668\u503c\u6620\u5c04\u5230\u4e86\u5185\u5b58\u4e2d\u7684 0x046c \u4f4d\u7f6e\u3002\u8fd9\u4e2a\u503c\u4f1a\u6bcf\u79d2\u66f4\u65b0 18.2 \u6b21\u3002\u5982\u679c\u4f60\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a\u8ba1\u65f6\u5668\u7684\u8bdd\uff0c\u9700\u8981\u6253\u5f00\u4e2d\u65ad ( sti )\u3002 \u53c2\u8003\u8d44\u6599 \u00b6 x86 Assembly Guide NASM Tutorial","title":"\u4f7f\u7528\u6c47\u7f16\u8bed\u8a00\uff0c\u7f16\u5199 x86 \u88f8\u91d1\u5c5e (bare-metal) \u7a0b\u5e8f"},{"location":"lab-1/mbr/#x86-bare-metal","text":"\u8bf7\u5148\u9605\u8bfb\u3001\u641c\u7d22\u8d44\u6599\uff0c\u719f\u6089 x86 \u6c47\u7f16\u6307\u4ee4\u3002 \u4f60\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u7684 x86 \u6307\u4ee4\uff08\u4e0d\u9650\u5236\u4e8e\u6b64\uff09\uff1a mov (\u6570\u636e\u79fb\u52a8) int (\u547c\u53eb\u4e2d\u65ad\u5904\u7406) jmp (\u8df3\u8f6c) cmp (\u6bd4\u8f83\u64cd\u4f5c\u6570\uff0c\u4fee\u6539 flags\uff0c\u4ee5\u63d0\u4f9b\u7ed9\u6761\u4ef6\u8df3\u8f6c\u6307\u4ee4) je \u7b49\u4e00\u4e9b\u6761\u4ef6\u8df3\u8f6c\u6307\u4ee4 lodsb (\u5c06\u5bc4\u5b58\u5668 si \u6307\u5411\u7684\u5b57\u7b26\u4e32\u5bf9\u5e94\u7684\u5b57\u7b26\u52a0\u8f7d\u5230 al \u4e2d\uff0c\u5e76\u81ea\u589e si) hlt (\u505c\u673a) \u5728\u4f20\u7edf\u7684 PC \u52a0\u8f7d\u65f6\uff0cBIOS \u4f1a\u52a0\u8f7d\u78c1\u76d8\u4e2d\u7684 MBR \u5757\uff0c\u5e76\u5728 16 \u4f4d\u5b9e\u6a21\u5f0f\u4e2d\u6267\u884c\u5176\u4e2d\u7684\u6307\u4ee4\u3002\u4e00\u4e2a\u7b80\u5355\u7684\u3001\u5411\u5c4f\u5e55\u8f93\u51fa\u4e00\u884c\u5b57\u7b26\u4e32\u7684 MBR \u7a0b\u5e8f\u5982\u4e0b\uff1a [ BITS 16 ] ; 16 bits program [ ORG 0x7C00 ] ; starts from 0x7c00, where MBR lies in memory mov si , OSH ; si points to string OSH print_str: lodsb ; load char to al cmp al , 0 ; is it the end of the string? je halt ; if true, then halt the system mov ah , 0x0e ; if false, then set AH = 0x0e int 0x10 ; call BIOS interrupt procedure, print a char to screen jmp print_str ; loop over to print all chars halt: hlt OSH db ` Hello , OSH 2020 Lab1 ! ` , 0 ; our string, null-terminated TIMES 510 - ( $ - $$ ) db 0 ; the size of MBR is 512 bytes, fill remaining bytes to 0 DW 0xAA55 ; magic number, mark it as a valid bootloader to BIOS \uff083/8 \u66f4\u65b0\uff1a\u6837\u4f8b\u7a0b\u5e8f\u6709\u5c0f\u5e45\u4fee\u6539\uff0c\u4fee\u590d\u4e86\u5728\u8f83\u8001\u7248\u672c\u7684 nasm \u4e2d\u65e0\u6cd5\u6c47\u7f16\u7684\u95ee\u9898\u3002\uff09 \u6b64\u6837\u4f8b\u7a0b\u5e8f\u9700\u8981\u4f7f\u7528 nasm \u6c47\u7f16\u3002 nasm example.asm \u4f1a\u751f\u6210 example \u6587\u4ef6\u3002\u8fd9\u4e2a\u6587\u4ef6\u53ef\u4ee5\u76f4\u63a5\u88ab qemu \u52a0\u8f7d\u3002 qemu-system-x86_64 -hda example \u4e3a\u4e86\u5b8c\u6210\u9644\u5c5e\u7684\u5b9e\u9a8c\u8981\u6c42\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u4f7f\u7528 8254 \u8ba1\u65f6\u5668\u3002\u7edd\u5927\u591a\u6570\u7684 BIOS \u90fd\u5c06\u6b64\u8ba1\u65f6\u5668\u503c\u6620\u5c04\u5230\u4e86\u5185\u5b58\u4e2d\u7684 0x046c \u4f4d\u7f6e\u3002\u8fd9\u4e2a\u503c\u4f1a\u6bcf\u79d2\u66f4\u65b0 18.2 \u6b21\u3002\u5982\u679c\u4f60\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a\u8ba1\u65f6\u5668\u7684\u8bdd\uff0c\u9700\u8981\u6253\u5f00\u4e2d\u65ad ( sti )\u3002","title":"\u4f7f\u7528\u6c47\u7f16\u8bed\u8a00\uff0c\u7f16\u5199 x86 \u88f8\u91d1\u5c5e (bare-metal) \u7a0b\u5e8f"},{"location":"lab-1/mbr/#_1","text":"x86 Assembly Guide NASM Tutorial","title":"\u53c2\u8003\u8d44\u6599"},{"location":"lab-2/","text":"Lab 2 \u00b6 \u5728\u5b9e\u9a8c\u4e00\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u4e86\u5927\u91cf\u7684\u547d\u4ee4\u884c\u64cd\u4f5c\u6765\u5b8c\u6210\u4e00\u7cfb\u5217\u5de5\u4f5c\uff0c\u5982\u7f16\u8bd1 Linux \u5185\u6838\u3001\u6253\u5305 initrd\u3001\u8fd0\u884c QEMU \u7b49\u3002\u6240\u6709\u7684\u547d\u4ee4\u884c\u90fd\u7531\u4e00\u4e2a\u53eb\u505a\u5916\u58f3\uff08shell\uff09\u7684\u7a0b\u5e8f\u89e3\u91ca\u5e76\u6267\u884c\u3002\u672c\u5b9e\u9a8c\u6211\u4eec\u5c06\u81ea\u5df1\u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u7684 shell \u5e76\u7406\u89e3 Linux shell \u7a0b\u5e8f\u7684\u5de5\u4f5c\u539f\u7406\u3002 \u7f16\u5199 Shell \u7a0b\u5e8f \u00b6 \u9996\u5148\uff0c\u5927\u5bb6\u53ef\u4ee5\u5c06\u672c\u9875\u5e95\u90e8\u52a9\u6559\u7f16\u5199\u7684\u4e00\u4e2a\u793a\u4f8b\u7a0b\u5e8f\u547d\u540d\u4e3a shell.c \u5e76\u5c1d\u8bd5\u7f16\u8bd1\u8fd0\u884c\u5b83\uff1a gcc -o sh shell.c \u4ee5\u4e0a\u547d\u4ee4\u4f1a\u8c03\u7528 GCC \u7f16\u8bd1\u5668\u7f16\u8bd1\u51fa\u4e00\u4e2a\u540d\u4e3a sh \u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u4f60\u53ef\u4ee5\u7ee7\u7eed\u8f93\u5165 ./sh \u6765\u8fd0\u884c\u5b83\u3002 \u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u964b\u7684 shell\uff0c\u5b83\u4f1a\u63d0\u793a\u4f60\u8f93\u5165\u547d\u4ee4\uff0c\u4f60\u53ef\u4ee5\u8f93\u5165 cd \u6765\u5207\u6362\u5de5\u4f5c\u76ee\u5f55\uff0c\u8f93\u5165 pwd \u663e\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u8f93\u5165 export \u5bfc\u51fa\u73af\u5883\u53d8\u91cf\uff0c\u8f93\u5165 exit \u9000\u51fa\uff0c\u6216\u8005\u8c03\u7528\u7cfb\u7edf\u4e2d\u6709\u7684\u5176\u4ed6\u547d\u4ee4\u6765\u8fd0\u884c\uff0c\u4f8b\u5982 ls , cat \u7b49\u3002 \u4f60\u7684\u4efb\u52a1\u662f\u5bf9\u8fd9\u4e2a shell \u7a0b\u5e8f\u8fdb\u884c\u4fee\u6539\u5347\u7ea7\uff08\u5f53\u7136\uff0c\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u81ea\u5df1\u4ece\u5934\u7f16\u5199\u2014\u2014\u8fd9\u4e0d\u662f\u5f3a\u5236\u8981\u6c42\u7684\uff09\uff0c\u5e76\u5b8c\u6210\u4e0b\u9762\u7684\u4efb\u52a1\u3002 \u66f4\u5065\u58ee\uff08\u63a8\u8350\uff0c\u4f46\u4e0d\u8981\u6c42\uff09 \u00b6 \u76ee\u524d\u7684\u793a\u4f8b\u7a0b\u5e8f\u975e\u5e38\u8106\u5f31\uff0c\u65e0\u6cd5\u5904\u7406\u4e0d\u826f\u7684\u8f93\u5165\uff08\u5982 cd / \u53ef\u4ee5\u8fd0\u884c\uff0c\u4f46\u5c06\u4e2d\u95f4\u7684\u4e00\u4e2a\u7a7a\u683c\u6539\u6210\u4e24\u4e2a\u5c31\u4e0d\u884c\uff09\uff0c\u4e5f\u4e0d\u68c0\u67e5\u5404\u79cd\u53ef\u80fd\u7684\u9519\u8bef\uff08 chdir \u3001 fork \u3001 exec \u7b49\u7cfb\u7edf\u8c03\u7528\u90fd\u53ef\u80fd\u51fa\u9519\uff09\u3002\u5efa\u8bae\u4f60\u5c06\u5b83\u6539\u5f97\u66f4\u5065\u58ee\uff0c\u4ee5\u65b9\u4fbf\u4e4b\u540e\u7684\u8fdb\u4e00\u6b65\u5f00\u53d1\u548c\u8c03\u8bd5\u3002 \u652f\u6301\u7ba1\u9053 \u00b6 \u5f62\u5982 env | wc \u8fd9\u6837\u7684\u547d\u4ee4\u5229\u7528\u4e86\u300c\u7ba1\u9053\u300d\u8bed\u6cd5\uff0c\u5c06\u4e24\u6761\u4e0d\u540c\u7684\u547d\u4ee4\u5bf9\u63a5\u5728\u4e00\u8d77\u540c\u65f6\u8fd0\u884c\u3002 | \u7684\u610f\u601d\u662f\u5c06\u524d\u9762\u7684\u547d\u4ee4 env \uff08\u8f93\u51fa\u6240\u6709\u73af\u5883\u53d8\u91cf\uff09\u7684\u6807\u51c6\u8f93\u51fa\u8fde\u63a5\u5230\u540e\u9762\u547d\u4ee4 wc \uff08\u7edf\u8ba1\u884c\u6570\uff09\u7684\u6807\u51c6\u8f93\u5165\uff08\u8fd9\u6837\u5c31\u80fd\u7edf\u8ba1\u51fa\u73af\u5883\u53d8\u91cf\u7684\u603b\u6570\uff09\u3002\u8bf7\u4f60\u89c2\u5bdf\u5e76\u5b66\u4e60\u8fd9\u4e2a\u8bed\u6cd5\u7684\u6548\u679c\uff0c\u4e3a\u4f60\u7684 shell \u7a0b\u5e8f\u5b9e\u73b0\u8fd9\u4e00\u529f\u80fd\u3002 \u4f60\u53ef\u80fd\u8981\u7528\u5230\u7684\u51fd\u6570\uff1a pipe \u3001 close \u3001 dup \u3002\u4f60\u53ef\u4ee5\u8fd0\u884c man \u51fd\u6570\u540d \u6765\u67e5\u770b\u7cfb\u7edf\u81ea\u5e26\u7684\u6587\u6863\uff0c\u6216\u8005\u4e0a\u7f51\u641c\u7d22\u66f4\u591a\u4fe1\u606f\u3002 \u652f\u6301\u57fa\u672c\u7684\u6587\u4ef6\u91cd\u5b9a\u5411 \u00b6 \u5f62\u5982 ls > out.txt \u4f1a\u5c06 ls \u547d\u4ee4\u7684\u8f93\u51fa\u91cd\u5b9a\u5411\u5230 out.txt \u6587\u4ef6\u4e2d\uff0c\u5177\u4f53\u5730\u8bf4\uff0c\u4f1a\u5c06 out.txt \u5173\u8054\u5230\u7a0b\u5e8f\u7684\u6807\u51c6\u8f93\u51fa\uff0c\u7136\u540e\u518d\u8fd0\u884c\u76f8\u5e94\u7684\u547d\u4ee4\u3002 \u7c7b\u4f3c\u7684\uff0c ls >> out.txt \u4f1a\u5c06\u8f93\u51fa\u8ffd\u52a0\uff08\u800c\u4e0d\u662f\u8986\u76d6\uff09\u5230 out.txt \u6587\u4ef6\uff0c cat < in.txt \u4f1a\u5c06\u7a0b\u5e8f\u7684\u6807\u51c6\u8f93\u5165\u91cd\u5b9a\u5411\u5230\u6587\u4ef6 in.txt \u3002 \u8bf7\u4e3a\u4f60\u7684 shell \u7a0b\u5e8f\u5b9e\u73b0 > \u3001 >> \u548c < \u7684\u529f\u80fd\u3002 \u4f60\u53ef\u80fd\u8981\u7528\u5230\u7684\u51fd\u6570\uff1a open \u3001 close \u3001 dup \u3002 \u5904\u7406 Ctrl-C \u7684\u6309\u952e \u00b6 \u5728\u4f7f\u7528 shell \u7684\u65f6\u5019\u6309\u4e0b Ctrl-C \u53ef\u4ee5\u4e22\u5f03\u5f53\u524d\u8f93\u5165\u5230\u4e00\u534a\u7684\u547d\u4ee4\uff0c\u91cd\u65b0\u663e\u793a\u63d0\u793a\u7b26\u5e76\u63a5\u53d7\u65b0\u7684\u547d\u4ee4\u8f93\u5165\u3002\u5f53\u6709\u7a0b\u5e8f\u8fd0\u884c\u65f6\uff0c\u6309\u4e0b Ctrl-C \u53ef\u4ee5\u7ec8\u7ed3\u8fd0\u884c\u4e2d\u7684\u7a0b\u5e8f\uff0c\u7acb\u5373\u56de\u5230 shell \u5f00\u59cb\u65b0\u7684\u547d\u4ee4\u8f93\u5165\uff08shell \u6ca1\u6709\u968f\u7a0b\u5e8f\u4e00\u8d77\u7ed3\u675f\uff09\u3002 \u4f8b\u5982\uff08 ^C \u8868\u793a\u9047\u5230 Ctrl-C \u7684\u8f93\u5165\uff09\uff1a $ echo Hello Hello $ echo Hello^C $ sleep 9999 # \u51e0\u79d2\u4e4b\u540e ^C $ # sleep \u6ca1\u6709\u8fd0\u884c\u5b8c $ ^C $ sh # \u8fd9\u91cc\u65b0\u5f00\u4e86\u4e00\u4e2a\u5d4c\u5957\u7684 shell $ ^C $ exit $ exit \u8bf7\u4e3a\u4f60\u7684 shell \u5b9e\u73b0\u5bf9 Ctrl-C \u7684\u5904\u7406\u3002 \u63d0\u793a\uff1a\u5f53\u4f60\u6b63\u786e\u5904\u7406\u7b2c\u4e00\u79cd\u60c5\u51b5\u540e\uff08\u4e22\u5f03\u672a\u8f93\u5165\u5b8c\u7684\u547d\u4ee4\uff09\uff0c\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff08\u7ec8\u7ed3\u8fd0\u884c\u4e2d\u7684\u7a0b\u5e8f\uff09\u5e76\u4e0d\u9700\u8981\u4f60\u505a\u4efb\u4f55\u5de5\u4f5c\u3002 \u4f60\u53ef\u80fd\u8981\u7528\u5230\u7684\u51fd\u6570\uff1a signal \u3001 waitpid \u3002 \u652f\u6301 Bash \u98ce\u683c\u7684 TCP \u91cd\u5b9a\u5411\uff08\u9009\u505a\uff09 \u00b6 \u5728\u7cbe\u7b80\u7684 Linux \u73af\u5883\u4e2d\uff08\u5982 Docker \u5bb9\u5668\u91cc\uff09\uff0c\u5e38\u5e38\u662f\u6ca1\u6709 nc \u547d\u4ee4\u7528\u6765\u8fdb\u884c\u539f\u59cb\u7684 TCP \u7f51\u7edc\u901a\u4fe1\u7684\u3002Bash \u548c\u4e00\u4e9b\u5176\u4ed6 shell \u652f\u6301\u4e00\u79cd\u7279\u6b8a\u7684\u91cd\u5b9a\u5411\u8bed\u6cd5\uff1a /dev/tcp/<host>/<port> \u3002 \u901a\u8fc7\u67e5\u770b Bash \u7684 man \u6587\u6863 \uff0c REDIRECTION \u4e00\u8282\uff0c\u5f53\u91cd\u5b9a\u5411\u76ee\u6807\u662f\u4e0b\u9762\u51e0\u79cd\u8def\u5f84\uff0c\u4e14\u64cd\u4f5c\u7cfb\u7edf\u6ca1\u6709\u63d0\u4f9b\u8fd9\u4e2a\u8def\u5f84\u65f6\uff0cBash \u4f1a\u81ea\u884c\u5904\u7406\u5b83\u4eec\uff1a /dev/fd/<fd> /dev/stdin /dev/stdout /dev/stderr /dev/tcp/<host>/<port> /dev/udp/<host>/<port> \u9605\u8bfb\u76f8\u5173\u6587\u6863\uff0c\u6a21\u62df Bash \u7684\u884c\u4e3a\u5b9e\u73b0 cmd > /dev/tcp/<host>/<port> \u548c cmd < /dev/tcp/<host>/<port> \u7684\u91cd\u5b9a\u5411\u3002 \u65b9\u4fbf\u8d77\u89c1\uff0c\u4f60\u53ea\u9700\u8981\u5904\u7406 <host> \u662f\u5178\u578b\u7684 IPv4 \u5730\u5740\uff08\u5373 a.b.c.d \u7684\u5f62\u5f0f\uff0c\u5176\u4e2d abcd \u5747\u4e3a 0 ~ 255 \u4e4b\u95f4\u7684\u6574\u6570\uff09\u4e14 <port> \u4e3a 1 ~ 65535 \u4e4b\u95f4\u7684\u6574\u6570\u65f6\u7684\u60c5\u51b5\u3002 \u4f60\u53ef\u80fd\u8981\u7528\u5230\u7684\u51fd\u6570\uff1a socket , connect \u652f\u6301\u57fa\u4e8e\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6587\u4ef6\u91cd\u5b9a\u5411\u3001\u6587\u4ef6\u91cd\u5b9a\u5411\u7ec4\u5408\uff08\u9009\u505a\uff09 \u00b6 \u5f62\u5982 cmd 10> out.txt \u548c cmd 20< in.txt \u4ee5\u53ca cmd 10>&20 30< in.txt \u8fd9\u6837\u7684\u547d\u4ee4\u4f1a\u5c06\u6253\u5f00\u6587\u4ef6\u63cf\u8ff0\u7b26 10\u300120 \u548c 30 \u5e76\u91cd\u5b9a\u5411\u5230\u76f8\u5e94\u7684\u6587\u4ef6\u3002\u8bf7\u81ea\u884c\u67e5\u627e\u8d44\u6599\uff0c\u5b9e\u73b0\u8fd9\u4e9b\u6587\u4ef6\u91cd\u5b9a\u5411\u3002 cmd << EOF this output EOF \u4e0a\u8ff0\u547d\u4ee4\u4f1a\u5c06\u5b57\u7b26\u4e32 \"this\\noutput\\n\" \u4f5c\u4e3a\u6807\u51c6\u8f93\u5165\u91cd\u5b9a\u5411\u7ed9 cmd \u3002\u8bf7\u5b9e\u73b0\u8fd9\u79cd\u91cd\u5b9a\u5411\u65b9\u5f0f\u3002 cmd <<< text \u4f1a\u5c06 \"text\\n\" \u4f5c\u4e3a\u6807\u51c6\u8f93\u5165\u91cd\u5b9a\u5411\u7ed9 cmd \u3002\u8bf7\u5b9e\u73b0\u8fd9\u79cd\u91cd\u5b9a\u5411\u65b9\u5f0f\u3002 \u66f4\u591a\u529f\u80fd\uff08\u9009\u505a\uff09 \u00b6 \u6211\u4eec\u4e00\u822c\u4f7f\u7528\u7684 shell \u975e\u5e38\u5f3a\u5927\uff0c\u4f60\u8fd8\u53ef\u4ee5\u81ea\u884c\u4e86\u89e3\u4e0b\u9762\u8fd9\u4e9b\u8bed\u6cd5\u7684\u542b\u4e49\uff1a echo $PATH A = 1 env alias ll = 'ls -l' echo ~ echo ~root ( sleep 10 ; echo aha ) & if true ; then ls ; fi \u8bf7\u81ea\u884c\u9009\u62e9\u4e00\u4e2a\u6216\u591a\u4e2a\u529f\u80fd\u5e76\u5b9e\u73b0\u5b83\u4eec\u3002 \u4f7f\u7528 strace \u5de5\u5177\u8ffd\u8e2a\u7cfb\u7edf\u8c03\u7528 \u00b6 Linux \u7cfb\u7edf\u4e2d\u6709\u8bb8\u591a\u7528\u4e8e\u76d1\u63a7\u3001\u8ffd\u8e2a\u7cfb\u7edf\u72b6\u6001\u7684\u5de5\u5177\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 strace \u662f\u4e00\u4e2a\u7528\u4e8e\u76d1\u63a7\u8fdb\u7a0b\u7cfb\u7edf\u8c03\u7528\u7684\u7a0b\u5e8f\uff0c\u4f8b\u5982\uff0c\u5728 Debian \u7cfb\u7edf\u4e2d\u4f7f\u7528 strace \u8ffd\u8e2a true \u547d\u4ee4\uff08\u4e00\u4e2a\u4ec0\u4e48\u90fd\u4e0d\u505a\u5e76\u8fd4\u56de 0 \u7684\u547d\u4ee4\uff09\uff0c\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u8f93\u51fa\uff1a execve ( \"/usr/bin/true\" , [ \"true\" ], 0x7ffc07ef2ae0 /* 48 vars */ ) = 0 brk ( NULL ) = 0x55cc2c5dc000 arch_prctl ( 0x3001 /* ARCH_??? */ , 0x7fff1b8ec3e0 ) = - 1 EINVAL ( Invalid argument ) access ( \"/etc/ld.so.preload\" , R_OK ) = - 1 ENOENT ( No such file or directory ) openat ( AT_FDCWD , \"/etc/ld.so.cache\" , O_RDONLY | O_CLOEXEC ) = 3 fstat ( 3 , { st_mode = S_IFREG | 0644 , st_size = 113477 , ...}) = 0 mmap ( NULL , 113477 , PROT_READ , MAP_PRIVATE , 3 , 0 ) = 0x7fcc2e447000 close ( 3 ) = 0 openat ( AT_FDCWD , \"/lib/x86_64-linux-gnu/libc.so.6\" , O_RDONLY | O_CLOEXEC ) = 3 read ( 3 , \" \\177 ELF \\2\\1\\1\\3\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0 > \\0\\1\\0\\0\\0\\360 r \\2\\0\\0\\0\\0\\0 \" ..., 832 ) = 832 lseek ( 3 , 64 , SEEK_SET ) = 64 /* \u6b64\u5904\u7701\u7565\u591a\u884c */ exit_group ( 0 ) = ? +++ exited with 0 +++ \u8bf7\u4f7f\u7528 strace \u5de5\u5177\u8ffd\u8e2a\u4f60\u7f16\u5199\u7684 shell\uff0c\u627e\u51fa 3 \u4e2a\u4f60\u4ee3\u7801\u91cc\u6ca1\u6709\u51fa\u73b0\uff0c\u4f46\u51fa\u73b0\u5728 strace \u7684\u8f93\u51fa\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\uff08 open , read , write \u9664\u5916\uff09\u3002\u67e5\u9605\u8d44\u6599\uff0c \u7b80\u5355 \u8bf4\u8bf4\u5b83\u4eec\u7684\u529f\u80fd\u3002 \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u8bf7\u6309\u7167\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\u7ec4\u7ec7\u4f60\u7684 GitHub \u4ed3\u5e93\uff1a (Git) // Git \u4ed3\u5e93\u76ee\u5f55 \u251c\u2500\u2500 lab2 // \u5b9e\u9a8c\u4e8c\u6839\u76ee\u5f55 \u2502 \u251c\u2500\u2500 shell.c // \u4f60\u7684 Shell \u7684\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 other.c // \uff08\u53ef\u9009\uff09\u66f4\u591a\u4ee3\u7801\u6587\u4ef6 \u2502 \u251c\u2500\u2500 Makefile // \uff08\u53ef\u9009\uff09\u4f60\u63d0\u4f9b\u7684 Makefile \u2502 \u2514\u2500\u2500 README.md // \u5b9e\u9a8c\u62a5\u544a \u251c\u2500\u2500 .gitignore // \u8fd9\u4e24\u4e2a\u6587\u4ef6\u5728\u5b9e\u9a8c\u4e00\u7684\u6587\u6863\u91cc\u8bf4\u8fc7\u4e86 \u2514\u2500\u2500 README.md \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206 10 \u5206\u3002\u4f60\u9700\u8981\u5b8c\u6210\uff1a \u6309\u7167\u4e0a\u9762\u7684\u8981\u6c42\u7ec4\u7ec7\u4ed3\u5e93\u7ed3\u6784\uff0c\u63d0\u4ea4\u4f60\u7684 shell \u6e90\u4ee3\u7801 \u5982\u679c\u4f60\u63d0\u4ea4\u7684\u5185\u5bb9\u65e0\u6cd5\u6b63\u5e38\u7f16\u8bd1\uff0c\u6211\u4eec\u4f1a\u5c1d\u8bd5\u4fee\u590d\u5e76\u914c\u60c5\u6263\u9664\u4e00\u5b9a\u5206\u6570 \u5b9e\u9a8c\u4e00\u4e2d\u5bf9\u4e8e Git \u5de5\u5177\u7684\u4f7f\u7528\u8981\u6c42\u4ecd\u7136\u9002\u7528\u4e8e\u672c\u5b9e\u9a8c\uff0c\u5373\u5f53\u51fa\u73b0\u4ee5\u4e0b\u60c5\u51b5\u65f6\uff0c\u6211\u4eec\u4f1a\u914c\u60c5\u6263\u9664\u4e00\u5b9a\u5206\u6570 \u5f88\u5927\u4e00\u90e8\u5206\u7684 commit \u7531 GitHub \u7f51\u9875\u7248\u751f\u6210\uff0c\u5373\u901a\u8fc7\u7f51\u9875\u7248\u6587\u4ef6\u4e0a\u4f20\u7684\u65b9\u5f0f\u63d0\u4ea4\u5b9e\u9a8c\u7684\u6587\u4ef6 \u53ea\u6709\u5be5\u5be5\u65e0\u51e0\u7684 commit \u4e0a\u4f20\u4e86\u5927\u91cf\u4e0e\u5b9e\u9a8c\u8981\u6c42\u65e0\u5173\u7684\u6587\u4ef6\uff0c\u6ca1\u6709\u8bbe\u7f6e .gitignore \u4f60\u7684 shell \u80fd\u591f\u6b63\u786e\u5904\u7406\u542b\u6709 1 \u4e2a\u7ba1\u9053\u7684\u547d\u4ee4\uff0c\u5982 ls | grep hello \u4f60\u7684 shell \u80fd\u591f\u6b63\u786e\u5904\u7406\u542b\u6709\u591a\u4e2a\u7ba1\u9053\u7684\u547d\u4ee4\uff0c\u5982 ls | cat -n | grep hello \u4f60\u7684 shell \u652f\u6301 > , >> , < \u91cd\u5b9a\u5411 \u4f60\u7684 shell \u5728\u9047\u5230 Ctrl-C \u65f6\u80fd\u4e22\u5f03\u5df2\u7ecf\u8f93\u5165\u4e00\u534a\u7684\u547d\u4ee4\u884c\uff0c\u663e\u793a # \u63d0\u793a\u7b26\u5e76\u91cd\u65b0\u63a5\u53d7\u8f93\u5165 \u4ee5\u4e0a\u5fc5\u505a\u9879\u76ee\u5168\u90e8\u5b8c\u6210\u53ef\u4ee5\u83b7\u5f97 7 \u5206\u3002\u5bf9\u4e8e\u989d\u5916\u7684\u9009\u505a\u9879\u76ee\uff0c\u7531\u52a9\u6559\u8bc4\u4f30\u786e\u5b9a\u5206\u6570\uff0c\u6700\u9ad8 4 \u5206 \u5b8c\u6210 shell \u83b7\u5f97\u52a0\u5206\u540e\uff0c\u603b\u5206\u4e0d\u8d85\u8fc7 9 \u5206 \u6309\u7167\u300cstrace \u5de5\u5177\u300d\u4e00\u8282\u7684\u5b9e\u9a8c\u8981\u6c42\u6709\u6548\u5730\u63cf\u8ff0\u4e86 3 \u4e2a\u7cfb\u7edf\u8c03\u7528\uff081 \u5206\uff09 \u5173\u4e8e\u5b9e\u9a8c\u62a5\u544a \u00b6 \u5c3d\u7ba1\u672c\u5b9e\u9a8c\u9664\u4e86\u300cstrace \u5de5\u5177\u300d\u4e00\u8282\u4ee5\u5916\u5bf9\u5b9e\u9a8c\u62a5\u544a\u5e76\u65e0\u8981\u6c42\uff0c\u4f46\u662f\u6211\u4eec\u4ecd\u7136\u63a8\u8350\u4f60\u5728 README.md \u4e2d\u5199\u5c11\u91cf\u5185\u5bb9\uff0c\u4f8b\u5982 \u4f60\u7684 shell \u5b9e\u73b0\u53ef\u80fd\u4e0e\u7cfb\u7edf\u4e2d\u7684 sh \uff08\u6216\u52a9\u6559\u671f\u671b\u7684\u8868\u73b0\uff09\u6709\u6240\u4e0d\u540c\uff0c\u7b80\u8981\u4ecb\u7ecd\u8fd9\u4e9b\u6f5c\u5728\u7684\u533a\u522b\uff0c\u4ee5\u514d\u4ea7\u751f\u8bef\u4f1a\uff0c\u5bfc\u81f4\u4e0d\u5fc5\u8981\u7684\u6263\u5206\u3002 \u4f60\u5b8c\u6210\u4e86\u4e00\u4e9b\u9009\u505a\u9879\u76ee\uff0c\u4e5f\u53ef\u4ee5\u7b80\u5355\u4ecb\u7ecd\uff0c\u65b9\u4fbf\u52a9\u6559\u8fdb\u884c\u66f4\u51c6\u786e\u7684\u8bc4\u4f30 \u672c\u5b9e\u9a8c\u7684\u4e3b\u8981\u5185\u5bb9\u4e3a shell \u7a0b\u5e8f\u7684\u7f16\u5199\uff0c\u56e0\u6b64\u4e0d\u5fc5\u82b1\u8d39\u592a\u591a\u5de5\u592b\u5728\u5b9e\u9a8c\u62a5\u544a\u4e0a\u3002 \u5173\u4e8e\u9009\u505a\u9879\u76ee \u00b6 \u5982\u679c\u4f60\u6309\u7167\u672c\u6587\u6863\u8981\u6c42\u5b9e\u73b0\u4e86\u4e0a\u8ff0\u4e09\u4e2a\u529f\u80fd\uff0c\u4f60\u5c06\u83b7\u5f97\u81f3\u5c11 7 \u5206\u3002\u5982\u679c\u4f60\u60f3\u83b7\u5f97\u66f4\u9ad8\u7684\u5206\u6570\uff0c\u8bf7\u53c2\u8003\u6807\u8bb0\u4e3a\u300c\u9009\u505a\u300d\u7684\u51e0\u4e2a\u5c0f\u8282\u4e2d\u4ecb\u7ecd\u7684 Linux shell \u7684\u5e38\u89c1\u529f\u80fd\u5e76\u5b9e\u73b0\uff08\u4e0d\u9650\u5236\u4e3a\u672c\u6587\u6863\u5217\u51fa\u7684\u529f\u80fd\uff0c\u89c1\u4e0b\uff09\u3002 \u6bcf\u4e00\u9879\u989d\u5916\u529f\u80fd\u90fd\u4f1a\u7531\u52a9\u6559\u8ba8\u8bba\u8bc4\u4f30\uff0c\u4f46\u901a\u5e38\u5355\u4e2a\u9879\u76ee\u4e0d\u4f1a\u8d85\u8fc7 2 \u5206\u3002 \u6211\u4eec\u9f13\u52b1\u8fdb\u884c\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u76f8\u5173\u7684\u5b9e\u9a8c\u63a2\u7a76\uff0c\u56e0\u6b64\u8fc7\u5ea6\u8131\u79bb\u4e3b\u9898\u7684\u9879\u76ee\u53ef\u80fd\u4e0d\u4f1a\u83b7\u5f97\u52a0\u5206\uff0c\u4f8b\u5982\uff1a \u8fc7\u4e8e\u7b80\u5355\u7684\u5185\u7f6e\u547d\u4ee4\uff0c\u5982 : (colon), true , false , help \u7b49 \u4e25\u91cd\u504f\u79bb shell \u7684\u57fa\u672c\u529f\u80fd\u7684\u9879\u76ee\uff0c\u4f8b\u5982\u4f60 \u6a21\u4eff Zsh \u4e3a\u4f60\u7684 shell \u5185\u7f6e\u4e86\u4e00\u4e2a\u4fc4\u7f57\u65af\u65b9\u5757\u6e38\u620f \u4f5c\u4e3a\u4e00\u4e2a\u53c2\u8003\u57fa\u51c6\uff0cGNU Bash \u5177\u6709\u7684\u529f\u80fd\u5927\u90e8\u5206\u90fd\u4f1a\u88ab\u8ba4\u53ef\u3002 \u5176\u4ed6\u8bf4\u660e \u00b6 \u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 C, C++ \u6216 Rust \u8bed\u8a00\u5b8c\u6210\uff0c\u5982\u679c\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u8bed\u8a00\u8bf7\u5148\u8be2\u95ee\u52a9\u6559\u3002\uff08\u6ce8\uff1a\u4e0d\u63a8\u8350 Rust\uff0c\u539f\u56e0\u89c1 FAQ \uff09 \u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 libc, libstdc++, libm \u4ee5\u53ca iostream, STL \u7b49 C/C++ \u8bed\u8a00\u6807\u51c6\u548c\u5e38\u7528\u5e93\u3002\u5982\u679c\u4f60\u613f\u610f\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 readline \u548c ncurses \u7b49 Linux \u7a0b\u5e8f\u5e38\u7528\u5e93\u3002\u4f7f\u7528\u6b64\u5904\u6ca1\u6709\u5217\u51fa\u7684\u5e93\u524d\u8bf7\u8be2\u95ee\u52a9\u6559\u3002 \u5173\u4e8e Makefile \u7684\u89e3\u91ca \u00b6 Make \u662f\u4e00\u79cd\u81ea\u52a8\u5316\u590d\u6742\u9879\u76ee\u7f16\u8bd1\u8fc7\u7a0b\u7684\u5de5\u5177\uff0c\u4f60\u53ef\u4ee5\u81ea\u884c\u4e86\u89e3\u5b83\u7684\u7528\u6cd5\u3002 \u8fd9\u91cc \u6709\u4e00\u7bc7\u535a\u5ba2\uff08\u82f1\u6587\uff09\u7b80\u5355\u4ecb\u7ecd\u4e86\u4f7f\u7528 Make \u8fdb\u884c\u7f16\u8bd1\u81ea\u52a8\u5316\u7684\u597d\u5904\u4e0e\u65b9\u5f0f\u3002 \u672c\u5b9e\u9a8c\u4e2d\uff0c\u5982\u679c\u4f60\u63d0\u4f9b\u4e86 Makefile \u6587\u4ef6\uff0c\u6211\u4eec\u5c06\u4f7f\u7528\u5b83\u6765\u7f16\u8bd1\u4f60\u63d0\u4ea4\u7684\u7a0b\u5e8f\uff1b\u5426\u5219\uff0c\u6211\u4eec\u5c06\u7f16\u8bd1 lab2/ \u76ee\u5f55\u4e0b\u6240\u6709\u7684 *.c \u548c *.cpp \u6587\u4ef6\u3002\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5728 README.md \u4e2d\u8bf4\u660e\u7f16\u8bd1\u4e0e\u8fd0\u884c\u76f8\u5173\u7684\u6ce8\u610f\u4e8b\u9879\u3002 \u793a\u4f8b\u7a0b\u5e8f \u00b6 #include <stdio.h> #include <stdlib.h> #include <unistd.h> #include <string.h> #include <sys/wait.h> #include <sys/types.h> int main () { /* \u8f93\u5165\u7684\u547d\u4ee4\u884c */ char cmd [ 256 ]; /* \u547d\u4ee4\u884c\u62c6\u89e3\u6210\u7684\u5404\u90e8\u5206\uff0c\u4ee5\u7a7a\u6307\u9488\u7ed3\u5c3e */ char * args [ 128 ]; int i ; while ( 1 ) { /* \u63d0\u793a\u7b26 */ printf ( \"# \" ); fflush ( stdin ); fgets ( cmd , 256 , stdin ); /* \u6e05\u7406\u7ed3\u5c3e\u7684\u6362\u884c\u7b26 */ for ( i = 0 ; cmd [ i ] != '\\n' ; i ++ ); cmd [ i ] = '\\0' ; /* \u62c6\u89e3\u547d\u4ee4\u884c */ args [ 0 ] = cmd ; for ( i = 0 ; * args [ i ]; i ++ ) for ( args [ i + 1 ] = args [ i ] + 1 ; * args [ i + 1 ]; args [ i + 1 ] ++ ) if ( * args [ i + 1 ] == ' ' ) { * args [ i + 1 ] = '\\0' ; args [ i + 1 ] ++ ; break ; } args [ i ] = NULL ; /* \u6ca1\u6709\u8f93\u5165\u547d\u4ee4 */ if ( ! args [ 0 ]) continue ; /* \u5185\u5efa\u547d\u4ee4 */ if ( strcmp ( args [ 0 ], \"cd\" ) == 0 ) { if ( args [ 1 ]) chdir ( args [ 1 ]); continue ; } if ( strcmp ( args [ 0 ], \"pwd\" ) == 0 ) { char wd [ 4096 ]; puts ( getcwd ( wd , 4096 )); continue ; } if ( strcmp ( args [ 0 ], \"export\" ) == 0 ) { for ( i = 1 ; args [ i ] != NULL ; i ++ ) { /*\u5904\u7406\u6bcf\u4e2a\u53d8\u91cf*/ char * name = args [ i ]; char * value = args [ i ] + 1 ; while ( * value != '\\0' && * value != '=' ) value ++ ; * value = '\\0' ; value ++ ; setenv ( name , value , 1 ); } continue ; } if ( strcmp ( args [ 0 ], \"exit\" ) == 0 ) return 0 ; /* \u5916\u90e8\u547d\u4ee4 */ pid_t pid = fork (); if ( pid == 0 ) { /* \u5b50\u8fdb\u7a0b */ execvp ( args [ 0 ], args ); /* execvp\u5931\u8d25 */ return 255 ; } /* \u7236\u8fdb\u7a0b */ wait ( NULL ); } }","title":"\u5b9e\u9a8c\u4e8c"},{"location":"lab-2/#lab-2","text":"\u5728\u5b9e\u9a8c\u4e00\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u4e86\u5927\u91cf\u7684\u547d\u4ee4\u884c\u64cd\u4f5c\u6765\u5b8c\u6210\u4e00\u7cfb\u5217\u5de5\u4f5c\uff0c\u5982\u7f16\u8bd1 Linux \u5185\u6838\u3001\u6253\u5305 initrd\u3001\u8fd0\u884c QEMU \u7b49\u3002\u6240\u6709\u7684\u547d\u4ee4\u884c\u90fd\u7531\u4e00\u4e2a\u53eb\u505a\u5916\u58f3\uff08shell\uff09\u7684\u7a0b\u5e8f\u89e3\u91ca\u5e76\u6267\u884c\u3002\u672c\u5b9e\u9a8c\u6211\u4eec\u5c06\u81ea\u5df1\u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u7684 shell \u5e76\u7406\u89e3 Linux shell \u7a0b\u5e8f\u7684\u5de5\u4f5c\u539f\u7406\u3002","title":"Lab 2"},{"location":"lab-2/#shell","text":"\u9996\u5148\uff0c\u5927\u5bb6\u53ef\u4ee5\u5c06\u672c\u9875\u5e95\u90e8\u52a9\u6559\u7f16\u5199\u7684\u4e00\u4e2a\u793a\u4f8b\u7a0b\u5e8f\u547d\u540d\u4e3a shell.c \u5e76\u5c1d\u8bd5\u7f16\u8bd1\u8fd0\u884c\u5b83\uff1a gcc -o sh shell.c \u4ee5\u4e0a\u547d\u4ee4\u4f1a\u8c03\u7528 GCC \u7f16\u8bd1\u5668\u7f16\u8bd1\u51fa\u4e00\u4e2a\u540d\u4e3a sh \u7684\u53ef\u6267\u884c\u6587\u4ef6\uff0c\u4f60\u53ef\u4ee5\u7ee7\u7eed\u8f93\u5165 ./sh \u6765\u8fd0\u884c\u5b83\u3002 \u8fd9\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u964b\u7684 shell\uff0c\u5b83\u4f1a\u63d0\u793a\u4f60\u8f93\u5165\u547d\u4ee4\uff0c\u4f60\u53ef\u4ee5\u8f93\u5165 cd \u6765\u5207\u6362\u5de5\u4f5c\u76ee\u5f55\uff0c\u8f93\u5165 pwd \u663e\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u8f93\u5165 export \u5bfc\u51fa\u73af\u5883\u53d8\u91cf\uff0c\u8f93\u5165 exit \u9000\u51fa\uff0c\u6216\u8005\u8c03\u7528\u7cfb\u7edf\u4e2d\u6709\u7684\u5176\u4ed6\u547d\u4ee4\u6765\u8fd0\u884c\uff0c\u4f8b\u5982 ls , cat \u7b49\u3002 \u4f60\u7684\u4efb\u52a1\u662f\u5bf9\u8fd9\u4e2a shell \u7a0b\u5e8f\u8fdb\u884c\u4fee\u6539\u5347\u7ea7\uff08\u5f53\u7136\uff0c\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u81ea\u5df1\u4ece\u5934\u7f16\u5199\u2014\u2014\u8fd9\u4e0d\u662f\u5f3a\u5236\u8981\u6c42\u7684\uff09\uff0c\u5e76\u5b8c\u6210\u4e0b\u9762\u7684\u4efb\u52a1\u3002","title":"\u7f16\u5199 Shell \u7a0b\u5e8f"},{"location":"lab-2/#_1","text":"\u76ee\u524d\u7684\u793a\u4f8b\u7a0b\u5e8f\u975e\u5e38\u8106\u5f31\uff0c\u65e0\u6cd5\u5904\u7406\u4e0d\u826f\u7684\u8f93\u5165\uff08\u5982 cd / \u53ef\u4ee5\u8fd0\u884c\uff0c\u4f46\u5c06\u4e2d\u95f4\u7684\u4e00\u4e2a\u7a7a\u683c\u6539\u6210\u4e24\u4e2a\u5c31\u4e0d\u884c\uff09\uff0c\u4e5f\u4e0d\u68c0\u67e5\u5404\u79cd\u53ef\u80fd\u7684\u9519\u8bef\uff08 chdir \u3001 fork \u3001 exec \u7b49\u7cfb\u7edf\u8c03\u7528\u90fd\u53ef\u80fd\u51fa\u9519\uff09\u3002\u5efa\u8bae\u4f60\u5c06\u5b83\u6539\u5f97\u66f4\u5065\u58ee\uff0c\u4ee5\u65b9\u4fbf\u4e4b\u540e\u7684\u8fdb\u4e00\u6b65\u5f00\u53d1\u548c\u8c03\u8bd5\u3002","title":"\u66f4\u5065\u58ee\uff08\u63a8\u8350\uff0c\u4f46\u4e0d\u8981\u6c42\uff09"},{"location":"lab-2/#_2","text":"\u5f62\u5982 env | wc \u8fd9\u6837\u7684\u547d\u4ee4\u5229\u7528\u4e86\u300c\u7ba1\u9053\u300d\u8bed\u6cd5\uff0c\u5c06\u4e24\u6761\u4e0d\u540c\u7684\u547d\u4ee4\u5bf9\u63a5\u5728\u4e00\u8d77\u540c\u65f6\u8fd0\u884c\u3002 | \u7684\u610f\u601d\u662f\u5c06\u524d\u9762\u7684\u547d\u4ee4 env \uff08\u8f93\u51fa\u6240\u6709\u73af\u5883\u53d8\u91cf\uff09\u7684\u6807\u51c6\u8f93\u51fa\u8fde\u63a5\u5230\u540e\u9762\u547d\u4ee4 wc \uff08\u7edf\u8ba1\u884c\u6570\uff09\u7684\u6807\u51c6\u8f93\u5165\uff08\u8fd9\u6837\u5c31\u80fd\u7edf\u8ba1\u51fa\u73af\u5883\u53d8\u91cf\u7684\u603b\u6570\uff09\u3002\u8bf7\u4f60\u89c2\u5bdf\u5e76\u5b66\u4e60\u8fd9\u4e2a\u8bed\u6cd5\u7684\u6548\u679c\uff0c\u4e3a\u4f60\u7684 shell \u7a0b\u5e8f\u5b9e\u73b0\u8fd9\u4e00\u529f\u80fd\u3002 \u4f60\u53ef\u80fd\u8981\u7528\u5230\u7684\u51fd\u6570\uff1a pipe \u3001 close \u3001 dup \u3002\u4f60\u53ef\u4ee5\u8fd0\u884c man \u51fd\u6570\u540d \u6765\u67e5\u770b\u7cfb\u7edf\u81ea\u5e26\u7684\u6587\u6863\uff0c\u6216\u8005\u4e0a\u7f51\u641c\u7d22\u66f4\u591a\u4fe1\u606f\u3002","title":"\u652f\u6301\u7ba1\u9053"},{"location":"lab-2/#_3","text":"\u5f62\u5982 ls > out.txt \u4f1a\u5c06 ls \u547d\u4ee4\u7684\u8f93\u51fa\u91cd\u5b9a\u5411\u5230 out.txt \u6587\u4ef6\u4e2d\uff0c\u5177\u4f53\u5730\u8bf4\uff0c\u4f1a\u5c06 out.txt \u5173\u8054\u5230\u7a0b\u5e8f\u7684\u6807\u51c6\u8f93\u51fa\uff0c\u7136\u540e\u518d\u8fd0\u884c\u76f8\u5e94\u7684\u547d\u4ee4\u3002 \u7c7b\u4f3c\u7684\uff0c ls >> out.txt \u4f1a\u5c06\u8f93\u51fa\u8ffd\u52a0\uff08\u800c\u4e0d\u662f\u8986\u76d6\uff09\u5230 out.txt \u6587\u4ef6\uff0c cat < in.txt \u4f1a\u5c06\u7a0b\u5e8f\u7684\u6807\u51c6\u8f93\u5165\u91cd\u5b9a\u5411\u5230\u6587\u4ef6 in.txt \u3002 \u8bf7\u4e3a\u4f60\u7684 shell \u7a0b\u5e8f\u5b9e\u73b0 > \u3001 >> \u548c < \u7684\u529f\u80fd\u3002 \u4f60\u53ef\u80fd\u8981\u7528\u5230\u7684\u51fd\u6570\uff1a open \u3001 close \u3001 dup \u3002","title":"\u652f\u6301\u57fa\u672c\u7684\u6587\u4ef6\u91cd\u5b9a\u5411"},{"location":"lab-2/#ctrl-c","text":"\u5728\u4f7f\u7528 shell \u7684\u65f6\u5019\u6309\u4e0b Ctrl-C \u53ef\u4ee5\u4e22\u5f03\u5f53\u524d\u8f93\u5165\u5230\u4e00\u534a\u7684\u547d\u4ee4\uff0c\u91cd\u65b0\u663e\u793a\u63d0\u793a\u7b26\u5e76\u63a5\u53d7\u65b0\u7684\u547d\u4ee4\u8f93\u5165\u3002\u5f53\u6709\u7a0b\u5e8f\u8fd0\u884c\u65f6\uff0c\u6309\u4e0b Ctrl-C \u53ef\u4ee5\u7ec8\u7ed3\u8fd0\u884c\u4e2d\u7684\u7a0b\u5e8f\uff0c\u7acb\u5373\u56de\u5230 shell \u5f00\u59cb\u65b0\u7684\u547d\u4ee4\u8f93\u5165\uff08shell \u6ca1\u6709\u968f\u7a0b\u5e8f\u4e00\u8d77\u7ed3\u675f\uff09\u3002 \u4f8b\u5982\uff08 ^C \u8868\u793a\u9047\u5230 Ctrl-C \u7684\u8f93\u5165\uff09\uff1a $ echo Hello Hello $ echo Hello^C $ sleep 9999 # \u51e0\u79d2\u4e4b\u540e ^C $ # sleep \u6ca1\u6709\u8fd0\u884c\u5b8c $ ^C $ sh # \u8fd9\u91cc\u65b0\u5f00\u4e86\u4e00\u4e2a\u5d4c\u5957\u7684 shell $ ^C $ exit $ exit \u8bf7\u4e3a\u4f60\u7684 shell \u5b9e\u73b0\u5bf9 Ctrl-C \u7684\u5904\u7406\u3002 \u63d0\u793a\uff1a\u5f53\u4f60\u6b63\u786e\u5904\u7406\u7b2c\u4e00\u79cd\u60c5\u51b5\u540e\uff08\u4e22\u5f03\u672a\u8f93\u5165\u5b8c\u7684\u547d\u4ee4\uff09\uff0c\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff08\u7ec8\u7ed3\u8fd0\u884c\u4e2d\u7684\u7a0b\u5e8f\uff09\u5e76\u4e0d\u9700\u8981\u4f60\u505a\u4efb\u4f55\u5de5\u4f5c\u3002 \u4f60\u53ef\u80fd\u8981\u7528\u5230\u7684\u51fd\u6570\uff1a signal \u3001 waitpid \u3002","title":"\u5904\u7406 Ctrl-C \u7684\u6309\u952e"},{"location":"lab-2/#bash-tcp","text":"\u5728\u7cbe\u7b80\u7684 Linux \u73af\u5883\u4e2d\uff08\u5982 Docker \u5bb9\u5668\u91cc\uff09\uff0c\u5e38\u5e38\u662f\u6ca1\u6709 nc \u547d\u4ee4\u7528\u6765\u8fdb\u884c\u539f\u59cb\u7684 TCP \u7f51\u7edc\u901a\u4fe1\u7684\u3002Bash \u548c\u4e00\u4e9b\u5176\u4ed6 shell \u652f\u6301\u4e00\u79cd\u7279\u6b8a\u7684\u91cd\u5b9a\u5411\u8bed\u6cd5\uff1a /dev/tcp/<host>/<port> \u3002 \u901a\u8fc7\u67e5\u770b Bash \u7684 man \u6587\u6863 \uff0c REDIRECTION \u4e00\u8282\uff0c\u5f53\u91cd\u5b9a\u5411\u76ee\u6807\u662f\u4e0b\u9762\u51e0\u79cd\u8def\u5f84\uff0c\u4e14\u64cd\u4f5c\u7cfb\u7edf\u6ca1\u6709\u63d0\u4f9b\u8fd9\u4e2a\u8def\u5f84\u65f6\uff0cBash \u4f1a\u81ea\u884c\u5904\u7406\u5b83\u4eec\uff1a /dev/fd/<fd> /dev/stdin /dev/stdout /dev/stderr /dev/tcp/<host>/<port> /dev/udp/<host>/<port> \u9605\u8bfb\u76f8\u5173\u6587\u6863\uff0c\u6a21\u62df Bash \u7684\u884c\u4e3a\u5b9e\u73b0 cmd > /dev/tcp/<host>/<port> \u548c cmd < /dev/tcp/<host>/<port> \u7684\u91cd\u5b9a\u5411\u3002 \u65b9\u4fbf\u8d77\u89c1\uff0c\u4f60\u53ea\u9700\u8981\u5904\u7406 <host> \u662f\u5178\u578b\u7684 IPv4 \u5730\u5740\uff08\u5373 a.b.c.d \u7684\u5f62\u5f0f\uff0c\u5176\u4e2d abcd \u5747\u4e3a 0 ~ 255 \u4e4b\u95f4\u7684\u6574\u6570\uff09\u4e14 <port> \u4e3a 1 ~ 65535 \u4e4b\u95f4\u7684\u6574\u6570\u65f6\u7684\u60c5\u51b5\u3002 \u4f60\u53ef\u80fd\u8981\u7528\u5230\u7684\u51fd\u6570\uff1a socket , connect","title":"\u652f\u6301 Bash \u98ce\u683c\u7684 TCP \u91cd\u5b9a\u5411\uff08\u9009\u505a\uff09"},{"location":"lab-2/#_4","text":"\u5f62\u5982 cmd 10> out.txt \u548c cmd 20< in.txt \u4ee5\u53ca cmd 10>&20 30< in.txt \u8fd9\u6837\u7684\u547d\u4ee4\u4f1a\u5c06\u6253\u5f00\u6587\u4ef6\u63cf\u8ff0\u7b26 10\u300120 \u548c 30 \u5e76\u91cd\u5b9a\u5411\u5230\u76f8\u5e94\u7684\u6587\u4ef6\u3002\u8bf7\u81ea\u884c\u67e5\u627e\u8d44\u6599\uff0c\u5b9e\u73b0\u8fd9\u4e9b\u6587\u4ef6\u91cd\u5b9a\u5411\u3002 cmd << EOF this output EOF \u4e0a\u8ff0\u547d\u4ee4\u4f1a\u5c06\u5b57\u7b26\u4e32 \"this\\noutput\\n\" \u4f5c\u4e3a\u6807\u51c6\u8f93\u5165\u91cd\u5b9a\u5411\u7ed9 cmd \u3002\u8bf7\u5b9e\u73b0\u8fd9\u79cd\u91cd\u5b9a\u5411\u65b9\u5f0f\u3002 cmd <<< text \u4f1a\u5c06 \"text\\n\" \u4f5c\u4e3a\u6807\u51c6\u8f93\u5165\u91cd\u5b9a\u5411\u7ed9 cmd \u3002\u8bf7\u5b9e\u73b0\u8fd9\u79cd\u91cd\u5b9a\u5411\u65b9\u5f0f\u3002","title":"\u652f\u6301\u57fa\u4e8e\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u6587\u4ef6\u91cd\u5b9a\u5411\u3001\u6587\u4ef6\u91cd\u5b9a\u5411\u7ec4\u5408\uff08\u9009\u505a\uff09"},{"location":"lab-2/#_5","text":"\u6211\u4eec\u4e00\u822c\u4f7f\u7528\u7684 shell \u975e\u5e38\u5f3a\u5927\uff0c\u4f60\u8fd8\u53ef\u4ee5\u81ea\u884c\u4e86\u89e3\u4e0b\u9762\u8fd9\u4e9b\u8bed\u6cd5\u7684\u542b\u4e49\uff1a echo $PATH A = 1 env alias ll = 'ls -l' echo ~ echo ~root ( sleep 10 ; echo aha ) & if true ; then ls ; fi \u8bf7\u81ea\u884c\u9009\u62e9\u4e00\u4e2a\u6216\u591a\u4e2a\u529f\u80fd\u5e76\u5b9e\u73b0\u5b83\u4eec\u3002","title":"\u66f4\u591a\u529f\u80fd\uff08\u9009\u505a\uff09"},{"location":"lab-2/#strace","text":"Linux \u7cfb\u7edf\u4e2d\u6709\u8bb8\u591a\u7528\u4e8e\u76d1\u63a7\u3001\u8ffd\u8e2a\u7cfb\u7edf\u72b6\u6001\u7684\u5de5\u5177\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002 strace \u662f\u4e00\u4e2a\u7528\u4e8e\u76d1\u63a7\u8fdb\u7a0b\u7cfb\u7edf\u8c03\u7528\u7684\u7a0b\u5e8f\uff0c\u4f8b\u5982\uff0c\u5728 Debian \u7cfb\u7edf\u4e2d\u4f7f\u7528 strace \u8ffd\u8e2a true \u547d\u4ee4\uff08\u4e00\u4e2a\u4ec0\u4e48\u90fd\u4e0d\u505a\u5e76\u8fd4\u56de 0 \u7684\u547d\u4ee4\uff09\uff0c\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u4ee5\u4e0b\u8f93\u51fa\uff1a execve ( \"/usr/bin/true\" , [ \"true\" ], 0x7ffc07ef2ae0 /* 48 vars */ ) = 0 brk ( NULL ) = 0x55cc2c5dc000 arch_prctl ( 0x3001 /* ARCH_??? */ , 0x7fff1b8ec3e0 ) = - 1 EINVAL ( Invalid argument ) access ( \"/etc/ld.so.preload\" , R_OK ) = - 1 ENOENT ( No such file or directory ) openat ( AT_FDCWD , \"/etc/ld.so.cache\" , O_RDONLY | O_CLOEXEC ) = 3 fstat ( 3 , { st_mode = S_IFREG | 0644 , st_size = 113477 , ...}) = 0 mmap ( NULL , 113477 , PROT_READ , MAP_PRIVATE , 3 , 0 ) = 0x7fcc2e447000 close ( 3 ) = 0 openat ( AT_FDCWD , \"/lib/x86_64-linux-gnu/libc.so.6\" , O_RDONLY | O_CLOEXEC ) = 3 read ( 3 , \" \\177 ELF \\2\\1\\1\\3\\0\\0\\0\\0\\0\\0\\0\\0\\3\\0 > \\0\\1\\0\\0\\0\\360 r \\2\\0\\0\\0\\0\\0 \" ..., 832 ) = 832 lseek ( 3 , 64 , SEEK_SET ) = 64 /* \u6b64\u5904\u7701\u7565\u591a\u884c */ exit_group ( 0 ) = ? +++ exited with 0 +++ \u8bf7\u4f7f\u7528 strace \u5de5\u5177\u8ffd\u8e2a\u4f60\u7f16\u5199\u7684 shell\uff0c\u627e\u51fa 3 \u4e2a\u4f60\u4ee3\u7801\u91cc\u6ca1\u6709\u51fa\u73b0\uff0c\u4f46\u51fa\u73b0\u5728 strace \u7684\u8f93\u51fa\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\uff08 open , read , write \u9664\u5916\uff09\u3002\u67e5\u9605\u8d44\u6599\uff0c \u7b80\u5355 \u8bf4\u8bf4\u5b83\u4eec\u7684\u529f\u80fd\u3002","title":"\u4f7f\u7528 strace \u5de5\u5177\u8ffd\u8e2a\u7cfb\u7edf\u8c03\u7528"},{"location":"lab-2/#_6","text":"\u8bf7\u6309\u7167\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\u7ec4\u7ec7\u4f60\u7684 GitHub \u4ed3\u5e93\uff1a (Git) // Git \u4ed3\u5e93\u76ee\u5f55 \u251c\u2500\u2500 lab2 // \u5b9e\u9a8c\u4e8c\u6839\u76ee\u5f55 \u2502 \u251c\u2500\u2500 shell.c // \u4f60\u7684 Shell \u7684\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 other.c // \uff08\u53ef\u9009\uff09\u66f4\u591a\u4ee3\u7801\u6587\u4ef6 \u2502 \u251c\u2500\u2500 Makefile // \uff08\u53ef\u9009\uff09\u4f60\u63d0\u4f9b\u7684 Makefile \u2502 \u2514\u2500\u2500 README.md // \u5b9e\u9a8c\u62a5\u544a \u251c\u2500\u2500 .gitignore // \u8fd9\u4e24\u4e2a\u6587\u4ef6\u5728\u5b9e\u9a8c\u4e00\u7684\u6587\u6863\u91cc\u8bf4\u8fc7\u4e86 \u2514\u2500\u2500 README.md \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206 10 \u5206\u3002\u4f60\u9700\u8981\u5b8c\u6210\uff1a \u6309\u7167\u4e0a\u9762\u7684\u8981\u6c42\u7ec4\u7ec7\u4ed3\u5e93\u7ed3\u6784\uff0c\u63d0\u4ea4\u4f60\u7684 shell \u6e90\u4ee3\u7801 \u5982\u679c\u4f60\u63d0\u4ea4\u7684\u5185\u5bb9\u65e0\u6cd5\u6b63\u5e38\u7f16\u8bd1\uff0c\u6211\u4eec\u4f1a\u5c1d\u8bd5\u4fee\u590d\u5e76\u914c\u60c5\u6263\u9664\u4e00\u5b9a\u5206\u6570 \u5b9e\u9a8c\u4e00\u4e2d\u5bf9\u4e8e Git \u5de5\u5177\u7684\u4f7f\u7528\u8981\u6c42\u4ecd\u7136\u9002\u7528\u4e8e\u672c\u5b9e\u9a8c\uff0c\u5373\u5f53\u51fa\u73b0\u4ee5\u4e0b\u60c5\u51b5\u65f6\uff0c\u6211\u4eec\u4f1a\u914c\u60c5\u6263\u9664\u4e00\u5b9a\u5206\u6570 \u5f88\u5927\u4e00\u90e8\u5206\u7684 commit \u7531 GitHub \u7f51\u9875\u7248\u751f\u6210\uff0c\u5373\u901a\u8fc7\u7f51\u9875\u7248\u6587\u4ef6\u4e0a\u4f20\u7684\u65b9\u5f0f\u63d0\u4ea4\u5b9e\u9a8c\u7684\u6587\u4ef6 \u53ea\u6709\u5be5\u5be5\u65e0\u51e0\u7684 commit \u4e0a\u4f20\u4e86\u5927\u91cf\u4e0e\u5b9e\u9a8c\u8981\u6c42\u65e0\u5173\u7684\u6587\u4ef6\uff0c\u6ca1\u6709\u8bbe\u7f6e .gitignore \u4f60\u7684 shell \u80fd\u591f\u6b63\u786e\u5904\u7406\u542b\u6709 1 \u4e2a\u7ba1\u9053\u7684\u547d\u4ee4\uff0c\u5982 ls | grep hello \u4f60\u7684 shell \u80fd\u591f\u6b63\u786e\u5904\u7406\u542b\u6709\u591a\u4e2a\u7ba1\u9053\u7684\u547d\u4ee4\uff0c\u5982 ls | cat -n | grep hello \u4f60\u7684 shell \u652f\u6301 > , >> , < \u91cd\u5b9a\u5411 \u4f60\u7684 shell \u5728\u9047\u5230 Ctrl-C \u65f6\u80fd\u4e22\u5f03\u5df2\u7ecf\u8f93\u5165\u4e00\u534a\u7684\u547d\u4ee4\u884c\uff0c\u663e\u793a # \u63d0\u793a\u7b26\u5e76\u91cd\u65b0\u63a5\u53d7\u8f93\u5165 \u4ee5\u4e0a\u5fc5\u505a\u9879\u76ee\u5168\u90e8\u5b8c\u6210\u53ef\u4ee5\u83b7\u5f97 7 \u5206\u3002\u5bf9\u4e8e\u989d\u5916\u7684\u9009\u505a\u9879\u76ee\uff0c\u7531\u52a9\u6559\u8bc4\u4f30\u786e\u5b9a\u5206\u6570\uff0c\u6700\u9ad8 4 \u5206 \u5b8c\u6210 shell \u83b7\u5f97\u52a0\u5206\u540e\uff0c\u603b\u5206\u4e0d\u8d85\u8fc7 9 \u5206 \u6309\u7167\u300cstrace \u5de5\u5177\u300d\u4e00\u8282\u7684\u5b9e\u9a8c\u8981\u6c42\u6709\u6548\u5730\u63cf\u8ff0\u4e86 3 \u4e2a\u7cfb\u7edf\u8c03\u7528\uff081 \u5206\uff09","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab-2/#_7","text":"\u5c3d\u7ba1\u672c\u5b9e\u9a8c\u9664\u4e86\u300cstrace \u5de5\u5177\u300d\u4e00\u8282\u4ee5\u5916\u5bf9\u5b9e\u9a8c\u62a5\u544a\u5e76\u65e0\u8981\u6c42\uff0c\u4f46\u662f\u6211\u4eec\u4ecd\u7136\u63a8\u8350\u4f60\u5728 README.md \u4e2d\u5199\u5c11\u91cf\u5185\u5bb9\uff0c\u4f8b\u5982 \u4f60\u7684 shell \u5b9e\u73b0\u53ef\u80fd\u4e0e\u7cfb\u7edf\u4e2d\u7684 sh \uff08\u6216\u52a9\u6559\u671f\u671b\u7684\u8868\u73b0\uff09\u6709\u6240\u4e0d\u540c\uff0c\u7b80\u8981\u4ecb\u7ecd\u8fd9\u4e9b\u6f5c\u5728\u7684\u533a\u522b\uff0c\u4ee5\u514d\u4ea7\u751f\u8bef\u4f1a\uff0c\u5bfc\u81f4\u4e0d\u5fc5\u8981\u7684\u6263\u5206\u3002 \u4f60\u5b8c\u6210\u4e86\u4e00\u4e9b\u9009\u505a\u9879\u76ee\uff0c\u4e5f\u53ef\u4ee5\u7b80\u5355\u4ecb\u7ecd\uff0c\u65b9\u4fbf\u52a9\u6559\u8fdb\u884c\u66f4\u51c6\u786e\u7684\u8bc4\u4f30 \u672c\u5b9e\u9a8c\u7684\u4e3b\u8981\u5185\u5bb9\u4e3a shell \u7a0b\u5e8f\u7684\u7f16\u5199\uff0c\u56e0\u6b64\u4e0d\u5fc5\u82b1\u8d39\u592a\u591a\u5de5\u592b\u5728\u5b9e\u9a8c\u62a5\u544a\u4e0a\u3002","title":"\u5173\u4e8e\u5b9e\u9a8c\u62a5\u544a"},{"location":"lab-2/#_8","text":"\u5982\u679c\u4f60\u6309\u7167\u672c\u6587\u6863\u8981\u6c42\u5b9e\u73b0\u4e86\u4e0a\u8ff0\u4e09\u4e2a\u529f\u80fd\uff0c\u4f60\u5c06\u83b7\u5f97\u81f3\u5c11 7 \u5206\u3002\u5982\u679c\u4f60\u60f3\u83b7\u5f97\u66f4\u9ad8\u7684\u5206\u6570\uff0c\u8bf7\u53c2\u8003\u6807\u8bb0\u4e3a\u300c\u9009\u505a\u300d\u7684\u51e0\u4e2a\u5c0f\u8282\u4e2d\u4ecb\u7ecd\u7684 Linux shell \u7684\u5e38\u89c1\u529f\u80fd\u5e76\u5b9e\u73b0\uff08\u4e0d\u9650\u5236\u4e3a\u672c\u6587\u6863\u5217\u51fa\u7684\u529f\u80fd\uff0c\u89c1\u4e0b\uff09\u3002 \u6bcf\u4e00\u9879\u989d\u5916\u529f\u80fd\u90fd\u4f1a\u7531\u52a9\u6559\u8ba8\u8bba\u8bc4\u4f30\uff0c\u4f46\u901a\u5e38\u5355\u4e2a\u9879\u76ee\u4e0d\u4f1a\u8d85\u8fc7 2 \u5206\u3002 \u6211\u4eec\u9f13\u52b1\u8fdb\u884c\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u76f8\u5173\u7684\u5b9e\u9a8c\u63a2\u7a76\uff0c\u56e0\u6b64\u8fc7\u5ea6\u8131\u79bb\u4e3b\u9898\u7684\u9879\u76ee\u53ef\u80fd\u4e0d\u4f1a\u83b7\u5f97\u52a0\u5206\uff0c\u4f8b\u5982\uff1a \u8fc7\u4e8e\u7b80\u5355\u7684\u5185\u7f6e\u547d\u4ee4\uff0c\u5982 : (colon), true , false , help \u7b49 \u4e25\u91cd\u504f\u79bb shell \u7684\u57fa\u672c\u529f\u80fd\u7684\u9879\u76ee\uff0c\u4f8b\u5982\u4f60 \u6a21\u4eff Zsh \u4e3a\u4f60\u7684 shell \u5185\u7f6e\u4e86\u4e00\u4e2a\u4fc4\u7f57\u65af\u65b9\u5757\u6e38\u620f \u4f5c\u4e3a\u4e00\u4e2a\u53c2\u8003\u57fa\u51c6\uff0cGNU Bash \u5177\u6709\u7684\u529f\u80fd\u5927\u90e8\u5206\u90fd\u4f1a\u88ab\u8ba4\u53ef\u3002","title":"\u5173\u4e8e\u9009\u505a\u9879\u76ee"},{"location":"lab-2/#_9","text":"\u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 C, C++ \u6216 Rust \u8bed\u8a00\u5b8c\u6210\uff0c\u5982\u679c\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u8bed\u8a00\u8bf7\u5148\u8be2\u95ee\u52a9\u6559\u3002\uff08\u6ce8\uff1a\u4e0d\u63a8\u8350 Rust\uff0c\u539f\u56e0\u89c1 FAQ \uff09 \u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 libc, libstdc++, libm \u4ee5\u53ca iostream, STL \u7b49 C/C++ \u8bed\u8a00\u6807\u51c6\u548c\u5e38\u7528\u5e93\u3002\u5982\u679c\u4f60\u613f\u610f\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 readline \u548c ncurses \u7b49 Linux \u7a0b\u5e8f\u5e38\u7528\u5e93\u3002\u4f7f\u7528\u6b64\u5904\u6ca1\u6709\u5217\u51fa\u7684\u5e93\u524d\u8bf7\u8be2\u95ee\u52a9\u6559\u3002","title":"\u5176\u4ed6\u8bf4\u660e"},{"location":"lab-2/#makefile","text":"Make \u662f\u4e00\u79cd\u81ea\u52a8\u5316\u590d\u6742\u9879\u76ee\u7f16\u8bd1\u8fc7\u7a0b\u7684\u5de5\u5177\uff0c\u4f60\u53ef\u4ee5\u81ea\u884c\u4e86\u89e3\u5b83\u7684\u7528\u6cd5\u3002 \u8fd9\u91cc \u6709\u4e00\u7bc7\u535a\u5ba2\uff08\u82f1\u6587\uff09\u7b80\u5355\u4ecb\u7ecd\u4e86\u4f7f\u7528 Make \u8fdb\u884c\u7f16\u8bd1\u81ea\u52a8\u5316\u7684\u597d\u5904\u4e0e\u65b9\u5f0f\u3002 \u672c\u5b9e\u9a8c\u4e2d\uff0c\u5982\u679c\u4f60\u63d0\u4f9b\u4e86 Makefile \u6587\u4ef6\uff0c\u6211\u4eec\u5c06\u4f7f\u7528\u5b83\u6765\u7f16\u8bd1\u4f60\u63d0\u4ea4\u7684\u7a0b\u5e8f\uff1b\u5426\u5219\uff0c\u6211\u4eec\u5c06\u7f16\u8bd1 lab2/ \u76ee\u5f55\u4e0b\u6240\u6709\u7684 *.c \u548c *.cpp \u6587\u4ef6\u3002\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5728 README.md \u4e2d\u8bf4\u660e\u7f16\u8bd1\u4e0e\u8fd0\u884c\u76f8\u5173\u7684\u6ce8\u610f\u4e8b\u9879\u3002","title":"\u5173\u4e8e Makefile \u7684\u89e3\u91ca"},{"location":"lab-2/#_10","text":"#include <stdio.h> #include <stdlib.h> #include <unistd.h> #include <string.h> #include <sys/wait.h> #include <sys/types.h> int main () { /* \u8f93\u5165\u7684\u547d\u4ee4\u884c */ char cmd [ 256 ]; /* \u547d\u4ee4\u884c\u62c6\u89e3\u6210\u7684\u5404\u90e8\u5206\uff0c\u4ee5\u7a7a\u6307\u9488\u7ed3\u5c3e */ char * args [ 128 ]; int i ; while ( 1 ) { /* \u63d0\u793a\u7b26 */ printf ( \"# \" ); fflush ( stdin ); fgets ( cmd , 256 , stdin ); /* \u6e05\u7406\u7ed3\u5c3e\u7684\u6362\u884c\u7b26 */ for ( i = 0 ; cmd [ i ] != '\\n' ; i ++ ); cmd [ i ] = '\\0' ; /* \u62c6\u89e3\u547d\u4ee4\u884c */ args [ 0 ] = cmd ; for ( i = 0 ; * args [ i ]; i ++ ) for ( args [ i + 1 ] = args [ i ] + 1 ; * args [ i + 1 ]; args [ i + 1 ] ++ ) if ( * args [ i + 1 ] == ' ' ) { * args [ i + 1 ] = '\\0' ; args [ i + 1 ] ++ ; break ; } args [ i ] = NULL ; /* \u6ca1\u6709\u8f93\u5165\u547d\u4ee4 */ if ( ! args [ 0 ]) continue ; /* \u5185\u5efa\u547d\u4ee4 */ if ( strcmp ( args [ 0 ], \"cd\" ) == 0 ) { if ( args [ 1 ]) chdir ( args [ 1 ]); continue ; } if ( strcmp ( args [ 0 ], \"pwd\" ) == 0 ) { char wd [ 4096 ]; puts ( getcwd ( wd , 4096 )); continue ; } if ( strcmp ( args [ 0 ], \"export\" ) == 0 ) { for ( i = 1 ; args [ i ] != NULL ; i ++ ) { /*\u5904\u7406\u6bcf\u4e2a\u53d8\u91cf*/ char * name = args [ i ]; char * value = args [ i ] + 1 ; while ( * value != '\\0' && * value != '=' ) value ++ ; * value = '\\0' ; value ++ ; setenv ( name , value , 1 ); } continue ; } if ( strcmp ( args [ 0 ], \"exit\" ) == 0 ) return 0 ; /* \u5916\u90e8\u547d\u4ee4 */ pid_t pid = fork (); if ( pid == 0 ) { /* \u5b50\u8fdb\u7a0b */ execvp ( args [ 0 ], args ); /* execvp\u5931\u8d25 */ return 255 ; } /* \u7236\u8fdb\u7a0b */ wait ( NULL ); } }","title":"\u793a\u4f8b\u7a0b\u5e8f"},{"location":"lab-3/","text":"Lab 3 \u00b6 \u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u7b80\u5355\u7684 socket \u7f16\u7a0b\uff0c\u5206\u522b\u5229\u7528\u591a\u7ebf\u7a0b\u6280\u672f\u548c IO \u590d\u7528\u6280\u672f\u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u7684\u591a\u4eba\u804a\u5929\u5ba4\u7a0b\u5e8f\u3002 \u9996\u5148\u7ed9\u51fa\u4e00\u4e2a\u7b80\u5355\u7684\u53cc\u4eba\u804a\u5929\u5ba4\u793a\u4f8b\u7a0b\u5e8f\uff1a #include <stdio.h> #include <string.h> #include <stdlib.h> #include <unistd.h> #include <sys/socket.h> #include <netinet/in.h> #include <pthread.h> struct Pipe { int fd_send ; int fd_recv ; }; void * handle_chat ( void * data ) { struct Pipe * pipe = ( struct Pipe * ) data ; char buffer [ 1024 ] = \"Message:\" ; ssize_t len ; while (( len = recv ( pipe -> fd_send , buffer + 8 , 1000 , 0 )) > 0 ) { send ( pipe -> fd_recv , buffer , len + 8 , 0 ); } return NULL ; } int main ( int argc , char ** argv ) { int port = atoi ( argv [ 1 ]); int fd ; if (( fd = socket ( AF_INET , SOCK_STREAM , 0 )) == 0 ) { perror ( \"socket\" ); return 1 ; } struct sockaddr_in addr ; addr . sin_family = AF_INET ; addr . sin_addr . s_addr = INADDR_ANY ; addr . sin_port = htons ( port ); socklen_t addr_len = sizeof ( addr ); if ( bind ( fd , ( struct sockaddr * ) & addr , sizeof ( addr ))) { perror ( \"bind\" ); return 1 ; } if ( listen ( fd , 2 )) { perror ( \"listen\" ); return 1 ; } int fd1 = accept ( fd , NULL , NULL ); int fd2 = accept ( fd , NULL , NULL ); if ( fd1 == - 1 || fd2 == - 1 ) { perror ( \"accept\" ); return 1 ; } pthread_t thread1 , thread2 ; struct Pipe pipe1 ; struct Pipe pipe2 ; pipe1 . fd_send = fd1 ; pipe1 . fd_recv = fd2 ; pipe2 . fd_send = fd2 ; pipe2 . fd_recv = fd1 ; pthread_create ( & thread1 , NULL , handle_chat , ( void * ) & pipe1 ); pthread_create ( & thread2 , NULL , handle_chat , ( void * ) & pipe2 ); pthread_join ( thread1 , NULL ); pthread_join ( thread2 , NULL ); return 0 ; } \u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u7f16\u8bd1\u5e76\u8fd0\u884c\uff1a gcc 1 .c -o 1 -lpthread ./1 6666 \u63a5\u7740\u4e24\u4e2a\u7ec8\u7aef\u4e2d\u5206\u522b\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fde\u63a5\uff1a nc 127 .0.0.1 6666 \u8fd9\u6837\u4ece\u4e00\u4e2a\u7ec8\u7aef\u8f93\u5165\u7684\u6d88\u606f\uff0c\u4f1a\u8f6c\u53d1\u5230\u53e6\u4e00\u4e2a\u7ec8\u7aef\uff0c\u4e8e\u662f\u4fbf\u5b9e\u73b0\u4e86\u4e24\u4e2a\u5ba2\u6237\u7aef\u95f4\u7684\u804a\u5929\u3002\u8fd9\u4e2a\u804a\u5929\u5ba4\u7a0b\u5e8f\u5341\u5206\u7b80\u964b\uff0c\u5ffd\u7565\u4e86 socket \u7f16\u7a0b\u4e2d\u7684\u5f88\u591a\u7ec6\u8282\uff0c\u4f60\u7684\u4efb\u52a1\u5c31\u662f\u4fee\u6539\u5b83\uff08\u6216\u8005\u4ece\u5934\u7f16\u5199\uff09\uff0c\u4f7f\u5f97\u5b83\u66f4\u5065\u58ee\uff0c\u5e76\u4e14\u652f\u6301\u591a\u4eba\u804a\u5929\u3002 \u5b8c\u5584\u53cc\u4eba\u804a\u5929\u5ba4 \u00b6 \u5b9e\u73b0\u4ee5\u6362\u884c\u4e3a\u5206\u9694\u7b26\u7684\u6d88\u606f\u5206\u5272 \u00b6 TCP \u662f\u4e00\u4e2a\u57fa\u4e8e\u6d41\u7684\u534f\u8bae\uff0c\u672c\u8eab\u6ca1\u6709\u201c\u6d88\u606f\u201d\u7684\u6982\u5ff5\u3002\u5728\u6574\u4e2a\u8fde\u63a5\u4e2d\uff0c\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u6570\u636e\u53ea\u662f\u4e00\u8fde\u4e32\u7684\u5b57\u8282\uff0c\u670d\u52a1\u7aef\u5e76\u4e0d\u80fd\u77e5\u9053\u8fd9\u4e9b\u6570\u636e\u662f\u4ee5\u600e\u6837\u7684\u65b9\u5f0f\u5206\u5272\u7684\uff08\u4e00\u6b21 send \u5e76\u4e0d\u4e00\u5b9a\u5bf9\u5e94\u5bf9\u65b9\u7684\u4e00\u6b21 recv \uff09\u3002\u793a\u4f8b\u7a0b\u5e8f\u5c06\u4e00\u6b21 recv \u5f97\u5230\u7684\u6570\u636e\u89c6\u4e3a\u4e00\u4e2a\u6d88\u606f\uff0c\u662f\u4e0d\u5408\u9002\u7684\u3002\u8bf7\u91cd\u65b0\u5b9e\u73b0\u63a5\u6536\u6570\u636e\u7684\u90e8\u5206\uff0c\u4f7f\u5f97\u4ee5\u6362\u884c\u7b26 \\n \u4e3a\u5206\u9694\u7b26\u63a5\u6536\u548c\u5206\u5272\u6570\u636e\uff0c\u5e76\u4ee5\u4e00\u6761\u6d88\u606f\u4e3a\u5355\u4f4d\u53d1\u9001\u7ed9\u53e6\u4e00\u4e2a\u5ba2\u6237\u7aef\u3002\u5728\u52a9\u6559\u7684\u6d4b\u8bd5\u4e2d\u6d88\u606f\u7684\u957f\u5ea6\u4e0d\u8d85\u8fc7 1 MiB\uff081,048,576 \u5b57\u8282\uff09\u3002 \u5904\u7406\u53ef\u80fd\u7684 send \u963b\u585e \u00b6 \u5f53\u53d1\u9001\u7684\u6570\u636e\u957f\u5ea6\u8db3\u591f\u5927\u65f6\uff0c\u53ef\u80fd\u4f1a\u5f15\u8d77 send \u7684\u963b\u585e\uff0c\u8fd9\u65f6\u53ea\u6709\u90e8\u5206\u6570\u636e\u88ab\u6210\u529f\u53d1\u9001\u3002\u8bf7\u5904\u7406\u8fd9\u79cd\u60c5\u51b5\uff0c\u4f7f\u5f97\u6240\u6709\u6570\u636e\u90fd\u80fd\u4fdd\u8bc1\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u3002 \u5229\u7528\u591a\u7ebf\u7a0b\u6280\u672f\u5b9e\u73b0\u591a\u4eba\u804a\u5929\u5ba4 \u00b6 \u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u5b9e\u73b0\u4e00\u4e2a\u652f\u6301\u591a\u4eba\u5728\u7ebf\u7684\u804a\u5929\u5ba4\uff0c\u5177\u4f53\u8981\u6c42\u5982\u4e0b\uff1a \u6700\u591a\u652f\u6301 32 \u4e2a\u7528\u6237\u540c\u65f6\u5728\u7ebf\uff0c\u7528\u6237\u53ef\u4ee5\u968f\u65f6\u52a0\u5165\u4e0e\u9000\u51fa \u7a0b\u5e8f\u5c06\u7528\u6237\u53d1\u51fa\u7684\u6570\u636e\u4ee5\u6362\u884c\u7b26\u5206\u5272\u4e3a\u6d88\u606f\uff0c\u5e76\u5c06\u6d88\u606f\u5b8c\u6574\u5730\u53d1\u9001\u7ed9\u5176\u4ed6\u7528\u6237 \u4f60\u9700\u8981\u4f7f\u7528\u963b\u585e IO \u4e0e\u591a\u7ebf\u7a0b\u6280\u672f\u6765\u5b9e\u73b0\u4e0a\u8ff0\u9700\u6c42\u3002\u53ef\u4ee5\u4f7f\u7528\u7684\u7ebf\u7a0b\u5e93\u6709 pthread, Windows API \u6216 std::thread \u3002\u9664\u4e86\u6807\u51c6\u5e93\u4e0e\u4e0a\u8ff0\u5e93\uff0c\u8bf7\u52ff\u4f7f\u7528\u5176\u4ed6\u5e93\u3002\u5728\u6d4b\u8bd5\u4e2d\u6d88\u606f\u7684\u957f\u5ea6\u4e0d\u8d85\u8fc7 1 MiB\u3002 \u8bf7\u6ce8\u610f\uff0csocket \u662f\u5168\u53cc\u5de5\u7684\uff0c\u5373\u53ef\u4ee5\u7531\u4e24\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5206\u522b\u8bfb\u53d6\u4e0e\u5199\u5165\u3002\u4f46\u5e76\u53d1\u5730\u8bfb\u53d6\u6216\u5e76\u53d1\u5730\u5199\u5165\u53ef\u80fd\u4f1a\u9020\u6210\u610f\u60f3\u4e0d\u5230\u7684\u540e\u679c\u3002\u8bf7\u5229\u7528\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u4e2d\u7ebf\u7a0b\u540c\u6b65\u7684\u76f8\u5173\u77e5\u8bc6\u5b9e\u73b0\u5bf9 socket \u7684\u5b89\u5168\u64cd\u4f5c\u3002 pthread \u00b6 \u5982\u679c\u4f60\u5728\u7c7b Unix \u7cfb\u7edf\u4e0b\u7f16\u7a0b\uff0c\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528 pthread \u7ebf\u7a0b\u5e93\uff0c\u8fd9\u91cc\u5c06\u5bf9\u5176\u57fa\u672c\u7528\u6cd5\u505a\u51fa\u4ecb\u7ecd\u3002 int pthread_create ( pthread_t * thread , const pthread_attr_t * attr , void * ( * start_routine ) ( void * ), void * arg ); int pthread_join ( pthread_t thread , void ** retval ); int pthread_detach ( pthread_t thread ); pthread_create \u51fd\u6570\u7528\u4e8e\u521b\u5efa\u5e76\u542f\u52a8\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\u3002\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a\u6307\u5411\u6211\u4eec\u8981\u521b\u5efa\u7684\u7ebf\u7a0b\u5bf9\u8c61\u7684\u6307\u9488\uff1b\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a\u521b\u5efa\u65f6\u7684\u5c5e\u6027\uff0c\u76ee\u524d\u53ef\u4ee5\u5ffd\u7565\uff1b\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a\u7ebf\u7a0b\u542f\u52a8\u540e\u5c06\u8981\u6267\u884c\u7684\u51fd\u6570\u6307\u9488\uff1b\u7b2c\u56db\u4e2a\u53c2\u6570\u4e3a\u4f20\u5165\u7ebf\u7a0b\u6267\u884c\u51fd\u6570\u7684\u6570\u636e\u3002 pthread_join \u7528\u4e8e\u7b49\u5f85\u7ebf\u7a0b\u7684\u7ed3\u675f\uff0c\u5e76\u63a5\u6536\u8fd4\u56de\u503c\u3002\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a\u7ebf\u7a0b\u5bf9\u8c61\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a\u63a5\u6536\u8fd4\u56de\u503c\u7684\u53d8\u91cf\u7684\u6307\u9488\uff0c\u5982\u679c\u4e3a NULL \u8868\u793a\u5ffd\u7565\u8fd4\u56de\u503c\u3002 pthread_detach \u53ef\u4ee5\u5c06\u7ebf\u7a0b\u4e0e\u4e3b\u7ebf\u7a0b\u5206\u79bb\uff0c\u4f7f\u8be5\u7ebf\u7a0b\u8fd0\u884c\u7ed3\u675f\u540e\u5f97\u4ee5\u7ec8\u6b62\u81ea\u5df1\u5e76\u91ca\u653e\u8d44\u6e90\u3002\u5206\u79bb\u540e\u7684\u7ebf\u7a0b\u5c06\u4e0d\u80fd\u88ab pthread_join \u7b49\u5f85\u3002 \u53e6\u5916 pthread \u7ebf\u7a0b\u5e93\u8fd8\u5305\u542b\u5904\u7406\u4e92\u65a5\u9501\u7684\u51fd\u6570\u3002 int pthread_mutex_init ( pthread_mutex_t * restrict mutex , const pthread_mutexattr_t * restrict attr ); int pthread_mutex_destroy ( pthread_mutex_t * mutex ); int pthread_mutex_lock ( pthread_mutex_t * mutex ); int pthread_mutex_unlock ( pthread_mutex_t * mutex ); \u6b63\u5982\u51fd\u6570\u540d\u6240\u793a\uff0c\u8fd9\u56db\u4e2a\u51fd\u6570\u5206\u522b\u5bf9\u5e94\u4e86\u4e92\u65a5\u9501\u7684\u521d\u59cb\u5316\u3001\u9500\u6bc1\u3001\u52a0\u9501\u548c\u89e3\u9501\u3002\u4f60\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 PTHREAD_MUTEX_INITIALIZER \u5b8f\u6765\u521d\u59cb\u5316\u4e92\u65a5\u9501\u3002 pthread \u4e5f\u5305\u542b\u5904\u7406\u6761\u4ef6\u53d8\u91cf\u7684\u51fd\u6570\uff0c\u53ef\u7528\u4e8e\u963b\u585e\u548c\u540c\u6b65\u7ebf\u7a0b\u3002 int pthread_cond_init ( pthread_cond_t * restrict cond , const pthread_condattr_t * restrict attr ); int pthread_cond_destroy ( pthread_cond_t * cond ); int pthread_cond_wait ( pthread_cond_t * restrict cond , pthread_mutex_t * restrict mutex ); \u4e0b\u9762\u7684\u4ee3\u7801\u5c55\u793a\u4e86\u6761\u4ef6\u53d8\u91cf\u548c\u4e92\u65a5\u9501\u7b80\u5355\u7684\u4f7f\u7528\u65b9\u6cd5\uff1a #include <stdio.h> #include <unistd.h> #include <pthread.h> pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER ; pthread_cond_t cv = PTHREAD_COND_INITIALIZER ; int ready = 0 ; int data ; void * worker ( void * p ) { pthread_mutex_lock ( & mutex ); while ( ! ready ) { pthread_cond_wait ( & cv , & mutex ); } printf ( \"%d \\n \" , data ); pthread_mutex_unlock ( & mutex ); return NULL ; } int main () { pthread_t thread ; pthread_create ( & thread , NULL , worker , NULL ); pthread_mutex_lock ( & mutex ); sleep ( 1 ); data = 1234 ; ready = 1 ; pthread_cond_signal ( & cv ); pthread_mutex_unlock ( & mutex ); pthread_join ( thread , NULL ); return 0 ; } \u4ee5\u4e0a\u5c31\u662f pthread \u7ebf\u7a0b\u5e93\u6700\u57fa\u672c\u7684\u7528\u6cd5\uff0c\u5982\u9700\u8fdb\u4e00\u6b65\u5b66\u4e60\u66f4\u9ad8\u7ea7\u7684\u7279\u6027\uff0c\u8bf7\u81ea\u884c\u5728\u4e92\u8054\u7f51\u4e0a\u641c\u7d22\u6559\u7a0b\u4e0e\u6587\u6863\u3002 C++ \u7ebf\u7a0b\u5e93 \u00b6 \u5982\u679c\u4f60\u6bd4\u8f83\u719f\u6089 C++ \uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 C++ \u6807\u51c6\u5e93\u4e2d\u7684\u7ebf\u7a0b\u5e93\u3002\u8fd9\u91cc\u7ed9\u51fa\u4e00\u4e2a\u4e0e\u4e0a\u9762\u7684\u793a\u4f8b\u7a0b\u5e8f\u529f\u80fd\u76f8\u540c\u7684\u4f8b\u5b50\uff1a #include <iostream> #include <thread> #include <mutex> #include <condition_variable> #include <chrono> int main () { int n = 0 ; int data ; bool ready = false ; std :: mutex mutex ; std :: condition_variable cv ; auto f = [ & ] { std :: unique_lock < std :: mutex > lock ( mutex ); cv . wait ( lock , [ & ]{ return ready ;}); std :: cout << data << std :: endl ; }; std :: thread thread ( f ); std :: this_thread :: sleep_for ( std :: chrono :: seconds ( 1 )); { std :: lock_guard < std :: mutex > lock ( mutex ); data = 1234 ; ready = true ; cv . notify_one (); } thread . join (); return 0 ; } \u8bf7\u81ea\u884c\u53c2\u9605 C++ \u624b\u518c\u5b66\u4e60\u7ebf\u7a0b\u5e93\u7684\u7528\u6cd5\u3002 \u9009\u505a\uff1a\u5229\u7528 IO \u590d\u7528 / \u5f02\u6b65 IO \u6280\u672f\u5b9e\u73b0\u591a\u4eba\u804a\u5929\u5ba4 \u00b6 \u9664\u4e86\u591a\u7ebf\u7a0b\uff0cIO \u590d\u7528\u4e0e\u5f02\u6b65 IO \u6280\u672f\u4e5f\u662f\u5b9e\u73b0\u5e76\u53d1\u670d\u52a1\u5668\u7684\u5e38\u89c1\u65b9\u5f0f\u3002\u5728\u793a\u4f8b\u7a0b\u5e8f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 recv \u5927\u90e8\u5206\u65f6\u95f4\u90fd\u5728\u7b49\u5f85\u6570\u636e\u7684\u5230\u6765\uff0c\u5b9e\u9645\u4e0a\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\u3002\u56e0\u6b64\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u591a\u7ebf\u7a0b\u5b9e\u9645\u4e0a\u662f\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u975e\u963b\u585e IO \u4e0e IO \u590d\u7528\u6280\u672f\u5b9e\u73b0\u76f8\u540c\u7684\u529f\u80fd\u3002\u8fd9\u91cc\u4f7f\u7528 Unix \u6807\u51c6\u4e2d\u7528\u4e8e IO \u591a\u8def\u590d\u7528\u7684\u7cfb\u7edf\u8c03\u7528 select \u5b9e\u73b0\u4e86\u4e0e\u7b2c\u4e00\u4e2a\u793a\u4f8b\u7a0b\u5e8f\u76f8\u540c\u7684\u529f\u80fd\uff1a #include <stdio.h> #include <string.h> #include <stdlib.h> #include <unistd.h> #include <fcntl.h> #include <sys/socket.h> #include <sys/select.h> #include <sys/time.h> #include <netinet/in.h> struct Pipe { int fd_send ; int fd_recv ; }; int main ( int argc , char ** argv ) { int port = atoi ( argv [ 1 ]); int fd ; if (( fd = socket ( AF_INET , SOCK_STREAM , 0 )) == 0 ) { perror ( \"socket\" ); return 1 ; } struct sockaddr_in addr ; addr . sin_family = AF_INET ; addr . sin_addr . s_addr = INADDR_ANY ; addr . sin_port = htons ( port ); socklen_t addr_len = sizeof ( addr ); if ( bind ( fd , ( struct sockaddr * ) & addr , sizeof ( addr ))) { perror ( \"bind\" ); return 1 ; } if ( listen ( fd , 2 )) { perror ( \"listen\" ); return 1 ; } int fd1 = accept ( fd , NULL , NULL ); int fd2 = accept ( fd , NULL , NULL ); if ( fd1 == - 1 || fd2 == - 1 ) { perror ( \"accept\" ); return 1 ; } fd_set clients ; char buffer [ 1024 ] = \"Message:\" ; fcntl ( fd1 , F_SETFL , fcntl ( fd1 , F_GETFL , 0 ) | O_NONBLOCK ); // \u5c06\u5ba2\u6237\u7aef\u7684\u5957\u63a5\u5b57\u8bbe\u7f6e\u6210\u975e\u963b\u585e fcntl ( fd2 , F_SETFL , fcntl ( fd2 , F_GETFL , 0 ) | O_NONBLOCK ); while ( 1 ) { FD_ZERO ( & clients ); FD_SET ( fd1 , & clients ); FD_SET ( fd2 , & clients ); if ( select ( fd2 + 1 , & clients , NULL , NULL , NULL ) > 0 ) { // \u627e\u51fa\u53ef\u4ee5\u8bfb\u7684\u5957\u63a5\u5b57 if ( FD_ISSET ( fd1 , & clients )) { ssize_t len = recv ( fd1 , buffer + 8 , 1000 , 0 ); if ( len <= 0 ) { break ; } send ( fd2 , buffer , len + 8 , 0 ); } if ( FD_ISSET ( fd2 , & clients )) { ssize_t len = recv ( fd2 , buffer + 8 , 1000 , 0 ); if ( len <= 0 ) { break ; } send ( fd1 , buffer , len + 8 , 0 ); } } else { break ; } } return 0 ; } \u5bf9\u4e8e\u4e00\u822c\u7684\u963b\u585e\u7684 socket \uff0c\u8fdb\u884c recv \u64cd\u4f5c\u65f6\u5982\u679c\u7f13\u51b2\u533a\u4e2d\u65e0\u6570\u636e\u53ef\u8bfb\uff0c\u5c06\u4f1a\u963b\u585e\u76f4\u5230\u6709\u6570\u636e\u4e3a\u6b62\uff0c\u8fd9\u6837\u4f7f\u5f97\u5927\u91cf\u65f6\u95f4\u7528\u4e8e\u7b49\u5f85\u6570\u636e\u4e0a\u3002\u800c\u5bf9\u4e8e\u975e\u963b\u585e\u7684 socket \uff0c\u82e5\u65e0\u6570\u636e\u53ef\u8bfb recv \u5c06\u76f4\u63a5\u8fd4\u56de\uff0c\u800c\u4e0d\u4f1a\u963b\u585e\u4f4f\u3002\u518d\u914d\u5408 select \uff0c\u6bcf\u6b21\u627e\u51fa\u53ef\u8bfb\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5728\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u540c\u65f6\u5904\u7406\u591a\u4e2a\u8fde\u63a5\u3002 select \u7cfb\u7edf\u8c03\u7528\u8fd8\u53ef\u4ee5\u627e\u51fa\u53ef\u5199\u53ca\u51fa\u9519\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u5e76\u8bbe\u5b9a\u7b49\u5f85\u68c0\u67e5\u5b8c\u6210\u7684\u6700\u957f\u65f6\u95f4\u3002\u4f60\u53ef\u4ee5\u5728\u4e92\u8054\u7f51\u4e0a\u67e5\u627e\u66f4\u591a\u5173\u4e8e select \u7684\u8d44\u6599\u3002 \u9664\u4e86\u6240\u6709 Unix \u7cfb\u7edf\u90fd\u6709\u7684 select \u7cfb\u7edf\u8c03\u7528\uff0cLinux \u7684 epoll \uff0cFreeBSD \u548c macOS \u7684 kqueue \uff0c\u4ee5\u53ca Windows \u7684 IOCP \u4e5f\u80fd\u5b9e\u73b0\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u5e76\u4e14\u76f8\u6bd4 select \u90fd\u6709\u5f88\u9ad8\u7684\u6548\u7387\u3002\u8fd9\u51e0\u79cd IO \u590d\u7528 / \u5f02\u6b65 IO \u63a5\u53e3\u6709\u5404\u81ea\u7684\u8bed\u4e49\u4e0e\u7528\u6cd5\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u4efb\u610f\u4e00\u79cd\uff0c\u5e76\u4ee5\u6b64\u4e3a\u57fa\u7840\u5b9e\u73b0\u4e00\u4e2a\u591a\u4eba\u804a\u5929\u5ba4\u3002\u4f60\u53ef\u80fd\u9700\u8981\u5b66\u4e60\u4e00\u4e9b\u975e\u963b\u585e IO \u7f51\u7edc\u7f16\u7a0b\u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u6bd4\u5982 Reactor \u8bbe\u8ba1\u6a21\u5f0f\u3002 \u804a\u5929\u5ba4\u7684\u8981\u6c42\u4e0e\u591a\u7ebf\u7a0b\u7248\u672c\u7684\u76f8\u540c\uff0c\u4f46\u4f60 \u4e0d\u5f97 \u4f7f\u7528\u591a\u7ebf\u7a0b\u6280\u672f\u3002\u9664\u4e86\u6807\u51c6\u5e93\u4e0e\u6240\u4f7f\u7528\u7cfb\u7edf\u7684\u5e93\u5916\uff0c\u8bf7\u52ff\u4f7f\u7528\u4efb\u4f55\u7b2c\u4e09\u65b9\u7684\u7f51\u7edc\u5e93\u6216\u4e8b\u4ef6\u5904\u7406\u5e93\u3002 \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u8bf7\u6309\u7167\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\u7ec4\u7ec7\u4f60\u7684 GitHub \u4ed3\u5e93\uff1a (Git) // Git \u4ed3\u5e93\u76ee\u5f55 \u251c\u2500\u2500 lab3 // \u5b9e\u9a8c\u4e09\u6839\u76ee\u5f55 \u2502 \u251c\u2500\u2500 1.c // \u5b8c\u5584\u540e\u7684\u53cc\u4eba\u804a\u5929\u5ba4\u7684\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 2.c // \u57fa\u4e8e\u591a\u7ebf\u7a0b\u7684\u591a\u4eba\u804a\u5929\u5ba4\u7684\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 3.c // \uff08\u53ef\u9009\uff09\u57fa\u4e8e IO \u590d\u7528 / \u5f02\u6b65 IO \u7684\u591a\u4eba\u804a\u5929\u5ba4\u7684\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 Makefile // \uff08\u53ef\u9009\uff09\u4f60\u63d0\u4f9b\u7684 Makefile \u2502 \u2514\u2500\u2500 README.md // \u5b9e\u9a8c\u62a5\u544a \u251c\u2500\u2500 .gitignore \u2514\u2500\u2500 README.md \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206\u4e3a 10 \u5206\u3002\u4f60\u9700\u8981\u5b8c\u6210\uff1a \u4f60\u7684\u7ecf\u8fc7\u5b8c\u5584\u7684\u53cc\u4eba\u804a\u5929\u5ba4\u80fd\u591f\u4ee5\u6362\u884c\u7b26\u5206\u5272\u6d88\u606f\uff0c\u5904\u7406\u957f\u8fbe 1 MiB \u7684\u6d88\u606f\uff0c\u5e76\u5b8c\u6574\u5730\u53d1\u9001\u5230\u53e6\u4e00\u5ba2\u6237\u7aef\uff082 \u5206\uff09 \u4f60\u7684\u591a\u7ebf\u7a0b\u804a\u5929\u5ba4\u80fd\u591f\u6ee1\u8db3\u524d\u8ff0\u8981\u6c42\uff0c\u6b63\u786e\u5730\u5b9e\u73b0\u7fa4\u804a\uff0c\u5e76\u6b63\u786e\u5730\u5904\u7406\u5bf9\u6570\u636e\u548c socket \u5bf9\u8c61\u7684\u5e76\u53d1\u8bbf\u95ee\uff0c\u4e0d\u4f1a\u9020\u6210\u6570\u636e\u635f\u574f\u4e0e\u5d29\u6e83\uff086 \u5206\uff09 \uff08\u53ef\u9009\uff09\u4f60\u7684 IO \u590d\u7528 / \u5f02\u6b65 IO \u804a\u5929\u5ba4\u80fd\u591f\u6ee1\u8db3\u524d\u8ff0\u8981\u6c42\uff0c\u6b63\u786e\u5730\u5b9e\u73b0\u7fa4\u804a\uff088 \u5206\uff09 \u6027\u80fd\u4e0d\u662f\u672c\u5b9e\u9a8c\u5173\u6ce8\u7684\u91cd\u70b9\uff0c\u53ea\u9700\u8981\u6b63\u786e\u5b9e\u73b0\u529f\u80fd\u5373\u53ef\u3002\u4e0e\u5b9e\u9a8c\u4e8c\u76f8\u4f3c\uff0c\u672c\u5b9e\u9a8c\u4e0d\u8981\u6c42\u5b9e\u9a8c\u62a5\u544a\uff0c\u4f46\u662f\u63a8\u8350\u7b80\u5355\u63cf\u8ff0\u4f60\u7684\u5b9e\u73b0\uff0c\u4ee5\u4f7f\u52a9\u6559\u80fd\u66f4\u597d\u5730\u7406\u89e3\u4f60\u7684\u4ee3\u7801\uff0c\u4ee5\u514d\u9020\u6210\u8bef\u89e3\u3002 \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206\u4e3a 10 \u5206\uff0c\u4f46\u6839\u636e\u4ee5\u4e0a\u5185\u5bb9\uff0c\u5b9e\u9645\u53ef\u83b7\u5f97\u7684\u5206\u6570\u4e0a\u9650\u4e3a 16 \u5206\uff0c\u8d85\u51fa 10 \u5206\u7684\u90e8\u5206\u5c06\u51cf\u534a\u8ba1\u5165\u5b9e\u9a8c\u603b\u5206\u3002 \u4f8b\u5982\uff0c\u82e5\u4f60\u6839\u636e\u4ee5\u4e0a\u6807\u51c6\u83b7\u5f97\u4e86 16 \u5206\uff0c\u90a3\u4e48\u672c\u6b21\u5b9e\u9a8c\u8ba1\u5165\u603b\u5206\u7684\u5206\u6570\u4e3a 13 \u5206\uff0c\u8fd9\u5c06\u7b49\u4ef7\u4e8e\u672c\u8bfe\u7a0b\u603b\u8bc4\u6210\u7ee9\u7684 6.5 \u5206\u3002 \u5176\u4ed6\u8bf4\u660e \u00b6 \u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 C \u6216 C++ \u8bed\u8a00\u5b8c\u6210\uff0c\u5982\u679c\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u8bed\u8a00\u8bf7\u5148\u8be2\u95ee\u52a9\u6559\u3002 \u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 C/C++ \u7684\u6807\u51c6\u5e93\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u7684\u5e93\uff08\u5982 POSIX \u6807\u51c6\u5e93\u6216 Windows API\uff09\uff0c\u4f46\u4e0d\u5f97\u4f7f\u7528\u4efb\u4f55\u7b2c\u4e09\u65b9\u7684\u7f51\u7edc\u5e93\u6216\u4e8b\u4ef6\u5904\u7406\u5e93\u3002\u4f7f\u7528\u6b64\u5904\u6ca1\u6709\u5217\u51fa\u7684\u5e93\u524d\u8bf7\u8be2\u95ee\u52a9\u6559\u3002","title":"\u5b9e\u9a8c\u4e09"},{"location":"lab-3/#lab-3","text":"\u5728\u672c\u6b21\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u5b66\u4e60\u7b80\u5355\u7684 socket \u7f16\u7a0b\uff0c\u5206\u522b\u5229\u7528\u591a\u7ebf\u7a0b\u6280\u672f\u548c IO \u590d\u7528\u6280\u672f\u7f16\u5199\u4e00\u4e2a\u7b80\u5355\u7684\u591a\u4eba\u804a\u5929\u5ba4\u7a0b\u5e8f\u3002 \u9996\u5148\u7ed9\u51fa\u4e00\u4e2a\u7b80\u5355\u7684\u53cc\u4eba\u804a\u5929\u5ba4\u793a\u4f8b\u7a0b\u5e8f\uff1a #include <stdio.h> #include <string.h> #include <stdlib.h> #include <unistd.h> #include <sys/socket.h> #include <netinet/in.h> #include <pthread.h> struct Pipe { int fd_send ; int fd_recv ; }; void * handle_chat ( void * data ) { struct Pipe * pipe = ( struct Pipe * ) data ; char buffer [ 1024 ] = \"Message:\" ; ssize_t len ; while (( len = recv ( pipe -> fd_send , buffer + 8 , 1000 , 0 )) > 0 ) { send ( pipe -> fd_recv , buffer , len + 8 , 0 ); } return NULL ; } int main ( int argc , char ** argv ) { int port = atoi ( argv [ 1 ]); int fd ; if (( fd = socket ( AF_INET , SOCK_STREAM , 0 )) == 0 ) { perror ( \"socket\" ); return 1 ; } struct sockaddr_in addr ; addr . sin_family = AF_INET ; addr . sin_addr . s_addr = INADDR_ANY ; addr . sin_port = htons ( port ); socklen_t addr_len = sizeof ( addr ); if ( bind ( fd , ( struct sockaddr * ) & addr , sizeof ( addr ))) { perror ( \"bind\" ); return 1 ; } if ( listen ( fd , 2 )) { perror ( \"listen\" ); return 1 ; } int fd1 = accept ( fd , NULL , NULL ); int fd2 = accept ( fd , NULL , NULL ); if ( fd1 == - 1 || fd2 == - 1 ) { perror ( \"accept\" ); return 1 ; } pthread_t thread1 , thread2 ; struct Pipe pipe1 ; struct Pipe pipe2 ; pipe1 . fd_send = fd1 ; pipe1 . fd_recv = fd2 ; pipe2 . fd_send = fd2 ; pipe2 . fd_recv = fd1 ; pthread_create ( & thread1 , NULL , handle_chat , ( void * ) & pipe1 ); pthread_create ( & thread2 , NULL , handle_chat , ( void * ) & pipe2 ); pthread_join ( thread1 , NULL ); pthread_join ( thread2 , NULL ); return 0 ; } \u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u7f16\u8bd1\u5e76\u8fd0\u884c\uff1a gcc 1 .c -o 1 -lpthread ./1 6666 \u63a5\u7740\u4e24\u4e2a\u7ec8\u7aef\u4e2d\u5206\u522b\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fde\u63a5\uff1a nc 127 .0.0.1 6666 \u8fd9\u6837\u4ece\u4e00\u4e2a\u7ec8\u7aef\u8f93\u5165\u7684\u6d88\u606f\uff0c\u4f1a\u8f6c\u53d1\u5230\u53e6\u4e00\u4e2a\u7ec8\u7aef\uff0c\u4e8e\u662f\u4fbf\u5b9e\u73b0\u4e86\u4e24\u4e2a\u5ba2\u6237\u7aef\u95f4\u7684\u804a\u5929\u3002\u8fd9\u4e2a\u804a\u5929\u5ba4\u7a0b\u5e8f\u5341\u5206\u7b80\u964b\uff0c\u5ffd\u7565\u4e86 socket \u7f16\u7a0b\u4e2d\u7684\u5f88\u591a\u7ec6\u8282\uff0c\u4f60\u7684\u4efb\u52a1\u5c31\u662f\u4fee\u6539\u5b83\uff08\u6216\u8005\u4ece\u5934\u7f16\u5199\uff09\uff0c\u4f7f\u5f97\u5b83\u66f4\u5065\u58ee\uff0c\u5e76\u4e14\u652f\u6301\u591a\u4eba\u804a\u5929\u3002","title":"Lab 3"},{"location":"lab-3/#_1","text":"","title":"\u5b8c\u5584\u53cc\u4eba\u804a\u5929\u5ba4"},{"location":"lab-3/#_2","text":"TCP \u662f\u4e00\u4e2a\u57fa\u4e8e\u6d41\u7684\u534f\u8bae\uff0c\u672c\u8eab\u6ca1\u6709\u201c\u6d88\u606f\u201d\u7684\u6982\u5ff5\u3002\u5728\u6574\u4e2a\u8fde\u63a5\u4e2d\uff0c\u5ba2\u6237\u7aef\u53d1\u9001\u7684\u6570\u636e\u53ea\u662f\u4e00\u8fde\u4e32\u7684\u5b57\u8282\uff0c\u670d\u52a1\u7aef\u5e76\u4e0d\u80fd\u77e5\u9053\u8fd9\u4e9b\u6570\u636e\u662f\u4ee5\u600e\u6837\u7684\u65b9\u5f0f\u5206\u5272\u7684\uff08\u4e00\u6b21 send \u5e76\u4e0d\u4e00\u5b9a\u5bf9\u5e94\u5bf9\u65b9\u7684\u4e00\u6b21 recv \uff09\u3002\u793a\u4f8b\u7a0b\u5e8f\u5c06\u4e00\u6b21 recv \u5f97\u5230\u7684\u6570\u636e\u89c6\u4e3a\u4e00\u4e2a\u6d88\u606f\uff0c\u662f\u4e0d\u5408\u9002\u7684\u3002\u8bf7\u91cd\u65b0\u5b9e\u73b0\u63a5\u6536\u6570\u636e\u7684\u90e8\u5206\uff0c\u4f7f\u5f97\u4ee5\u6362\u884c\u7b26 \\n \u4e3a\u5206\u9694\u7b26\u63a5\u6536\u548c\u5206\u5272\u6570\u636e\uff0c\u5e76\u4ee5\u4e00\u6761\u6d88\u606f\u4e3a\u5355\u4f4d\u53d1\u9001\u7ed9\u53e6\u4e00\u4e2a\u5ba2\u6237\u7aef\u3002\u5728\u52a9\u6559\u7684\u6d4b\u8bd5\u4e2d\u6d88\u606f\u7684\u957f\u5ea6\u4e0d\u8d85\u8fc7 1 MiB\uff081,048,576 \u5b57\u8282\uff09\u3002","title":"\u5b9e\u73b0\u4ee5\u6362\u884c\u4e3a\u5206\u9694\u7b26\u7684\u6d88\u606f\u5206\u5272"},{"location":"lab-3/#send","text":"\u5f53\u53d1\u9001\u7684\u6570\u636e\u957f\u5ea6\u8db3\u591f\u5927\u65f6\uff0c\u53ef\u80fd\u4f1a\u5f15\u8d77 send \u7684\u963b\u585e\uff0c\u8fd9\u65f6\u53ea\u6709\u90e8\u5206\u6570\u636e\u88ab\u6210\u529f\u53d1\u9001\u3002\u8bf7\u5904\u7406\u8fd9\u79cd\u60c5\u51b5\uff0c\u4f7f\u5f97\u6240\u6709\u6570\u636e\u90fd\u80fd\u4fdd\u8bc1\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u3002","title":"\u5904\u7406\u53ef\u80fd\u7684 send \u963b\u585e"},{"location":"lab-3/#_3","text":"\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u5b9e\u73b0\u4e00\u4e2a\u652f\u6301\u591a\u4eba\u5728\u7ebf\u7684\u804a\u5929\u5ba4\uff0c\u5177\u4f53\u8981\u6c42\u5982\u4e0b\uff1a \u6700\u591a\u652f\u6301 32 \u4e2a\u7528\u6237\u540c\u65f6\u5728\u7ebf\uff0c\u7528\u6237\u53ef\u4ee5\u968f\u65f6\u52a0\u5165\u4e0e\u9000\u51fa \u7a0b\u5e8f\u5c06\u7528\u6237\u53d1\u51fa\u7684\u6570\u636e\u4ee5\u6362\u884c\u7b26\u5206\u5272\u4e3a\u6d88\u606f\uff0c\u5e76\u5c06\u6d88\u606f\u5b8c\u6574\u5730\u53d1\u9001\u7ed9\u5176\u4ed6\u7528\u6237 \u4f60\u9700\u8981\u4f7f\u7528\u963b\u585e IO \u4e0e\u591a\u7ebf\u7a0b\u6280\u672f\u6765\u5b9e\u73b0\u4e0a\u8ff0\u9700\u6c42\u3002\u53ef\u4ee5\u4f7f\u7528\u7684\u7ebf\u7a0b\u5e93\u6709 pthread, Windows API \u6216 std::thread \u3002\u9664\u4e86\u6807\u51c6\u5e93\u4e0e\u4e0a\u8ff0\u5e93\uff0c\u8bf7\u52ff\u4f7f\u7528\u5176\u4ed6\u5e93\u3002\u5728\u6d4b\u8bd5\u4e2d\u6d88\u606f\u7684\u957f\u5ea6\u4e0d\u8d85\u8fc7 1 MiB\u3002 \u8bf7\u6ce8\u610f\uff0csocket \u662f\u5168\u53cc\u5de5\u7684\uff0c\u5373\u53ef\u4ee5\u7531\u4e24\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5206\u522b\u8bfb\u53d6\u4e0e\u5199\u5165\u3002\u4f46\u5e76\u53d1\u5730\u8bfb\u53d6\u6216\u5e76\u53d1\u5730\u5199\u5165\u53ef\u80fd\u4f1a\u9020\u6210\u610f\u60f3\u4e0d\u5230\u7684\u540e\u679c\u3002\u8bf7\u5229\u7528\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u4e2d\u7ebf\u7a0b\u540c\u6b65\u7684\u76f8\u5173\u77e5\u8bc6\u5b9e\u73b0\u5bf9 socket \u7684\u5b89\u5168\u64cd\u4f5c\u3002","title":"\u5229\u7528\u591a\u7ebf\u7a0b\u6280\u672f\u5b9e\u73b0\u591a\u4eba\u804a\u5929\u5ba4"},{"location":"lab-3/#pthread","text":"\u5982\u679c\u4f60\u5728\u7c7b Unix \u7cfb\u7edf\u4e0b\u7f16\u7a0b\uff0c\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528 pthread \u7ebf\u7a0b\u5e93\uff0c\u8fd9\u91cc\u5c06\u5bf9\u5176\u57fa\u672c\u7528\u6cd5\u505a\u51fa\u4ecb\u7ecd\u3002 int pthread_create ( pthread_t * thread , const pthread_attr_t * attr , void * ( * start_routine ) ( void * ), void * arg ); int pthread_join ( pthread_t thread , void ** retval ); int pthread_detach ( pthread_t thread ); pthread_create \u51fd\u6570\u7528\u4e8e\u521b\u5efa\u5e76\u542f\u52a8\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\u3002\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a\u6307\u5411\u6211\u4eec\u8981\u521b\u5efa\u7684\u7ebf\u7a0b\u5bf9\u8c61\u7684\u6307\u9488\uff1b\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a\u521b\u5efa\u65f6\u7684\u5c5e\u6027\uff0c\u76ee\u524d\u53ef\u4ee5\u5ffd\u7565\uff1b\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a\u7ebf\u7a0b\u542f\u52a8\u540e\u5c06\u8981\u6267\u884c\u7684\u51fd\u6570\u6307\u9488\uff1b\u7b2c\u56db\u4e2a\u53c2\u6570\u4e3a\u4f20\u5165\u7ebf\u7a0b\u6267\u884c\u51fd\u6570\u7684\u6570\u636e\u3002 pthread_join \u7528\u4e8e\u7b49\u5f85\u7ebf\u7a0b\u7684\u7ed3\u675f\uff0c\u5e76\u63a5\u6536\u8fd4\u56de\u503c\u3002\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a\u7ebf\u7a0b\u5bf9\u8c61\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a\u63a5\u6536\u8fd4\u56de\u503c\u7684\u53d8\u91cf\u7684\u6307\u9488\uff0c\u5982\u679c\u4e3a NULL \u8868\u793a\u5ffd\u7565\u8fd4\u56de\u503c\u3002 pthread_detach \u53ef\u4ee5\u5c06\u7ebf\u7a0b\u4e0e\u4e3b\u7ebf\u7a0b\u5206\u79bb\uff0c\u4f7f\u8be5\u7ebf\u7a0b\u8fd0\u884c\u7ed3\u675f\u540e\u5f97\u4ee5\u7ec8\u6b62\u81ea\u5df1\u5e76\u91ca\u653e\u8d44\u6e90\u3002\u5206\u79bb\u540e\u7684\u7ebf\u7a0b\u5c06\u4e0d\u80fd\u88ab pthread_join \u7b49\u5f85\u3002 \u53e6\u5916 pthread \u7ebf\u7a0b\u5e93\u8fd8\u5305\u542b\u5904\u7406\u4e92\u65a5\u9501\u7684\u51fd\u6570\u3002 int pthread_mutex_init ( pthread_mutex_t * restrict mutex , const pthread_mutexattr_t * restrict attr ); int pthread_mutex_destroy ( pthread_mutex_t * mutex ); int pthread_mutex_lock ( pthread_mutex_t * mutex ); int pthread_mutex_unlock ( pthread_mutex_t * mutex ); \u6b63\u5982\u51fd\u6570\u540d\u6240\u793a\uff0c\u8fd9\u56db\u4e2a\u51fd\u6570\u5206\u522b\u5bf9\u5e94\u4e86\u4e92\u65a5\u9501\u7684\u521d\u59cb\u5316\u3001\u9500\u6bc1\u3001\u52a0\u9501\u548c\u89e3\u9501\u3002\u4f60\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 PTHREAD_MUTEX_INITIALIZER \u5b8f\u6765\u521d\u59cb\u5316\u4e92\u65a5\u9501\u3002 pthread \u4e5f\u5305\u542b\u5904\u7406\u6761\u4ef6\u53d8\u91cf\u7684\u51fd\u6570\uff0c\u53ef\u7528\u4e8e\u963b\u585e\u548c\u540c\u6b65\u7ebf\u7a0b\u3002 int pthread_cond_init ( pthread_cond_t * restrict cond , const pthread_condattr_t * restrict attr ); int pthread_cond_destroy ( pthread_cond_t * cond ); int pthread_cond_wait ( pthread_cond_t * restrict cond , pthread_mutex_t * restrict mutex ); \u4e0b\u9762\u7684\u4ee3\u7801\u5c55\u793a\u4e86\u6761\u4ef6\u53d8\u91cf\u548c\u4e92\u65a5\u9501\u7b80\u5355\u7684\u4f7f\u7528\u65b9\u6cd5\uff1a #include <stdio.h> #include <unistd.h> #include <pthread.h> pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER ; pthread_cond_t cv = PTHREAD_COND_INITIALIZER ; int ready = 0 ; int data ; void * worker ( void * p ) { pthread_mutex_lock ( & mutex ); while ( ! ready ) { pthread_cond_wait ( & cv , & mutex ); } printf ( \"%d \\n \" , data ); pthread_mutex_unlock ( & mutex ); return NULL ; } int main () { pthread_t thread ; pthread_create ( & thread , NULL , worker , NULL ); pthread_mutex_lock ( & mutex ); sleep ( 1 ); data = 1234 ; ready = 1 ; pthread_cond_signal ( & cv ); pthread_mutex_unlock ( & mutex ); pthread_join ( thread , NULL ); return 0 ; } \u4ee5\u4e0a\u5c31\u662f pthread \u7ebf\u7a0b\u5e93\u6700\u57fa\u672c\u7684\u7528\u6cd5\uff0c\u5982\u9700\u8fdb\u4e00\u6b65\u5b66\u4e60\u66f4\u9ad8\u7ea7\u7684\u7279\u6027\uff0c\u8bf7\u81ea\u884c\u5728\u4e92\u8054\u7f51\u4e0a\u641c\u7d22\u6559\u7a0b\u4e0e\u6587\u6863\u3002","title":"pthread"},{"location":"lab-3/#c","text":"\u5982\u679c\u4f60\u6bd4\u8f83\u719f\u6089 C++ \uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 C++ \u6807\u51c6\u5e93\u4e2d\u7684\u7ebf\u7a0b\u5e93\u3002\u8fd9\u91cc\u7ed9\u51fa\u4e00\u4e2a\u4e0e\u4e0a\u9762\u7684\u793a\u4f8b\u7a0b\u5e8f\u529f\u80fd\u76f8\u540c\u7684\u4f8b\u5b50\uff1a #include <iostream> #include <thread> #include <mutex> #include <condition_variable> #include <chrono> int main () { int n = 0 ; int data ; bool ready = false ; std :: mutex mutex ; std :: condition_variable cv ; auto f = [ & ] { std :: unique_lock < std :: mutex > lock ( mutex ); cv . wait ( lock , [ & ]{ return ready ;}); std :: cout << data << std :: endl ; }; std :: thread thread ( f ); std :: this_thread :: sleep_for ( std :: chrono :: seconds ( 1 )); { std :: lock_guard < std :: mutex > lock ( mutex ); data = 1234 ; ready = true ; cv . notify_one (); } thread . join (); return 0 ; } \u8bf7\u81ea\u884c\u53c2\u9605 C++ \u624b\u518c\u5b66\u4e60\u7ebf\u7a0b\u5e93\u7684\u7528\u6cd5\u3002","title":"C++ \u7ebf\u7a0b\u5e93"},{"location":"lab-3/#io-io","text":"\u9664\u4e86\u591a\u7ebf\u7a0b\uff0cIO \u590d\u7528\u4e0e\u5f02\u6b65 IO \u6280\u672f\u4e5f\u662f\u5b9e\u73b0\u5e76\u53d1\u670d\u52a1\u5668\u7684\u5e38\u89c1\u65b9\u5f0f\u3002\u5728\u793a\u4f8b\u7a0b\u5e8f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 recv \u5927\u90e8\u5206\u65f6\u95f4\u90fd\u5728\u7b49\u5f85\u6570\u636e\u7684\u5230\u6765\uff0c\u5b9e\u9645\u4e0a\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\u3002\u56e0\u6b64\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u591a\u7ebf\u7a0b\u5b9e\u9645\u4e0a\u662f\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u975e\u963b\u585e IO \u4e0e IO \u590d\u7528\u6280\u672f\u5b9e\u73b0\u76f8\u540c\u7684\u529f\u80fd\u3002\u8fd9\u91cc\u4f7f\u7528 Unix \u6807\u51c6\u4e2d\u7528\u4e8e IO \u591a\u8def\u590d\u7528\u7684\u7cfb\u7edf\u8c03\u7528 select \u5b9e\u73b0\u4e86\u4e0e\u7b2c\u4e00\u4e2a\u793a\u4f8b\u7a0b\u5e8f\u76f8\u540c\u7684\u529f\u80fd\uff1a #include <stdio.h> #include <string.h> #include <stdlib.h> #include <unistd.h> #include <fcntl.h> #include <sys/socket.h> #include <sys/select.h> #include <sys/time.h> #include <netinet/in.h> struct Pipe { int fd_send ; int fd_recv ; }; int main ( int argc , char ** argv ) { int port = atoi ( argv [ 1 ]); int fd ; if (( fd = socket ( AF_INET , SOCK_STREAM , 0 )) == 0 ) { perror ( \"socket\" ); return 1 ; } struct sockaddr_in addr ; addr . sin_family = AF_INET ; addr . sin_addr . s_addr = INADDR_ANY ; addr . sin_port = htons ( port ); socklen_t addr_len = sizeof ( addr ); if ( bind ( fd , ( struct sockaddr * ) & addr , sizeof ( addr ))) { perror ( \"bind\" ); return 1 ; } if ( listen ( fd , 2 )) { perror ( \"listen\" ); return 1 ; } int fd1 = accept ( fd , NULL , NULL ); int fd2 = accept ( fd , NULL , NULL ); if ( fd1 == - 1 || fd2 == - 1 ) { perror ( \"accept\" ); return 1 ; } fd_set clients ; char buffer [ 1024 ] = \"Message:\" ; fcntl ( fd1 , F_SETFL , fcntl ( fd1 , F_GETFL , 0 ) | O_NONBLOCK ); // \u5c06\u5ba2\u6237\u7aef\u7684\u5957\u63a5\u5b57\u8bbe\u7f6e\u6210\u975e\u963b\u585e fcntl ( fd2 , F_SETFL , fcntl ( fd2 , F_GETFL , 0 ) | O_NONBLOCK ); while ( 1 ) { FD_ZERO ( & clients ); FD_SET ( fd1 , & clients ); FD_SET ( fd2 , & clients ); if ( select ( fd2 + 1 , & clients , NULL , NULL , NULL ) > 0 ) { // \u627e\u51fa\u53ef\u4ee5\u8bfb\u7684\u5957\u63a5\u5b57 if ( FD_ISSET ( fd1 , & clients )) { ssize_t len = recv ( fd1 , buffer + 8 , 1000 , 0 ); if ( len <= 0 ) { break ; } send ( fd2 , buffer , len + 8 , 0 ); } if ( FD_ISSET ( fd2 , & clients )) { ssize_t len = recv ( fd2 , buffer + 8 , 1000 , 0 ); if ( len <= 0 ) { break ; } send ( fd1 , buffer , len + 8 , 0 ); } } else { break ; } } return 0 ; } \u5bf9\u4e8e\u4e00\u822c\u7684\u963b\u585e\u7684 socket \uff0c\u8fdb\u884c recv \u64cd\u4f5c\u65f6\u5982\u679c\u7f13\u51b2\u533a\u4e2d\u65e0\u6570\u636e\u53ef\u8bfb\uff0c\u5c06\u4f1a\u963b\u585e\u76f4\u5230\u6709\u6570\u636e\u4e3a\u6b62\uff0c\u8fd9\u6837\u4f7f\u5f97\u5927\u91cf\u65f6\u95f4\u7528\u4e8e\u7b49\u5f85\u6570\u636e\u4e0a\u3002\u800c\u5bf9\u4e8e\u975e\u963b\u585e\u7684 socket \uff0c\u82e5\u65e0\u6570\u636e\u53ef\u8bfb recv \u5c06\u76f4\u63a5\u8fd4\u56de\uff0c\u800c\u4e0d\u4f1a\u963b\u585e\u4f4f\u3002\u518d\u914d\u5408 select \uff0c\u6bcf\u6b21\u627e\u51fa\u53ef\u8bfb\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5728\u4e00\u4e2a\u7ebf\u7a0b\u4e2d\u540c\u65f6\u5904\u7406\u591a\u4e2a\u8fde\u63a5\u3002 select \u7cfb\u7edf\u8c03\u7528\u8fd8\u53ef\u4ee5\u627e\u51fa\u53ef\u5199\u53ca\u51fa\u9519\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u5e76\u8bbe\u5b9a\u7b49\u5f85\u68c0\u67e5\u5b8c\u6210\u7684\u6700\u957f\u65f6\u95f4\u3002\u4f60\u53ef\u4ee5\u5728\u4e92\u8054\u7f51\u4e0a\u67e5\u627e\u66f4\u591a\u5173\u4e8e select \u7684\u8d44\u6599\u3002 \u9664\u4e86\u6240\u6709 Unix \u7cfb\u7edf\u90fd\u6709\u7684 select \u7cfb\u7edf\u8c03\u7528\uff0cLinux \u7684 epoll \uff0cFreeBSD \u548c macOS \u7684 kqueue \uff0c\u4ee5\u53ca Windows \u7684 IOCP \u4e5f\u80fd\u5b9e\u73b0\u7c7b\u4f3c\u7684\u529f\u80fd\uff0c\u5e76\u4e14\u76f8\u6bd4 select \u90fd\u6709\u5f88\u9ad8\u7684\u6548\u7387\u3002\u8fd9\u51e0\u79cd IO \u590d\u7528 / \u5f02\u6b65 IO \u63a5\u53e3\u6709\u5404\u81ea\u7684\u8bed\u4e49\u4e0e\u7528\u6cd5\uff0c\u4f60\u53ef\u4ee5\u9009\u62e9\u4efb\u610f\u4e00\u79cd\uff0c\u5e76\u4ee5\u6b64\u4e3a\u57fa\u7840\u5b9e\u73b0\u4e00\u4e2a\u591a\u4eba\u804a\u5929\u5ba4\u3002\u4f60\u53ef\u80fd\u9700\u8981\u5b66\u4e60\u4e00\u4e9b\u975e\u963b\u585e IO \u7f51\u7edc\u7f16\u7a0b\u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u6bd4\u5982 Reactor \u8bbe\u8ba1\u6a21\u5f0f\u3002 \u804a\u5929\u5ba4\u7684\u8981\u6c42\u4e0e\u591a\u7ebf\u7a0b\u7248\u672c\u7684\u76f8\u540c\uff0c\u4f46\u4f60 \u4e0d\u5f97 \u4f7f\u7528\u591a\u7ebf\u7a0b\u6280\u672f\u3002\u9664\u4e86\u6807\u51c6\u5e93\u4e0e\u6240\u4f7f\u7528\u7cfb\u7edf\u7684\u5e93\u5916\uff0c\u8bf7\u52ff\u4f7f\u7528\u4efb\u4f55\u7b2c\u4e09\u65b9\u7684\u7f51\u7edc\u5e93\u6216\u4e8b\u4ef6\u5904\u7406\u5e93\u3002","title":"\u9009\u505a\uff1a\u5229\u7528 IO \u590d\u7528 / \u5f02\u6b65 IO \u6280\u672f\u5b9e\u73b0\u591a\u4eba\u804a\u5929\u5ba4"},{"location":"lab-3/#_4","text":"\u8bf7\u6309\u7167\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\u7ec4\u7ec7\u4f60\u7684 GitHub \u4ed3\u5e93\uff1a (Git) // Git \u4ed3\u5e93\u76ee\u5f55 \u251c\u2500\u2500 lab3 // \u5b9e\u9a8c\u4e09\u6839\u76ee\u5f55 \u2502 \u251c\u2500\u2500 1.c // \u5b8c\u5584\u540e\u7684\u53cc\u4eba\u804a\u5929\u5ba4\u7684\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 2.c // \u57fa\u4e8e\u591a\u7ebf\u7a0b\u7684\u591a\u4eba\u804a\u5929\u5ba4\u7684\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 3.c // \uff08\u53ef\u9009\uff09\u57fa\u4e8e IO \u590d\u7528 / \u5f02\u6b65 IO \u7684\u591a\u4eba\u804a\u5929\u5ba4\u7684\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 Makefile // \uff08\u53ef\u9009\uff09\u4f60\u63d0\u4f9b\u7684 Makefile \u2502 \u2514\u2500\u2500 README.md // \u5b9e\u9a8c\u62a5\u544a \u251c\u2500\u2500 .gitignore \u2514\u2500\u2500 README.md \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206\u4e3a 10 \u5206\u3002\u4f60\u9700\u8981\u5b8c\u6210\uff1a \u4f60\u7684\u7ecf\u8fc7\u5b8c\u5584\u7684\u53cc\u4eba\u804a\u5929\u5ba4\u80fd\u591f\u4ee5\u6362\u884c\u7b26\u5206\u5272\u6d88\u606f\uff0c\u5904\u7406\u957f\u8fbe 1 MiB \u7684\u6d88\u606f\uff0c\u5e76\u5b8c\u6574\u5730\u53d1\u9001\u5230\u53e6\u4e00\u5ba2\u6237\u7aef\uff082 \u5206\uff09 \u4f60\u7684\u591a\u7ebf\u7a0b\u804a\u5929\u5ba4\u80fd\u591f\u6ee1\u8db3\u524d\u8ff0\u8981\u6c42\uff0c\u6b63\u786e\u5730\u5b9e\u73b0\u7fa4\u804a\uff0c\u5e76\u6b63\u786e\u5730\u5904\u7406\u5bf9\u6570\u636e\u548c socket \u5bf9\u8c61\u7684\u5e76\u53d1\u8bbf\u95ee\uff0c\u4e0d\u4f1a\u9020\u6210\u6570\u636e\u635f\u574f\u4e0e\u5d29\u6e83\uff086 \u5206\uff09 \uff08\u53ef\u9009\uff09\u4f60\u7684 IO \u590d\u7528 / \u5f02\u6b65 IO \u804a\u5929\u5ba4\u80fd\u591f\u6ee1\u8db3\u524d\u8ff0\u8981\u6c42\uff0c\u6b63\u786e\u5730\u5b9e\u73b0\u7fa4\u804a\uff088 \u5206\uff09 \u6027\u80fd\u4e0d\u662f\u672c\u5b9e\u9a8c\u5173\u6ce8\u7684\u91cd\u70b9\uff0c\u53ea\u9700\u8981\u6b63\u786e\u5b9e\u73b0\u529f\u80fd\u5373\u53ef\u3002\u4e0e\u5b9e\u9a8c\u4e8c\u76f8\u4f3c\uff0c\u672c\u5b9e\u9a8c\u4e0d\u8981\u6c42\u5b9e\u9a8c\u62a5\u544a\uff0c\u4f46\u662f\u63a8\u8350\u7b80\u5355\u63cf\u8ff0\u4f60\u7684\u5b9e\u73b0\uff0c\u4ee5\u4f7f\u52a9\u6559\u80fd\u66f4\u597d\u5730\u7406\u89e3\u4f60\u7684\u4ee3\u7801\uff0c\u4ee5\u514d\u9020\u6210\u8bef\u89e3\u3002 \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206\u4e3a 10 \u5206\uff0c\u4f46\u6839\u636e\u4ee5\u4e0a\u5185\u5bb9\uff0c\u5b9e\u9645\u53ef\u83b7\u5f97\u7684\u5206\u6570\u4e0a\u9650\u4e3a 16 \u5206\uff0c\u8d85\u51fa 10 \u5206\u7684\u90e8\u5206\u5c06\u51cf\u534a\u8ba1\u5165\u5b9e\u9a8c\u603b\u5206\u3002 \u4f8b\u5982\uff0c\u82e5\u4f60\u6839\u636e\u4ee5\u4e0a\u6807\u51c6\u83b7\u5f97\u4e86 16 \u5206\uff0c\u90a3\u4e48\u672c\u6b21\u5b9e\u9a8c\u8ba1\u5165\u603b\u5206\u7684\u5206\u6570\u4e3a 13 \u5206\uff0c\u8fd9\u5c06\u7b49\u4ef7\u4e8e\u672c\u8bfe\u7a0b\u603b\u8bc4\u6210\u7ee9\u7684 6.5 \u5206\u3002","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab-3/#_5","text":"\u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 C \u6216 C++ \u8bed\u8a00\u5b8c\u6210\uff0c\u5982\u679c\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u8bed\u8a00\u8bf7\u5148\u8be2\u95ee\u52a9\u6559\u3002 \u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 C/C++ \u7684\u6807\u51c6\u5e93\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u7684\u5e93\uff08\u5982 POSIX \u6807\u51c6\u5e93\u6216 Windows API\uff09\uff0c\u4f46\u4e0d\u5f97\u4f7f\u7528\u4efb\u4f55\u7b2c\u4e09\u65b9\u7684\u7f51\u7edc\u5e93\u6216\u4e8b\u4ef6\u5904\u7406\u5e93\u3002\u4f7f\u7528\u6b64\u5904\u6ca1\u6709\u5217\u51fa\u7684\u5e93\u524d\u8bf7\u8be2\u95ee\u52a9\u6559\u3002","title":"\u5176\u4ed6\u8bf4\u660e"},{"location":"lab-4/","text":"Lab 4 \u00b6 \u5bb9\u5668 \u662f\u8fd1\u5e74\u6765\u975e\u5e38\u70ed\u95e8\u7684\u4e00\u4e2a\u6982\u5ff5\u3002\u5b83\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u63d0\u4f9b\u7684\u9694\u79bb\u6280\u672f\uff0c\u5b9e\u73b0\u8f7b\u91cf\u7ea7\u7684\u865a\u62df\u5316\u73af\u5883\u3002\u76ee\u524d\uff0c\u5b83\u5728\u8f6f\u4ef6\u7684\u5f00\u53d1\u3001\u90e8\u7f72\u7b49\u65b9\u9762\u6709\u7740\u975e\u5e38\u5e7f\u6cdb\u7684\u5e94\u7528\u3002 \u6700\u5e38\u89c1\u7684\u51e0\u79cd\u5bb9\u5668\uff0c\u5982 Docker\uff0c\u90fd\u5145\u5206\u5229\u7528\u4e86\u591a\u79cd Linux \u7684\u7279\u6027\uff0c\u56e0\u6b64\u6beb\u4e0d\u5938\u5f20\u5730\u8bf4\uff0c\u5bb9\u5668\u662f\u5c5e\u4e8e Linux \u7684\u3002\u672c\u5b9e\u9a8c\u4e2d\u6211\u4eec\u5c06\u52a8\u624b\u7f16\u5199\u4e00\u4e2a\u5bb9\u5668\u5b9e\u73b0\uff0c\u7406\u89e3 Linux \u4e2d\u7684\u5bb9\u5668\u6280\u672f\u3002 \u672c\u5b9e\u9a8c\u7531\u4e8e\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u6df1\u5ea6\u7ed3\u5408\uff0c\u56e0\u6b64\u65e0\u6cd5\u5728 vlab \u5e73\u53f0\u4e0a\u8fdb\u884c\uff0c\u8bf7\u540c\u5b66\u4eec\u5728\u81ea\u5df1\u7684\u865a\u62df\u673a\u4e0a\u5b8c\u6210\u3002\u4ee5\u4e0b\u8d44\u6e90\u53ef\u4ee5\u4f7f\u7528\uff1a VMware Workstation 15.5 \u8f6f\u4ef6 Linux 101 \u63d0\u4f9b\u7684 Xubuntu \u865a\u62df\u673a\u955c\u50cf \u51c6\u5907\u5de5\u4f5c \u00b6 \u4f60\u9700\u8981\u4e00\u4e2a C \u7f16\u8bd1\u5668\u548c\u6700\u57fa\u672c\u7684 C \u8bed\u8a00\u5e93\uff0c\u76f8\u4fe1\u4f60\u5df2\u7ecf\u5728\u524d\u51e0\u4e2a\u5b9e\u9a8c\u4e2d\u4f7f\u7528\u719f\u7ec3\u4e86\uff0c\u56e0\u6b64\u7565\u8fc7\u3002 Linux \u5bb9\u5668\u7684\u5178\u578b\u5b9e\u73b0\u4f7f\u7528\u4e86\u81f3\u5c11\u4e94\u79cd\u7279\u6027\uff1a \u547d\u540d\u7a7a\u95f4\uff08namespaces\uff09 \u3001 pivot_root \u3001 \u80fd\u529b\uff08capabilities\uff09 \u3001 SecComp\uff08Secure Computing\uff09 \u548c Cgroup\uff08Control Groups\uff09 \u5176\u4e2d\uff0c\u547d\u540d\u7a7a\u95f4\u4f7f\u7528 clone(2) \u548c unshare(2) \u7684 flags \u6765\u5b8c\u6210\uff0ccgroup \u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf\u7684 API\uff08\u5373\u901a\u8fc7\u521b\u5efa\u5220\u9664\u76ee\u5f55\u548c\u8bfb\u5199\u6587\u4ef6\u7684\u65b9\u5f0f\u4e0e cgroup \u7cfb\u7edf\u4ea4\u4e92\uff09\uff0c\u800c seccomp \u548c capabilities \u4f7f\u7528\u539f\u751f\u7684\u7cfb\u7edf\u8c03\u7528\uff08\u8be5\u7cfb\u7edf\u8c03\u7528\u975e\u5e38\u590d\u6742\uff0c\u56e0\u6b64\u6211\u4eec\u4f7f\u7528\u76f8\u5173\u5e93\u6765\u5b8c\u6210\u8fd9\u4e24\u9879\u529f\u80fd\uff09\u3002 \u5728\u9605\u8bfb\u672c\u6b21\u5b9e\u9a8c\u6587\u6863\u524d\uff0c\u4f60\u9700\u8981\u7406\u89e3\u5982 fork(2) \u8fd9\u6837\u7684\u8868\u8fbe\u65b9\u5f0f\u3002\u4f60\u53ef\u4ee5\u53c2\u8003 Linux \u7528\u6237\u534f\u4f1a\u7684 Linux 101 \u8bb2\u4e49\u9644\u5f55\u4e2d\u7684 \u76f8\u5173\u7ae0\u8282 \u6765\u8fdb\u884c\u521d\u6b65\u7684\u4e86\u89e3\u3002 \u4e00\u4e2a\u91cd\u8981\u7684\u63d0\u793a\u662f\uff0c\u5b9e\u9a8c\u4e8c\u4e2d\u5b66\u4e60\u4f7f\u7528\u7684 strace \u5de5\u5177\u5728\u672c\u5b9e\u9a8c\u4e2d\u975e\u5e38\u6709\u5e2e\u52a9\u3002 \u5b9e\u9a8c\u5185\u5bb9 \u00b6 \u6784\u5efa\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff08rootfs\uff09 \u5728\u4f60\u51c6\u5907\u597d rootfs \u4e4b\u540e\uff0c\u53ef\u4ee5\u7f16\u8bd1\u8fd0\u884c\u8be5\u9875\u9762\u5e95\u90e8\u7684\u793a\u4f8b\u7a0b\u5e8f\u4f53\u9a8c\u201c\u5149\u6746\u5bb9\u5668\u201d\u3002\u4e0b\u9762\u7684\u5404\u9879\u4efb\u52a1\u662f\u5bf9\u5176\u8fdb\u884c\u4fee\u6539\u5347\u7ea7\uff08\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u81ea\u5df1\u4ece\u5934\u7f16\u5199\u4e00\u4e2a\uff09\u3002\u7531\u4e8e\u4e0b\u9762\u51e0\u4e2a\u9879\u76ee\u4e2d\u6709\u4e92\u76f8\u4f9d\u8d56\u7684\u4efb\u52a1\uff0c\u6216\u8005\u662f\u8fdb\u884c\u529f\u80fd\u4e0a\u7684\u9650\u5236\uff0c\u56e0\u6b64\u8bf7\u5c3d\u91cf\u6309\u987a\u5e8f\u5b8c\u6210\u3002 \u4f7f\u7528 clone(2) \u4ee3\u66ff fork(2)\uff0c\u5e76\u9694\u79bb\u547d\u540d\u7a7a\u95f4 \u5728\u5bb9\u5668\u4e2d\u4f7f\u7528 mount(2) \u4e0e mknod(2) \u6302\u8f7d\u5fc5\u8981\u7684\u6587\u4ef6\u7cfb\u7edf\u7ed3\u6784 \u4f7f\u7528 pivot_root(2) \u66ff\u4ee3 chroot(2) \u5b8c\u6210\u5bb9\u5668\u5185\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u5207\u6362 \u4f7f\u7528 libcap \u4e3a\u5bb9\u5668\u7f29\u51cf\u4e0d\u5fc5\u8981\u7684\u80fd\u529b\uff08capabilities\uff09 \u4f7f\u7528 libseccomp \u5bf9\u5bb9\u5668\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\u8fdb\u884c\u767d\u540d\u5355\u8fc7\u6ee4 \u4f7f\u7528 cgroup \u9650\u5236\u5bb9\u5668\u4e2d\u7684 CPU\u3001\u5185\u5b58\u4e0e\u8fdb\u7a0b\u6570 \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u8bf7\u6309\u7167\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\u7ec4\u7ec7\u4f60\u7684 GitHub \u4ed3\u5e93\uff1a (Git) // Git \u4ed3\u5e93\u76ee\u5f55 \u251c\u2500\u2500 lab4 // \u5b9e\u9a8c\u56db\u6839\u76ee\u5f55 \u2502 \u251c\u2500\u2500 *.c // \u4f60\u7684\u5bb9\u5668\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 *.cpp // \u4f60\u7684\u5bb9\u5668\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 *.go // \u4f60\u7684\u5bb9\u5668\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 *.rs // \u4f60\u7684\u5bb9\u5668\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 Makefile // \uff08\u53ef\u9009\uff09\u4f60\u63d0\u4f9b\u7684 Makefile \u2502 \u2514\u2500\u2500 README.md // \u7b80\u8981\u7684\u8bf4\u660e \u251c\u2500\u2500 .gitignore // \u8fd9\u4e24\u4e2a\u6587\u4ef6\u5728\u5b9e\u9a8c\u4e00\u7684\u6587\u6863\u91cc\u8bf4\u8fc7\u4e86 \u2514\u2500\u2500 README.md \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206\u4e3a 10 \u5206\uff0c\u4f60\u9700\u8981\u5b8c\u6210\uff1a \u4f7f\u7528 Linux \u547d\u540d\u7a7a\u95f4\u9694\u79bb\u5b50\u8fdb\u7a0b\u7684\u7279\u6027\uff08\u4e0d\u8981\u6c42\u9694\u79bb\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u3001\u7528\u6237\u547d\u540d\u7a7a\u95f4\u4e0e\u65f6\u95f4\u547d\u540d\u7a7a\u95f4\uff09\uff081 \u5206\uff09 \u6b63\u786e\u6302\u8f7d\u5bb9\u5668\u5185\u7684 /proc , /sys , /tmp , /dev \uff0c\u5e76\u5728 /dev \u4e0b\u521b\u5efa\u5fc5\u8981\u7684\u8282\u70b9\uff083 \u5206\uff09 \u4f7f\u7528 pivot_root(2) \u66ff\u4ee3 chroot(2) \u5b8c\u6210\u5bb9\u5668\u5185\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u5207\u6362\uff0c\u5e76\u4ece\u4e3b\u673a\u4e0a\u9690\u85cf\u5bb9\u5668\u7684\u6302\u8f7d\u70b9\uff084 \u5206\uff09 \u4e3a\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u79fb\u9664\u4e00\u4e9b\u80fd\u529b\uff08drop capabilities\uff09\uff082 \u5206\uff09 \u4f7f\u7528 SecComp \u9650\u5236\u5bb9\u5668\u4e2d\u80fd\u591f\u8fdb\u884c\u7684\u7cfb\u7edf\u8c03\u7528\uff082 \u5206\uff09 \u4f7f\u7528 cgroup \u9650\u5236\u5bb9\u5668\u4e2d\u7684\u7cfb\u7edf\u8d44\u6e90\u4f7f\u7528\uff0c\u5e76\u5728\u5bb9\u5668\u4e2d\u6309\u8981\u6c42\u6302\u8f7d\u4e09\u4e2a cgroup \u63a7\u5236\u5668\uff082 \u5206\uff09 \u5b8c\u6210\u601d\u8003\u9898\uff082 \u5206\uff09 \u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 C / C++ / Go / Rust \u8bed\u8a00\u5b8c\u6210\uff0c\u63a8\u8350\u4f7f\u7528 C \u6216 C++ \u8bed\u8a00\u3002\u4f7f\u7528\u5176\u4ed6\u7f16\u7a0b\u8bed\u8a00\u524d\u8bf7\u8be2\u95ee\u52a9\u6559\u3002\u65b9\u4fbf\u8d77\u89c1\uff0c\u4f60\u7684\u7a0b\u5e8f\u5e94\u5f53\u652f\u6301\u4e0b\u9762\u7684\u547d\u4ee4\u884c\u53c2\u6570\uff1a ./lab4 <rootfs> <command> [ args... ] \u5373 argv[1] \u8868\u793a rootfs \u7684\u8def\u5f84\uff08\u6ca1\u6709 / \u7ed3\u5c3e\uff09\uff0c argv[2] \u5f00\u59cb\u8868\u793a\u4f5c\u4e3a\u5bb9\u5668\u4e2d\u7684 PID 1 \u8fd0\u884c\u7684\u7a0b\u5e8f\u53ca\u53c2\u6570\uff0c\u53ef\u4ee5\u5047\u8bbe argc \u2265 3\uff08\u5728 argc < 3 \u65f6\u4f60\u53ef\u4ee5\u9009\u62e9\u76f4\u63a5\u62a5\u9519\uff0c\u4f46\u8bf7\u5c3d\u91cf\u907f\u514d\u5f02\u5e38\u9000\u51fa\uff0c\u5982\u6570\u7ec4\u8d8a\u754c\u7b49\uff09\u3002 \u9664\u4e86\u8fd0\u884c\u5bb9\u5668\u4e2d\u7684\u7b2c\u4e00\u4e2a\u7a0b\u5e8f\uff08\u5373\u5bb9\u5668\u4e2d\u7684 PID 1\uff0c\u5e94\u7531\u547d\u4ee4\u884c\u7ed9\u51fa\uff09\u4e4b\u5916\uff0c\u4f60\u7684\u7a0b\u5e8f\u4e0d\u5e94\u8be5\u8c03\u7528\u5176\u4ed6\u7a0b\u5e8f\u6765\u5b8c\u6210\u4efb\u4f55\u529f\u80fd\u3002\u4f60\u53ef\u4ee5\u5c06\u300c\u8c03\u7528\u5176\u4ed6\u7a0b\u5e8f\u300d\u7406\u89e3\u4e3a\u300c\u9664\u4e86\u8fd0\u884c\u76ee\u6807\u547d\u4ee4\u4e4b\u5916\u7684 execve \u7cfb\u7edf\u8c03\u7528\u300d\u3002\u8bf7\u6ce8\u610f\uff0c\u4e00\u4e9b\u5e93\u51fd\u6570\uff08\u5982 system(3) \u548c popen(3) \u7b49\uff09\u90fd\u4f1a\u8c03\u7528\u989d\u5916\u7684\u7a0b\u5e8f\uff0c\u8fd9\u4e9b\u8c03\u7528\u8fc7\u7a0b\u901a\u5e38\u5305\u542b\u4e86 fork+execve \u7684\u7cfb\u7edf\u8c03\u7528\u3002 \u4e0e\u5b9e\u9a8c\u4e8c\u548c\u4e09\u76f8\u4f3c\uff0c\u672c\u5b9e\u9a8c\u4e0d\u8981\u6c42\u5b9e\u9a8c\u62a5\u544a\uff0c\u4f46\u662f\u63a8\u8350\u7b80\u5355\u63cf\u8ff0\u4f60\u7684\u5b9e\u73b0\uff0c\u5e76\u5bf9\u4f60\u4f7f\u7528\u7684\u300c\u5947\u6280\u6deb\u5de7\u300d\u7b80\u5355\u4ecb\u7ecd\uff0c\u4ee5\u514d\u5bf9\u52a9\u6559\u9020\u6210\u8bef\u4f1a\u7b49\u3002 \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206\u4e3a 10 \u5206\uff0c\u4f46\u6839\u636e\u4ee5\u4e0a\u5185\u5bb9\uff0c\u5b9e\u9645\u53ef\u83b7\u5f97\u7684\u5206\u6570\u4e0a\u9650\u4e3a 16 \u5206\uff0c\u8d85\u51fa 10 \u5206\u7684\u90e8\u5206\u5c06\u51cf\u534a\u8ba1\u5165\u5b9e\u9a8c\u603b\u5206\u3002 \u4f8b\u5982\uff0c\u82e5\u4f60\u6839\u636e\u4ee5\u4e0a\u6807\u51c6\u83b7\u5f97\u4e86 16 \u5206\uff0c\u90a3\u4e48\u672c\u6b21\u5b9e\u9a8c\u8ba1\u5165\u603b\u5206\u7684\u5206\u6570\u4e3a 13 \u5206\uff0c\u8fd9\u5c06\u7b49\u4ef7\u4e8e\u672c\u8bfe\u7a0b\u603b\u8bc4\u6210\u7ee9\u7684 6.5 \u5206\u3002 \u601d\u8003\u9898 \u00b6 \u7528\u4e8e\u9650\u5236\u8fdb\u7a0b\u80fd\u591f\u8fdb\u884c\u7684\u7cfb\u7edf\u8c03\u7528\u7684 seccomp \u6a21\u5757\u5b9e\u9645\u4f7f\u7528\u7684\u7cfb\u7edf\u8c03\u7528\u662f\u54ea\u4e2a\uff1f\u7528\u4e8e\u63a7\u5236\u8fdb\u7a0b\u80fd\u529b\u7684 capabilities \u5b9e\u9645\u4f7f\u7528\u7684\u7cfb\u7edf\u8c03\u7528\u662f\u54ea\u4e2a\uff1f\u5c1d\u8bd5\u8bf4\u660e\u4e3a\u4ec0\u4e48\u672c\u6587\u6700\u4e0a\u9762\u8ba4\u4e3a\u300c\u8be5\u7cfb\u7edf\u8c03\u7528\u975e\u5e38\u590d\u6742\u300d\u3002 \u5f53\u4f60\u7528 cgroup \u9650\u5236\u4e86\u5bb9\u5668\u4e2d\u7684 CPU \u4e0e\u5185\u5b58\u7b49\u8d44\u6e90\u540e\uff0c\u5bb9\u5668\u4e2d\u7684\u6240\u6709\u8fdb\u7a0b\u90fd\u4e0d\u80fd\u591f\u8d85\u989d\u4f7f\u7528\u8d44\u6e90\uff0c\u4f46\u662f\u8bf8\u5982 htop \u7b49\u300c\u4efb\u52a1\u7ba1\u7406\u5668\u300d\u7c7b\u7684\u5de5\u5177\u4ecd\u7136\u4f1a\u663e\u793a\u4e3b\u673a\u4e0a\u7684\u5168\u90e8 CPU \u548c\u5185\u5b58\uff08\u5c3d\u7ba1\u65e0\u6cd5\u4f7f\u7528\uff09\u3002\u67e5\u627e\u8d44\u6599\uff0c\u8bf4\u660e\u539f\u56e0\uff0c\u5c1d\u8bd5 \u63d0\u51fa \u4e00\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u4f7f\u4efb\u52a1\u7ba1\u7406\u5668\u4e00\u7c7b\u7684\u7a0b\u5e8f\u80fd\u591f\u6b63\u786e\u663e\u793a\u88ab\u9650\u5236\u540e\u7684\u53ef\u7528 CPU \u548c\u5185\u5b58\uff08\u4e0d\u8981\u6c42\u5b9e\u73b0\uff09\u3002","title":"\u4ecb\u7ecd"},{"location":"lab-4/#lab-4","text":"\u5bb9\u5668 \u662f\u8fd1\u5e74\u6765\u975e\u5e38\u70ed\u95e8\u7684\u4e00\u4e2a\u6982\u5ff5\u3002\u5b83\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u63d0\u4f9b\u7684\u9694\u79bb\u6280\u672f\uff0c\u5b9e\u73b0\u8f7b\u91cf\u7ea7\u7684\u865a\u62df\u5316\u73af\u5883\u3002\u76ee\u524d\uff0c\u5b83\u5728\u8f6f\u4ef6\u7684\u5f00\u53d1\u3001\u90e8\u7f72\u7b49\u65b9\u9762\u6709\u7740\u975e\u5e38\u5e7f\u6cdb\u7684\u5e94\u7528\u3002 \u6700\u5e38\u89c1\u7684\u51e0\u79cd\u5bb9\u5668\uff0c\u5982 Docker\uff0c\u90fd\u5145\u5206\u5229\u7528\u4e86\u591a\u79cd Linux \u7684\u7279\u6027\uff0c\u56e0\u6b64\u6beb\u4e0d\u5938\u5f20\u5730\u8bf4\uff0c\u5bb9\u5668\u662f\u5c5e\u4e8e Linux \u7684\u3002\u672c\u5b9e\u9a8c\u4e2d\u6211\u4eec\u5c06\u52a8\u624b\u7f16\u5199\u4e00\u4e2a\u5bb9\u5668\u5b9e\u73b0\uff0c\u7406\u89e3 Linux \u4e2d\u7684\u5bb9\u5668\u6280\u672f\u3002 \u672c\u5b9e\u9a8c\u7531\u4e8e\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u6df1\u5ea6\u7ed3\u5408\uff0c\u56e0\u6b64\u65e0\u6cd5\u5728 vlab \u5e73\u53f0\u4e0a\u8fdb\u884c\uff0c\u8bf7\u540c\u5b66\u4eec\u5728\u81ea\u5df1\u7684\u865a\u62df\u673a\u4e0a\u5b8c\u6210\u3002\u4ee5\u4e0b\u8d44\u6e90\u53ef\u4ee5\u4f7f\u7528\uff1a VMware Workstation 15.5 \u8f6f\u4ef6 Linux 101 \u63d0\u4f9b\u7684 Xubuntu \u865a\u62df\u673a\u955c\u50cf","title":"Lab 4"},{"location":"lab-4/#_1","text":"\u4f60\u9700\u8981\u4e00\u4e2a C \u7f16\u8bd1\u5668\u548c\u6700\u57fa\u672c\u7684 C \u8bed\u8a00\u5e93\uff0c\u76f8\u4fe1\u4f60\u5df2\u7ecf\u5728\u524d\u51e0\u4e2a\u5b9e\u9a8c\u4e2d\u4f7f\u7528\u719f\u7ec3\u4e86\uff0c\u56e0\u6b64\u7565\u8fc7\u3002 Linux \u5bb9\u5668\u7684\u5178\u578b\u5b9e\u73b0\u4f7f\u7528\u4e86\u81f3\u5c11\u4e94\u79cd\u7279\u6027\uff1a \u547d\u540d\u7a7a\u95f4\uff08namespaces\uff09 \u3001 pivot_root \u3001 \u80fd\u529b\uff08capabilities\uff09 \u3001 SecComp\uff08Secure Computing\uff09 \u548c Cgroup\uff08Control Groups\uff09 \u5176\u4e2d\uff0c\u547d\u540d\u7a7a\u95f4\u4f7f\u7528 clone(2) \u548c unshare(2) \u7684 flags \u6765\u5b8c\u6210\uff0ccgroup \u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf\u7684 API\uff08\u5373\u901a\u8fc7\u521b\u5efa\u5220\u9664\u76ee\u5f55\u548c\u8bfb\u5199\u6587\u4ef6\u7684\u65b9\u5f0f\u4e0e cgroup \u7cfb\u7edf\u4ea4\u4e92\uff09\uff0c\u800c seccomp \u548c capabilities \u4f7f\u7528\u539f\u751f\u7684\u7cfb\u7edf\u8c03\u7528\uff08\u8be5\u7cfb\u7edf\u8c03\u7528\u975e\u5e38\u590d\u6742\uff0c\u56e0\u6b64\u6211\u4eec\u4f7f\u7528\u76f8\u5173\u5e93\u6765\u5b8c\u6210\u8fd9\u4e24\u9879\u529f\u80fd\uff09\u3002 \u5728\u9605\u8bfb\u672c\u6b21\u5b9e\u9a8c\u6587\u6863\u524d\uff0c\u4f60\u9700\u8981\u7406\u89e3\u5982 fork(2) \u8fd9\u6837\u7684\u8868\u8fbe\u65b9\u5f0f\u3002\u4f60\u53ef\u4ee5\u53c2\u8003 Linux \u7528\u6237\u534f\u4f1a\u7684 Linux 101 \u8bb2\u4e49\u9644\u5f55\u4e2d\u7684 \u76f8\u5173\u7ae0\u8282 \u6765\u8fdb\u884c\u521d\u6b65\u7684\u4e86\u89e3\u3002 \u4e00\u4e2a\u91cd\u8981\u7684\u63d0\u793a\u662f\uff0c\u5b9e\u9a8c\u4e8c\u4e2d\u5b66\u4e60\u4f7f\u7528\u7684 strace \u5de5\u5177\u5728\u672c\u5b9e\u9a8c\u4e2d\u975e\u5e38\u6709\u5e2e\u52a9\u3002","title":"\u51c6\u5907\u5de5\u4f5c"},{"location":"lab-4/#_2","text":"\u6784\u5efa\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff08rootfs\uff09 \u5728\u4f60\u51c6\u5907\u597d rootfs \u4e4b\u540e\uff0c\u53ef\u4ee5\u7f16\u8bd1\u8fd0\u884c\u8be5\u9875\u9762\u5e95\u90e8\u7684\u793a\u4f8b\u7a0b\u5e8f\u4f53\u9a8c\u201c\u5149\u6746\u5bb9\u5668\u201d\u3002\u4e0b\u9762\u7684\u5404\u9879\u4efb\u52a1\u662f\u5bf9\u5176\u8fdb\u884c\u4fee\u6539\u5347\u7ea7\uff08\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u81ea\u5df1\u4ece\u5934\u7f16\u5199\u4e00\u4e2a\uff09\u3002\u7531\u4e8e\u4e0b\u9762\u51e0\u4e2a\u9879\u76ee\u4e2d\u6709\u4e92\u76f8\u4f9d\u8d56\u7684\u4efb\u52a1\uff0c\u6216\u8005\u662f\u8fdb\u884c\u529f\u80fd\u4e0a\u7684\u9650\u5236\uff0c\u56e0\u6b64\u8bf7\u5c3d\u91cf\u6309\u987a\u5e8f\u5b8c\u6210\u3002 \u4f7f\u7528 clone(2) \u4ee3\u66ff fork(2)\uff0c\u5e76\u9694\u79bb\u547d\u540d\u7a7a\u95f4 \u5728\u5bb9\u5668\u4e2d\u4f7f\u7528 mount(2) \u4e0e mknod(2) \u6302\u8f7d\u5fc5\u8981\u7684\u6587\u4ef6\u7cfb\u7edf\u7ed3\u6784 \u4f7f\u7528 pivot_root(2) \u66ff\u4ee3 chroot(2) \u5b8c\u6210\u5bb9\u5668\u5185\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u5207\u6362 \u4f7f\u7528 libcap \u4e3a\u5bb9\u5668\u7f29\u51cf\u4e0d\u5fc5\u8981\u7684\u80fd\u529b\uff08capabilities\uff09 \u4f7f\u7528 libseccomp \u5bf9\u5bb9\u5668\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\u8fdb\u884c\u767d\u540d\u5355\u8fc7\u6ee4 \u4f7f\u7528 cgroup \u9650\u5236\u5bb9\u5668\u4e2d\u7684 CPU\u3001\u5185\u5b58\u4e0e\u8fdb\u7a0b\u6570","title":"\u5b9e\u9a8c\u5185\u5bb9"},{"location":"lab-4/#_3","text":"\u8bf7\u6309\u7167\u4ee5\u4e0b\u76ee\u5f55\u7ed3\u6784\u7ec4\u7ec7\u4f60\u7684 GitHub \u4ed3\u5e93\uff1a (Git) // Git \u4ed3\u5e93\u76ee\u5f55 \u251c\u2500\u2500 lab4 // \u5b9e\u9a8c\u56db\u6839\u76ee\u5f55 \u2502 \u251c\u2500\u2500 *.c // \u4f60\u7684\u5bb9\u5668\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 *.cpp // \u4f60\u7684\u5bb9\u5668\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 *.go // \u4f60\u7684\u5bb9\u5668\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 *.rs // \u4f60\u7684\u5bb9\u5668\u6e90\u4ee3\u7801 \u2502 \u251c\u2500\u2500 Makefile // \uff08\u53ef\u9009\uff09\u4f60\u63d0\u4f9b\u7684 Makefile \u2502 \u2514\u2500\u2500 README.md // \u7b80\u8981\u7684\u8bf4\u660e \u251c\u2500\u2500 .gitignore // \u8fd9\u4e24\u4e2a\u6587\u4ef6\u5728\u5b9e\u9a8c\u4e00\u7684\u6587\u6863\u91cc\u8bf4\u8fc7\u4e86 \u2514\u2500\u2500 README.md \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206\u4e3a 10 \u5206\uff0c\u4f60\u9700\u8981\u5b8c\u6210\uff1a \u4f7f\u7528 Linux \u547d\u540d\u7a7a\u95f4\u9694\u79bb\u5b50\u8fdb\u7a0b\u7684\u7279\u6027\uff08\u4e0d\u8981\u6c42\u9694\u79bb\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u3001\u7528\u6237\u547d\u540d\u7a7a\u95f4\u4e0e\u65f6\u95f4\u547d\u540d\u7a7a\u95f4\uff09\uff081 \u5206\uff09 \u6b63\u786e\u6302\u8f7d\u5bb9\u5668\u5185\u7684 /proc , /sys , /tmp , /dev \uff0c\u5e76\u5728 /dev \u4e0b\u521b\u5efa\u5fc5\u8981\u7684\u8282\u70b9\uff083 \u5206\uff09 \u4f7f\u7528 pivot_root(2) \u66ff\u4ee3 chroot(2) \u5b8c\u6210\u5bb9\u5668\u5185\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u5207\u6362\uff0c\u5e76\u4ece\u4e3b\u673a\u4e0a\u9690\u85cf\u5bb9\u5668\u7684\u6302\u8f7d\u70b9\uff084 \u5206\uff09 \u4e3a\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u79fb\u9664\u4e00\u4e9b\u80fd\u529b\uff08drop capabilities\uff09\uff082 \u5206\uff09 \u4f7f\u7528 SecComp \u9650\u5236\u5bb9\u5668\u4e2d\u80fd\u591f\u8fdb\u884c\u7684\u7cfb\u7edf\u8c03\u7528\uff082 \u5206\uff09 \u4f7f\u7528 cgroup \u9650\u5236\u5bb9\u5668\u4e2d\u7684\u7cfb\u7edf\u8d44\u6e90\u4f7f\u7528\uff0c\u5e76\u5728\u5bb9\u5668\u4e2d\u6309\u8981\u6c42\u6302\u8f7d\u4e09\u4e2a cgroup \u63a7\u5236\u5668\uff082 \u5206\uff09 \u5b8c\u6210\u601d\u8003\u9898\uff082 \u5206\uff09 \u672c\u5b9e\u9a8c\u53ef\u4ee5\u4f7f\u7528 C / C++ / Go / Rust \u8bed\u8a00\u5b8c\u6210\uff0c\u63a8\u8350\u4f7f\u7528 C \u6216 C++ \u8bed\u8a00\u3002\u4f7f\u7528\u5176\u4ed6\u7f16\u7a0b\u8bed\u8a00\u524d\u8bf7\u8be2\u95ee\u52a9\u6559\u3002\u65b9\u4fbf\u8d77\u89c1\uff0c\u4f60\u7684\u7a0b\u5e8f\u5e94\u5f53\u652f\u6301\u4e0b\u9762\u7684\u547d\u4ee4\u884c\u53c2\u6570\uff1a ./lab4 <rootfs> <command> [ args... ] \u5373 argv[1] \u8868\u793a rootfs \u7684\u8def\u5f84\uff08\u6ca1\u6709 / \u7ed3\u5c3e\uff09\uff0c argv[2] \u5f00\u59cb\u8868\u793a\u4f5c\u4e3a\u5bb9\u5668\u4e2d\u7684 PID 1 \u8fd0\u884c\u7684\u7a0b\u5e8f\u53ca\u53c2\u6570\uff0c\u53ef\u4ee5\u5047\u8bbe argc \u2265 3\uff08\u5728 argc < 3 \u65f6\u4f60\u53ef\u4ee5\u9009\u62e9\u76f4\u63a5\u62a5\u9519\uff0c\u4f46\u8bf7\u5c3d\u91cf\u907f\u514d\u5f02\u5e38\u9000\u51fa\uff0c\u5982\u6570\u7ec4\u8d8a\u754c\u7b49\uff09\u3002 \u9664\u4e86\u8fd0\u884c\u5bb9\u5668\u4e2d\u7684\u7b2c\u4e00\u4e2a\u7a0b\u5e8f\uff08\u5373\u5bb9\u5668\u4e2d\u7684 PID 1\uff0c\u5e94\u7531\u547d\u4ee4\u884c\u7ed9\u51fa\uff09\u4e4b\u5916\uff0c\u4f60\u7684\u7a0b\u5e8f\u4e0d\u5e94\u8be5\u8c03\u7528\u5176\u4ed6\u7a0b\u5e8f\u6765\u5b8c\u6210\u4efb\u4f55\u529f\u80fd\u3002\u4f60\u53ef\u4ee5\u5c06\u300c\u8c03\u7528\u5176\u4ed6\u7a0b\u5e8f\u300d\u7406\u89e3\u4e3a\u300c\u9664\u4e86\u8fd0\u884c\u76ee\u6807\u547d\u4ee4\u4e4b\u5916\u7684 execve \u7cfb\u7edf\u8c03\u7528\u300d\u3002\u8bf7\u6ce8\u610f\uff0c\u4e00\u4e9b\u5e93\u51fd\u6570\uff08\u5982 system(3) \u548c popen(3) \u7b49\uff09\u90fd\u4f1a\u8c03\u7528\u989d\u5916\u7684\u7a0b\u5e8f\uff0c\u8fd9\u4e9b\u8c03\u7528\u8fc7\u7a0b\u901a\u5e38\u5305\u542b\u4e86 fork+execve \u7684\u7cfb\u7edf\u8c03\u7528\u3002 \u4e0e\u5b9e\u9a8c\u4e8c\u548c\u4e09\u76f8\u4f3c\uff0c\u672c\u5b9e\u9a8c\u4e0d\u8981\u6c42\u5b9e\u9a8c\u62a5\u544a\uff0c\u4f46\u662f\u63a8\u8350\u7b80\u5355\u63cf\u8ff0\u4f60\u7684\u5b9e\u73b0\uff0c\u5e76\u5bf9\u4f60\u4f7f\u7528\u7684\u300c\u5947\u6280\u6deb\u5de7\u300d\u7b80\u5355\u4ecb\u7ecd\uff0c\u4ee5\u514d\u5bf9\u52a9\u6559\u9020\u6210\u8bef\u4f1a\u7b49\u3002 \u672c\u6b21\u5b9e\u9a8c\u6ee1\u5206\u4e3a 10 \u5206\uff0c\u4f46\u6839\u636e\u4ee5\u4e0a\u5185\u5bb9\uff0c\u5b9e\u9645\u53ef\u83b7\u5f97\u7684\u5206\u6570\u4e0a\u9650\u4e3a 16 \u5206\uff0c\u8d85\u51fa 10 \u5206\u7684\u90e8\u5206\u5c06\u51cf\u534a\u8ba1\u5165\u5b9e\u9a8c\u603b\u5206\u3002 \u4f8b\u5982\uff0c\u82e5\u4f60\u6839\u636e\u4ee5\u4e0a\u6807\u51c6\u83b7\u5f97\u4e86 16 \u5206\uff0c\u90a3\u4e48\u672c\u6b21\u5b9e\u9a8c\u8ba1\u5165\u603b\u5206\u7684\u5206\u6570\u4e3a 13 \u5206\uff0c\u8fd9\u5c06\u7b49\u4ef7\u4e8e\u672c\u8bfe\u7a0b\u603b\u8bc4\u6210\u7ee9\u7684 6.5 \u5206\u3002","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab-4/#_4","text":"\u7528\u4e8e\u9650\u5236\u8fdb\u7a0b\u80fd\u591f\u8fdb\u884c\u7684\u7cfb\u7edf\u8c03\u7528\u7684 seccomp \u6a21\u5757\u5b9e\u9645\u4f7f\u7528\u7684\u7cfb\u7edf\u8c03\u7528\u662f\u54ea\u4e2a\uff1f\u7528\u4e8e\u63a7\u5236\u8fdb\u7a0b\u80fd\u529b\u7684 capabilities \u5b9e\u9645\u4f7f\u7528\u7684\u7cfb\u7edf\u8c03\u7528\u662f\u54ea\u4e2a\uff1f\u5c1d\u8bd5\u8bf4\u660e\u4e3a\u4ec0\u4e48\u672c\u6587\u6700\u4e0a\u9762\u8ba4\u4e3a\u300c\u8be5\u7cfb\u7edf\u8c03\u7528\u975e\u5e38\u590d\u6742\u300d\u3002 \u5f53\u4f60\u7528 cgroup \u9650\u5236\u4e86\u5bb9\u5668\u4e2d\u7684 CPU \u4e0e\u5185\u5b58\u7b49\u8d44\u6e90\u540e\uff0c\u5bb9\u5668\u4e2d\u7684\u6240\u6709\u8fdb\u7a0b\u90fd\u4e0d\u80fd\u591f\u8d85\u989d\u4f7f\u7528\u8d44\u6e90\uff0c\u4f46\u662f\u8bf8\u5982 htop \u7b49\u300c\u4efb\u52a1\u7ba1\u7406\u5668\u300d\u7c7b\u7684\u5de5\u5177\u4ecd\u7136\u4f1a\u663e\u793a\u4e3b\u673a\u4e0a\u7684\u5168\u90e8 CPU \u548c\u5185\u5b58\uff08\u5c3d\u7ba1\u65e0\u6cd5\u4f7f\u7528\uff09\u3002\u67e5\u627e\u8d44\u6599\uff0c\u8bf4\u660e\u539f\u56e0\uff0c\u5c1d\u8bd5 \u63d0\u51fa \u4e00\u79cd\u89e3\u51b3\u65b9\u6848\uff0c\u4f7f\u4efb\u52a1\u7ba1\u7406\u5668\u4e00\u7c7b\u7684\u7a0b\u5e8f\u80fd\u591f\u6b63\u786e\u663e\u793a\u88ab\u9650\u5236\u540e\u7684\u53ef\u7528 CPU \u548c\u5185\u5b58\uff08\u4e0d\u8981\u6c42\u5b9e\u73b0\uff09\u3002","title":"\u601d\u8003\u9898"},{"location":"lab-4/capabilities/","text":"\u4e3a\u4f60\u7684\u5bb9\u5668\u7f29\u51cf\u4e0d\u5fc5\u8981\u7684\u80fd\u529b \u00b6 \u5728\u5b8c\u6210\u4e86\u4ee5\u4e0a\u51e0\u70b9\u8981\u6c42\uff0c\u521b\u5efa\u4e86\u5bb9\u5668\u4e4b\u540e\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff1a\u5c3d\u7ba1\u4f60\u5b9e\u73b0\u4e86\u4e0a\u6587\u63d0\u5230\u7684 5 \u79cd\u547d\u540d\u7a7a\u95f4\u9694\u79bb\uff0c\u4f60\u7684\u300c\u5bb9\u5668\u300d\u4e2d\u7684\u8fdb\u7a0b\uff08\u5728 root \u6743\u9650\u4e0b\uff09\u4ecd\u7136\u53ef\u4ee5\u505a\u4e00\u4e9b\u8d8a\u754c\u7684\u4e8b\u60c5\uff0c\u6bd4\u5982\u8bf4\uff1a \u4fee\u6539\u4e3b\u673a\u7684\u7cfb\u7edf\u65e5\u671f\u4e0e\u65f6\u95f4 \u4f7f\u7528 mknod \u521b\u5efa\u8bbe\u5907\u6587\u4ef6\uff0c\u5e76\u4e14\uff08\u4e0e\u4e3b\u673a\u4e00\u6837\uff09\u4efb\u610f\u8bfb\u5199\uff08\u8bf7\u4e0d\u8981\u5728\u4f60\u7684\u7535\u8111\u4e0a\u5c1d\u8bd5\uff01\uff09 \u4efb\u610f\u52a0\u8f7d\u3001\u5378\u8f7d\u5185\u6838\u6a21\u5757 \u901a\u8fc7 /sys \u4fee\u6539\u5185\u6838\u8bbe\u7f6e \u2026\u2026 \u672c\u8282 (capabilities) \u4e0e\u4e0b\u4e00\u8282 (seccomp) \u7684\u5185\u5bb9\u5c06\u5173\u6ce8\u7f29\u51cf\u5bb9\u5668\u4e2d\u7a0b\u5e8f\u7684\u6743\u9650\uff0c\u5b89\u5168\u5730\u6267\u884c\u7a0b\u5e8f\u3002 \u4ec0\u4e48\u662f\u80fd\u529b (capabilities)\uff1f \u00b6 \u4ece Linux 2.2 \u5f00\u59cb\uff0ccapabilities \u7684\u6982\u5ff5\u51fa\u73b0\uff0c\u7528\u4e8e\u66f4\u52a0\u7ec6\u5206\u7cfb\u7edf\u7ea7\u522b\u7684\u6743\u9650\u3002\u5728\u6b64\u4e4b\u524d\uff0c\u9700\u8981\u4f7f\u7528 root \u7ea7\u522b\u6743\u9650\u6267\u884c\u7cfb\u7edf\u7ea7\u4efb\u52a1\u7684\u7a0b\u5e8f\u9700\u8981\u83b7\u53d6\u5b8c\u6574\u7684 root \u6743\u9650\u624d\u884c\u3002\u4f46\u4e00\u90e8\u5206\u7a0b\u5e8f\u53ea\u9700\u8981\u8fd9\u4e9b\u6743\u9650\u4e2d\u5f88\u5c0f\u7684\u4e00\u90e8\u5206\uff08\u4f8b\u5982\u9700\u8981\u53d1\u9001\u539f\u59cb\u6570\u636e\u5305\u7684 ping \uff09\uff0c\u5c06\u5b83\u4eec\u4ee5 root \u6743\u9650\u8fd0\u884c\u5e26\u6765\u4e86\u5b89\u5168\u6027\u4e0a\u7684\u98ce\u9669\uff1a\u8fd9\u4e9b\u7a0b\u5e8f\u4e2d\u7684\u5c0f\u7f3a\u9677\uff0c\u4f1a\u5bfc\u81f4\u653b\u51fb\u8005\u83b7\u5f97\u5b8c\u6574\u7684 root \u6743\u9650\u3002 \u5728 capabilities \u51fa\u73b0\u4e4b\u540e\uff0c\u8fd9\u6837\u7684\u60c5\u51b5\u6709\u4e86\u6539\u5584\u3002Capabilities \u5c06 root \u6743\u9650\u8fdb\u4e00\u6b65\u7ec6\u5206\uff0c\u53ea\u9700\u8981\u7ed9\u7a0b\u5e8f\u6388\u4e88\u5fc5\u9700\u7684\u6743\u9650\uff08\u201c\u80fd\u529b\u201d\uff09\uff0c\u5373\u4f7f\u4e0d\u4ee5 root \u7528\u6237\u8fd0\u884c\uff0c\u4e5f\u53ef\u4ee5\u5b8c\u6210\u4efb\u52a1\uff0c\u63d0\u9ad8\u4e86\u7cfb\u7edf\u7684\u5b89\u5168\u6027\u3002\u540c\u6837\uff0c\u5bf9\u4e8e\u4ee5 root \u7528\u6237\u6267\u884c\u7684\u7a0b\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e22\u5f03\u6743\u9650\uff0c\u51cf\u5c0f\u653b\u51fb\u9762\u3002\u5b9e\u9645\u4e0a\uff0c\u4e00\u4e2a\u62e5\u6709\u5168\u90e8 capabilities \u7684\u7a0b\u5e8f\u4e0e\u771f\u5b9e\u7684 root \u7528\u6237\u51e0\u4e4e\u6ca1\u6709\u533a\u522b\u3002 \u6709\u5173 capabilities \u7684\u5217\u8868\u7b49\u66f4\u591a\u4fe1\u606f\uff0c\u53ef\u4ee5\u5230 man 7 capabilities \u67e5\u770b\u3002 \u5982\u4f55\u9650\u5236\u5bb9\u5668\u4e2d\u8fdb\u7a0b\u7684\u80fd\u529b\uff1f \u00b6 \u53ef\u4ee5\u4f7f\u7528 libcap \u5e93\u6765\u8fdb\u884c\u9650\u5236,\u4f7f\u7528 man libcap \u67e5\u770b\u5e93\u51fd\u6570\u4e0e\u94fe\u63a5\u65b9\u5f0f\u3002 \u6216\u8005\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 libcap-ng \u5e93\u6765\u8fdb\u884c\u9650\u5236\uff08\u66f4\u7b80\u5355\uff09\u3002\u4f7f\u7528\u65b9\u6cd5\u53ef\u53c2\u89c1 https://people.redhat.com/sgrubb/libcap-ng/ \u3002 \u4e24\u4e2a\u5e93\u53ef\u4ee5\u5206\u522b\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5\uff08Ubuntu\uff09\uff1a sudo apt install libcap-dev sudo apt install libcap-ng-dev \u5982\u679c\u4f60\u4f7f\u7528\u4e86 libcap\uff0c\u90a3\u4e48\u7f16\u8bd1\u65f6\u9700\u8981\u52a0\u4e0a\u94fe\u63a5\u53c2\u6570 -lcap \uff1b\u540c\u7406\uff0c\u5bf9\u4e8e libcap-ng\uff0c\u9700\u8981\u52a0\u4e0a\u94fe\u63a5\u53c2\u6570 -lcap-ng \u3002 \u63d0\u793a\uff1a\u4f60\u53ef\u80fd\u9700\u8981\u9605\u8bfb man 7 capabilities \u4e86\u89e3 capability set \u7684\u76f8\u5173\u8d44\u6599\u3002\u6b64\u5916\uff0c libcap \u9644\u5e26\u4e00\u4e2a\u547d\u4ee4\u884c\u5de5\u5177 capsh \uff0c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u68c0\u67e5\u80fd\u529b\u8bbe\u7f6e\u662f\u5426\u6b63\u786e\u3002 \u6211\u9700\u8981\u9650\u5236\u54ea\u4e9b\u80fd\u529b\uff1f \u00b6 \u5728\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 \u767d\u540d\u5355 \u7684\u65b9\u5f0f\u9650\u5236\u80fd\u529b\uff0c\u5373\u4e22\u5f03\u9664\u767d\u540d\u5355\u4e2d\u80fd\u529b\u4ee5\u5916\u7684\u5176\u4ed6\u6240\u6709\u80fd\u529b\u3002\u767d\u540d\u5355\u53c2\u8003 Docker \u7684\u9ed8\u8ba4\u914d\u7f6e \u5982\u4e0b\uff1a Capability \uff08\u4e2d\u6587\u7ffb\u8bd1\u540e\u7684\uff09\u63cf\u8ff0 SETPCAP \u4fee\u6539\u8fdb\u7a0b\u7684\u300c\u80fd\u529b\u300d MKNOD \u4f7f\u7528 mknod(2) \u521b\u5efa\u8bbe\u5907\u6587\u4ef6 AUDIT_WRITE \u5411\u5185\u6838\u5ba1\u8ba1\u65e5\u5fd7\u5199\u5165\u8bb0\u5f55 CHOWN \u4efb\u610f\u4fee\u6539\u6587\u4ef6\u7684 UID \u548c GID (\u53c2\u8003 chown(2)) NET_RAW \u4f7f\u7528 packet socket\uff0c\u6536\u53d1\u4efb\u610f\u6570\u636e\u5305 (\u53c2\u8003 packet(7)) DAC_OVERRIDE \u7ed5\u8fc7\u6587\u4ef6 rwx \u6743\u9650\u68c0\u67e5 FOWNER \u7ed5\u8fc7\u8981\u6c42\u8fdb\u7a0b\u7684 UID \u4e0e\u6587\u4ef6 UID \u4e00\u81f4\u7684\u68c0\u67e5 FSETID \u5728\u6587\u4ef6\u4fee\u6539\u65f6\u5141\u8bb8\u4e0d\u6e05\u9664 setuid \u548c setgid \u6743\u9650\u4f4d KILL \u7ed5\u8fc7\u53d1\u9001\u4fe1\u53f7\u65f6\u7684\u6743\u9650\u68c0\u67e5 SETGID \u4efb\u610f\u4fee\u6539\u8fdb\u7a0b\u7684 GID \u4e0e\u8f85\u52a9 GID \u5217\u8868 SETUID \u4efb\u610f\u4fee\u6539\u8fdb\u7a0b\u7684 UID NET_BIND_SERVICE \u5c06 TCP \u6216 UDP \u5957\u63a5\u5b57\u7ed1\u5b9a\u5230\u5c0f\u4e8e 1024 \u7684\u7aef\u53e3\uff08\u5373\u300c\u7279\u6743\u7aef\u53e3\u300d\uff09 SYS_CHROOT \u4f7f\u7528 chroot(2) SETFCAP \u8bbe\u7f6e\u6587\u4ef6\u7684\u300c\u80fd\u529b\u300d \u5728\u8fd9\u4efd\u767d\u540d\u5355\u7684\u57fa\u7840\u4e0a\uff0c\u4f60\u8fd8\u53ef\u4ee5\u518d\u5220\u9664\u4e00\u4e9b capabilities\u3002\u5982\u679c\u4f60\u8fd8\u5220\u9664\u4e86\u4ee5\u4e0a\u5217\u8868\u4e2d\u7684 capabilities\uff0c\u8bf7\u5728\u4f60\u4ed3\u5e93\u7684 README \u6587\u4ef6\u4e2d\u6ce8\u660e\u3002","title":"\u9650\u5236 capabilities"},{"location":"lab-4/capabilities/#_1","text":"\u5728\u5b8c\u6210\u4e86\u4ee5\u4e0a\u51e0\u70b9\u8981\u6c42\uff0c\u521b\u5efa\u4e86\u5bb9\u5668\u4e4b\u540e\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff1a\u5c3d\u7ba1\u4f60\u5b9e\u73b0\u4e86\u4e0a\u6587\u63d0\u5230\u7684 5 \u79cd\u547d\u540d\u7a7a\u95f4\u9694\u79bb\uff0c\u4f60\u7684\u300c\u5bb9\u5668\u300d\u4e2d\u7684\u8fdb\u7a0b\uff08\u5728 root \u6743\u9650\u4e0b\uff09\u4ecd\u7136\u53ef\u4ee5\u505a\u4e00\u4e9b\u8d8a\u754c\u7684\u4e8b\u60c5\uff0c\u6bd4\u5982\u8bf4\uff1a \u4fee\u6539\u4e3b\u673a\u7684\u7cfb\u7edf\u65e5\u671f\u4e0e\u65f6\u95f4 \u4f7f\u7528 mknod \u521b\u5efa\u8bbe\u5907\u6587\u4ef6\uff0c\u5e76\u4e14\uff08\u4e0e\u4e3b\u673a\u4e00\u6837\uff09\u4efb\u610f\u8bfb\u5199\uff08\u8bf7\u4e0d\u8981\u5728\u4f60\u7684\u7535\u8111\u4e0a\u5c1d\u8bd5\uff01\uff09 \u4efb\u610f\u52a0\u8f7d\u3001\u5378\u8f7d\u5185\u6838\u6a21\u5757 \u901a\u8fc7 /sys \u4fee\u6539\u5185\u6838\u8bbe\u7f6e \u2026\u2026 \u672c\u8282 (capabilities) \u4e0e\u4e0b\u4e00\u8282 (seccomp) \u7684\u5185\u5bb9\u5c06\u5173\u6ce8\u7f29\u51cf\u5bb9\u5668\u4e2d\u7a0b\u5e8f\u7684\u6743\u9650\uff0c\u5b89\u5168\u5730\u6267\u884c\u7a0b\u5e8f\u3002","title":"\u4e3a\u4f60\u7684\u5bb9\u5668\u7f29\u51cf\u4e0d\u5fc5\u8981\u7684\u80fd\u529b"},{"location":"lab-4/capabilities/#capabilities","text":"\u4ece Linux 2.2 \u5f00\u59cb\uff0ccapabilities \u7684\u6982\u5ff5\u51fa\u73b0\uff0c\u7528\u4e8e\u66f4\u52a0\u7ec6\u5206\u7cfb\u7edf\u7ea7\u522b\u7684\u6743\u9650\u3002\u5728\u6b64\u4e4b\u524d\uff0c\u9700\u8981\u4f7f\u7528 root \u7ea7\u522b\u6743\u9650\u6267\u884c\u7cfb\u7edf\u7ea7\u4efb\u52a1\u7684\u7a0b\u5e8f\u9700\u8981\u83b7\u53d6\u5b8c\u6574\u7684 root \u6743\u9650\u624d\u884c\u3002\u4f46\u4e00\u90e8\u5206\u7a0b\u5e8f\u53ea\u9700\u8981\u8fd9\u4e9b\u6743\u9650\u4e2d\u5f88\u5c0f\u7684\u4e00\u90e8\u5206\uff08\u4f8b\u5982\u9700\u8981\u53d1\u9001\u539f\u59cb\u6570\u636e\u5305\u7684 ping \uff09\uff0c\u5c06\u5b83\u4eec\u4ee5 root \u6743\u9650\u8fd0\u884c\u5e26\u6765\u4e86\u5b89\u5168\u6027\u4e0a\u7684\u98ce\u9669\uff1a\u8fd9\u4e9b\u7a0b\u5e8f\u4e2d\u7684\u5c0f\u7f3a\u9677\uff0c\u4f1a\u5bfc\u81f4\u653b\u51fb\u8005\u83b7\u5f97\u5b8c\u6574\u7684 root \u6743\u9650\u3002 \u5728 capabilities \u51fa\u73b0\u4e4b\u540e\uff0c\u8fd9\u6837\u7684\u60c5\u51b5\u6709\u4e86\u6539\u5584\u3002Capabilities \u5c06 root \u6743\u9650\u8fdb\u4e00\u6b65\u7ec6\u5206\uff0c\u53ea\u9700\u8981\u7ed9\u7a0b\u5e8f\u6388\u4e88\u5fc5\u9700\u7684\u6743\u9650\uff08\u201c\u80fd\u529b\u201d\uff09\uff0c\u5373\u4f7f\u4e0d\u4ee5 root \u7528\u6237\u8fd0\u884c\uff0c\u4e5f\u53ef\u4ee5\u5b8c\u6210\u4efb\u52a1\uff0c\u63d0\u9ad8\u4e86\u7cfb\u7edf\u7684\u5b89\u5168\u6027\u3002\u540c\u6837\uff0c\u5bf9\u4e8e\u4ee5 root \u7528\u6237\u6267\u884c\u7684\u7a0b\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e22\u5f03\u6743\u9650\uff0c\u51cf\u5c0f\u653b\u51fb\u9762\u3002\u5b9e\u9645\u4e0a\uff0c\u4e00\u4e2a\u62e5\u6709\u5168\u90e8 capabilities \u7684\u7a0b\u5e8f\u4e0e\u771f\u5b9e\u7684 root \u7528\u6237\u51e0\u4e4e\u6ca1\u6709\u533a\u522b\u3002 \u6709\u5173 capabilities \u7684\u5217\u8868\u7b49\u66f4\u591a\u4fe1\u606f\uff0c\u53ef\u4ee5\u5230 man 7 capabilities \u67e5\u770b\u3002","title":"\u4ec0\u4e48\u662f\u80fd\u529b (capabilities)\uff1f"},{"location":"lab-4/capabilities/#_2","text":"\u53ef\u4ee5\u4f7f\u7528 libcap \u5e93\u6765\u8fdb\u884c\u9650\u5236,\u4f7f\u7528 man libcap \u67e5\u770b\u5e93\u51fd\u6570\u4e0e\u94fe\u63a5\u65b9\u5f0f\u3002 \u6216\u8005\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 libcap-ng \u5e93\u6765\u8fdb\u884c\u9650\u5236\uff08\u66f4\u7b80\u5355\uff09\u3002\u4f7f\u7528\u65b9\u6cd5\u53ef\u53c2\u89c1 https://people.redhat.com/sgrubb/libcap-ng/ \u3002 \u4e24\u4e2a\u5e93\u53ef\u4ee5\u5206\u522b\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5\uff08Ubuntu\uff09\uff1a sudo apt install libcap-dev sudo apt install libcap-ng-dev \u5982\u679c\u4f60\u4f7f\u7528\u4e86 libcap\uff0c\u90a3\u4e48\u7f16\u8bd1\u65f6\u9700\u8981\u52a0\u4e0a\u94fe\u63a5\u53c2\u6570 -lcap \uff1b\u540c\u7406\uff0c\u5bf9\u4e8e libcap-ng\uff0c\u9700\u8981\u52a0\u4e0a\u94fe\u63a5\u53c2\u6570 -lcap-ng \u3002 \u63d0\u793a\uff1a\u4f60\u53ef\u80fd\u9700\u8981\u9605\u8bfb man 7 capabilities \u4e86\u89e3 capability set \u7684\u76f8\u5173\u8d44\u6599\u3002\u6b64\u5916\uff0c libcap \u9644\u5e26\u4e00\u4e2a\u547d\u4ee4\u884c\u5de5\u5177 capsh \uff0c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u68c0\u67e5\u80fd\u529b\u8bbe\u7f6e\u662f\u5426\u6b63\u786e\u3002","title":"\u5982\u4f55\u9650\u5236\u5bb9\u5668\u4e2d\u8fdb\u7a0b\u7684\u80fd\u529b\uff1f"},{"location":"lab-4/capabilities/#_3","text":"\u5728\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528 \u767d\u540d\u5355 \u7684\u65b9\u5f0f\u9650\u5236\u80fd\u529b\uff0c\u5373\u4e22\u5f03\u9664\u767d\u540d\u5355\u4e2d\u80fd\u529b\u4ee5\u5916\u7684\u5176\u4ed6\u6240\u6709\u80fd\u529b\u3002\u767d\u540d\u5355\u53c2\u8003 Docker \u7684\u9ed8\u8ba4\u914d\u7f6e \u5982\u4e0b\uff1a Capability \uff08\u4e2d\u6587\u7ffb\u8bd1\u540e\u7684\uff09\u63cf\u8ff0 SETPCAP \u4fee\u6539\u8fdb\u7a0b\u7684\u300c\u80fd\u529b\u300d MKNOD \u4f7f\u7528 mknod(2) \u521b\u5efa\u8bbe\u5907\u6587\u4ef6 AUDIT_WRITE \u5411\u5185\u6838\u5ba1\u8ba1\u65e5\u5fd7\u5199\u5165\u8bb0\u5f55 CHOWN \u4efb\u610f\u4fee\u6539\u6587\u4ef6\u7684 UID \u548c GID (\u53c2\u8003 chown(2)) NET_RAW \u4f7f\u7528 packet socket\uff0c\u6536\u53d1\u4efb\u610f\u6570\u636e\u5305 (\u53c2\u8003 packet(7)) DAC_OVERRIDE \u7ed5\u8fc7\u6587\u4ef6 rwx \u6743\u9650\u68c0\u67e5 FOWNER \u7ed5\u8fc7\u8981\u6c42\u8fdb\u7a0b\u7684 UID \u4e0e\u6587\u4ef6 UID \u4e00\u81f4\u7684\u68c0\u67e5 FSETID \u5728\u6587\u4ef6\u4fee\u6539\u65f6\u5141\u8bb8\u4e0d\u6e05\u9664 setuid \u548c setgid \u6743\u9650\u4f4d KILL \u7ed5\u8fc7\u53d1\u9001\u4fe1\u53f7\u65f6\u7684\u6743\u9650\u68c0\u67e5 SETGID \u4efb\u610f\u4fee\u6539\u8fdb\u7a0b\u7684 GID \u4e0e\u8f85\u52a9 GID \u5217\u8868 SETUID \u4efb\u610f\u4fee\u6539\u8fdb\u7a0b\u7684 UID NET_BIND_SERVICE \u5c06 TCP \u6216 UDP \u5957\u63a5\u5b57\u7ed1\u5b9a\u5230\u5c0f\u4e8e 1024 \u7684\u7aef\u53e3\uff08\u5373\u300c\u7279\u6743\u7aef\u53e3\u300d\uff09 SYS_CHROOT \u4f7f\u7528 chroot(2) SETFCAP \u8bbe\u7f6e\u6587\u4ef6\u7684\u300c\u80fd\u529b\u300d \u5728\u8fd9\u4efd\u767d\u540d\u5355\u7684\u57fa\u7840\u4e0a\uff0c\u4f60\u8fd8\u53ef\u4ee5\u518d\u5220\u9664\u4e00\u4e9b capabilities\u3002\u5982\u679c\u4f60\u8fd8\u5220\u9664\u4e86\u4ee5\u4e0a\u5217\u8868\u4e2d\u7684 capabilities\uff0c\u8bf7\u5728\u4f60\u4ed3\u5e93\u7684 README \u6587\u4ef6\u4e2d\u6ce8\u660e\u3002","title":"\u6211\u9700\u8981\u9650\u5236\u54ea\u4e9b\u80fd\u529b\uff1f"},{"location":"lab-4/cgroup/","text":"\u9650\u5236\u5bb9\u5668\u4e2d\u7684 CPU\u3001\u5185\u5b58\u4e0e\u8fdb\u7a0b\u6570 \u00b6 \u5230\u8fd9\u91cc\uff0c\u4f60\u53ef\u80fd\u5df2\u7ecf\u5b8c\u6210\u4e86\u4e00\u4e2a\u770b\u8d77\u6765\u8fd8\u4e0d\u9519\u7684\u5bb9\u5668\u3002\u4f46\u6211\u4eec\u8fd8\u7f3a\u5c11\u6700\u540e\u4e00\u5757\u62fc\u56fe\uff1a\u5982\u679c\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u75af\u72c2\u5360\u7528\u7cfb\u7edf\u8d44\u6e90\u7684\u8bdd\uff0c\u53ef\u80fd\u4f1a\u8ba9\u4e3b\u673a\u4e0d\u53ef\u7528\uff08\u5178\u578b\u7684\u4f8b\u5b50\u662f fork \u70b8\u5f39\uff09\u3002\u6211\u4eec\u5e94\u8be5\u5982\u4f55\u8fdb\u884c\u9650\u5236\u5462\uff1f \u5bf9\u4e8e\u5355\u8fdb\u7a0b\u7684\u573a\u5408\u6765\u8bf4\uff0c setrlimit() \u53ef\u4ee5\u7528\u6765\u9650\u5236\u7cfb\u7edf\u8d44\u6e90\u7684\u5360\u7528\uff0c\u4f46\u662f\u5bf9\u4e8e\u5bb9\u5668\u6765\u8bf4\uff0c\u4f7f\u7528 setrlimit() \u5c31\u5f88\u6349\u895f\u89c1\u8098\u4e86\u3002\u5c3d\u7ba1 setrlimit \u7684\u6587\u6863\u58f0\u79f0 \"A child process created via fork(2) inherits its parent's resource limits.\"\uff0c\u7136\u800c\u8fd9\u4e0d\u4ee3\u8868\u7236\u8fdb\u7a0b\u548c\u5b83\u7684\u5b50\u8fdb\u7a0b\u4eec\u4f1a\u5171\u4eab\u76f8\u540c\u7684\u8d44\u6e90\u9650\u5236\u3002\u4ec5\u4ec5\u662f\u5b83\u4eec\u7684\u8d44\u6e90\u9650\u5236\u7684\u91cf\u662f\u76f8\u540c\u7684\u3002\u8fd9\u610f\u5473\u7740\u8fd9\u6837\u7684\u60c5\u51b5\uff1a\u5982\u679c\u4f60\u9650\u5236\u5bb9\u5668\u4e3b\u8fdb\u7a0b\u53ea\u80fd\u4f7f\u7528 2 GiB \u5185\u5b58\uff0c\u5b83\u521b\u5efa\u4e86 2 \u4e2a\u5b50\u8fdb\u7a0b\uff0c\u90a3\u4e48\u4f60\u7684\u5185\u5b58\u53ef\u80fd\u4f1a\u88ab\u5403\u6389 6 GiB\uff08\u800c\u4e0d\u662f 2 GiB\uff09\u3002 \u5bf9\u4e8e\u9700\u8981\u9650\u5236\u4e00\u7ec4\u8fdb\u7a0b\u8d44\u6e90\u7684\u573a\u5408\uff0c\u4f7f\u7528 cgroup \u66f4\u52a0\u5408\u9002\u3002cgroup \u5728 Linux 2.6.24 \u88ab\u5f15\u5165\u4e3b\u7ebf\u7248\u672c\u3002 \u4f7f\u7528 cgroup \u00b6 \u4f7f\u7528\u547d\u4ee4\u884c\u5de5\u5177\u4f53\u9a8c \u00b6 Cgroup \u6709\u81ea\u5df1\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u5728 Ubuntu \u4e2d\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5 cgroup-tools \u8f6f\u4ef6\u5305\u6765\u83b7\u5f97\u3002\u5b89\u88c5\u597d\u540e\u6211\u4eec\u6765\u4f7f\u7528 cgroup-tools \u4e2d\u7684\u547d\u4ee4\u4f53\u9a8c\u4f7f\u7528 cgroup \u9650\u5236\u8fdb\u7a0b\u5185\u5b58\uff0c\u8fd9\u4e9b\u547d\u4ee4\u4e2d\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u9700\u8981\u4ee5 root \u7528\u6237\u8fd0\u884c\u3002 \u9996\u5148\uff0c\u5728 memory \u5206\u7c7b\u4e0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5b50\u63a7\u5236\u7ec4\uff1a cgcreate -g memory:test \u5728 test \u4e2d\u8bbe\u7f6e\u7528\u6237\u6001\u5185\u5b58\u9650\u5236\u4e3a 16 MiB\uff1a cgset -r memory.limit_in_bytes = 16777216 test \u5728\u65b0\u521b\u5efa\u7684\u63a7\u5236\u7ec4\u4e2d\u8fd0\u884c\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u4f8b\u5982 Python\uff1a cgexec -g memory:test python3 \u7136\u540e\u4f60\u5c31\u53ef\u4ee5\u5c1d\u8bd5\u7a81\u7834\u8fd9\u4e2a\u5185\u5b58\u9650\u5236\u4e86\uff0c\u4f8b\u5982\uff0c\u5728 64 \u4f4d\u7684\u7cfb\u7edf\u4e2d\uff0c\u5c1d\u8bd5\u521b\u5efa\u4e00\u4e2a\u542b\u6709 400 \u4e07\u4e2a\u5143\u7d20\u7684\u6570\u7ec4\u5373\u53ef\u5360\u7528\u81f3\u5c11 32 MB \u7684\u5185\u5b58\uff1a Python 3.8 . 2 ( default , Mar 13 2020 , 10 : 14 : 16 ) [ GCC 9.3 . 0 ] on linux Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> a = [ 0 ] * 4000000 \u6709\u65f6\u5019\u4f60\u4f1a\u53d1\u73b0\u8fd9\u4e2a\u8fdb\u7a0b\u4f3c\u4e4e\u8fd8\u5728\u8fd0\u884c\uff0c\u751a\u81f3\u8fd8\u80fd\u4f7f\u7528\u66f4\u591a\u5185\u5b58\uff0c\u4f46\u662f\u53cd\u5e94\u5341\u5206\u7f13\u6162\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u53ea\u9650\u5236\u4e86 \u5185\u5b58 \uff0c\u800c\u8d85\u51fa\u9650\u5236\u7684\u5185\u5b58\u88ab\u5185\u6838 \u4ea4\u6362 \uff08swap\uff09\u8fdb\u4e86\u786c\u76d8\u3002\u5982\u679c\u4f60\u6ca1\u6709\u9047\u5230\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u80fd\u662f\u56e0\u4e3a\u4f60\u7684\u7cfb\u7edf\u6ca1\u6709\u542f\u7528\u4ea4\u6362\u7a7a\u95f4\uff0c\u6b64\u65f6\u4f60\u53ef\u4ee5\u5ffd\u7565\u4e0b\u4e00\u6b65\u3002 \u6211\u4eec\u9700\u8981\u5bf9\u8fd9\u4e2a\u5b50 cgroup \u7981\u7528 swap\uff1a cgset -r memory.swappiness = 0 test \u518d\u6b21\u5c1d\u8bd5\u8fd0\u884c\u4e00\u4e2a\u5360\u7528\u5185\u5b58\u8d85\u8fc7 16 MiB \u7684\u7a0b\u5e8f\uff0c\u4f60\u4f1a\u53d1\u73b0\u5b83\u88ab\u6740\u6389\u4e86\uff0c\u8fd9\u8bf4\u660e cgroup \u7684\u8d44\u6e90\u9650\u5236\u8d77\u4f5c\u7528\u4e86\u3002 osh @ubuntu : ~ $ cgexec - g memory : test python3 Python 3.8 . 2 ( default , Mar 13 2020 , 10 : 14 : 16 ) [ GCC 9.3 . 0 ] on linux Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> a = [ 0 ] * 4000000 Killed osh @ubuntu : ~ $ echo $? 130 osh @ubuntu : ~ $ \u6d4b\u8bd5\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u5220\u9664\u521a\u624d\u521b\u5efa\u7684 cgroup\uff1a cgdelete memory:test \u5e95\u5c42\u7ec6\u8282 \u00b6 \u4e0e seccomp \u548c capabilities \u4e0d\u540c\uff0ccgroup \u5e76\u6ca1\u6709\u4e13\u95e8\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u800c\u662f\u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf\u7684 API\uff08\u4e5f\u5c31\u662f\u5217\u76ee\u5f55\u548c\u8bfb\u5199\u6587\u4ef6\u90a3\u4e9b\uff09\u6765\u8fdb\u884c\u4ea4\u4e92\u7684\u3002\u6240\u6709 cgroup \u7684\u7ed3\u6784\u90fd\u4f4d\u4e8e /sys/fs/cgroup \u4e0b\uff0c\u8be5\u8def\u5f84\u4e0b\u7684\u6240\u6709\u201c\u6587\u4ef6\u201d\u548c\u5176\u4ed6\u6240\u6709\u7528\u4f5c\u4e0e\u5185\u6838\u4ea4\u4e92\u7684\u63a5\u53e3\u7684\u201c\u6587\u4ef6\u201d\uff08\u5982 /proc \u548c /sys \u4e0b\u7684\uff09\u4e00\u6837\uff0c\u8bfb\u5199\u5b83\u5c31\u662f\u4e0e\u5185\u6838\u4e2d\u7684 cgroup \u63a7\u5236\u5668\u8fdb\u884c\u4ea4\u4e92\u3002\u5728\u4e00\u4e2a\u5178\u578b\u7684 Linux 5.x \u7cfb\u7edf\u4e2d\uff0c\u4f60\u53ef\u4ee5\u5728\u8be5\u76ee\u5f55\u4e0b\u770b\u5230\u4ee5\u4e0b\u9879\u76ee\uff1b blkio cpu,cpuacct cpuset freezer memory net_cls,net_prio perf_event rdma unified cpu cpuacct devices hugetlb net_cls net_prio pids systemd \u5176\u4e2d\u4e00\u4e9b\u9879\u76ee\u7684\u529f\u80fd\u5982\u4e0b\uff1a blkio\uff1a\u5373 Block I/O\uff0c\u63a7\u5236\u5757\u8bbe\u5907\uff08\u786c\u76d8\u7b49\uff09\u64cd\u4f5c cpu,cpuacct\uff1a\u5904\u7406\u5668\u4e0e\u5176\u6838\u7b97\uff0c\u63a7\u5236 CPU \u4f7f\u7528\u4e0e\u5206\u914d devices\uff1a\u63a7\u5236\u5bf9\u8bbe\u5907\u7684\u8bbf\u95ee memory\uff1a\u63a7\u5236\u5bf9\u5185\u5b58\u7684\u4f7f\u7528 pids\uff1a\u63a7\u5236 PID \u76f8\u5173\u8d44\u6e90 unified\uff1a\u8fd9\u662f\u7b2c\u4e8c\u4ee3 cgroup \u63a5\u53e3\uff0c\u4e0e\u5176\u4ed6\u6240\u6709\u5185\u5bb9\u4e0d\u540c\uff0c\u5728\u4e00\u4e2a\u6811\u4e2d\u63d0\u4f9b\u7684\u6240\u6709\u7684 cgroup \u63a7\u5236\u9009\u9879 \u6216\u8bb8\u4f60\u5df2\u7ecf\u731c\u5230\u4e86\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u5b50 cgroup \u5c31\u662f\u5728\u5408\u9002\u7684\u4f4d\u7f6e\u8fdb\u884c mkdir\uff0c\u800c\u8bbe\u7f6e\u6570\u503c\u5c31\u662f\u5411\u5176\u4e2d\u7684\u201c\u6587\u4ef6\u201d\u5199\u5165\u5185\u5bb9\u3002\u4e0b\u9762\u6211\u4eec\u629b\u5f03 cgroup-tools\uff0c\u4f7f\u7528\u6700\u666e\u901a\u7684\u547d\u4ee4\u884c\u5de5\u5177\u91cd\u590d\u4e00\u904d\u4e0a\u9762\u7684\u5de5\u4f5c\u3002 \u5728 memory \u7c7b\u522b\u4e0b\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a test \u7684 cgroup\u3002\u8bf7\u8bb0\u5f97\u5728\u4e0a\u4e00\u8282\u7684\u6700\u540e\u4e00\u6b65\u4e2d\u5220\u9664\u540d\u4e3a test \u7684 cgroup\uff0c\u5426\u5219\u8fd9\u91cc\u4f1a\u51fa\u73b0\u51b2\u7a81\u3002 mkdir /sys/fs/cgroup/memory/test \u5728\u65b0\u521b\u5efa\u7684 cgroup \u4e2d\u8bbe\u7f6e\u5185\u5b58\u4e0e\u4ea4\u6362\uff08swap\uff09\u9650\u5236\uff1a echo 16777216 > /sys/fs/cgroup/memory/test/memory.limit_in_bytes echo 0 > /sys/fs/cgroup/memory/test/memory.swappiness \u63a5\u4e0b\u6765\u7684\u95ee\u9898\u662f\uff0c\u6211\u4eec\u600e\u4e48\u6a21\u62df cgexec(1) \u5462\uff1f\u7b54\u6848\u662f\u65b0\u521b\u5efa\u7684\u76ee\u5f55\u4e2d\u7684 cgroup.procs \u6587\u4ef6\u3002\u8bfb\u53d6\u5b83\u4f1a\u83b7\u5f97\u5c5e\u4e8e\u8be5 cgroup \u7684\u6240\u6709\u8fdb\u7a0b\u7684 PID\uff0c\u800c\u5c06\u4e00\u4e2a\u8fdb\u7a0b\u7684 PID \u5199\u5165\u8fd9\u4e2a\u6587\u4ef6\uff0c\u5b9e\u9645\u4e0a\u5c31\u4f1a\u5c06\u5bf9\u5e94\u7684\u8fdb\u7a0b\u79fb\u81f3\u8be5 cgroup \u4e2d\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u5c06 python3 \u8fdb\u7a0b\u79fb\u5165\u8fd9\u4e2a\u5e26\u6709\u5185\u5b58\u9650\u5236\u7684 cgroup \u4e2d\uff0c\u6211\u4eec\u9996\u5148\u8981\u542f\u52a8\u5b83\uff0c\u5e76\u83b7\u5f97\u5b83\u7684 PID\uff1a Python 3.8 . 2 ( default , Mar 13 2020 , 10 : 14 : 16 ) [ GCC 9.3 . 0 ] on linux Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> import os >>> os . getpid () 888888 >>> \u5728\u4ee5\u4e0a\u793a\u4f8b\u4e2d\uff0cpython3 \u8fdb\u7a0b\u7684 PID \u4e3a 888888\u3002\u73b0\u5728\u65b0\u5f00\u4e00\u4e2a\u7ec8\u7aef\uff0c\u5c06\u8fd9\u4e2a\u6570\u5b57\u5199\u5165\u6b63\u786e\u7684\u6587\u4ef6\u4e2d\uff1b echo 888888 >> /sys/fs/cgroup/memory/test/cgroup.procs \u56de\u5230 python \u4e2d\uff0c\u5c1d\u8bd5\u5360\u7528\u8d85\u8fc7 16 MiB \u7684\u5185\u5b58\uff0c\u89c2\u5bdf python \u8fdb\u7a0b\u6709\u6ca1\u6709\u88ab\u6740\u6389\u3002 \u540c\u6837\uff0c\u5b9e\u9a8c\u7ed3\u675f\u540e\uff0c\u6211\u4eec\u8981\u6e05\u7406\u521a\u624d\u521b\u5efa\u7684 cgroup\uff1a rmdir /sys/fs/cgroup/memory/test \u8fd9\u91cc\u8fd8\u6709\u4e00\u4e2a\u5c0f\u95ee\u9898\u9700\u8981\u6ce8\u610f\uff0c\u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u5220\u9664\u4e00\u4e2a\u5b50 cgroup \u7684\u65f6\u5019\u8fd8\u6709\u8fdb\u7a0b\u88ab\u5b83\u63a7\u5236\u600e\u4e48\u529e\uff1f\u4e0d\u96be\u60f3\u5230\uff0c\u628a\u76f8\u5173\u8fdb\u7a0b\u5168\u90e8\u79fb\u51fa\u8fdb\u5bf9\u5e94\u7684\u7236 cgroup \u5373\u53ef\uff1a cat /sys/fs/cgroup/memory/test/cgroup.procs > /sys/fs/cgroup/memory/cgroup.procs \u5728\u5bb9\u5668\u4e2d\u6302\u8f7d cgroup \u63a7\u5236\u5668 \u00b6 \u6302\u8f7d cgroup \u63a7\u5236\u5668\u4e0e\u6302\u8f7d\u5176\u4ed6\u6587\u4ef6\u7cfb\u7edf\u5e76\u6ca1\u6709\u592a\u5927\u533a\u522b\uff0c\u4f46\u662f\u9700\u8981\u7528\u5230 mount \u4e00\u9875 \u4e2d\u7684\u4e00\u4e2a\u5c0f\u7ec6\u8282\uff08\u63d0\u793a\uff1a\u8bf7\u81ea\u5df1\u67e5\u9605\u8d44\u6599\uff09\u3002 \u6302\u8f7d cgroup \u63a7\u5236\u5668\u65f6\u9700\u8981\u6ce8\u610f\u7684\u4e00\u70b9\u662f\uff0ccgroup namespace \u4e2d\u770b\u5230\u7684\u300c\u6839 cgroup \u7ed3\u6784\u300d\u662f\u5728 \u521b\u5efa\u547d\u540d\u7a7a\u95f4\u65f6 \u8fdb\u7a0b\u6240\u5904\u7684 cgroup \u6811\u4e2d\u7684\u4f4d\u7f6e\uff0c\u800c\u4e0d\u662f \u6302\u8f7d\u65f6 \u6240\u5904\u7684\u4f4d\u7f6e\u3002\u4f8b\u5982\uff1a echo 8888 > /sys/fs/cgroup/example/test/cgroup.procs # \u8fdb\u7a0b 8888 \u521b\u5efa\u4e86\u4e00\u4e2a\u65b0 cgroup namespace echo 8888 > /sys/fs/cgroup/example/test2/cgroup.procs \u6b64\u65f6\u82e5\u8fdb\u7a0b 8888 \u6302\u8f7d\u4e86 example cgroup \u63a7\u5236\u5668\uff0c\u90a3\u4e48\u6302\u8f7d\u70b9\u663e\u793a\u7684\u5185\u5bb9\u4e3a example:/test \u7684\u5185\u5bb9\uff0c\u800c\u4e0d\u662f example:/test2 \u7684\u5185\u5bb9\u3002 \u4f60\u9700\u8981\u6b63\u786e\u5904\u7406\u5bb9\u5668\u300c\u770b\u5230\u7684\u6839 cgroup \u7ed3\u6784\u300d\u3002\u5224\u65ad\u5b9e\u73b0\u6b63\u786e\u7684\u4e00\u4e2a\u65b9\u6cd5\u662f\uff0c\u5728\u5bb9\u5668\u5185\u90e8\u67e5\u770b /proc/1/cgroup \uff0c\u82e5\u4e0a\u9762\u6d89\u53ca\u5230\u7684 3 \u4e2a\u63a7\u5236\u5668\u5bf9\u5e94\u7684\u884c\u90fd\u4ee5 :/ \u7ed3\u5c3e\uff0c\u90a3\u4e48\u53ef\u4ee5\u57fa\u672c\u8ba4\u4e3a\u662f\u6b63\u786e\u7684\u3002 \u5982\u679c\u4f60\u8ba4\u4e3a\u57fa\u4e8e clone(2) \u7684\u547d\u540d\u7a7a\u95f4\u9694\u79bb\u548c\u8def\u5f84\u5904\u7406\u8fc7\u4e8e\u590d\u6742\uff0c\u53ef\u4ee5\u56de\u5230 \u300a\u547d\u540d\u7a7a\u95f4\u300b\u8fd9\u4e00\u9875 \u770b\u770b\u6709\u6ca1\u6709\u5176\u4ed6\u7684\u60f3\u6cd5\u3002 \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u8bf7\u4e3a\u4f60\u7684\u5bb9\u5668\u9650\u5236\u4ee5\u4e0b\u5185\u5bb9\uff1a \u7528\u6237\u6001\u5185\u5b58\u4e0a\u9650\uff08\u63a8\u8350\u503c 64 MiB = 67108864\uff09 \u5185\u6838\u5185\u5b58\u4e0a\u9650\uff08\u540c\u6837\u63a8\u8350 64 MiB\uff0c\u63d0\u793a\uff1a\u5185\u6838\u5185\u5b58\u79f0\u4e3a kmem\uff09 \u7981\u7528\u4ea4\u6362\u7a7a\u95f4 \u8bbe\u7f6e CPU \u914d\u989d\uff08 cpu.shares \uff09\u4e3a 256 \u8bbe\u7f6e PID \u6570\u91cf\u4e0a\u9650\u4e3a 64 \u540c\u65f6\uff0c\u8bf7\u5728\u5bb9\u5668\u4e2d\u6302\u8f7d\u4e0a\u9762\u6d89\u53ca\u5230\u7684 3 \u4e2a cgroup \u63a7\u5236\u5668\uff0c\u4ee5\u4f7f\u5f97\u5bb9\u5668\u4e2d\u80fd\u591f\u6b63\u5e38\u4f7f\u7528\u5b83\u4eec\u3002\u4f60\u9700\u8981\u4fdd\u8bc1\u6302\u8f7d\u7684\u63a7\u5236\u5668\u770b\u5230\u7684\u300c\u6839 cgroup\u300d\u662f\u5bb9\u5668\u6240\u5728\u7684\u7ed3\u6784\uff08\u5373\u6b63\u786e\u9694\u79bb\u4e86 cgroup namespace\uff09\u3002 \u8bf7\u786e\u4fdd\u5f53\u4f60\u7684\u5bb9\u5668\u9000\u51fa\u65f6\u4f60\u521b\u5efa\u7684\u5b50 cgroup \u4e5f\u80fd\u591f\u6b63\u786e\u5220\u9664\u3002","title":"\u9650\u5236\u7cfb\u7edf\u8d44\u6e90"},{"location":"lab-4/cgroup/#cpu","text":"\u5230\u8fd9\u91cc\uff0c\u4f60\u53ef\u80fd\u5df2\u7ecf\u5b8c\u6210\u4e86\u4e00\u4e2a\u770b\u8d77\u6765\u8fd8\u4e0d\u9519\u7684\u5bb9\u5668\u3002\u4f46\u6211\u4eec\u8fd8\u7f3a\u5c11\u6700\u540e\u4e00\u5757\u62fc\u56fe\uff1a\u5982\u679c\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u75af\u72c2\u5360\u7528\u7cfb\u7edf\u8d44\u6e90\u7684\u8bdd\uff0c\u53ef\u80fd\u4f1a\u8ba9\u4e3b\u673a\u4e0d\u53ef\u7528\uff08\u5178\u578b\u7684\u4f8b\u5b50\u662f fork \u70b8\u5f39\uff09\u3002\u6211\u4eec\u5e94\u8be5\u5982\u4f55\u8fdb\u884c\u9650\u5236\u5462\uff1f \u5bf9\u4e8e\u5355\u8fdb\u7a0b\u7684\u573a\u5408\u6765\u8bf4\uff0c setrlimit() \u53ef\u4ee5\u7528\u6765\u9650\u5236\u7cfb\u7edf\u8d44\u6e90\u7684\u5360\u7528\uff0c\u4f46\u662f\u5bf9\u4e8e\u5bb9\u5668\u6765\u8bf4\uff0c\u4f7f\u7528 setrlimit() \u5c31\u5f88\u6349\u895f\u89c1\u8098\u4e86\u3002\u5c3d\u7ba1 setrlimit \u7684\u6587\u6863\u58f0\u79f0 \"A child process created via fork(2) inherits its parent's resource limits.\"\uff0c\u7136\u800c\u8fd9\u4e0d\u4ee3\u8868\u7236\u8fdb\u7a0b\u548c\u5b83\u7684\u5b50\u8fdb\u7a0b\u4eec\u4f1a\u5171\u4eab\u76f8\u540c\u7684\u8d44\u6e90\u9650\u5236\u3002\u4ec5\u4ec5\u662f\u5b83\u4eec\u7684\u8d44\u6e90\u9650\u5236\u7684\u91cf\u662f\u76f8\u540c\u7684\u3002\u8fd9\u610f\u5473\u7740\u8fd9\u6837\u7684\u60c5\u51b5\uff1a\u5982\u679c\u4f60\u9650\u5236\u5bb9\u5668\u4e3b\u8fdb\u7a0b\u53ea\u80fd\u4f7f\u7528 2 GiB \u5185\u5b58\uff0c\u5b83\u521b\u5efa\u4e86 2 \u4e2a\u5b50\u8fdb\u7a0b\uff0c\u90a3\u4e48\u4f60\u7684\u5185\u5b58\u53ef\u80fd\u4f1a\u88ab\u5403\u6389 6 GiB\uff08\u800c\u4e0d\u662f 2 GiB\uff09\u3002 \u5bf9\u4e8e\u9700\u8981\u9650\u5236\u4e00\u7ec4\u8fdb\u7a0b\u8d44\u6e90\u7684\u573a\u5408\uff0c\u4f7f\u7528 cgroup \u66f4\u52a0\u5408\u9002\u3002cgroup \u5728 Linux 2.6.24 \u88ab\u5f15\u5165\u4e3b\u7ebf\u7248\u672c\u3002","title":"\u9650\u5236\u5bb9\u5668\u4e2d\u7684 CPU\u3001\u5185\u5b58\u4e0e\u8fdb\u7a0b\u6570"},{"location":"lab-4/cgroup/#cgroup","text":"","title":"\u4f7f\u7528 cgroup"},{"location":"lab-4/cgroup/#_1","text":"Cgroup \u6709\u81ea\u5df1\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u5728 Ubuntu \u4e2d\u53ef\u4ee5\u901a\u8fc7\u5b89\u88c5 cgroup-tools \u8f6f\u4ef6\u5305\u6765\u83b7\u5f97\u3002\u5b89\u88c5\u597d\u540e\u6211\u4eec\u6765\u4f7f\u7528 cgroup-tools \u4e2d\u7684\u547d\u4ee4\u4f53\u9a8c\u4f7f\u7528 cgroup \u9650\u5236\u8fdb\u7a0b\u5185\u5b58\uff0c\u8fd9\u4e9b\u547d\u4ee4\u4e2d\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u9700\u8981\u4ee5 root \u7528\u6237\u8fd0\u884c\u3002 \u9996\u5148\uff0c\u5728 memory \u5206\u7c7b\u4e0b\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5b50\u63a7\u5236\u7ec4\uff1a cgcreate -g memory:test \u5728 test \u4e2d\u8bbe\u7f6e\u7528\u6237\u6001\u5185\u5b58\u9650\u5236\u4e3a 16 MiB\uff1a cgset -r memory.limit_in_bytes = 16777216 test \u5728\u65b0\u521b\u5efa\u7684\u63a7\u5236\u7ec4\u4e2d\u8fd0\u884c\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u4f8b\u5982 Python\uff1a cgexec -g memory:test python3 \u7136\u540e\u4f60\u5c31\u53ef\u4ee5\u5c1d\u8bd5\u7a81\u7834\u8fd9\u4e2a\u5185\u5b58\u9650\u5236\u4e86\uff0c\u4f8b\u5982\uff0c\u5728 64 \u4f4d\u7684\u7cfb\u7edf\u4e2d\uff0c\u5c1d\u8bd5\u521b\u5efa\u4e00\u4e2a\u542b\u6709 400 \u4e07\u4e2a\u5143\u7d20\u7684\u6570\u7ec4\u5373\u53ef\u5360\u7528\u81f3\u5c11 32 MB \u7684\u5185\u5b58\uff1a Python 3.8 . 2 ( default , Mar 13 2020 , 10 : 14 : 16 ) [ GCC 9.3 . 0 ] on linux Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> a = [ 0 ] * 4000000 \u6709\u65f6\u5019\u4f60\u4f1a\u53d1\u73b0\u8fd9\u4e2a\u8fdb\u7a0b\u4f3c\u4e4e\u8fd8\u5728\u8fd0\u884c\uff0c\u751a\u81f3\u8fd8\u80fd\u4f7f\u7528\u66f4\u591a\u5185\u5b58\uff0c\u4f46\u662f\u53cd\u5e94\u5341\u5206\u7f13\u6162\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u53ea\u9650\u5236\u4e86 \u5185\u5b58 \uff0c\u800c\u8d85\u51fa\u9650\u5236\u7684\u5185\u5b58\u88ab\u5185\u6838 \u4ea4\u6362 \uff08swap\uff09\u8fdb\u4e86\u786c\u76d8\u3002\u5982\u679c\u4f60\u6ca1\u6709\u9047\u5230\u8fd9\u4e2a\u95ee\u9898\uff0c\u53ef\u80fd\u662f\u56e0\u4e3a\u4f60\u7684\u7cfb\u7edf\u6ca1\u6709\u542f\u7528\u4ea4\u6362\u7a7a\u95f4\uff0c\u6b64\u65f6\u4f60\u53ef\u4ee5\u5ffd\u7565\u4e0b\u4e00\u6b65\u3002 \u6211\u4eec\u9700\u8981\u5bf9\u8fd9\u4e2a\u5b50 cgroup \u7981\u7528 swap\uff1a cgset -r memory.swappiness = 0 test \u518d\u6b21\u5c1d\u8bd5\u8fd0\u884c\u4e00\u4e2a\u5360\u7528\u5185\u5b58\u8d85\u8fc7 16 MiB \u7684\u7a0b\u5e8f\uff0c\u4f60\u4f1a\u53d1\u73b0\u5b83\u88ab\u6740\u6389\u4e86\uff0c\u8fd9\u8bf4\u660e cgroup \u7684\u8d44\u6e90\u9650\u5236\u8d77\u4f5c\u7528\u4e86\u3002 osh @ubuntu : ~ $ cgexec - g memory : test python3 Python 3.8 . 2 ( default , Mar 13 2020 , 10 : 14 : 16 ) [ GCC 9.3 . 0 ] on linux Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> a = [ 0 ] * 4000000 Killed osh @ubuntu : ~ $ echo $? 130 osh @ubuntu : ~ $ \u6d4b\u8bd5\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u5220\u9664\u521a\u624d\u521b\u5efa\u7684 cgroup\uff1a cgdelete memory:test","title":"\u4f7f\u7528\u547d\u4ee4\u884c\u5de5\u5177\u4f53\u9a8c"},{"location":"lab-4/cgroup/#_2","text":"\u4e0e seccomp \u548c capabilities \u4e0d\u540c\uff0ccgroup \u5e76\u6ca1\u6709\u4e13\u95e8\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u800c\u662f\u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf\u7684 API\uff08\u4e5f\u5c31\u662f\u5217\u76ee\u5f55\u548c\u8bfb\u5199\u6587\u4ef6\u90a3\u4e9b\uff09\u6765\u8fdb\u884c\u4ea4\u4e92\u7684\u3002\u6240\u6709 cgroup \u7684\u7ed3\u6784\u90fd\u4f4d\u4e8e /sys/fs/cgroup \u4e0b\uff0c\u8be5\u8def\u5f84\u4e0b\u7684\u6240\u6709\u201c\u6587\u4ef6\u201d\u548c\u5176\u4ed6\u6240\u6709\u7528\u4f5c\u4e0e\u5185\u6838\u4ea4\u4e92\u7684\u63a5\u53e3\u7684\u201c\u6587\u4ef6\u201d\uff08\u5982 /proc \u548c /sys \u4e0b\u7684\uff09\u4e00\u6837\uff0c\u8bfb\u5199\u5b83\u5c31\u662f\u4e0e\u5185\u6838\u4e2d\u7684 cgroup \u63a7\u5236\u5668\u8fdb\u884c\u4ea4\u4e92\u3002\u5728\u4e00\u4e2a\u5178\u578b\u7684 Linux 5.x \u7cfb\u7edf\u4e2d\uff0c\u4f60\u53ef\u4ee5\u5728\u8be5\u76ee\u5f55\u4e0b\u770b\u5230\u4ee5\u4e0b\u9879\u76ee\uff1b blkio cpu,cpuacct cpuset freezer memory net_cls,net_prio perf_event rdma unified cpu cpuacct devices hugetlb net_cls net_prio pids systemd \u5176\u4e2d\u4e00\u4e9b\u9879\u76ee\u7684\u529f\u80fd\u5982\u4e0b\uff1a blkio\uff1a\u5373 Block I/O\uff0c\u63a7\u5236\u5757\u8bbe\u5907\uff08\u786c\u76d8\u7b49\uff09\u64cd\u4f5c cpu,cpuacct\uff1a\u5904\u7406\u5668\u4e0e\u5176\u6838\u7b97\uff0c\u63a7\u5236 CPU \u4f7f\u7528\u4e0e\u5206\u914d devices\uff1a\u63a7\u5236\u5bf9\u8bbe\u5907\u7684\u8bbf\u95ee memory\uff1a\u63a7\u5236\u5bf9\u5185\u5b58\u7684\u4f7f\u7528 pids\uff1a\u63a7\u5236 PID \u76f8\u5173\u8d44\u6e90 unified\uff1a\u8fd9\u662f\u7b2c\u4e8c\u4ee3 cgroup \u63a5\u53e3\uff0c\u4e0e\u5176\u4ed6\u6240\u6709\u5185\u5bb9\u4e0d\u540c\uff0c\u5728\u4e00\u4e2a\u6811\u4e2d\u63d0\u4f9b\u7684\u6240\u6709\u7684 cgroup \u63a7\u5236\u9009\u9879 \u6216\u8bb8\u4f60\u5df2\u7ecf\u731c\u5230\u4e86\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u5b50 cgroup \u5c31\u662f\u5728\u5408\u9002\u7684\u4f4d\u7f6e\u8fdb\u884c mkdir\uff0c\u800c\u8bbe\u7f6e\u6570\u503c\u5c31\u662f\u5411\u5176\u4e2d\u7684\u201c\u6587\u4ef6\u201d\u5199\u5165\u5185\u5bb9\u3002\u4e0b\u9762\u6211\u4eec\u629b\u5f03 cgroup-tools\uff0c\u4f7f\u7528\u6700\u666e\u901a\u7684\u547d\u4ee4\u884c\u5de5\u5177\u91cd\u590d\u4e00\u904d\u4e0a\u9762\u7684\u5de5\u4f5c\u3002 \u5728 memory \u7c7b\u522b\u4e0b\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a test \u7684 cgroup\u3002\u8bf7\u8bb0\u5f97\u5728\u4e0a\u4e00\u8282\u7684\u6700\u540e\u4e00\u6b65\u4e2d\u5220\u9664\u540d\u4e3a test \u7684 cgroup\uff0c\u5426\u5219\u8fd9\u91cc\u4f1a\u51fa\u73b0\u51b2\u7a81\u3002 mkdir /sys/fs/cgroup/memory/test \u5728\u65b0\u521b\u5efa\u7684 cgroup \u4e2d\u8bbe\u7f6e\u5185\u5b58\u4e0e\u4ea4\u6362\uff08swap\uff09\u9650\u5236\uff1a echo 16777216 > /sys/fs/cgroup/memory/test/memory.limit_in_bytes echo 0 > /sys/fs/cgroup/memory/test/memory.swappiness \u63a5\u4e0b\u6765\u7684\u95ee\u9898\u662f\uff0c\u6211\u4eec\u600e\u4e48\u6a21\u62df cgexec(1) \u5462\uff1f\u7b54\u6848\u662f\u65b0\u521b\u5efa\u7684\u76ee\u5f55\u4e2d\u7684 cgroup.procs \u6587\u4ef6\u3002\u8bfb\u53d6\u5b83\u4f1a\u83b7\u5f97\u5c5e\u4e8e\u8be5 cgroup \u7684\u6240\u6709\u8fdb\u7a0b\u7684 PID\uff0c\u800c\u5c06\u4e00\u4e2a\u8fdb\u7a0b\u7684 PID \u5199\u5165\u8fd9\u4e2a\u6587\u4ef6\uff0c\u5b9e\u9645\u4e0a\u5c31\u4f1a\u5c06\u5bf9\u5e94\u7684\u8fdb\u7a0b\u79fb\u81f3\u8be5 cgroup \u4e2d\u3002\u56e0\u6b64\uff0c\u4e3a\u4e86\u5c06 python3 \u8fdb\u7a0b\u79fb\u5165\u8fd9\u4e2a\u5e26\u6709\u5185\u5b58\u9650\u5236\u7684 cgroup \u4e2d\uff0c\u6211\u4eec\u9996\u5148\u8981\u542f\u52a8\u5b83\uff0c\u5e76\u83b7\u5f97\u5b83\u7684 PID\uff1a Python 3.8 . 2 ( default , Mar 13 2020 , 10 : 14 : 16 ) [ GCC 9.3 . 0 ] on linux Type \"help\" , \"copyright\" , \"credits\" or \"license\" for more information . >>> import os >>> os . getpid () 888888 >>> \u5728\u4ee5\u4e0a\u793a\u4f8b\u4e2d\uff0cpython3 \u8fdb\u7a0b\u7684 PID \u4e3a 888888\u3002\u73b0\u5728\u65b0\u5f00\u4e00\u4e2a\u7ec8\u7aef\uff0c\u5c06\u8fd9\u4e2a\u6570\u5b57\u5199\u5165\u6b63\u786e\u7684\u6587\u4ef6\u4e2d\uff1b echo 888888 >> /sys/fs/cgroup/memory/test/cgroup.procs \u56de\u5230 python \u4e2d\uff0c\u5c1d\u8bd5\u5360\u7528\u8d85\u8fc7 16 MiB \u7684\u5185\u5b58\uff0c\u89c2\u5bdf python \u8fdb\u7a0b\u6709\u6ca1\u6709\u88ab\u6740\u6389\u3002 \u540c\u6837\uff0c\u5b9e\u9a8c\u7ed3\u675f\u540e\uff0c\u6211\u4eec\u8981\u6e05\u7406\u521a\u624d\u521b\u5efa\u7684 cgroup\uff1a rmdir /sys/fs/cgroup/memory/test \u8fd9\u91cc\u8fd8\u6709\u4e00\u4e2a\u5c0f\u95ee\u9898\u9700\u8981\u6ce8\u610f\uff0c\u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u5220\u9664\u4e00\u4e2a\u5b50 cgroup \u7684\u65f6\u5019\u8fd8\u6709\u8fdb\u7a0b\u88ab\u5b83\u63a7\u5236\u600e\u4e48\u529e\uff1f\u4e0d\u96be\u60f3\u5230\uff0c\u628a\u76f8\u5173\u8fdb\u7a0b\u5168\u90e8\u79fb\u51fa\u8fdb\u5bf9\u5e94\u7684\u7236 cgroup \u5373\u53ef\uff1a cat /sys/fs/cgroup/memory/test/cgroup.procs > /sys/fs/cgroup/memory/cgroup.procs","title":"\u5e95\u5c42\u7ec6\u8282"},{"location":"lab-4/cgroup/#cgroup_1","text":"\u6302\u8f7d cgroup \u63a7\u5236\u5668\u4e0e\u6302\u8f7d\u5176\u4ed6\u6587\u4ef6\u7cfb\u7edf\u5e76\u6ca1\u6709\u592a\u5927\u533a\u522b\uff0c\u4f46\u662f\u9700\u8981\u7528\u5230 mount \u4e00\u9875 \u4e2d\u7684\u4e00\u4e2a\u5c0f\u7ec6\u8282\uff08\u63d0\u793a\uff1a\u8bf7\u81ea\u5df1\u67e5\u9605\u8d44\u6599\uff09\u3002 \u6302\u8f7d cgroup \u63a7\u5236\u5668\u65f6\u9700\u8981\u6ce8\u610f\u7684\u4e00\u70b9\u662f\uff0ccgroup namespace \u4e2d\u770b\u5230\u7684\u300c\u6839 cgroup \u7ed3\u6784\u300d\u662f\u5728 \u521b\u5efa\u547d\u540d\u7a7a\u95f4\u65f6 \u8fdb\u7a0b\u6240\u5904\u7684 cgroup \u6811\u4e2d\u7684\u4f4d\u7f6e\uff0c\u800c\u4e0d\u662f \u6302\u8f7d\u65f6 \u6240\u5904\u7684\u4f4d\u7f6e\u3002\u4f8b\u5982\uff1a echo 8888 > /sys/fs/cgroup/example/test/cgroup.procs # \u8fdb\u7a0b 8888 \u521b\u5efa\u4e86\u4e00\u4e2a\u65b0 cgroup namespace echo 8888 > /sys/fs/cgroup/example/test2/cgroup.procs \u6b64\u65f6\u82e5\u8fdb\u7a0b 8888 \u6302\u8f7d\u4e86 example cgroup \u63a7\u5236\u5668\uff0c\u90a3\u4e48\u6302\u8f7d\u70b9\u663e\u793a\u7684\u5185\u5bb9\u4e3a example:/test \u7684\u5185\u5bb9\uff0c\u800c\u4e0d\u662f example:/test2 \u7684\u5185\u5bb9\u3002 \u4f60\u9700\u8981\u6b63\u786e\u5904\u7406\u5bb9\u5668\u300c\u770b\u5230\u7684\u6839 cgroup \u7ed3\u6784\u300d\u3002\u5224\u65ad\u5b9e\u73b0\u6b63\u786e\u7684\u4e00\u4e2a\u65b9\u6cd5\u662f\uff0c\u5728\u5bb9\u5668\u5185\u90e8\u67e5\u770b /proc/1/cgroup \uff0c\u82e5\u4e0a\u9762\u6d89\u53ca\u5230\u7684 3 \u4e2a\u63a7\u5236\u5668\u5bf9\u5e94\u7684\u884c\u90fd\u4ee5 :/ \u7ed3\u5c3e\uff0c\u90a3\u4e48\u53ef\u4ee5\u57fa\u672c\u8ba4\u4e3a\u662f\u6b63\u786e\u7684\u3002 \u5982\u679c\u4f60\u8ba4\u4e3a\u57fa\u4e8e clone(2) \u7684\u547d\u540d\u7a7a\u95f4\u9694\u79bb\u548c\u8def\u5f84\u5904\u7406\u8fc7\u4e8e\u590d\u6742\uff0c\u53ef\u4ee5\u56de\u5230 \u300a\u547d\u540d\u7a7a\u95f4\u300b\u8fd9\u4e00\u9875 \u770b\u770b\u6709\u6ca1\u6709\u5176\u4ed6\u7684\u60f3\u6cd5\u3002","title":"\u5728\u5bb9\u5668\u4e2d\u6302\u8f7d cgroup \u63a7\u5236\u5668"},{"location":"lab-4/cgroup/#_3","text":"\u8bf7\u4e3a\u4f60\u7684\u5bb9\u5668\u9650\u5236\u4ee5\u4e0b\u5185\u5bb9\uff1a \u7528\u6237\u6001\u5185\u5b58\u4e0a\u9650\uff08\u63a8\u8350\u503c 64 MiB = 67108864\uff09 \u5185\u6838\u5185\u5b58\u4e0a\u9650\uff08\u540c\u6837\u63a8\u8350 64 MiB\uff0c\u63d0\u793a\uff1a\u5185\u6838\u5185\u5b58\u79f0\u4e3a kmem\uff09 \u7981\u7528\u4ea4\u6362\u7a7a\u95f4 \u8bbe\u7f6e CPU \u914d\u989d\uff08 cpu.shares \uff09\u4e3a 256 \u8bbe\u7f6e PID \u6570\u91cf\u4e0a\u9650\u4e3a 64 \u540c\u65f6\uff0c\u8bf7\u5728\u5bb9\u5668\u4e2d\u6302\u8f7d\u4e0a\u9762\u6d89\u53ca\u5230\u7684 3 \u4e2a cgroup \u63a7\u5236\u5668\uff0c\u4ee5\u4f7f\u5f97\u5bb9\u5668\u4e2d\u80fd\u591f\u6b63\u5e38\u4f7f\u7528\u5b83\u4eec\u3002\u4f60\u9700\u8981\u4fdd\u8bc1\u6302\u8f7d\u7684\u63a7\u5236\u5668\u770b\u5230\u7684\u300c\u6839 cgroup\u300d\u662f\u5bb9\u5668\u6240\u5728\u7684\u7ed3\u6784\uff08\u5373\u6b63\u786e\u9694\u79bb\u4e86 cgroup namespace\uff09\u3002 \u8bf7\u786e\u4fdd\u5f53\u4f60\u7684\u5bb9\u5668\u9000\u51fa\u65f6\u4f60\u521b\u5efa\u7684\u5b50 cgroup \u4e5f\u80fd\u591f\u6b63\u786e\u5220\u9664\u3002","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab-4/mounts/","text":"\u4e3a\u5bb9\u5668\u8865\u5168\u6587\u4ef6\u7cfb\u7edf \u00b6 \u5728\u5b9e\u9a8c\u4e00\u4e2d\u6211\u4eec\u77e5\u9053\uff0c\u4ec5\u6709\u4e00\u4e2a init \u7a0b\u5e8f\u7684\u6587\u4ef6\u7cfb\u7edf\u4e5f\u53ef\u4ee5\u542f\u52a8\u4e00\u4e2a\u5b8c\u6574\u7684 Linux \u7cfb\u7edf\uff0c\u4f46\u662f\u663e\u7136\u8fd9\u6837\u7684 Linux \u7cfb\u7edf\u662f\u6ca1\u6709\u4ec0\u4e48\u5b9e\u7528\u4ef7\u503c\u7684\u2014\u2014\u5b83\u8fd0\u884c\u4e0d\u4e86\u54ea\u6015\u662f\u7a0d\u5fae\u5178\u578b\u4e00\u4e9b\u7684 Linux \u7a0b\u5e8f\u6216 shell \u547d\u4ee4\uff0c\u8fd9\u662f\u56e0\u4e3a\u4ec5\u6709\u4e00\u4e2a init \u7a0b\u5e8f\u7684\u6587\u4ef6\u7cfb\u7edf\u7f3a\u4e4f\u5927\u90e8\u5206\u7a0b\u5e8f\u9700\u8981\u7684\u76ee\u5f55\u7ed3\u6784\uff0c\u5982 /proc \u548c /sys \u7b49\u3002 \u4f7f\u7528 mount \u547d\u4ee4 \u00b6 mount(8) \u662f Linux \u4e2d\u5e38\u7528\u7684\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\u7684\u547d\u4ee4\uff0c\u5f53\u4ec0\u4e48\u53c2\u6570\u90fd\u6ca1\u6709\u65f6\uff0c\u5b83\u5217\u51fa\u5168\u90e8\u5df2\u6302\u8f7d\u7684\u6587\u4ef6\u7cfb\u7edf\u3002 \u67e5\u770b\u5f53\u524d\u7cfb\u7edf\u6302\u8f7d\u70b9 \u00b6 \u5728\u7ec8\u7aef\u4e2d\u8fd0\u884c mount \u547d\u4ee4\uff0c\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u8fd9\u6837\u7684\u8f93\u51fa\uff1a sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime) proc on /proc type proc (rw,nosuid,nodev,noexec,relatime) udev on /dev type devtmpfs (rw,nosuid,relatime,size=32852896k,nr_inodes=8213224,mode=755) devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000) tmpfs on /run type tmpfs (rw,nosuid,noexec,relatime,size=6576800k,mode=755) none on /tmp type tmpfs (rw,nosuid,nodev,noatime) /dev/nvme0n1p2 on / type ext4 (rw,relatime,errors=remount-ro) securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime) tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev) tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k) tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,mode=755) cgroup2 on /sys/fs/cgroup/unified type cgroup2 (rw,nosuid,nodev,noexec,relatime) cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name=systemd) pstore on /sys/fs/pstore type pstore (rw,nosuid,nodev,noexec,relatime) efivarfs on /sys/firmware/efi/efivars type efivarfs (rw,nosuid,nodev,noexec,relatime) bpf on /sys/fs/bpf type bpf (rw,nosuid,nodev,noexec,relatime,mode=700) mount \u7684\u6bcf\u4e00\u884c\u8f93\u51fa\u683c\u5f0f\u5982\u4e0b\uff1a {\u6e90} on {\u6302\u8f7d\u70b9} type {\u7c7b\u578b} ({\u6302\u8f7d\u53c2\u6570},{\u6302\u8f7d\u53c2\u6570},...) \u4f8b\u5982\uff0c\u5bf9\u4e8e\u4e0a\u9762\u7684\u7b2c\u4e00\u884c\u8f93\u51fa\uff0c sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime) \u8868\u793a\u6e90 sysfs \u4ee5 sysfs \u7c7b\u578b\u6302\u8f7d\u5230\u4e86 /sys \u8def\u5f84\uff0c\u53c2\u6570\u4e3a\u8bfb\u5199\uff08 rw \uff09\u3001\u65e0\u89c6 setuid \u6807\u5fd7\uff08 nosuid \uff09\u3001\u4e0d\u5141\u8bb8\u8bbe\u5907\u6587\u4ef6\uff08 nodev \uff09\u3001\u4e0d\u5141\u8bb8\u6267\u884c\u7a0b\u5e8f\uff08 noexec \uff09\u4ee5\u53ca\u4f7f\u7528\u76f8\u5bf9\u7684\u8bbf\u95ee\u65f6\u95f4\uff08 relatime \uff09\u3002 \u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6587\u4ef6\u7cfb\u7edf\u9700\u8981\u771f\u5b9e\u8bbe\u5907\u7684\u652f\u6301\uff08\u5982 /dev/sda \u6216 /dev/nvme0n1p2 \uff09\uff0c\u4f46\u662f\u5bf9\u4e8e\u4e00\u4e9b\u7c7b\u578b\u7684\u6587\u4ef6\u7cfb\u7edf\uff08\u5982 tmpfs\uff09\uff0c\u6302\u8f7d\u6e90\u662f\u4e0d\u91cd\u8981\u7684\uff0c\u751a\u81f3\u53ef\u4ee5\u4f7f\u7528\u4efb\u610f\u5b57\u7b26\u4e32\u3002 \u6302\u8f7d\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf \u00b6 \u4f7f\u7528 mount \u547d\u4ee4\u6302\u8f7d\u4e00\u4e2a tmpfs \u5230\u67d0\u4e2a\u8def\u5f84\u4e0b\u7684\u64cd\u4f5c\u4e3a\uff1a mkdir -p /mnt/mytmpfs mount -t tmpfs none /mnt/mytmpfs mount \u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u53ef\u4ee5\u5728 mount(8) \u7684\u624b\u518c \u4e2d\u67e5\u770b\u3002\u5bf9\u4e8e\u4e0a\u9762\u7684\u7b2c\u4e8c\u884c\u547d\u4ee4\uff0c\u5bf9\u5e94\u7684\u662f\u4e0b\u9762\u8fd9\u4e2a\u683c\u5f0f\uff1a mount [-fnrsvw] [-t fstype] [-o options] device dir \u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf \u00b6 \u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf\u53ef\u4ee5\u4f7f\u7528 umount(8)\uff0c\u4f8b\u5982 umount /mnt/mytmpfs \u5373\u53ef\u5b8c\u6210\u5bf9\u521a\u624d\u6302\u8f7d\u7684\u76ee\u5f55\u7684\u5378\u8f7d\u64cd\u4f5c\u3002 \u540c\u6837\uff0cumount(8) \u4e5f\u6709\u4e00\u4e9b\u53c2\u6570\uff0c\u4f8b\u5982 -l \uff08lazy\uff09\u53ef\u4ee5\u5c06\u6302\u8f7d\u70b9\u4ece\u76ee\u5f55\u6811\u7ed3\u6784\u4e2d\u5378\u8f7d\uff0c\u800c\u4e0d\u5f71\u54cd\u6b63\u5728\u4f7f\u7528\u8be5\u6587\u4ef6\u7cfb\u7edf\u7ed3\u6784\u7684\u8fdb\u7a0b\uff08\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u5378\u8f7d\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u524d\u4e0d\u80fd\u6709\u8fdb\u7a0b\u5728\u5360\u7528\u8fd9\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff09\u3002 \u4f7f\u7528 mount \u7cfb\u7edf\u8c03\u7528\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf \u00b6 \u67e5\u770b mount(2) \u7684\u624b\u518c \uff0c\u53ef\u4ee5\u53d1\u73b0\u5176\u539f\u578b\u5982\u4e0b\uff1a #include <sys/mount.h> int mount(const char *source, const char *target, const char *filesystemtype, unsigned long mountflags, const void *data); \u4e0d\u96be\u731c\u5230\uff0cmount(2) \u7684\u524d\u4e24\u4e2a\u53c2\u6570\u5bf9\u5e94 mount(8) \u7684\u6700\u540e\u4e24\u4e2a\u53c2\u6570\uff0c\u800c mountflags \u5219\u5bf9\u5e94 \u90e8\u5206 \u6302\u8f7d\u9009\u9879\uff0c\u5982\u53ea\u8bfb / \u53ef\u5199\uff0c\u4ee5\u53ca nosuid , nodev , noexec \u7b49\u9009\u9879\u3002\u8bf7\u81ea\u5df1\u67e5\u9605\u8d44\u6599\uff0c\u4e86\u89e3\u6700\u540e\u4e00\u4e2a\u53c2\u6570 data \u7684\u610f\u4e49\uff08\u540e\u9762\u53ef\u80fd\u4f1a\u7528\u5230\uff09\u3002 \u4e0e mount(2) \u7c7b\u4f3c\uff0cumount(2) \u53ca umount2(2) \u4e24\u4e2a\u7cfb\u7edf\u8c03\u7528\u53ef\u4ee5\u7528\u4e8e\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf\u3002\u8bf7\u81ea\u884c\u67e5\u9605\u624b\u518c\u4e86\u89e3\u5b83\u4eec\u7684\u7528\u6cd5\u3002 \u9694\u79bb\u6302\u8f7d\u70b9 \u00b6 \u8bf7\u786e\u4fdd\u4f60\u5728\u7b2c\u4e00\u6b65\u5b8c\u6210\u4e86\u5bf9\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff08CLONE_NEWNS\uff09\u7684\u9694\u79bb\uff0c\u518d\u8fdb\u884c\u8fd9\u4e00\u6b65\u64cd\u4f5c\u3002 \u9694\u79bb\u4e86\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\u540e\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6240\u6709\u5bf9\u73b0\u6709\u6302\u8f7d\u70b9\u7684\u4fee\u6539\u4e0d\u4f1a\u4f20\u64ad\uff08propagate\uff09\u5230\u4e3b\u673a\u4e2d\uff0c\u9996\u5148\u9700\u8981\u5c06 rootfs \u9012\u5f52\u5730\u91cd\u65b0\u6302\u8f7d\u4e3a\u79c1\u6709\uff08\u63d0\u793a\uff1a mount --make-rprivate / \uff09\uff0c\u7136\u540e\u518d\u8fdb\u884c\u5bb9\u5668\uff08\u65b0\u7684\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff09\u5185\u7684\u6302\u8f7d\u64cd\u4f5c\u7b49\u3002 \u5b9e\u9a8c\u8981\u6c42 \u00b6 \u8bf7\u4f7f\u7528 mount(2) \u4e3a\u4f60\u7684\u5bb9\u5668\u5728 /dev , /proc , /sys \u548c /tmp \u4f4d\u7f6e\u5404\u6302\u8f7d\u4e00\u4e2a\u5408\u9002\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u5728 /sys/fs/cgroup \u4e0b\u6302\u8f7d\u6307\u5b9a\u7684\u4e09\u7c7b cgroup \u63a7\u5236\u5668\uff08\u89c1 cgroup \u4e00\u8282 \uff09\u3002 \u6ce8\u610f \u5c06 /sys \u6302\u8f7d\u4e3a\u53ea\u8bfb \uff08\u8fd9\u662f systemd \u7684\u5bb9\u5668\u754c\u9762\u7684\u4e00\u4e2a\u8981\u6c42\uff0c\u8fd9\u91cc\u4e5f\u4f5c\u4e3a\u672c\u5b9e\u9a8c\u7684\u8981\u6c42\uff09\u3002 \u4f60\u53ef\u4ee5\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u4e3a\u5176\u4ed6\u8def\u5f84\u6302\u8f7d\u6070\u5f53\u7684\u6587\u4ef6\u7cfb\u7edf\uff08\u5982 /run \uff09\uff0c\u6216\u4ece\u4e3b\u673a\u7cfb\u7edf\u4ee5 bind \u65b9\u5f0f\u6302\u8f7d\u4e00\u4e9b\u76ee\u5f55\u3002 \u6302\u8f7d\u5b8c\u6210\u540e\uff0c\u8bf7\u5728 /dev \u4e0b\u521b\u5efa\u4e00\u4e9b\u8bbe\u5907\u8282\u70b9\uff0c\u4f8b\u5982 null , zero , urandom \u7b49\u3002\u5efa\u8bae\u5c06 /dev/tty \u4e5f\u521b\u5efa\uff0c\u5426\u5219\u90e8\u5206\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c\uff08\u5982 less \u548c Vim \u7b49\uff09\u3002 \u4e0b\u4e00\u8282\u7684 pivot_root \u540e\u4f60\u9700\u8981\u4f7f\u7528 umount(2) \u4ece\u5bb9\u5668\u4e2d\u5378\u8f7d\u4e3b\u673a\u7cfb\u7edf\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u4ee5\u5c06\u4e3b\u673a\u4ece\u5bb9\u5668\u4e2d\u201c\u9690\u85cf\u201d\u3002\u8fd9\u4e00\u6b65\u64cd\u4f5c\u5c06\u5728\u4e0b\u4e00\u8282\u4e2d\u8be6\u7ec6\u8ba8\u8bba\u3002 \u53e6\u5916\uff0c\u5728\u4e0b\u4e00\u8282 pivot_root \u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u8c03\u6574\u90e8\u5206\u672c\u8282\u4e2d\u5df2\u5b8c\u6210\u7684 monut \u64cd\u4f5c\u7684\u987a\u5e8f\u3002","title":"\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab-4/mounts/#_1","text":"\u5728\u5b9e\u9a8c\u4e00\u4e2d\u6211\u4eec\u77e5\u9053\uff0c\u4ec5\u6709\u4e00\u4e2a init \u7a0b\u5e8f\u7684\u6587\u4ef6\u7cfb\u7edf\u4e5f\u53ef\u4ee5\u542f\u52a8\u4e00\u4e2a\u5b8c\u6574\u7684 Linux \u7cfb\u7edf\uff0c\u4f46\u662f\u663e\u7136\u8fd9\u6837\u7684 Linux \u7cfb\u7edf\u662f\u6ca1\u6709\u4ec0\u4e48\u5b9e\u7528\u4ef7\u503c\u7684\u2014\u2014\u5b83\u8fd0\u884c\u4e0d\u4e86\u54ea\u6015\u662f\u7a0d\u5fae\u5178\u578b\u4e00\u4e9b\u7684 Linux \u7a0b\u5e8f\u6216 shell \u547d\u4ee4\uff0c\u8fd9\u662f\u56e0\u4e3a\u4ec5\u6709\u4e00\u4e2a init \u7a0b\u5e8f\u7684\u6587\u4ef6\u7cfb\u7edf\u7f3a\u4e4f\u5927\u90e8\u5206\u7a0b\u5e8f\u9700\u8981\u7684\u76ee\u5f55\u7ed3\u6784\uff0c\u5982 /proc \u548c /sys \u7b49\u3002","title":"\u4e3a\u5bb9\u5668\u8865\u5168\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab-4/mounts/#mount","text":"mount(8) \u662f Linux \u4e2d\u5e38\u7528\u7684\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\u7684\u547d\u4ee4\uff0c\u5f53\u4ec0\u4e48\u53c2\u6570\u90fd\u6ca1\u6709\u65f6\uff0c\u5b83\u5217\u51fa\u5168\u90e8\u5df2\u6302\u8f7d\u7684\u6587\u4ef6\u7cfb\u7edf\u3002","title":"\u4f7f\u7528 mount \u547d\u4ee4"},{"location":"lab-4/mounts/#_2","text":"\u5728\u7ec8\u7aef\u4e2d\u8fd0\u884c mount \u547d\u4ee4\uff0c\u53ef\u4ee5\u770b\u5230\u7c7b\u4f3c\u8fd9\u6837\u7684\u8f93\u51fa\uff1a sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime) proc on /proc type proc (rw,nosuid,nodev,noexec,relatime) udev on /dev type devtmpfs (rw,nosuid,relatime,size=32852896k,nr_inodes=8213224,mode=755) devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000) tmpfs on /run type tmpfs (rw,nosuid,noexec,relatime,size=6576800k,mode=755) none on /tmp type tmpfs (rw,nosuid,nodev,noatime) /dev/nvme0n1p2 on / type ext4 (rw,relatime,errors=remount-ro) securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime) tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev) tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k) tmpfs on /sys/fs/cgroup type tmpfs (ro,nosuid,nodev,noexec,mode=755) cgroup2 on /sys/fs/cgroup/unified type cgroup2 (rw,nosuid,nodev,noexec,relatime) cgroup on /sys/fs/cgroup/systemd type cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name=systemd) pstore on /sys/fs/pstore type pstore (rw,nosuid,nodev,noexec,relatime) efivarfs on /sys/firmware/efi/efivars type efivarfs (rw,nosuid,nodev,noexec,relatime) bpf on /sys/fs/bpf type bpf (rw,nosuid,nodev,noexec,relatime,mode=700) mount \u7684\u6bcf\u4e00\u884c\u8f93\u51fa\u683c\u5f0f\u5982\u4e0b\uff1a {\u6e90} on {\u6302\u8f7d\u70b9} type {\u7c7b\u578b} ({\u6302\u8f7d\u53c2\u6570},{\u6302\u8f7d\u53c2\u6570},...) \u4f8b\u5982\uff0c\u5bf9\u4e8e\u4e0a\u9762\u7684\u7b2c\u4e00\u884c\u8f93\u51fa\uff0c sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime) \u8868\u793a\u6e90 sysfs \u4ee5 sysfs \u7c7b\u578b\u6302\u8f7d\u5230\u4e86 /sys \u8def\u5f84\uff0c\u53c2\u6570\u4e3a\u8bfb\u5199\uff08 rw \uff09\u3001\u65e0\u89c6 setuid \u6807\u5fd7\uff08 nosuid \uff09\u3001\u4e0d\u5141\u8bb8\u8bbe\u5907\u6587\u4ef6\uff08 nodev \uff09\u3001\u4e0d\u5141\u8bb8\u6267\u884c\u7a0b\u5e8f\uff08 noexec \uff09\u4ee5\u53ca\u4f7f\u7528\u76f8\u5bf9\u7684\u8bbf\u95ee\u65f6\u95f4\uff08 relatime \uff09\u3002 \u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u6587\u4ef6\u7cfb\u7edf\u9700\u8981\u771f\u5b9e\u8bbe\u5907\u7684\u652f\u6301\uff08\u5982 /dev/sda \u6216 /dev/nvme0n1p2 \uff09\uff0c\u4f46\u662f\u5bf9\u4e8e\u4e00\u4e9b\u7c7b\u578b\u7684\u6587\u4ef6\u7cfb\u7edf\uff08\u5982 tmpfs\uff09\uff0c\u6302\u8f7d\u6e90\u662f\u4e0d\u91cd\u8981\u7684\uff0c\u751a\u81f3\u53ef\u4ee5\u4f7f\u7528\u4efb\u610f\u5b57\u7b26\u4e32\u3002","title":"\u67e5\u770b\u5f53\u524d\u7cfb\u7edf\u6302\u8f7d\u70b9"},{"location":"lab-4/mounts/#_3","text":"\u4f7f\u7528 mount \u547d\u4ee4\u6302\u8f7d\u4e00\u4e2a tmpfs \u5230\u67d0\u4e2a\u8def\u5f84\u4e0b\u7684\u64cd\u4f5c\u4e3a\uff1a mkdir -p /mnt/mytmpfs mount -t tmpfs none /mnt/mytmpfs mount \u547d\u4ee4\u7684\u8be6\u7ec6\u7528\u6cd5\u53ef\u4ee5\u5728 mount(8) \u7684\u624b\u518c \u4e2d\u67e5\u770b\u3002\u5bf9\u4e8e\u4e0a\u9762\u7684\u7b2c\u4e8c\u884c\u547d\u4ee4\uff0c\u5bf9\u5e94\u7684\u662f\u4e0b\u9762\u8fd9\u4e2a\u683c\u5f0f\uff1a mount [-fnrsvw] [-t fstype] [-o options] device dir","title":"\u6302\u8f7d\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab-4/mounts/#_4","text":"\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf\u53ef\u4ee5\u4f7f\u7528 umount(8)\uff0c\u4f8b\u5982 umount /mnt/mytmpfs \u5373\u53ef\u5b8c\u6210\u5bf9\u521a\u624d\u6302\u8f7d\u7684\u76ee\u5f55\u7684\u5378\u8f7d\u64cd\u4f5c\u3002 \u540c\u6837\uff0cumount(8) \u4e5f\u6709\u4e00\u4e9b\u53c2\u6570\uff0c\u4f8b\u5982 -l \uff08lazy\uff09\u53ef\u4ee5\u5c06\u6302\u8f7d\u70b9\u4ece\u76ee\u5f55\u6811\u7ed3\u6784\u4e2d\u5378\u8f7d\uff0c\u800c\u4e0d\u5f71\u54cd\u6b63\u5728\u4f7f\u7528\u8be5\u6587\u4ef6\u7cfb\u7edf\u7ed3\u6784\u7684\u8fdb\u7a0b\uff08\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u5378\u8f7d\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\u524d\u4e0d\u80fd\u6709\u8fdb\u7a0b\u5728\u5360\u7528\u8fd9\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff09\u3002","title":"\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab-4/mounts/#mount_1","text":"\u67e5\u770b mount(2) \u7684\u624b\u518c \uff0c\u53ef\u4ee5\u53d1\u73b0\u5176\u539f\u578b\u5982\u4e0b\uff1a #include <sys/mount.h> int mount(const char *source, const char *target, const char *filesystemtype, unsigned long mountflags, const void *data); \u4e0d\u96be\u731c\u5230\uff0cmount(2) \u7684\u524d\u4e24\u4e2a\u53c2\u6570\u5bf9\u5e94 mount(8) \u7684\u6700\u540e\u4e24\u4e2a\u53c2\u6570\uff0c\u800c mountflags \u5219\u5bf9\u5e94 \u90e8\u5206 \u6302\u8f7d\u9009\u9879\uff0c\u5982\u53ea\u8bfb / \u53ef\u5199\uff0c\u4ee5\u53ca nosuid , nodev , noexec \u7b49\u9009\u9879\u3002\u8bf7\u81ea\u5df1\u67e5\u9605\u8d44\u6599\uff0c\u4e86\u89e3\u6700\u540e\u4e00\u4e2a\u53c2\u6570 data \u7684\u610f\u4e49\uff08\u540e\u9762\u53ef\u80fd\u4f1a\u7528\u5230\uff09\u3002 \u4e0e mount(2) \u7c7b\u4f3c\uff0cumount(2) \u53ca umount2(2) \u4e24\u4e2a\u7cfb\u7edf\u8c03\u7528\u53ef\u4ee5\u7528\u4e8e\u5378\u8f7d\u6587\u4ef6\u7cfb\u7edf\u3002\u8bf7\u81ea\u884c\u67e5\u9605\u624b\u518c\u4e86\u89e3\u5b83\u4eec\u7684\u7528\u6cd5\u3002","title":"\u4f7f\u7528 mount \u7cfb\u7edf\u8c03\u7528\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab-4/mounts/#_5","text":"\u8bf7\u786e\u4fdd\u4f60\u5728\u7b2c\u4e00\u6b65\u5b8c\u6210\u4e86\u5bf9\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff08CLONE_NEWNS\uff09\u7684\u9694\u79bb\uff0c\u518d\u8fdb\u884c\u8fd9\u4e00\u6b65\u64cd\u4f5c\u3002 \u9694\u79bb\u4e86\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\u540e\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6240\u6709\u5bf9\u73b0\u6709\u6302\u8f7d\u70b9\u7684\u4fee\u6539\u4e0d\u4f1a\u4f20\u64ad\uff08propagate\uff09\u5230\u4e3b\u673a\u4e2d\uff0c\u9996\u5148\u9700\u8981\u5c06 rootfs \u9012\u5f52\u5730\u91cd\u65b0\u6302\u8f7d\u4e3a\u79c1\u6709\uff08\u63d0\u793a\uff1a mount --make-rprivate / \uff09\uff0c\u7136\u540e\u518d\u8fdb\u884c\u5bb9\u5668\uff08\u65b0\u7684\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff09\u5185\u7684\u6302\u8f7d\u64cd\u4f5c\u7b49\u3002","title":"\u9694\u79bb\u6302\u8f7d\u70b9"},{"location":"lab-4/mounts/#_6","text":"\u8bf7\u4f7f\u7528 mount(2) \u4e3a\u4f60\u7684\u5bb9\u5668\u5728 /dev , /proc , /sys \u548c /tmp \u4f4d\u7f6e\u5404\u6302\u8f7d\u4e00\u4e2a\u5408\u9002\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u5728 /sys/fs/cgroup \u4e0b\u6302\u8f7d\u6307\u5b9a\u7684\u4e09\u7c7b cgroup \u63a7\u5236\u5668\uff08\u89c1 cgroup \u4e00\u8282 \uff09\u3002 \u6ce8\u610f \u5c06 /sys \u6302\u8f7d\u4e3a\u53ea\u8bfb \uff08\u8fd9\u662f systemd \u7684\u5bb9\u5668\u754c\u9762\u7684\u4e00\u4e2a\u8981\u6c42\uff0c\u8fd9\u91cc\u4e5f\u4f5c\u4e3a\u672c\u5b9e\u9a8c\u7684\u8981\u6c42\uff09\u3002 \u4f60\u53ef\u4ee5\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u4e3a\u5176\u4ed6\u8def\u5f84\u6302\u8f7d\u6070\u5f53\u7684\u6587\u4ef6\u7cfb\u7edf\uff08\u5982 /run \uff09\uff0c\u6216\u4ece\u4e3b\u673a\u7cfb\u7edf\u4ee5 bind \u65b9\u5f0f\u6302\u8f7d\u4e00\u4e9b\u76ee\u5f55\u3002 \u6302\u8f7d\u5b8c\u6210\u540e\uff0c\u8bf7\u5728 /dev \u4e0b\u521b\u5efa\u4e00\u4e9b\u8bbe\u5907\u8282\u70b9\uff0c\u4f8b\u5982 null , zero , urandom \u7b49\u3002\u5efa\u8bae\u5c06 /dev/tty \u4e5f\u521b\u5efa\uff0c\u5426\u5219\u90e8\u5206\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c\uff08\u5982 less \u548c Vim \u7b49\uff09\u3002 \u4e0b\u4e00\u8282\u7684 pivot_root \u540e\u4f60\u9700\u8981\u4f7f\u7528 umount(2) \u4ece\u5bb9\u5668\u4e2d\u5378\u8f7d\u4e3b\u673a\u7cfb\u7edf\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u4ee5\u5c06\u4e3b\u673a\u4ece\u5bb9\u5668\u4e2d\u201c\u9690\u85cf\u201d\u3002\u8fd9\u4e00\u6b65\u64cd\u4f5c\u5c06\u5728\u4e0b\u4e00\u8282\u4e2d\u8be6\u7ec6\u8ba8\u8bba\u3002 \u53e6\u5916\uff0c\u5728\u4e0b\u4e00\u8282 pivot_root \u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u8c03\u6574\u90e8\u5206\u672c\u8282\u4e2d\u5df2\u5b8c\u6210\u7684 monut \u64cd\u4f5c\u7684\u987a\u5e8f\u3002","title":"\u5b9e\u9a8c\u8981\u6c42"},{"location":"lab-4/namespaces/","text":"\u9694\u79bb\u5bb9\u5668\u7684\u547d\u540d\u7a7a\u95f4 \u00b6 \u547d\u540d\u7a7a\u95f4\uff08namespaces\uff09\u662f Linux \u5185\u6838\u7684\u4e00\u4e2a\u7279\u6027\uff0c\u5c06\u90e8\u5206\u7cfb\u7edf\u8d44\u6e90\u9694\u79bb\uff0c\u4f7f\u5f97\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fdb\u7a0b\u4e0d\u80fd\u4e92\u76f8\u770b\u89c1\u5176\u4ed6\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u540c\u79cd\u8d44\u6e90\u3002 \u547d\u540d\u7a7a\u95f4\u7684\u6982\u5ff5\u6700\u65e9\u51fa\u73b0\u5728 2002 \u5e74\u7684 Linux 2.4.19\uff0c\u5f53\u65f6\u552f\u4e00\u7684\u547d\u540d\u7a7a\u95f4\u662f\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff08mount namespaces\uff09\uff0c\u7531\u4e8e\u5f53\u65f6\u7684\u5f00\u53d1\u8005\u5e76\u6ca1\u6709\u60f3\u5230\u4ee5\u540e\u4f1a\u6709\u5404\u79cd\u5404\u6837\u7684\u547d\u540d\u7a7a\u95f4\u88ab\u52a0\u5165 Linux\uff0c\u6240\u4ee5\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\u5c31\u4f7f\u7528\u4e86 CLONE_NEWNS \uff08clone new namespace\uff09\u8fd9\u6837\u4e00\u4e2a\u5e73\u51e1\u7684 flag\u3002 \u76ee\u524d\u6700\u65b0\u7684 Linux \u5185\u6838\uff08>= 5.6\uff09\u4e00\u5171\u652f\u6301\u516b\u79cd\u547d\u540d\u7a7a\u95f4\uff1a CLONE_NEWNS : \u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff08mount namespaces\uff09\uff0c\u9694\u79bb\u6302\u8f7d\u70b9\u7b49\u4fe1\u606f\uff0c\u5b50\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\u7684\u6302\u8f7d\u4e0d\u4f1a\u5411\u4e0a\u4f20\u9012\u5230\u7236\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff0c\u662f Linux \u5185\u6838\u5386\u53f2\u4e0a\u7b2c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u7684\u6982\u5ff5\u3002\uff08Kernel 2.4.19, 2002\uff09 CLONE_NEWUTS : Unix \u4e3b\u673a\u547d\u540d\u7a7a\u95f4\uff08 UTS namespaces, UNIX Time-Sharing \uff09\uff0c\u9694\u79bb\u4e3b\u673a\u540d\u4e0e\u57df\u540d\u7b49\u4fe1\u606f\uff0c\u4e0d\u540c\u7684 UTS \u547d\u540d\u7a7a\u95f4\u53ef\u4ee5\u62e5\u6709\u4e0d\u540c\u7684\u4e3b\u673a\u540d\uff0c\u5728\u7f51\u7edc\u4e0a\u5448\u73b0\u4e3a\u591a\u4e2a\u4e3b\u673a\u3002\uff08Kernel 2.6.19, 2006\uff09 CLONE_NEWIPC : \u8fdb\u7a0b\u95f4\u901a\u4fe1\u547d\u540d\u7a7a\u95f4\uff08 IPC namespaces, Inter-Process Communication \uff09\uff0c\u9694\u79bb System V IPC\uff0c\u4e0d\u540c IPC \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fdb\u7a0b\u4e0d\u80fd\u4f7f\u7528\u4f20\u7edf\u7684 System V \u98ce\u683c\u7684\u8fdb\u7a0b\u95f4\u901a\u4fe1\u65b9\u5f0f\uff0c\u5982\u5171\u4eab\u5185\u5b58\uff08SHM\uff09\u7b49\u3002\uff08Kernel 2.6.19, 2006\uff09 CLONE_NEWPID : \u8fdb\u7a0b ID \u547d\u540d\u7a7a\u95f4\uff08PID namespaces\uff09\uff0c\u9694\u79bb\u8fdb\u7a0b\u7684 PID \u7a7a\u95f4\uff0c\u4e0d\u540c\u7684 PID \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 PID \u53ef\u4ee5\u91cd\u590d\uff0c\u4e92\u4e0d\u5f71\u54cd\u3002\uff08Kernel 2.6.24, 2008\uff09 CLONE_NEWNET : \u7f51\u7edc\u547d\u540d\u7a7a\u95f4\uff08network namespaces\uff09\uff0c\u865a\u62df\u5316\u4e00\u4e2a\u5b8c\u6574\u7684\u7f51\u7edc\u6808\uff0c\u6bcf\u4e2a\u7f51\u7edc\u6808\u62e5\u6709\u4e00\u5957\u5b8c\u6574\u7684\u7f51\u7edc\u8d44\u6e90\uff0c\u5305\u62ec\u7f51\u7edc\u8bbe\u5907\uff08interfaces\uff09\u3001\u8def\u7531\u8868\u4e0e\u9632\u706b\u5899\u7b49\u3002\u4e0e\u5176\u4ed6\u547d\u540d\u7a7a\u95f4\u4e0d\u540c\uff0c\u7f51\u7edc\u547d\u540d\u7a7a\u95f4 \u6ca1\u6709 \u5c42\u6b21\u7ed3\u6784\uff0c\u6240\u6709\u7684\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u4e92\u76f8\u72ec\u7acb\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u53ea\u80fd\u5c5e\u4e8e\u4e00\u4e2a\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u4e14\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u5728\u6ca1\u6709\u8fdb\u7a0b\u5c5e\u4e8e\u5b83\u7684\u65f6\u5019 \u4e0d\u4f1a \u81ea\u52a8\u6d88\u5931\u3002\uff08Kernel 2.6.29, 2009\uff09 CLONE_NEWUSER : \u7528\u6237\u547d\u540d\u7a7a\u95f4\uff08user namespaces\uff09\uff0c\u9694\u79bb\u7528\u6237\u4e0e\u7ec4\u4fe1\u606f\uff0c\u5b50\u7528\u6237\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6bcf\u4e2a\u7528\u6237\u548c\u7ec4\uff08UID / GID\uff09\u5747\u6620\u5c04\u5230\u7236\u7528\u6237\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4e00\u4e2a\u7528\u6237\u548c\u7ec4\uff0c\u63d0\u4f9b\u4e00\u79cd\u66f4\u597d\u7684\u6743\u9650\u9694\u79bb\u65b9\u5f0f\u3002\u901a\u8fc7\u5c06\u5bb9\u5668\u4e2d\u7684 root \u7528\u6237\u6620\u5c04\u5230\u4e3b\u673a\u4e0a\u7684\u4e00\u4e2a\u975e\u7279\u6743\u7528\u6237\uff0c\u53ef\u4ee5\u63d0\u5347\u5bb9\u5668\u7684\u5b89\u5168\u6027\uff0c\u8fd9\u4e5f\u662f LXC / LXD \u5b9e\u73b0\u300c\u975e\u7279\u6743\u5bb9\u5668\u300d\u7684\u65b9\u6cd5\u3002\uff08Kernel 3.8, 2013\uff09 CLONE_NEWCGROUP : Cgroup \u547d\u540d\u7a7a\u95f4\uff0c\u7c7b\u4f3c chroot\uff0c\u9694\u79bb cgroup \u5c42\u6b21\u7ed3\u6784\uff0c\u5b50\u547d\u540d\u7a7a\u95f4\u770b\u5230\u7684\u6839 cgroup \u7ed3\u6784\u5b9e\u9645\u4e0a\u662f\u7236\u547d\u540d\u7a7a\u95f4\u7684\u4e00\u4e2a\u5b50\u6811\u3002\uff08Kernel 4.6, 2016\uff09 CLONE_NEWTIME : \u7cfb\u7edf\u65f6\u95f4\u547d\u540d\u7a7a\u95f4\uff0c\u4e0e UTS \u547d\u540d\u7a7a\u95f4\u7c7b\u4f3c\uff0c\u5141\u8bb8\u4e0d\u540c\u7684\u8fdb\u7a0b\u770b\u5230\u4e0d\u540c\u7684\u7cfb\u7edf\u65f6\u95f4\u3002\uff08Kernel 5.6, 2020\uff09 \u672c\u5b9e\u9a8c\u8981\u6c42\u4e3a\u4f60\u7684\u5bb9\u5668\u9694\u79bb NEWNS, NEWUTS, NEWIPC, NEWPID \u548c NEWCGROUP \u4e94\u79cd\u547d\u540d\u7a7a\u95f4\u3002\u7531\u4e8e NEWNET \u548c NEWUSER \u9700\u8981\u4e0d\u5c11\u9644\u52a0\u5de5\u4f5c\u548c\u989d\u5916\u7684\u77e5\u8bc6\u57fa\u7840\uff0c\u56e0\u6b64\u672c\u5b9e\u9a8c\u4e0d\u5bf9\u8fd9\u4e24\u79cd\u547d\u540d\u7a7a\u95f4\u4f5c\u4efb\u4f55\u8981\u6c42\uff0c\u5f53\u7136\uff0c\u6709\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u63a2\u7a76\uff08\u4e0d\u5efa\u8bae\uff09\u3002NEWTIME \u7531\u4e8e\u662f\u5728 3 \u6708 30 \u65e5\u624d\u6b63\u5f0f\u53d1\u5e03\u7684 Linux 5.6 \u5185\u6838\u4e2d\u65b0\u589e\u7684\uff0c\u76f8\u5173\u652f\u6301\u8fd8\u4e0d\u5b8c\u5584\uff0c\u56e0\u6b64\u672c\u5b9e\u9a8c\u4e5f\u4e0d\u8981\u6c42\u3002 \u4f7f\u7528 clone(2) \u66ff\u4ee3 fork(2) \u521b\u5efa\u5b50\u8fdb\u7a0b \u00b6 Linux \u4e2d\u9694\u79bb\u547d\u540d\u7a7a\u95f4\u7684\u7cfb\u7edf\u8c03\u7528\u6709\u4e24\u4e2a\uff0c unshare(2) \u4e0e clone(2) \u3002\u524d\u8005 \u591a\u6570\u65f6\u5019 \u7528\u4e8e\u5728\u5f53\u524d\u8fdb\u7a0b\u4e2d\u521b\u5efa\u65b0\u547d\u540d\u7a7a\u95f4\uff0c\u4e14\u4e24\u8005\u5bf9\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\uff08clone flags\uff09\u7684\u5904\u7406\u65b9\u5f0f\u7565\u6709\u4e0d\u540c\uff0c\u5bb9\u6613\u641e\u6df7\uff0c\u56e0\u6b64\u6211\u4eec\u4f7f\u7528 clone \u7cfb\u7edf\u8c03\u7528\uff0c\u5728\u521b\u5efa\u5b50\u8fdb\u7a0b\u7684\u540c\u65f6\u76f4\u63a5\u5c06\u5b50\u8fdb\u7a0b\u7684\u5404\u79cd\u547d\u540d\u7a7a\u95f4\u9694\u79bb\u3002 \u4f60\u77e5\u9053\u5417\uff1f \u51e0\u4e2a\u77e5\u540d\u5bb9\u5668\uff0c\u5982 Docker \u548c Singularity \u7b49\u6240\u4f7f\u7528\u7684 Go \u8bed\u8a00 os/exec \u5305\u4e2d\u7684 Command \u4f7f\u7528 clone \u800c\u4e0d\u662f fork \u4f5c\u4e3a\u652f\u6301\u8be5\u529f\u80fd\u7684\u7cfb\u7edf\u8c03\u7528\u3002 \u67e5\u770b clone \u7cfb\u7edf\u8c03\u7528\u7684\u624b\u518c \uff0c\u53ef\u4ee5\u770b\u5230\u5176\u539f\u578b\u5982\u4e0b\uff1a int clone ( int ( * fn )( void * ), void * child_stack , int flags , void * arg , ... /* pid_t *ptid, void *newtls, pid_t *ctid */ ); \u672c\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u53ea\u5173\u5fc3\u524d\u56db\u4e2a\u5fc5\u8981\u7684\u53c2\u6570\uff0c\u8fd9\u91cc\u7b80\u8981\u4ecb\u7ecd\u4e00\u4e0b\uff1a fn : \u4e0e fork(2) \u4e0d\u540c\u7684\u662f\uff0cclone \u51fa\u6765\u7684\u5b50\u8fdb\u7a0b\u5e76\u4e0d\u4ece\u5f53\u524d\u4f4d\u7f6e\u7ee7\u7eed\uff0c\u800c\u662f\u4ece\u7ed9\u51fa\u7684 fn \u51fd\u6570\u5f00\u59cb\u8fd0\u884c\uff0c\u6b64\u65f6\u7684 fn \u51fd\u6570\u5c31\u76f8\u5f53\u4e8e\u5b50\u8fdb\u7a0b\u7684 main \u51fd\u6570\uff0c\u82e5 fn \u51fd\u6570\u8fd4\u56de\u4e86\uff08\u6216\u8c03\u7528\u4e86 exit \uff09\uff0c\u90a3\u4e48\u5b50\u8fdb\u7a0b\u5c31\u9000\u51fa\u4e86\uff0c fn \u7684\u8fd4\u56de\u503c\uff08\u6216\u4f20\u5165 exit \u7684\u53c2\u6570\uff09\u5c31\u4f5c\u4e3a\u5b50\u8fdb\u7a0b\u7684\u8fd4\u56de\u503c\u3002 child_stack : \u540c\u6837\u4e0e fork \u7cfb\u7edf\u8c03\u7528\u4e0d\u540c\u7684\u662f\uff0cclone \u4e0d\u4ec5\u80fd\u521b\u5efa\u5b50\u8fdb\u7a0b\uff0c\u4e5f\u53ef\u4ee5\u5728\u5f53\u524d\u8fdb\u7a0b\u4e2d\u521b\u5efa\u989d\u5916\u7684\u7ebf\u7a0b\uff0c\u56e0\u6b64 clone \u4e0d\u4fdd\u8bc1\u521b\u5efa\u7684\u65b0\u7a0b\u5e8f\u6bb5\u4e00\u5b9a\u662f\u590d\u5236\u7684\u6216\u5168\u65b0\u7684\uff0c\u6240\u4ee5\u5f53\u521b\u5efa\u7684\u662f\u5b50\u8fdb\u7a0b\u7684\u65f6\u5019\uff0c\u9700\u8981\u624b\u52a8\u4e3a\u5b50\u8fdb\u7a0b\u6307\u5b9a\u6808\u7684\u5f00\u59cb\u4f4d\u7f6e\u3002\u672c\u6587\u4e0b\u65b9\u6709\u4e00\u4e2a\u4f7f\u7528 clone \u4ee3\u66ff fork \u7684\u7b80\u5355\u7684\u793a\u4f8b\u7a0b\u5e8f\u53ef\u4f9b\u53c2\u8003\uff0c\u53e6\u5916 clone \u7cfb\u7edf\u8c03\u7528\u7684\u624b\u518c\u4e2d Example \u4e00\u8282\u4e5f\u6709\u4e00\u4e2a\u7a0d\u5fae\u957f\u4e00\u70b9\u7684\u793a\u4f8b\u3002 flags : \u8fd9\u662f\u4f7f\u7528 clone \u6765\u9694\u79bb\u547d\u540d\u7a7a\u95f4\u7684\u5173\u952e\uff0c\u901a\u8fc7\u5411 flags \u53c2\u6570\u4f20\u5165\u4e0a\u9762\u6240\u8ff0\u7684 CLONE_ \u5f00\u5934\u7684\u6807\u5fd7\u4e2d\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u7684\u6309\u4f4d\u6216\uff08bitwise OR\uff09\uff0c\u53ef\u4ee5\u5c06 clone \u51fa\u6765\u7684\u5b50\u8fdb\u7a0b\u76f4\u63a5\u653e\u5165\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u3002 \u4e0e fork \u4e0d\u540c\u7684\u662f\uff0cclone \u51fa\u6765\u7684\u5b50\u8fdb\u7a0b\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4e0d\u80fd\u591f\u76f4\u63a5 wait\uff0c\u9700\u8981\u5728 flags \u4e2d\u4f7f\u7528\u6309\u4f4d\u6216\u4f20\u5165 SIGCHLD \u540e\u624d\u80fd\u591f wait\u3002\u8be6\u60c5\u53ef\u4ee5\u53c2\u8003\u672c\u6587\u540e\u9762\u7684\u793a\u4f8b\u7a0b\u5e8f\u3002 arg : \u6ce8\u610f\u5230 clone \u7b2c\u4e00\u4e2a\u53c2\u6570\u7684\u539f\u578b\u662f int (*)(void *) \uff0c\u8fd9\u662f\u4e00\u4e2a\u51fd\u6570\u6307\u9488\uff0c\u6307\u5411\u7684\u51fd\u6570\u63a5\u53d7\u4e00\u4e2a void * \u7c7b\u578b\u7684\u53c2\u6570\u3002\u8fd9\u4e2a\u53c2\u6570 arg \u5c31\u662f\u76f4\u63a5\u4f20\u5165\u5b50\u8fdb\u7a0b\u7684\uff0c\u7528\u4e8e\u5355\u5411\u4f20\u9012\u4fe1\u606f\u3002 \u6700\u540e\u4e09\u4e2a\u53c2\u6570\u5199\u5728\u4e00\u4e2a\u5757\u6ce8\u91ca\u91cc\uff0c\u8868\u793a\u5b83\u4eec\u662f \u6761\u4ef6\u53c2\u6570 \uff0c\u4ec5\u5f53\u524d\u9762\u7684\u53c2\u6570\u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6\u65f6\u624d\u9700\u8981\u8bbe\u5b9a\u3002 \u672c\u5b9e\u9a8c\u4e0d\u6d89\u53ca\u8fd9\u51e0\u4e2a\u6761\u4ef6\u53c2\u6570\u3002 \u987a\u4fbf\u4e00\u63d0\uff0c open(2) \u7cfb\u7edf\u8c03\u7528\u4e5f\u6709\u4e00\u4e2a\u53ef\u9009\u53c2\u6570\uff08\u53c2\u6570 3 mode_t mode \uff09\uff0c\u8be5\u53c2\u6570\u5b58\u5728\u4e0e\u5426\u7684\u5224\u65ad\u4e0e\u4e0a\u9762\u8bf4\u7684\u65b9\u6cd5\u662f\u4e00\u6837\u7684\u3002 \u4f7f\u7528 mmap(2) \u4e3a\u5b50\u8fdb\u7a0b\u5206\u914d\u6808\u7a7a\u95f4 \u00b6 \u4e0a\u9762\u63d0\u5230\u4e86\uff0c\u7531\u4e8e clone \u7684\u7279\u6b8a\u6027\uff0c\u9700\u8981\u624b\u52a8\u4e3a\u5b50\u8fdb\u7a0b\u6307\u5b9a\u6808\u4f4d\u7f6e\u3002\u4e00\u4e2a\u517c\u5bb9\u6027\u597d\u7684\u505a\u6cd5\u662f\uff0c\u4f7f\u7528 mmap(2) \u7cfb\u7edf\u8c03\u7528 \u5206\u914d\u4e00\u6bb5\u5730\u5740\u7528\u4f5c\u5b50\u8fdb\u7a0b\u7684\u6808\u3002 mmap \u51fd\u6570\u7684\u539f\u578b\u548c\u53c2\u6570\u53ef\u4ee5\u4ece\u624b\u518c\u4e2d\u67e5\u5230\u3002\u5bf9\u4e8e\u6b64\u5904\u7684\u7528\u9014\uff0c\u6211\u4eec\u5173\u5fc3\u4ee5\u4e0b\u53c2\u6570\u7684\u503c\uff1a prot \u53c2\u6570\u5e94\u5f53\u4e3a PROT_READ | PROT_WRITE \uff0c\u663e\u7136\u5b50\u8fdb\u7a0b\u9700\u8981\u8bfb\u5199\u8fd9\u5757\u5185\u5b58 flags \u53c2\u6570\u5e94\u5f53\u5305\u542b MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK \uff0c\u56e0\u4e3a\u6808\u662f\u8fdb\u7a0b\u79c1\u6709\u7684\uff08private\uff09\uff0c\u5e76\u4e14\u4e0d\u4ee5\u4efb\u4f55\u6587\u4ef6\u4e3a\u57fa\u7840\uff08anonymous\uff09\uff0c\u6700\u540e\u4e00\u4e2a\u53c2\u6570 MAP_STACK \u662f\u663e\u7136\u7684 fd \u5e94\u4e3a -1\uff0c\u5177\u4f53\u8bf7\u89c1 mmap \u7684 man \u6587\u6863\u4e2d\u5173\u4e8e MAP_ANONYMOUS \u7684\u89e3\u91ca \u7531\u4e8e\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u73af\u5883\uff08amd64 \u67b6\u6784\uff09\u4e2d\uff0c\u6808\u662f\u53cd\u5411\u589e\u957f\u7684\uff0c\u6808\u5e95\u7684\u5185\u5b58\u5730\u5740\u5728\u6570\u503c\u4e0a\u662f\u6700\u5927\u7684\uff0c\u56e0\u6b64\u5728\u5c06 mmap \u8fd4\u56de\u7684\u5185\u5b58\u5730\u5740\u7528\u4f5c\u6808\u7684\u8d77\u59cb\u4f4d\u7f6e\u524d\uff0c\u5e94\u8be5\u52a0\u4e0a\u5b83\u7684\u5927\u5c0f\uff0c\u8fd9\u6837\u5b9e\u9645\u4f20\u5165\u7684\u6307\u9488\u6307\u5411\u8fd9\u5757\u5185\u5b58\u533a\u57df\u5c3e\u90e8\u540e\u9762\uff0c\u624d\u80fd\u591f\u6b63\u786e\u7528\u4f5c\u5b50\u8fdb\u7a0b\u7684\u6808\u3002\u6240\u4ee5\u4f60\u53ef\u4ee5\u5728\u4e0b\u9762\u7684\u793a\u4f8b\u7a0b\u5e8f\u4e2d\u770b\u5230\u5982\u4e0b\u4ee3\u7801\uff1a void * child_stack_start = child_stack + STACK_SIZE ; \u5c06\u5b50\u8fdb\u7a0b\u9694\u79bb\u81f3\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d (clone) \u00b6 \u8fd9\u4e00\u6b65\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728\u8c03\u7528 clone \u65f6\u7684 flags \u53c2\u6570\u4e2d\u901a\u8fc7\u6309\u4f4d\u6216\u7684\u65b9\u5f0f\u6dfb\u52a0\u4e00\u4e2a\u6216\u591a\u4e2a\u672c\u6587\u6700\u5f00\u5934\u7ed9\u51fa\u7684 clone flags\uff0c\u6b64\u65f6\u751f\u6210\u7684\u5b50\u8fdb\u7a0b\u5c31\u5728\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u4e86\u3002\u4f8b\u5982\uff1a -int ch = clone(child, child_stack_start, SIGCHLD, name); +int ch = clone(child, child_stack_start, CLONE_NEWPID | SIGCHLD, name); \u5c06\u8fdb\u7a0b\u9694\u79bb\u81f3\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d (unshare) \u00b6 \u4e0a\u9762\u63d0\u5230\uff0c\u9694\u79bb\u547d\u540d\u7a7a\u95f4\u7684\u53e6\u4e00\u4e2a\u9009\u62e9\u662f unshare\u3002\u4e0e clone \u7684\u4e3b\u8981\u4e0d\u540c\u70b9\u662f\uff0cunshare \u5728 \u5f53\u524d\u8fdb\u7a0b \u4e2d\u521b\u5efa\u9694\u79bb\u7684\u547d\u540d\u7a7a\u95f4\uff08\uff09\uff0c\u5728\u8c03\u7528 unshare(CLONE_NEWXXX) \u5b8c\u6210\u4e4b\u540e\uff0c\u5f53\u524d\u8fdb\u7a0b\u5c31\u4f4d\u4e8e\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u4e86\u3002\u5982\u679c\u4f60\u5728\u540e\u9762\u7684\u5b9e\u9a8c\u6b65\u9aa4\u4e2d\u9047\u5230\u4e86\u56f0\u96be\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u5c06\u4e00\u4e2a\u6216\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\u6539\u4e3a\u4f7f\u7528 unshare \u9694\u79bb\u3002 * \u8fd9\u91cc\u6709\u4e00\u4e2a\u4f8b\u5916\uff0c\u90a3\u5c31\u662f CLONE_NEWPID \u3002\u8c03\u7528 unshare(CLONE_NEWPID) \u540e\uff0c\u5f53\u524d\u8fdb\u7a0b \u4e0d\u4f1a \u4f4d\u4e8e\u65b0\u7684 PID \u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u800c\u662f\u5728\u6b64\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2a fork \u51fa\u6765\u7684\u5b50\u8fdb\u7a0b\u3002 \u53c2\u8003\u8d44\u6599 \u00b6 Separation Anxiety: A Tutorial for Isolating Your System with Linux Namespaces \u4e0b\u9762\u51e0\u4e2a\u94fe\u63a5\u662f\u5728\u7ebf\u7248\u7684 man \u6587\u6863\uff0c\u4e0e\u7ec8\u7aef\u91cc\u7684 man 7 <title> \u5728\u5185\u5bb9\u4e0a\u6ca1\u6709\u4efb\u4f55\u533a\u522b\uff0c\u5efa\u8bae\u6309\u9700\u9605\u8bfb\u3002 namespaces(7) cgroup_namespaces(7) ipc_namespaces(7) mount_namespaces(7) pid_namespaces(7) uts_namespaces(7) clone \u7684\u793a\u4f8b\u7a0b\u5e8f \u00b6 #define _GNU_SOURCE // Required for enabling clone(2) #include <stdio.h> #include <sched.h> // For clone(2) #include <signal.h> // For SIGCHLD constant #include <sys/mman.h> // For mmap(2) #include <sys/types.h> // For wait(2) #include <sys/wait.h> // For wait(2) int child ( void * arg ) { printf ( \"My name is %s \\n \" , ( char * ) arg ); return 3 ; } int main () { char name [] = \"child\" ; #define STACK_SIZE (1024 * 1024) // 1 MiB void * child_stack = mmap ( NULL , STACK_SIZE , PROT_READ | PROT_WRITE , MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK , - 1 , 0 ); // Assume stack grows downwards void * child_stack_start = child_stack + STACK_SIZE ; int ch = clone ( child , child_stack_start , SIGCHLD , name ); int status ; wait ( & status ); printf ( \"Child exited with code %d \\n \" , WEXITSTATUS ( status )); return 0 ; }","title":"\u9694\u79bb\u547d\u540d\u7a7a\u95f4"},{"location":"lab-4/namespaces/#_1","text":"\u547d\u540d\u7a7a\u95f4\uff08namespaces\uff09\u662f Linux \u5185\u6838\u7684\u4e00\u4e2a\u7279\u6027\uff0c\u5c06\u90e8\u5206\u7cfb\u7edf\u8d44\u6e90\u9694\u79bb\uff0c\u4f7f\u5f97\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fdb\u7a0b\u4e0d\u80fd\u4e92\u76f8\u770b\u89c1\u5176\u4ed6\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u540c\u79cd\u8d44\u6e90\u3002 \u547d\u540d\u7a7a\u95f4\u7684\u6982\u5ff5\u6700\u65e9\u51fa\u73b0\u5728 2002 \u5e74\u7684 Linux 2.4.19\uff0c\u5f53\u65f6\u552f\u4e00\u7684\u547d\u540d\u7a7a\u95f4\u662f\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff08mount namespaces\uff09\uff0c\u7531\u4e8e\u5f53\u65f6\u7684\u5f00\u53d1\u8005\u5e76\u6ca1\u6709\u60f3\u5230\u4ee5\u540e\u4f1a\u6709\u5404\u79cd\u5404\u6837\u7684\u547d\u540d\u7a7a\u95f4\u88ab\u52a0\u5165 Linux\uff0c\u6240\u4ee5\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\u5c31\u4f7f\u7528\u4e86 CLONE_NEWNS \uff08clone new namespace\uff09\u8fd9\u6837\u4e00\u4e2a\u5e73\u51e1\u7684 flag\u3002 \u76ee\u524d\u6700\u65b0\u7684 Linux \u5185\u6838\uff08>= 5.6\uff09\u4e00\u5171\u652f\u6301\u516b\u79cd\u547d\u540d\u7a7a\u95f4\uff1a CLONE_NEWNS : \u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff08mount namespaces\uff09\uff0c\u9694\u79bb\u6302\u8f7d\u70b9\u7b49\u4fe1\u606f\uff0c\u5b50\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\u7684\u6302\u8f7d\u4e0d\u4f1a\u5411\u4e0a\u4f20\u9012\u5230\u7236\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\uff0c\u662f Linux \u5185\u6838\u5386\u53f2\u4e0a\u7b2c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u7684\u6982\u5ff5\u3002\uff08Kernel 2.4.19, 2002\uff09 CLONE_NEWUTS : Unix \u4e3b\u673a\u547d\u540d\u7a7a\u95f4\uff08 UTS namespaces, UNIX Time-Sharing \uff09\uff0c\u9694\u79bb\u4e3b\u673a\u540d\u4e0e\u57df\u540d\u7b49\u4fe1\u606f\uff0c\u4e0d\u540c\u7684 UTS \u547d\u540d\u7a7a\u95f4\u53ef\u4ee5\u62e5\u6709\u4e0d\u540c\u7684\u4e3b\u673a\u540d\uff0c\u5728\u7f51\u7edc\u4e0a\u5448\u73b0\u4e3a\u591a\u4e2a\u4e3b\u673a\u3002\uff08Kernel 2.6.19, 2006\uff09 CLONE_NEWIPC : \u8fdb\u7a0b\u95f4\u901a\u4fe1\u547d\u540d\u7a7a\u95f4\uff08 IPC namespaces, Inter-Process Communication \uff09\uff0c\u9694\u79bb System V IPC\uff0c\u4e0d\u540c IPC \u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8fdb\u7a0b\u4e0d\u80fd\u4f7f\u7528\u4f20\u7edf\u7684 System V \u98ce\u683c\u7684\u8fdb\u7a0b\u95f4\u901a\u4fe1\u65b9\u5f0f\uff0c\u5982\u5171\u4eab\u5185\u5b58\uff08SHM\uff09\u7b49\u3002\uff08Kernel 2.6.19, 2006\uff09 CLONE_NEWPID : \u8fdb\u7a0b ID \u547d\u540d\u7a7a\u95f4\uff08PID namespaces\uff09\uff0c\u9694\u79bb\u8fdb\u7a0b\u7684 PID \u7a7a\u95f4\uff0c\u4e0d\u540c\u7684 PID \u547d\u540d\u7a7a\u95f4\u4e2d\u7684 PID \u53ef\u4ee5\u91cd\u590d\uff0c\u4e92\u4e0d\u5f71\u54cd\u3002\uff08Kernel 2.6.24, 2008\uff09 CLONE_NEWNET : \u7f51\u7edc\u547d\u540d\u7a7a\u95f4\uff08network namespaces\uff09\uff0c\u865a\u62df\u5316\u4e00\u4e2a\u5b8c\u6574\u7684\u7f51\u7edc\u6808\uff0c\u6bcf\u4e2a\u7f51\u7edc\u6808\u62e5\u6709\u4e00\u5957\u5b8c\u6574\u7684\u7f51\u7edc\u8d44\u6e90\uff0c\u5305\u62ec\u7f51\u7edc\u8bbe\u5907\uff08interfaces\uff09\u3001\u8def\u7531\u8868\u4e0e\u9632\u706b\u5899\u7b49\u3002\u4e0e\u5176\u4ed6\u547d\u540d\u7a7a\u95f4\u4e0d\u540c\uff0c\u7f51\u7edc\u547d\u540d\u7a7a\u95f4 \u6ca1\u6709 \u5c42\u6b21\u7ed3\u6784\uff0c\u6240\u6709\u7684\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u4e92\u76f8\u72ec\u7acb\uff0c\u6bcf\u4e2a\u8fdb\u7a0b\u53ea\u80fd\u5c5e\u4e8e\u4e00\u4e2a\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\uff0c\u5e76\u4e14\u7f51\u7edc\u547d\u540d\u7a7a\u95f4\u5728\u6ca1\u6709\u8fdb\u7a0b\u5c5e\u4e8e\u5b83\u7684\u65f6\u5019 \u4e0d\u4f1a \u81ea\u52a8\u6d88\u5931\u3002\uff08Kernel 2.6.29, 2009\uff09 CLONE_NEWUSER : \u7528\u6237\u547d\u540d\u7a7a\u95f4\uff08user namespaces\uff09\uff0c\u9694\u79bb\u7528\u6237\u4e0e\u7ec4\u4fe1\u606f\uff0c\u5b50\u7528\u6237\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u6bcf\u4e2a\u7528\u6237\u548c\u7ec4\uff08UID / GID\uff09\u5747\u6620\u5c04\u5230\u7236\u7528\u6237\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4e00\u4e2a\u7528\u6237\u548c\u7ec4\uff0c\u63d0\u4f9b\u4e00\u79cd\u66f4\u597d\u7684\u6743\u9650\u9694\u79bb\u65b9\u5f0f\u3002\u901a\u8fc7\u5c06\u5bb9\u5668\u4e2d\u7684 root \u7528\u6237\u6620\u5c04\u5230\u4e3b\u673a\u4e0a\u7684\u4e00\u4e2a\u975e\u7279\u6743\u7528\u6237\uff0c\u53ef\u4ee5\u63d0\u5347\u5bb9\u5668\u7684\u5b89\u5168\u6027\uff0c\u8fd9\u4e5f\u662f LXC / LXD \u5b9e\u73b0\u300c\u975e\u7279\u6743\u5bb9\u5668\u300d\u7684\u65b9\u6cd5\u3002\uff08Kernel 3.8, 2013\uff09 CLONE_NEWCGROUP : Cgroup \u547d\u540d\u7a7a\u95f4\uff0c\u7c7b\u4f3c chroot\uff0c\u9694\u79bb cgroup \u5c42\u6b21\u7ed3\u6784\uff0c\u5b50\u547d\u540d\u7a7a\u95f4\u770b\u5230\u7684\u6839 cgroup \u7ed3\u6784\u5b9e\u9645\u4e0a\u662f\u7236\u547d\u540d\u7a7a\u95f4\u7684\u4e00\u4e2a\u5b50\u6811\u3002\uff08Kernel 4.6, 2016\uff09 CLONE_NEWTIME : \u7cfb\u7edf\u65f6\u95f4\u547d\u540d\u7a7a\u95f4\uff0c\u4e0e UTS \u547d\u540d\u7a7a\u95f4\u7c7b\u4f3c\uff0c\u5141\u8bb8\u4e0d\u540c\u7684\u8fdb\u7a0b\u770b\u5230\u4e0d\u540c\u7684\u7cfb\u7edf\u65f6\u95f4\u3002\uff08Kernel 5.6, 2020\uff09 \u672c\u5b9e\u9a8c\u8981\u6c42\u4e3a\u4f60\u7684\u5bb9\u5668\u9694\u79bb NEWNS, NEWUTS, NEWIPC, NEWPID \u548c NEWCGROUP \u4e94\u79cd\u547d\u540d\u7a7a\u95f4\u3002\u7531\u4e8e NEWNET \u548c NEWUSER \u9700\u8981\u4e0d\u5c11\u9644\u52a0\u5de5\u4f5c\u548c\u989d\u5916\u7684\u77e5\u8bc6\u57fa\u7840\uff0c\u56e0\u6b64\u672c\u5b9e\u9a8c\u4e0d\u5bf9\u8fd9\u4e24\u79cd\u547d\u540d\u7a7a\u95f4\u4f5c\u4efb\u4f55\u8981\u6c42\uff0c\u5f53\u7136\uff0c\u6709\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u81ea\u884c\u63a2\u7a76\uff08\u4e0d\u5efa\u8bae\uff09\u3002NEWTIME \u7531\u4e8e\u662f\u5728 3 \u6708 30 \u65e5\u624d\u6b63\u5f0f\u53d1\u5e03\u7684 Linux 5.6 \u5185\u6838\u4e2d\u65b0\u589e\u7684\uff0c\u76f8\u5173\u652f\u6301\u8fd8\u4e0d\u5b8c\u5584\uff0c\u56e0\u6b64\u672c\u5b9e\u9a8c\u4e5f\u4e0d\u8981\u6c42\u3002","title":"\u9694\u79bb\u5bb9\u5668\u7684\u547d\u540d\u7a7a\u95f4"},{"location":"lab-4/namespaces/#clone2-fork2","text":"Linux \u4e2d\u9694\u79bb\u547d\u540d\u7a7a\u95f4\u7684\u7cfb\u7edf\u8c03\u7528\u6709\u4e24\u4e2a\uff0c unshare(2) \u4e0e clone(2) \u3002\u524d\u8005 \u591a\u6570\u65f6\u5019 \u7528\u4e8e\u5728\u5f53\u524d\u8fdb\u7a0b\u4e2d\u521b\u5efa\u65b0\u547d\u540d\u7a7a\u95f4\uff0c\u4e14\u4e24\u8005\u5bf9\u4e0d\u540c\u547d\u540d\u7a7a\u95f4\uff08clone flags\uff09\u7684\u5904\u7406\u65b9\u5f0f\u7565\u6709\u4e0d\u540c\uff0c\u5bb9\u6613\u641e\u6df7\uff0c\u56e0\u6b64\u6211\u4eec\u4f7f\u7528 clone \u7cfb\u7edf\u8c03\u7528\uff0c\u5728\u521b\u5efa\u5b50\u8fdb\u7a0b\u7684\u540c\u65f6\u76f4\u63a5\u5c06\u5b50\u8fdb\u7a0b\u7684\u5404\u79cd\u547d\u540d\u7a7a\u95f4\u9694\u79bb\u3002 \u4f60\u77e5\u9053\u5417\uff1f \u51e0\u4e2a\u77e5\u540d\u5bb9\u5668\uff0c\u5982 Docker \u548c Singularity \u7b49\u6240\u4f7f\u7528\u7684 Go \u8bed\u8a00 os/exec \u5305\u4e2d\u7684 Command \u4f7f\u7528 clone \u800c\u4e0d\u662f fork \u4f5c\u4e3a\u652f\u6301\u8be5\u529f\u80fd\u7684\u7cfb\u7edf\u8c03\u7528\u3002 \u67e5\u770b clone \u7cfb\u7edf\u8c03\u7528\u7684\u624b\u518c \uff0c\u53ef\u4ee5\u770b\u5230\u5176\u539f\u578b\u5982\u4e0b\uff1a int clone ( int ( * fn )( void * ), void * child_stack , int flags , void * arg , ... /* pid_t *ptid, void *newtls, pid_t *ctid */ ); \u672c\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u53ea\u5173\u5fc3\u524d\u56db\u4e2a\u5fc5\u8981\u7684\u53c2\u6570\uff0c\u8fd9\u91cc\u7b80\u8981\u4ecb\u7ecd\u4e00\u4e0b\uff1a fn : \u4e0e fork(2) \u4e0d\u540c\u7684\u662f\uff0cclone \u51fa\u6765\u7684\u5b50\u8fdb\u7a0b\u5e76\u4e0d\u4ece\u5f53\u524d\u4f4d\u7f6e\u7ee7\u7eed\uff0c\u800c\u662f\u4ece\u7ed9\u51fa\u7684 fn \u51fd\u6570\u5f00\u59cb\u8fd0\u884c\uff0c\u6b64\u65f6\u7684 fn \u51fd\u6570\u5c31\u76f8\u5f53\u4e8e\u5b50\u8fdb\u7a0b\u7684 main \u51fd\u6570\uff0c\u82e5 fn \u51fd\u6570\u8fd4\u56de\u4e86\uff08\u6216\u8c03\u7528\u4e86 exit \uff09\uff0c\u90a3\u4e48\u5b50\u8fdb\u7a0b\u5c31\u9000\u51fa\u4e86\uff0c fn \u7684\u8fd4\u56de\u503c\uff08\u6216\u4f20\u5165 exit \u7684\u53c2\u6570\uff09\u5c31\u4f5c\u4e3a\u5b50\u8fdb\u7a0b\u7684\u8fd4\u56de\u503c\u3002 child_stack : \u540c\u6837\u4e0e fork \u7cfb\u7edf\u8c03\u7528\u4e0d\u540c\u7684\u662f\uff0cclone \u4e0d\u4ec5\u80fd\u521b\u5efa\u5b50\u8fdb\u7a0b\uff0c\u4e5f\u53ef\u4ee5\u5728\u5f53\u524d\u8fdb\u7a0b\u4e2d\u521b\u5efa\u989d\u5916\u7684\u7ebf\u7a0b\uff0c\u56e0\u6b64 clone \u4e0d\u4fdd\u8bc1\u521b\u5efa\u7684\u65b0\u7a0b\u5e8f\u6bb5\u4e00\u5b9a\u662f\u590d\u5236\u7684\u6216\u5168\u65b0\u7684\uff0c\u6240\u4ee5\u5f53\u521b\u5efa\u7684\u662f\u5b50\u8fdb\u7a0b\u7684\u65f6\u5019\uff0c\u9700\u8981\u624b\u52a8\u4e3a\u5b50\u8fdb\u7a0b\u6307\u5b9a\u6808\u7684\u5f00\u59cb\u4f4d\u7f6e\u3002\u672c\u6587\u4e0b\u65b9\u6709\u4e00\u4e2a\u4f7f\u7528 clone \u4ee3\u66ff fork \u7684\u7b80\u5355\u7684\u793a\u4f8b\u7a0b\u5e8f\u53ef\u4f9b\u53c2\u8003\uff0c\u53e6\u5916 clone \u7cfb\u7edf\u8c03\u7528\u7684\u624b\u518c\u4e2d Example \u4e00\u8282\u4e5f\u6709\u4e00\u4e2a\u7a0d\u5fae\u957f\u4e00\u70b9\u7684\u793a\u4f8b\u3002 flags : \u8fd9\u662f\u4f7f\u7528 clone \u6765\u9694\u79bb\u547d\u540d\u7a7a\u95f4\u7684\u5173\u952e\uff0c\u901a\u8fc7\u5411 flags \u53c2\u6570\u4f20\u5165\u4e0a\u9762\u6240\u8ff0\u7684 CLONE_ \u5f00\u5934\u7684\u6807\u5fd7\u4e2d\u7684\u4e00\u4e2a\u6216\u591a\u4e2a\u7684\u6309\u4f4d\u6216\uff08bitwise OR\uff09\uff0c\u53ef\u4ee5\u5c06 clone \u51fa\u6765\u7684\u5b50\u8fdb\u7a0b\u76f4\u63a5\u653e\u5165\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u3002 \u4e0e fork \u4e0d\u540c\u7684\u662f\uff0cclone \u51fa\u6765\u7684\u5b50\u8fdb\u7a0b\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4e0d\u80fd\u591f\u76f4\u63a5 wait\uff0c\u9700\u8981\u5728 flags \u4e2d\u4f7f\u7528\u6309\u4f4d\u6216\u4f20\u5165 SIGCHLD \u540e\u624d\u80fd\u591f wait\u3002\u8be6\u60c5\u53ef\u4ee5\u53c2\u8003\u672c\u6587\u540e\u9762\u7684\u793a\u4f8b\u7a0b\u5e8f\u3002 arg : \u6ce8\u610f\u5230 clone \u7b2c\u4e00\u4e2a\u53c2\u6570\u7684\u539f\u578b\u662f int (*)(void *) \uff0c\u8fd9\u662f\u4e00\u4e2a\u51fd\u6570\u6307\u9488\uff0c\u6307\u5411\u7684\u51fd\u6570\u63a5\u53d7\u4e00\u4e2a void * \u7c7b\u578b\u7684\u53c2\u6570\u3002\u8fd9\u4e2a\u53c2\u6570 arg \u5c31\u662f\u76f4\u63a5\u4f20\u5165\u5b50\u8fdb\u7a0b\u7684\uff0c\u7528\u4e8e\u5355\u5411\u4f20\u9012\u4fe1\u606f\u3002 \u6700\u540e\u4e09\u4e2a\u53c2\u6570\u5199\u5728\u4e00\u4e2a\u5757\u6ce8\u91ca\u91cc\uff0c\u8868\u793a\u5b83\u4eec\u662f \u6761\u4ef6\u53c2\u6570 \uff0c\u4ec5\u5f53\u524d\u9762\u7684\u53c2\u6570\u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6\u65f6\u624d\u9700\u8981\u8bbe\u5b9a\u3002 \u672c\u5b9e\u9a8c\u4e0d\u6d89\u53ca\u8fd9\u51e0\u4e2a\u6761\u4ef6\u53c2\u6570\u3002 \u987a\u4fbf\u4e00\u63d0\uff0c open(2) \u7cfb\u7edf\u8c03\u7528\u4e5f\u6709\u4e00\u4e2a\u53ef\u9009\u53c2\u6570\uff08\u53c2\u6570 3 mode_t mode \uff09\uff0c\u8be5\u53c2\u6570\u5b58\u5728\u4e0e\u5426\u7684\u5224\u65ad\u4e0e\u4e0a\u9762\u8bf4\u7684\u65b9\u6cd5\u662f\u4e00\u6837\u7684\u3002","title":"\u4f7f\u7528 clone(2) \u66ff\u4ee3 fork(2) \u521b\u5efa\u5b50\u8fdb\u7a0b"},{"location":"lab-4/namespaces/#mmap2","text":"\u4e0a\u9762\u63d0\u5230\u4e86\uff0c\u7531\u4e8e clone \u7684\u7279\u6b8a\u6027\uff0c\u9700\u8981\u624b\u52a8\u4e3a\u5b50\u8fdb\u7a0b\u6307\u5b9a\u6808\u4f4d\u7f6e\u3002\u4e00\u4e2a\u517c\u5bb9\u6027\u597d\u7684\u505a\u6cd5\u662f\uff0c\u4f7f\u7528 mmap(2) \u7cfb\u7edf\u8c03\u7528 \u5206\u914d\u4e00\u6bb5\u5730\u5740\u7528\u4f5c\u5b50\u8fdb\u7a0b\u7684\u6808\u3002 mmap \u51fd\u6570\u7684\u539f\u578b\u548c\u53c2\u6570\u53ef\u4ee5\u4ece\u624b\u518c\u4e2d\u67e5\u5230\u3002\u5bf9\u4e8e\u6b64\u5904\u7684\u7528\u9014\uff0c\u6211\u4eec\u5173\u5fc3\u4ee5\u4e0b\u53c2\u6570\u7684\u503c\uff1a prot \u53c2\u6570\u5e94\u5f53\u4e3a PROT_READ | PROT_WRITE \uff0c\u663e\u7136\u5b50\u8fdb\u7a0b\u9700\u8981\u8bfb\u5199\u8fd9\u5757\u5185\u5b58 flags \u53c2\u6570\u5e94\u5f53\u5305\u542b MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK \uff0c\u56e0\u4e3a\u6808\u662f\u8fdb\u7a0b\u79c1\u6709\u7684\uff08private\uff09\uff0c\u5e76\u4e14\u4e0d\u4ee5\u4efb\u4f55\u6587\u4ef6\u4e3a\u57fa\u7840\uff08anonymous\uff09\uff0c\u6700\u540e\u4e00\u4e2a\u53c2\u6570 MAP_STACK \u662f\u663e\u7136\u7684 fd \u5e94\u4e3a -1\uff0c\u5177\u4f53\u8bf7\u89c1 mmap \u7684 man \u6587\u6863\u4e2d\u5173\u4e8e MAP_ANONYMOUS \u7684\u89e3\u91ca \u7531\u4e8e\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u73af\u5883\uff08amd64 \u67b6\u6784\uff09\u4e2d\uff0c\u6808\u662f\u53cd\u5411\u589e\u957f\u7684\uff0c\u6808\u5e95\u7684\u5185\u5b58\u5730\u5740\u5728\u6570\u503c\u4e0a\u662f\u6700\u5927\u7684\uff0c\u56e0\u6b64\u5728\u5c06 mmap \u8fd4\u56de\u7684\u5185\u5b58\u5730\u5740\u7528\u4f5c\u6808\u7684\u8d77\u59cb\u4f4d\u7f6e\u524d\uff0c\u5e94\u8be5\u52a0\u4e0a\u5b83\u7684\u5927\u5c0f\uff0c\u8fd9\u6837\u5b9e\u9645\u4f20\u5165\u7684\u6307\u9488\u6307\u5411\u8fd9\u5757\u5185\u5b58\u533a\u57df\u5c3e\u90e8\u540e\u9762\uff0c\u624d\u80fd\u591f\u6b63\u786e\u7528\u4f5c\u5b50\u8fdb\u7a0b\u7684\u6808\u3002\u6240\u4ee5\u4f60\u53ef\u4ee5\u5728\u4e0b\u9762\u7684\u793a\u4f8b\u7a0b\u5e8f\u4e2d\u770b\u5230\u5982\u4e0b\u4ee3\u7801\uff1a void * child_stack_start = child_stack + STACK_SIZE ;","title":"\u4f7f\u7528 mmap(2) \u4e3a\u5b50\u8fdb\u7a0b\u5206\u914d\u6808\u7a7a\u95f4"},{"location":"lab-4/namespaces/#clone","text":"\u8fd9\u4e00\u6b65\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728\u8c03\u7528 clone \u65f6\u7684 flags \u53c2\u6570\u4e2d\u901a\u8fc7\u6309\u4f4d\u6216\u7684\u65b9\u5f0f\u6dfb\u52a0\u4e00\u4e2a\u6216\u591a\u4e2a\u672c\u6587\u6700\u5f00\u5934\u7ed9\u51fa\u7684 clone flags\uff0c\u6b64\u65f6\u751f\u6210\u7684\u5b50\u8fdb\u7a0b\u5c31\u5728\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u4e86\u3002\u4f8b\u5982\uff1a -int ch = clone(child, child_stack_start, SIGCHLD, name); +int ch = clone(child, child_stack_start, CLONE_NEWPID | SIGCHLD, name);","title":"\u5c06\u5b50\u8fdb\u7a0b\u9694\u79bb\u81f3\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d (clone)"},{"location":"lab-4/namespaces/#unshare","text":"\u4e0a\u9762\u63d0\u5230\uff0c\u9694\u79bb\u547d\u540d\u7a7a\u95f4\u7684\u53e6\u4e00\u4e2a\u9009\u62e9\u662f unshare\u3002\u4e0e clone \u7684\u4e3b\u8981\u4e0d\u540c\u70b9\u662f\uff0cunshare \u5728 \u5f53\u524d\u8fdb\u7a0b \u4e2d\u521b\u5efa\u9694\u79bb\u7684\u547d\u540d\u7a7a\u95f4\uff08\uff09\uff0c\u5728\u8c03\u7528 unshare(CLONE_NEWXXX) \u5b8c\u6210\u4e4b\u540e\uff0c\u5f53\u524d\u8fdb\u7a0b\u5c31\u4f4d\u4e8e\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u4e86\u3002\u5982\u679c\u4f60\u5728\u540e\u9762\u7684\u5b9e\u9a8c\u6b65\u9aa4\u4e2d\u9047\u5230\u4e86\u56f0\u96be\uff0c\u53ef\u4ee5\u5c1d\u8bd5\u5c06\u4e00\u4e2a\u6216\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\u6539\u4e3a\u4f7f\u7528 unshare \u9694\u79bb\u3002 * \u8fd9\u91cc\u6709\u4e00\u4e2a\u4f8b\u5916\uff0c\u90a3\u5c31\u662f CLONE_NEWPID \u3002\u8c03\u7528 unshare(CLONE_NEWPID) \u540e\uff0c\u5f53\u524d\u8fdb\u7a0b \u4e0d\u4f1a \u4f4d\u4e8e\u65b0\u7684 PID \u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u800c\u662f\u5728\u6b64\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2a fork \u51fa\u6765\u7684\u5b50\u8fdb\u7a0b\u3002","title":"\u5c06\u8fdb\u7a0b\u9694\u79bb\u81f3\u65b0\u7684\u547d\u540d\u7a7a\u95f4\u4e2d (unshare)"},{"location":"lab-4/namespaces/#_2","text":"Separation Anxiety: A Tutorial for Isolating Your System with Linux Namespaces \u4e0b\u9762\u51e0\u4e2a\u94fe\u63a5\u662f\u5728\u7ebf\u7248\u7684 man \u6587\u6863\uff0c\u4e0e\u7ec8\u7aef\u91cc\u7684 man 7 <title> \u5728\u5185\u5bb9\u4e0a\u6ca1\u6709\u4efb\u4f55\u533a\u522b\uff0c\u5efa\u8bae\u6309\u9700\u9605\u8bfb\u3002 namespaces(7) cgroup_namespaces(7) ipc_namespaces(7) mount_namespaces(7) pid_namespaces(7) uts_namespaces(7)","title":"\u53c2\u8003\u8d44\u6599"},{"location":"lab-4/namespaces/#clone_1","text":"#define _GNU_SOURCE // Required for enabling clone(2) #include <stdio.h> #include <sched.h> // For clone(2) #include <signal.h> // For SIGCHLD constant #include <sys/mman.h> // For mmap(2) #include <sys/types.h> // For wait(2) #include <sys/wait.h> // For wait(2) int child ( void * arg ) { printf ( \"My name is %s \\n \" , ( char * ) arg ); return 3 ; } int main () { char name [] = \"child\" ; #define STACK_SIZE (1024 * 1024) // 1 MiB void * child_stack = mmap ( NULL , STACK_SIZE , PROT_READ | PROT_WRITE , MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK , - 1 , 0 ); // Assume stack grows downwards void * child_stack_start = child_stack + STACK_SIZE ; int ch = clone ( child , child_stack_start , SIGCHLD , name ); int status ; wait ( & status ); printf ( \"Child exited with code %d \\n \" , WEXITSTATUS ( status )); return 0 ; }","title":"clone \u7684\u793a\u4f8b\u7a0b\u5e8f"},{"location":"lab-4/pivot_root/","text":"\u5207\u6362\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf \u00b6 \u5728\u7b2c\u4e00\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u6bd4\u8f83\u4e86 chroot \u4e0e systemd-nspawn \u4e24\u79cd\u5de5\u5177\u3002 \u8bf7\u786e\u4fdd\u4f60\u5728\u524d\u4e00\u6b65\u5b9e\u9a8c\u4e2d\u6309\u8981\u6c42\u5b8c\u6210\u4e86\u5bf9\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\u548c PID \u547d\u540d\u7a7a\u95f4\u7684\u9694\u79bb \uff08\u63a8\u8350\u6309\u8bf4\u660e\u9694\u79bb 5 \u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u4f46\u672c\u6b65\u9aa4\u6700\u5c11\u9700\u8981\u8fd9\u4e24\u4e2a\uff09\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u5bf9\u4f60\u7684\u64cd\u4f5c\u7cfb\u7edf\u4ea7\u751f\u4e00\u4e9b\u5f71\u54cd\u3002\u8fd9\u4e5f\u662f\u7ed9\u51fa\u7684\u6837\u4f8b\u4ee3\u7801\u53ea\u7528\u4e86 chroot(2) \u7684\u539f\u56e0\u3002 \u4f7f\u7528 pivot_root(2) \u7cfb\u7edf\u8c03\u7528 \u00b6 \u67e5\u770b pivot_root(2) \u7684 man \u6587\u6863\uff0c\u53ef\u4ee5\u77e5\u9053\u5b83\u7684\u539f\u578b\u5982\u4e0b\uff1a int pivot_root ( const char * new_root , const char * put_old ); \u540c\u65f6\u6ce8\u610f\u5230\u5e26\u6709\u4e0b\u5212\u7ebf\u7684 Note \u5c31\u5728\u4e0b\u9762\u4e00\u884c\uff1a Note: There is no glibc wrapper for this system call; see NOTES. \u56e0\u6b64\uff0c\u6211\u4eec\u9762\u5bf9\u7684\u7b2c\u4e00\u4e2a\u95ee\u9898\u662f\uff0c\u4e0d\u80fd\u76f4\u63a5\u4f7f\u7528 pivot_root(new_root, put_old) \uff0c\u800c\u662f\u9700\u8981\u4f7f\u7528\u5b83\u7684\u7cfb\u7edf\u8c03\u7528\u53f7\u548c syscall(2) \u3002\u8bf7\u81ea\u884c\u67e5\u9605\u8d44\u6599\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002 \u51c6\u5907 pivot_root \u7684\u73af\u5883 \u00b6 \u5728 pivot_root(2) \u7684 DESCRIPTION \u4e00\u8282\u6709\u5199\u660e The following restrictions apply \uff0c\u6211\u4eec\u6bd4\u8f83\u5173\u5fc3\u5176\u4e2d\u7684\u7b2c\u4e8c\u4e2a\uff1a new_root and put_old must not be on the same filesystem as the current root. \u7531\u4e8e\u6211\u4eec\u7684\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u5c31\u5728\u4e00\u4e2a\u76ee\u5f55\u4e0b\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8fd9\u5b9e\u9645\u4e0a\u662f\u4e0d\u53ef\u80fd\u7684\u3002\u5b9e\u9a8c\u8868\u660e\uff0c\u8fd9\u91cc\u8981\u6c42\u7684\u5e76\u4e0d\u662f\u7269\u7406\u4e0a\u6216\u903b\u8f91\u4e0a\u4e0d\u540c\u7684\u201c\u6587\u4ef6\u7cfb\u7edf\u201d\uff0c\u800c\u662f\u4e0d\u5728\u540c\u4e00\u4e2a\u6302\u8f7d\u70b9\u4e0b\u7684\u76ee\u5f55\u6811\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u901a\u8fc7 bind mount \u7684\u65b9\u5f0f\u5c06\u6211\u4eec\u7684\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u5230\u4e00\u4e2a\u4e34\u65f6\u7684\u5730\u65b9\uff0c\u7136\u540e\u5c31\u53ef\u4ee5 pivot_root \u8fc7\u53bb\u4e86\u3002 \u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u7684\u76ee\u5f55\u7528\u4e8e bind mount \u5341\u5206\u7b80\u5355\uff0c\u4f8b\u5982\u4f60\u53ef\u4ee5\u4f7f\u7528 /tmp/lab4 \uff0c\u4f46\u662f\u591a\u6b21\u8fd0\u884c\u7684\u65f6\u5019\u53ef\u80fd\u4f1a\u53d1\u751f\u51b2\u7a81\uff0c\u56e0\u6b64\u8fd9\u91cc\u63a8\u8350\u4f7f\u7528 mkdtemp(3) \u521b\u5efa\u542b\u6709\u968f\u673a\u5b57\u7b26\u4e32\u7684\u4e34\u65f6\u6587\u4ef6\u5939\u7528\u4e8e\u540e\u7eed\u5de5\u4f5c\u3002 mkdtemp(3) \u63a5\u53d7\u4e00\u4e2a\u5b57\u7b26\u4e32\u53c2\u6570\uff0c\u4e14\u672b\u5c3e\u6709\u81f3\u5c11 6 \u4e2a\u5927\u5199\u5b57\u6bcd X \u3002\u5f53\u5176\u8fd0\u884c\u6210\u529f\u65f6\uff0c\u4f1a\u5c06\u5b57\u7b26\u4e32\u672b\u5c3e\u7684 X \u66ff\u6362\u4e3a\u968f\u673a\u7684\u5b57\u6bcd\u548c\u6570\u5b57\uff0c\u5e76\u4ee5\u8fd9\u4e2a\u65b0\u7684\u540d\u5b57\u521b\u5efa\u4e00\u4e2a\u76ee\u5f55\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u5c31\u662f\u4e00\u79cd mkdtemp(3) \u7684\u7528\u6cd5\uff1a char tmpdir [] = \"/tmp/lab4-XXXXXX\" ; mkdtemp ( tmpdir ); \u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u4f7f\u7528 mount(2) \u5c06\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf bind mount \u81f3\u65b0\u521b\u5efa\u7684\u76ee\u5f55\u3002\u5173\u4e8e mount(2) \u7684\u7528\u6cd5\u8bf7\u53c2\u9605 \u76f8\u5173\u7ae0\u8282 \u3002\u5728 shell \u4e2d\uff0c\u4f60\u5c06\u4f1a\u4f7f\u7528 mount -o bind <src> <dst> \u8fd9\u6837\u7684\u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c\u3002 \u6ce8\u610f \uff1abind mount \u4f1a\u8986\u76d6\uff08\u9690\u85cf\uff09\u6302\u8f7d\u70b9\u539f\u6709\u7684\u6587\u4ef6\uff0c\u540c\u65f6 bind mount \u4e0d\u662f\u9012\u5f52\u7684\uff08\u5373\u539f\u8def\u5f84\u4e0b\u7684\u5176\u4ed6\u6302\u8f7d\u70b9\u4e0d\u4f1a\u8ddf\u7740\u4e00\u8d77 bind \u8fc7\u53bb\uff09\uff0c\u56e0\u6b64\u5982\u679c\u4f60\u5df2\u7ecf\u5728\u4e0a\u4e00\u6b65\u5b8c\u6210\u4e86\u5bf9 /proc \u7b49\u5bb9\u5668\u5185\u7279\u6b8a\u6587\u4ef6\u7cfb\u7edf\u7684\u6302\u8f7d\uff0c\u4f60\u9700\u8981\u5c06\u76f8\u5173\u64cd\u4f5c\u79fb\u52a8\u5230 bind mount \u4e4b\u540e\u8fdb\u884c\u3002 \u8fdb\u884c pivot_root \u00b6 \u4e00\u5207\u51c6\u5907\u5c31\u7eea\u540e\uff0c\u5c31\u53ef\u4ee5\u4e3a\u5bb9\u5668\u5207\u6362\u6839\u6587\u4ef6\u7cfb\u7edf\u4e86\u3002\u5207\u6362\u7684\u64cd\u4f5c\u6bd4\u8f83\u7b80\u5355\uff0c\u76f4\u63a5\u8c03\u7528 pivot_root(2) \u5373\u53ef\uff1a char oldrootdir [] = \"\" ; sprintf ( oldrootdir , \"%s/oldroot\" , tmpdir ); pivot_root ( tmpdir , oldrootdir ); \u82e5 pivot_root \u8fd4\u56de\u503c\u4e3a\u96f6\uff0c\u90a3\u4e48\u5c31\u5207\u6362\u6210\u529f\u4e86\uff0c\u539f\u6765\u73af\u5883\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u73b0\u5728\u4f4d\u4e8e /oldroot \uff0c\u6211\u4eec\u5c06\u5728\u4e0b\u9762\u7684\u5c0f\u8282\u8ba8\u8bba\u5b83\u3002 \u8fd9\u91cc\u5bf9 pivot_root(2) \u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u505a\u4e00\u4e9b\u8865\u5145\u8bf4\u660e\u3002 \u5728 pivot_root(2) \u7684 DESCRIPTION \u4e00\u8282\u6709\u5199\u660e The following restrictions apply \uff0c\u521a\u624d\u6211\u4eec\u5173\u6ce8\u4e86\u5176\u4e2d\u7684\u7b2c\u4e8c\u4e2a\uff0c\u73b0\u5728\u6211\u4eec\u8981\u5173\u6ce8\u7b2c\u4e09\u4e2a\uff1a put_old must be underneath new_root , that is, adding a nonzero number of /.. to the string pointed to by put_old must yield the same directory as new_root . \u8fd9\u91cc\u7684\u8981\u6c42\u662f put_old \u5fc5\u987b\u662f new_root \u7684\u5b50\u76ee\u5f55\uff0c\u6240\u4ee5\u5b83\u4eec\u90fd\u662f\u8fdb\u884c pivot_root \u4e4b\u524d \u7684\u8def\u5f84\uff0c\u800c\u5728 pivot_root \u4e4b\u540e\uff0c\u539f\u5148\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u5c31\u4f4d\u4e8e put_old - new_root \u7684\u4f4d\u7f6e\u4e86\u3002\uff08\u8fd9\u91cc\u7684\u5b57\u7b26\u4e32\u51cf\u6cd5\u4ec5\u4f5c\u793a\u610f\uff0c\u7406\u89e3\u610f\u601d\u5373\u53ef\uff09 \u9690\u85cf\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf \u00b6 \u4e3a\u5bb9\u5668\u5207\u6362\u6839\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u5c31\u4f4d\u4e8e\u5bb9\u5668\u4e2d\u7684 /oldroot \u4e86\u3002\u8fd9\u65f6\u5019\u4f60\u53ef\u4ee5\u89c2\u5bdf mount \u547d\u4ee4\u7684\u8f93\u51fa\uff0c\u5e94\u8be5\u80fd\u770b\u5230\u5176\u4e2d\u6709\u4e0b\u9762\u8fd9\u6837\u4e00\u884c\uff1a /dev/sda1 on /oldroot type ext4 (rw,relatime,errors=remount-ro) \u540c\u65f6\u4f60\u4e5f\u5e94\u8be5\u6ce8\u610f\u5230\u4e86\uff0c\u6302\u8f7d\u8def\u5f84\u5f00\u5934\u5c31\u662f / \uff08\u6839\u76ee\u5f55\uff09\uff0c\u800c\u4e0d\u662f\u50cf /tmp/lab4-tkytql \u8fd9\u6837\u5728\u4e3b\u673a\u4e0a\u7684\u524d\u7f00\uff0c\u8fd9\u8bf4\u660e pivot_root \u8fd0\u884c\u6210\u529f\u4e86\u3002 \u5bb9\u5668\u7684\u4e00\u5927\u7279\u70b9\u5c31\u662f\u4e0e\u4e3b\u673a\u9694\u79bb\uff0c\u56e0\u6b64 \u5c06\u4e3b\u673a\u7684\u6587\u4ef6\u7cfb\u7edf\u66b4\u9732\u5728\u5bb9\u5668\u4e2d\u663e\u7136\u662f\u4e0d\u80fd\u63a5\u53d7\u7684 \uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u8981\u5c06 /oldroot \u4ece\u5bb9\u5668\u4e2d\u9690\u85cf\u8d77\u6765\u3002 \u73b0\u5728\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u73b0\u5728\u521a\u597d\u662f\u4e00\u4e2a\u6302\u8f7d\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5c06\u5176\u5378\u8f7d\u3002\u4f60\u53ef\u80fd\u4f1a\u8feb\u4e0d\u53ca\u5f85\u5730\u60f3\u8981\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a umount /oldroot \u8fd9\u65f6\u5019\u4f60\u4f1a\u5931\u671b\u5730\u770b\u5230\u4e0b\u9762\u7684\u8f93\u51fa\uff1a umount: /oldroot: target is busy. \u8fd9\u662f\u56e0\u4e3a\u4e3b\u673a\u4e0a\u8fd8\u6709\u8fdb\u7a0b\u5728\u4f7f\u7528\u8fd9\u4e2a\u6302\u8f7d\u70b9\u4e0b\u7684\u6587\u4ef6\u7b49\uff08\u8fd9\u662f\u663e\u7136\u7684\uff09\uff0c\u56e0\u6b64\u4e0d\u80fd\u76f4\u63a5\u5378\u8f7d\u8fd9\u4e2a\u8def\u5f84\u3002 Linux \u63d0\u4f9b\u4e86\u4e00\u79cd\u65b9\u5f0f\uff0c\u4e0d\u76f4\u63a5\u5378\u8f7d\u6574\u4e2a\u6302\u8f7d\u70b9\uff0c\u800c\u662f\u5c06\u6302\u8f7d\u70b9\u4ece\u5f53\u524d\u7684\u76ee\u5f55\u6811\u4e2d\u8131\u79bb\uff08detach\uff09\uff0c\u6b64\u65f6\u6240\u6709\u7a0b\u5e8f\u90fd\u4e0d\u518d\u80fd\u591f\u901a\u8fc7\u8fd9\u4e2a\u8def\u5f84\u6765\u8bbf\u95ee\u8be5\u6302\u8f7d\u70b9\u4e0b\u7684\u5185\u5bb9\uff0c\u4f46\u5df2\u7ecf\u6253\u5f00\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u7b49\u5219\u4e0d\u53d7\u5f71\u54cd\u3002\u8fd9\u88ab\u79f0\u4f5c\u300c\u61d2\u60f0\u5378\u8f7d\u300d\uff08lazy unmounting\uff09\uff0c\u5bf9\u5e94\u7684\u547d\u4ee4\u662f umount -l <path> \u3002\u8bf7\u81ea\u884c\u67e5\u9605\u8d44\u6599\uff08\u5982 umount(8) \u7b49\uff09\uff0c\u7ed3\u5408\u4f7f\u7528 strace \u5de5\u5177\u627e\u51fa\u5408\u9002\u7684\u7cfb\u7edf\u8c03\u7528\u6765\u5b8c\u6210\u8be5\u64cd\u4f5c\uff08\u5c06\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u4ece\u5f53\u524d\u76ee\u5f55\u6811\u7ed3\u6784\u4e2d\u8131\u79bb\uff09\u3002\u6b63\u786e\u9690\u85cf\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c /oldroot \u5e94\u8be5\u4e3a\u4e00\u4e2a\u7a7a\u76ee\u5f55\uff0c\u6b64\u65f6\u4f60\u53ef\u4ee5\u5c06\u5b83\u5220\u9664\uff08\u4f7f\u7528 rmdir(\"/oldroot\") \u5373\u53ef\uff09 \u4f5c\u4e3a\u4e00\u4e2a\u63d0\u793a\uff0c\u672c\u6bb5\u843d\u6240\u8ff0\u5185\u5bb9\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u8c03\u7528\u4e24\u4e2a\u7cfb\u7edf\u8c03\u7528\uff0c\u5176\u4e2d\u7b2c\u4e8c\u4e2a\u662f rmdir(2) \uff1b \u4ece\u4e3b\u673a\u4e0a\u9690\u85cf\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf \u00b6 \u5728\u524d\u9762\u7684\u6b65\u9aa4\u4e2d\uff0c\u6211\u4eec\u4e3a\u4e86\u4f7f\u7528 pivot_root(2)\uff0c\u5c06\u672c\u5df2\u5b58\u5728\u4e8e\u7cfb\u7edf\u76ee\u5f55\u7ed3\u6784\u4e2d\u7684\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u901a\u8fc7 bind mount \u7684\u65b9\u5f0f\u53c8\u6302\u8f7d\u5230\u4e86\u53e6\u4e00\u4e2a\u5730\u65b9\uff0c\u8fd9\u4ece\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u5728\u4e3b\u673a\u7684\u76ee\u5f55\u6811\u4e2d\u589e\u52a0\u4e86\u6df7\u4e71\u3002 \u8fd9\u4e00\u6b65\u7684\u8981\u6c42\u4e0e\u4e0a\u4e00\u6b65\u5b8c\u5168\u4e00\u81f4\uff0c\u4f46\u65b9\u5411\u6070\u597d\u76f8\u53cd\uff0c\u5c06\u524d\u9762\u7684\u6b65\u9aa4\u4e2d\u521b\u5efa\u7684 bind mount \u6302\u8f7d\u70b9 \u7528\u76f8\u540c\u7684\u65b9\u5f0f\u4ece\u4e3b\u673a\u4e2d\u9690\u85cf\uff08\u5305\u62ec rmdir \u79fb\u9664\u6302\u8f7d\u76ee\u5f55\uff09\u3002\u4f60\u4e0d\u9700\u8981\u5c06 bind mount \u7684\u6e90\u76ee\u5f55\u9690\u85cf\uff08\u4e8b\u5b9e\u4e0a\u8fd9\u4e2a\u8981\u6c42\u53ef\u80fd\u662f\u4e0d\u5408\u7406\u7684\uff09\u3002 \u5982\u679c\u4f60\u5728\u524d\u9762\u5b9e\u73b0\u7684\u6302\u8f7d\u70b9\u9694\u79bb\u662f\u6b63\u786e\u7684\uff0c\u90a3\u4e48\u53ea\u9700\u8981\u79fb\u9664 bind mount \u7684\u4e34\u65f6\u76ee\u5f55\u5373\u53ef\u3002 \u5982\u679c\u4f60\u9700\u8981\u4e00\u79cd\u5728\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u4e4b\u95f4\u901a\u4fe1\u7684\u65b9\u6cd5\uff0c\u8bf7\u4ed4\u7ec6\u56de\u5fc6\u5b9e\u9a8c\u4e8c\u4e2d\u8981\u6c42\u5b9e\u73b0\u7684\u529f\u80fd\uff0c\u601d\u8003\u4e00\u4e0b\u6709\u6ca1\u6709\u5728\u8fd9\u91cc\u7528\u5f97\u4e0a\u7684\u529e\u6cd5\u3002","title":"\u4f7f\u7528 pivot_root"},{"location":"lab-4/pivot_root/#_1","text":"\u5728\u7b2c\u4e00\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u6bd4\u8f83\u4e86 chroot \u4e0e systemd-nspawn \u4e24\u79cd\u5de5\u5177\u3002 \u8bf7\u786e\u4fdd\u4f60\u5728\u524d\u4e00\u6b65\u5b9e\u9a8c\u4e2d\u6309\u8981\u6c42\u5b8c\u6210\u4e86\u5bf9\u6302\u8f7d\u547d\u540d\u7a7a\u95f4\u548c PID \u547d\u540d\u7a7a\u95f4\u7684\u9694\u79bb \uff08\u63a8\u8350\u6309\u8bf4\u660e\u9694\u79bb 5 \u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u4f46\u672c\u6b65\u9aa4\u6700\u5c11\u9700\u8981\u8fd9\u4e24\u4e2a\uff09\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u5bf9\u4f60\u7684\u64cd\u4f5c\u7cfb\u7edf\u4ea7\u751f\u4e00\u4e9b\u5f71\u54cd\u3002\u8fd9\u4e5f\u662f\u7ed9\u51fa\u7684\u6837\u4f8b\u4ee3\u7801\u53ea\u7528\u4e86 chroot(2) \u7684\u539f\u56e0\u3002","title":"\u5207\u6362\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab-4/pivot_root/#pivot_root2","text":"\u67e5\u770b pivot_root(2) \u7684 man \u6587\u6863\uff0c\u53ef\u4ee5\u77e5\u9053\u5b83\u7684\u539f\u578b\u5982\u4e0b\uff1a int pivot_root ( const char * new_root , const char * put_old ); \u540c\u65f6\u6ce8\u610f\u5230\u5e26\u6709\u4e0b\u5212\u7ebf\u7684 Note \u5c31\u5728\u4e0b\u9762\u4e00\u884c\uff1a Note: There is no glibc wrapper for this system call; see NOTES. \u56e0\u6b64\uff0c\u6211\u4eec\u9762\u5bf9\u7684\u7b2c\u4e00\u4e2a\u95ee\u9898\u662f\uff0c\u4e0d\u80fd\u76f4\u63a5\u4f7f\u7528 pivot_root(new_root, put_old) \uff0c\u800c\u662f\u9700\u8981\u4f7f\u7528\u5b83\u7684\u7cfb\u7edf\u8c03\u7528\u53f7\u548c syscall(2) \u3002\u8bf7\u81ea\u884c\u67e5\u9605\u8d44\u6599\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002","title":"\u4f7f\u7528 pivot_root(2) \u7cfb\u7edf\u8c03\u7528"},{"location":"lab-4/pivot_root/#pivot_root","text":"\u5728 pivot_root(2) \u7684 DESCRIPTION \u4e00\u8282\u6709\u5199\u660e The following restrictions apply \uff0c\u6211\u4eec\u6bd4\u8f83\u5173\u5fc3\u5176\u4e2d\u7684\u7b2c\u4e8c\u4e2a\uff1a new_root and put_old must not be on the same filesystem as the current root. \u7531\u4e8e\u6211\u4eec\u7684\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u5c31\u5728\u4e00\u4e2a\u76ee\u5f55\u4e0b\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8fd9\u5b9e\u9645\u4e0a\u662f\u4e0d\u53ef\u80fd\u7684\u3002\u5b9e\u9a8c\u8868\u660e\uff0c\u8fd9\u91cc\u8981\u6c42\u7684\u5e76\u4e0d\u662f\u7269\u7406\u4e0a\u6216\u903b\u8f91\u4e0a\u4e0d\u540c\u7684\u201c\u6587\u4ef6\u7cfb\u7edf\u201d\uff0c\u800c\u662f\u4e0d\u5728\u540c\u4e00\u4e2a\u6302\u8f7d\u70b9\u4e0b\u7684\u76ee\u5f55\u6811\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u901a\u8fc7 bind mount \u7684\u65b9\u5f0f\u5c06\u6211\u4eec\u7684\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u5230\u4e00\u4e2a\u4e34\u65f6\u7684\u5730\u65b9\uff0c\u7136\u540e\u5c31\u53ef\u4ee5 pivot_root \u8fc7\u53bb\u4e86\u3002 \u521b\u5efa\u4e00\u4e2a\u4e34\u65f6\u7684\u76ee\u5f55\u7528\u4e8e bind mount \u5341\u5206\u7b80\u5355\uff0c\u4f8b\u5982\u4f60\u53ef\u4ee5\u4f7f\u7528 /tmp/lab4 \uff0c\u4f46\u662f\u591a\u6b21\u8fd0\u884c\u7684\u65f6\u5019\u53ef\u80fd\u4f1a\u53d1\u751f\u51b2\u7a81\uff0c\u56e0\u6b64\u8fd9\u91cc\u63a8\u8350\u4f7f\u7528 mkdtemp(3) \u521b\u5efa\u542b\u6709\u968f\u673a\u5b57\u7b26\u4e32\u7684\u4e34\u65f6\u6587\u4ef6\u5939\u7528\u4e8e\u540e\u7eed\u5de5\u4f5c\u3002 mkdtemp(3) \u63a5\u53d7\u4e00\u4e2a\u5b57\u7b26\u4e32\u53c2\u6570\uff0c\u4e14\u672b\u5c3e\u6709\u81f3\u5c11 6 \u4e2a\u5927\u5199\u5b57\u6bcd X \u3002\u5f53\u5176\u8fd0\u884c\u6210\u529f\u65f6\uff0c\u4f1a\u5c06\u5b57\u7b26\u4e32\u672b\u5c3e\u7684 X \u66ff\u6362\u4e3a\u968f\u673a\u7684\u5b57\u6bcd\u548c\u6570\u5b57\uff0c\u5e76\u4ee5\u8fd9\u4e2a\u65b0\u7684\u540d\u5b57\u521b\u5efa\u4e00\u4e2a\u76ee\u5f55\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u5c31\u662f\u4e00\u79cd mkdtemp(3) \u7684\u7528\u6cd5\uff1a char tmpdir [] = \"/tmp/lab4-XXXXXX\" ; mkdtemp ( tmpdir ); \u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u4f7f\u7528 mount(2) \u5c06\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf bind mount \u81f3\u65b0\u521b\u5efa\u7684\u76ee\u5f55\u3002\u5173\u4e8e mount(2) \u7684\u7528\u6cd5\u8bf7\u53c2\u9605 \u76f8\u5173\u7ae0\u8282 \u3002\u5728 shell \u4e2d\uff0c\u4f60\u5c06\u4f1a\u4f7f\u7528 mount -o bind <src> <dst> \u8fd9\u6837\u7684\u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c\u3002 \u6ce8\u610f \uff1abind mount \u4f1a\u8986\u76d6\uff08\u9690\u85cf\uff09\u6302\u8f7d\u70b9\u539f\u6709\u7684\u6587\u4ef6\uff0c\u540c\u65f6 bind mount \u4e0d\u662f\u9012\u5f52\u7684\uff08\u5373\u539f\u8def\u5f84\u4e0b\u7684\u5176\u4ed6\u6302\u8f7d\u70b9\u4e0d\u4f1a\u8ddf\u7740\u4e00\u8d77 bind \u8fc7\u53bb\uff09\uff0c\u56e0\u6b64\u5982\u679c\u4f60\u5df2\u7ecf\u5728\u4e0a\u4e00\u6b65\u5b8c\u6210\u4e86\u5bf9 /proc \u7b49\u5bb9\u5668\u5185\u7279\u6b8a\u6587\u4ef6\u7cfb\u7edf\u7684\u6302\u8f7d\uff0c\u4f60\u9700\u8981\u5c06\u76f8\u5173\u64cd\u4f5c\u79fb\u52a8\u5230 bind mount \u4e4b\u540e\u8fdb\u884c\u3002","title":"\u51c6\u5907 pivot_root \u7684\u73af\u5883"},{"location":"lab-4/pivot_root/#pivot_root_1","text":"\u4e00\u5207\u51c6\u5907\u5c31\u7eea\u540e\uff0c\u5c31\u53ef\u4ee5\u4e3a\u5bb9\u5668\u5207\u6362\u6839\u6587\u4ef6\u7cfb\u7edf\u4e86\u3002\u5207\u6362\u7684\u64cd\u4f5c\u6bd4\u8f83\u7b80\u5355\uff0c\u76f4\u63a5\u8c03\u7528 pivot_root(2) \u5373\u53ef\uff1a char oldrootdir [] = \"\" ; sprintf ( oldrootdir , \"%s/oldroot\" , tmpdir ); pivot_root ( tmpdir , oldrootdir ); \u82e5 pivot_root \u8fd4\u56de\u503c\u4e3a\u96f6\uff0c\u90a3\u4e48\u5c31\u5207\u6362\u6210\u529f\u4e86\uff0c\u539f\u6765\u73af\u5883\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u73b0\u5728\u4f4d\u4e8e /oldroot \uff0c\u6211\u4eec\u5c06\u5728\u4e0b\u9762\u7684\u5c0f\u8282\u8ba8\u8bba\u5b83\u3002 \u8fd9\u91cc\u5bf9 pivot_root(2) \u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u505a\u4e00\u4e9b\u8865\u5145\u8bf4\u660e\u3002 \u5728 pivot_root(2) \u7684 DESCRIPTION \u4e00\u8282\u6709\u5199\u660e The following restrictions apply \uff0c\u521a\u624d\u6211\u4eec\u5173\u6ce8\u4e86\u5176\u4e2d\u7684\u7b2c\u4e8c\u4e2a\uff0c\u73b0\u5728\u6211\u4eec\u8981\u5173\u6ce8\u7b2c\u4e09\u4e2a\uff1a put_old must be underneath new_root , that is, adding a nonzero number of /.. to the string pointed to by put_old must yield the same directory as new_root . \u8fd9\u91cc\u7684\u8981\u6c42\u662f put_old \u5fc5\u987b\u662f new_root \u7684\u5b50\u76ee\u5f55\uff0c\u6240\u4ee5\u5b83\u4eec\u90fd\u662f\u8fdb\u884c pivot_root \u4e4b\u524d \u7684\u8def\u5f84\uff0c\u800c\u5728 pivot_root \u4e4b\u540e\uff0c\u539f\u5148\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u5c31\u4f4d\u4e8e put_old - new_root \u7684\u4f4d\u7f6e\u4e86\u3002\uff08\u8fd9\u91cc\u7684\u5b57\u7b26\u4e32\u51cf\u6cd5\u4ec5\u4f5c\u793a\u610f\uff0c\u7406\u89e3\u610f\u601d\u5373\u53ef\uff09","title":"\u8fdb\u884c pivot_root"},{"location":"lab-4/pivot_root/#_2","text":"\u4e3a\u5bb9\u5668\u5207\u6362\u6839\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u5c31\u4f4d\u4e8e\u5bb9\u5668\u4e2d\u7684 /oldroot \u4e86\u3002\u8fd9\u65f6\u5019\u4f60\u53ef\u4ee5\u89c2\u5bdf mount \u547d\u4ee4\u7684\u8f93\u51fa\uff0c\u5e94\u8be5\u80fd\u770b\u5230\u5176\u4e2d\u6709\u4e0b\u9762\u8fd9\u6837\u4e00\u884c\uff1a /dev/sda1 on /oldroot type ext4 (rw,relatime,errors=remount-ro) \u540c\u65f6\u4f60\u4e5f\u5e94\u8be5\u6ce8\u610f\u5230\u4e86\uff0c\u6302\u8f7d\u8def\u5f84\u5f00\u5934\u5c31\u662f / \uff08\u6839\u76ee\u5f55\uff09\uff0c\u800c\u4e0d\u662f\u50cf /tmp/lab4-tkytql \u8fd9\u6837\u5728\u4e3b\u673a\u4e0a\u7684\u524d\u7f00\uff0c\u8fd9\u8bf4\u660e pivot_root \u8fd0\u884c\u6210\u529f\u4e86\u3002 \u5bb9\u5668\u7684\u4e00\u5927\u7279\u70b9\u5c31\u662f\u4e0e\u4e3b\u673a\u9694\u79bb\uff0c\u56e0\u6b64 \u5c06\u4e3b\u673a\u7684\u6587\u4ef6\u7cfb\u7edf\u66b4\u9732\u5728\u5bb9\u5668\u4e2d\u663e\u7136\u662f\u4e0d\u80fd\u63a5\u53d7\u7684 \uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u8981\u5c06 /oldroot \u4ece\u5bb9\u5668\u4e2d\u9690\u85cf\u8d77\u6765\u3002 \u73b0\u5728\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u73b0\u5728\u521a\u597d\u662f\u4e00\u4e2a\u6302\u8f7d\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5c06\u5176\u5378\u8f7d\u3002\u4f60\u53ef\u80fd\u4f1a\u8feb\u4e0d\u53ca\u5f85\u5730\u60f3\u8981\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a umount /oldroot \u8fd9\u65f6\u5019\u4f60\u4f1a\u5931\u671b\u5730\u770b\u5230\u4e0b\u9762\u7684\u8f93\u51fa\uff1a umount: /oldroot: target is busy. \u8fd9\u662f\u56e0\u4e3a\u4e3b\u673a\u4e0a\u8fd8\u6709\u8fdb\u7a0b\u5728\u4f7f\u7528\u8fd9\u4e2a\u6302\u8f7d\u70b9\u4e0b\u7684\u6587\u4ef6\u7b49\uff08\u8fd9\u662f\u663e\u7136\u7684\uff09\uff0c\u56e0\u6b64\u4e0d\u80fd\u76f4\u63a5\u5378\u8f7d\u8fd9\u4e2a\u8def\u5f84\u3002 Linux \u63d0\u4f9b\u4e86\u4e00\u79cd\u65b9\u5f0f\uff0c\u4e0d\u76f4\u63a5\u5378\u8f7d\u6574\u4e2a\u6302\u8f7d\u70b9\uff0c\u800c\u662f\u5c06\u6302\u8f7d\u70b9\u4ece\u5f53\u524d\u7684\u76ee\u5f55\u6811\u4e2d\u8131\u79bb\uff08detach\uff09\uff0c\u6b64\u65f6\u6240\u6709\u7a0b\u5e8f\u90fd\u4e0d\u518d\u80fd\u591f\u901a\u8fc7\u8fd9\u4e2a\u8def\u5f84\u6765\u8bbf\u95ee\u8be5\u6302\u8f7d\u70b9\u4e0b\u7684\u5185\u5bb9\uff0c\u4f46\u5df2\u7ecf\u6253\u5f00\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u7b49\u5219\u4e0d\u53d7\u5f71\u54cd\u3002\u8fd9\u88ab\u79f0\u4f5c\u300c\u61d2\u60f0\u5378\u8f7d\u300d\uff08lazy unmounting\uff09\uff0c\u5bf9\u5e94\u7684\u547d\u4ee4\u662f umount -l <path> \u3002\u8bf7\u81ea\u884c\u67e5\u9605\u8d44\u6599\uff08\u5982 umount(8) \u7b49\uff09\uff0c\u7ed3\u5408\u4f7f\u7528 strace \u5de5\u5177\u627e\u51fa\u5408\u9002\u7684\u7cfb\u7edf\u8c03\u7528\u6765\u5b8c\u6210\u8be5\u64cd\u4f5c\uff08\u5c06\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u4ece\u5f53\u524d\u76ee\u5f55\u6811\u7ed3\u6784\u4e2d\u8131\u79bb\uff09\u3002\u6b63\u786e\u9690\u85cf\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u540e\uff0c /oldroot \u5e94\u8be5\u4e3a\u4e00\u4e2a\u7a7a\u76ee\u5f55\uff0c\u6b64\u65f6\u4f60\u53ef\u4ee5\u5c06\u5b83\u5220\u9664\uff08\u4f7f\u7528 rmdir(\"/oldroot\") \u5373\u53ef\uff09 \u4f5c\u4e3a\u4e00\u4e2a\u63d0\u793a\uff0c\u672c\u6bb5\u843d\u6240\u8ff0\u5185\u5bb9\u975e\u5e38\u7b80\u5355\uff0c\u53ea\u9700\u8981\u8c03\u7528\u4e24\u4e2a\u7cfb\u7edf\u8c03\u7528\uff0c\u5176\u4e2d\u7b2c\u4e8c\u4e2a\u662f rmdir(2) \uff1b","title":"\u9690\u85cf\u4e3b\u673a\u7684\u6839\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab-4/pivot_root/#_3","text":"\u5728\u524d\u9762\u7684\u6b65\u9aa4\u4e2d\uff0c\u6211\u4eec\u4e3a\u4e86\u4f7f\u7528 pivot_root(2)\uff0c\u5c06\u672c\u5df2\u5b58\u5728\u4e8e\u7cfb\u7edf\u76ee\u5f55\u7ed3\u6784\u4e2d\u7684\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u901a\u8fc7 bind mount \u7684\u65b9\u5f0f\u53c8\u6302\u8f7d\u5230\u4e86\u53e6\u4e00\u4e2a\u5730\u65b9\uff0c\u8fd9\u4ece\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u5728\u4e3b\u673a\u7684\u76ee\u5f55\u6811\u4e2d\u589e\u52a0\u4e86\u6df7\u4e71\u3002 \u8fd9\u4e00\u6b65\u7684\u8981\u6c42\u4e0e\u4e0a\u4e00\u6b65\u5b8c\u5168\u4e00\u81f4\uff0c\u4f46\u65b9\u5411\u6070\u597d\u76f8\u53cd\uff0c\u5c06\u524d\u9762\u7684\u6b65\u9aa4\u4e2d\u521b\u5efa\u7684 bind mount \u6302\u8f7d\u70b9 \u7528\u76f8\u540c\u7684\u65b9\u5f0f\u4ece\u4e3b\u673a\u4e2d\u9690\u85cf\uff08\u5305\u62ec rmdir \u79fb\u9664\u6302\u8f7d\u76ee\u5f55\uff09\u3002\u4f60\u4e0d\u9700\u8981\u5c06 bind mount \u7684\u6e90\u76ee\u5f55\u9690\u85cf\uff08\u4e8b\u5b9e\u4e0a\u8fd9\u4e2a\u8981\u6c42\u53ef\u80fd\u662f\u4e0d\u5408\u7406\u7684\uff09\u3002 \u5982\u679c\u4f60\u5728\u524d\u9762\u5b9e\u73b0\u7684\u6302\u8f7d\u70b9\u9694\u79bb\u662f\u6b63\u786e\u7684\uff0c\u90a3\u4e48\u53ea\u9700\u8981\u79fb\u9664 bind mount \u7684\u4e34\u65f6\u76ee\u5f55\u5373\u53ef\u3002 \u5982\u679c\u4f60\u9700\u8981\u4e00\u79cd\u5728\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u4e4b\u95f4\u901a\u4fe1\u7684\u65b9\u6cd5\uff0c\u8bf7\u4ed4\u7ec6\u56de\u5fc6\u5b9e\u9a8c\u4e8c\u4e2d\u8981\u6c42\u5b9e\u73b0\u7684\u529f\u80fd\uff0c\u601d\u8003\u4e00\u4e0b\u6709\u6ca1\u6709\u5728\u8fd9\u91cc\u7528\u5f97\u4e0a\u7684\u529e\u6cd5\u3002","title":"\u4ece\u4e3b\u673a\u4e0a\u9690\u85cf\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab-4/rootfs/","text":"\u51c6\u5907\u4f60\u7684\u5bb9\u5668\u73af\u5883 \u00b6 \u6784\u5efa\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff08rootfs\uff09 \u00b6 \u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u548c\u5b8c\u6574\u64cd\u4f5c\u7cfb\u7edf\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u5e76\u65e0\u592a\u5927\u533a\u522b\uff0c\u90fd\u5305\u542b\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684\u64cd\u4f5c\u7cfb\u7edf\u76ee\u5f55\u7ed3\u6784\u548c\u5fc5\u8981\u7684\u6587\u4ef6\u3002\u4e0b\u9762\u4ecb\u7ecd\u4e09\u79cd\u6784\u5efa\u5bb9\u5668\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u65b9\u5f0f\u3002 \u672c\u6b21\u5b9e\u9a8c\u63a8\u8350\u4f7f\u7528 LXC \u955c\u50cf\u3002 \u81ea\u5df1\u7f16\u5199 init \u7a0b\u5e8f\u4e0e\u4f7f\u7528 BusyBox \u6784\u5efa\u6839\u6587\u4ef6\u7cfb\u7edf \u00b6 \u5b9e\u9a8c\u4e00\u4e2d \u4ecb\u7ecd\u7684\u4e24\u79cd\u6784\u5efa\u521d\u59cb\u5185\u5b58\u76d8\uff08initrd\uff09\u7684\u65b9\u5f0f\u5728\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\uff0c\u5728\u5c06\u6587\u4ef6\u653e\u7f6e\u59a5\u5f53\u540e\uff0c\u4f60\u4e0d\u518d\u9700\u8981\u5c06\u5b83\u4eec\u6253\u5305\u4e3a initrd.cpio.gz \u6587\u4ef6\uff0c\u800c\u662f\u53ef\u4ee5\u5728\u5bb9\u5668\u4e2d\u76f4\u63a5\u4f7f\u7528\u3002\u5982\u679c\u4f60\u51c6\u5907\u91c7\u7528\u8fd9\u4e24\u79cd\u65b9\u5f0f\uff0c\u53ef\u4ee5\u76f4\u63a5\u9605\u8bfb\u5b9e\u9a8c\u4e00\u6587\u6863\u7684\u76f8\u5173\u7ae0\u8282\u3002 \u4ece LXC \u955c\u50cf\u5e93\u4e0b\u8f7d\u5bb9\u5668\u955c\u50cf \u00b6 Linux Containers \uff08LXC\uff09\u662f\u4e00\u4e2a\u7cfb\u7edf\u5bb9\u5668\u5b9e\u73b0\uff0c\u5176\u4f7f\u7528 Linux \u7684\u5bb9\u5668\u6280\u672f\u8fd0\u884c\u5b8c\u6574\u7684 Linux \u5b50\u7cfb\u7edf\u3002\u7531\u4e8e\u5bb9\u5668\u76f4\u63a5\u4f7f\u7528\u4e3b\u673a\u7684\u5185\u6838\uff0c\u6ca1\u6709\u4e86\u865a\u62df\u5316\u4e2d\u95f4\u5c42\uff0c\u4e0e\u4f20\u7edf\u865a\u62df\u673a\uff08KVM, VMware\uff09\u76f8\u6bd4\u66f4\u8f7b\u4fbf\u3002 LXC \u63d0\u4f9b\u4e86\u591a\u79cd\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u4f60\u53ef\u4ee5\u4ece https://images.linuxcontainers.org/images/ \u76f4\u63a5\u9009\u62e9\u4e0b\u8f7d\uff08\u8bf7\u4e0b\u8f7d amd64 \u67b6\u6784\u4e0b default \u4e2d\u7684 rootfs.tar.gz \u6216 rootfs.tar.xz \u6587\u4ef6\uff09\u3002\u4e0d\u540c\u7684 Linux \u53d1\u884c\u7248\u955c\u50cf\u4e0d\u5f71\u54cd\u672c\u5b9e\u9a8c\u7684\u540e\u7eed\u5185\u5bb9\uff0c\u4f46\u5982\u679c\u4f60\u4e0d\u4e86\u89e3\u5b83\u4eec\u7684\u533a\u522b\u7684\u8bdd\uff0c\u6211\u4eec\u63a8\u8350 Ubuntu 18.04 \u3001 Ubuntu 20.04 \u6216 Debian Buster \u7684\u955c\u50cf\u3002 \u4e0b\u8f7d\u5230\u7684\u6253\u5305 rootfs \u6587\u4ef6\u53ea\u9700\u8981\u89e3\u538b\u5230\u4e00\u4e2a\u65b0\u7684\u76ee\u5f55\u5373\u53ef\uff1a mkdir rootfs/ cd rootfs/ tar zxf ../rootfs.tar.gz # \u6216 tar Jxf ../rootfs.tar.xz Vlab \u5e73\u53f0\u7684\u865a\u62df\u673a\u5373\u662f LXC \u7cfb\u7edf\u5bb9\u5668\uff0c\u4f46\u672c\u5b9e\u9a8c\u4e0d\u5bf9 LXC \u7684\u5b9e\u73b0\u4f5c\u8fc7\u591a\u63a2\u7a76\u3002 \u4f7f\u7528 chroot \u4e0e systemd-nspawn \u4f53\u9a8c\u9694\u79bb\u73af\u5883\u4e0e\u5bb9\u5668\u6280\u672f \u00b6 chroot \u662f\u4e00\u4e2a\u7528\u4e8e\u9650\u5236\u8fdb\u7a0b\u53ef\u4ee5\u770b\u89c1\u7684 root \u76ee\u5f55\uff08\u6839\u76ee\u5f55\uff09\u7684\u673a\u5236\u3002\u5728 chroot \u4e4b\u540e\u4ea7\u751f\u7684\u6240\u6709\u5b50\u8fdb\u7a0b\uff0c\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u662f\u65e0\u6cd5\u770b\u89c1 chroot \u76ee\u5f55\u4ee5\u5916\u7684\u5185\u5bb9\u7684\u3002\u5c3d\u7ba1\u5b9e\u9645\u7684\u5bb9\u5668\u5e76\u4e0d\u4f7f\u7528 chroot\uff08\u540e\u9762\u4f1a\u8bb2\u5230\uff09\uff0c\u7406\u89e3\u5b83\u4ecd\u7136\u662f\u7406\u89e3\u5bb9\u5668\u539f\u7406\u7684\u91cd\u8981\u7684\u4e00\u6b65\u3002 \u5728\u4f60\u51c6\u5907\u597d\u7684 BusyBox \u6216 LXC \u7cfb\u7edf\u955c\u50cf\u76ee\u5f55\u4e2d\u8fd0\u884c chroot . /bin/sh \u6216 chroot . /bin/bash \uff0c\u5373\u53ef chroot \u8fdb\u5165\u8fd9\u4e2a\u7cfb\u7edf\u955c\u50cf\u5e76\u5bf9\u6587\u4ef6\u7cfb\u7edf\u8fdb\u884c\u4e00\u4e9b\u64cd\u4f5c\u3002\u5982\u679c\u4f60\u4f7f\u7528 LXC \u955c\u50cf\uff0c\u4f60\u751a\u81f3\u53ef\u4ee5\u5728\u8fd9\u91cc\u8fdb\u884c apt update \u7b49\u5305\u7ba1\u7406\u64cd\u4f5c\u3002 \u8fd9\u53ea\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u57fa\u7840\u7684\u9694\u79bb\u3002root \u7528\u6237\u53ef\u4ee5\u8f7b\u6613\u8131\u79bb\u4e0d\u52a0\u989d\u5916\u9650\u5236\u7684 chroot \u76d1\u72f1\uff0c\u5e76\u4e14 chroot \u4e0d\u963b\u6b62\u5176\u4ed6\u8bbf\u95ee\u7cfb\u7edf\u8d44\u6e90\u6216\u5176\u4ed6\u8fdb\u7a0b\u7684\u65b9\u5f0f\uff08\u4f60\u53ef\u4ee5\u8bd5\u8bd5\u5728 chroot \u73af\u5883\u4e0b\u6267\u884c reboot \u2014\u2014\u6ce8\u610f\u4fdd\u5b58\u672a\u5b8c\u6210\u7684\u5de5\u4f5c\uff09\u3002 systemd-nspawn \u00b6 \u4f5c\u4e3a\u4e00\u4e2a\u5bf9\u6bd4\uff0csystemd-nspawn \u662f\u4e00\u4e2a\u6700\u5c0f\u5316\u4f46\u5b8c\u6574\u7684\u5bb9\u5668\u5b9e\u73b0\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u8f6f\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88c5 systemd-container \u6765\u83b7\u5f97 systemd-nspawn \u547d\u4ee4\u3002 systemd-nspawn \u7684\u7528\u6cd5\u4e0e chroot \u7c7b\u4f3c\uff0c\u9996\u5148 cd \u5230\u5b58\u6709\u5bb9\u5668\u7cfb\u7edf\u955c\u50cf\u7684\u76ee\u5f55\uff0c\u7136\u540e\u8fd0\u884c systemd-nspawn \uff0c\u4f60\u5c31\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a shell\u3002\u5c3d\u7ba1\u8fd9\u4e2a shell \u770b\u8d77\u6765\u4e0e chroot \u4e2d\u7684 shell \u6ca1\u6709\u4ec0\u4e48\u533a\u522b\uff0c\u4f46\u662f\u5c1d\u8bd5\u4f7f\u7528\u67d0\u4e9b\u547d\u4ee4\u5c31\u4f1a\u53d1\u884c\u660e\u663e\u7684\u4e0d\u540c\u3002\u4e0b\u9762\u5217\u51fa\u51e0\u4e2a\u4f8b\u5b50\uff0c\u4f60\u53ef\u4ee5\u81ea\u5df1\u5206\u522b\u5728 systemd-nspawn \u4e2d\u548c chroot \u4e2d\u8fd0\u884c\u5e76\u6bd4\u8f83\uff1a reboot mount # \u67e5\u770b\u6302\u8f7d\u70b9 dd if = /dev/sda of = test bs = 64k count = 1 # \u5c1d\u8bd5\u8bbf\u95ee\u8bbe\u5907\u6587\u4ef6 echo $$ # \u68c0\u67e5 shell \u672c\u8eab\u7684 PID \u9519\u8bef\u5904\u7406 \u5982\u679c\u4f60\u4f7f\u7528 systemd-nspawn \u65f6\u9047\u5230\u4e86\u4e0b\u9762\u8fd9\u4e2a\u62a5\u9519: Failed to read machine ID from container image: Invalid argument \u8bf7\u5411\u5bb9\u5668\u955c\u50cf\u4e2d\u7684 /etc/machine-id \u6587\u4ef6\u5199\u5165\u4e00\u4e2a machine ID \u5b57\u7b26\u4e32\uff08\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff09\uff0c\u7136\u540e\u91cd\u65b0\u5c1d\u8bd5\u8fd0\u884c. $ systemd-machine-id-setup --root = \u5bb9\u5668\u7684rootfs\u8def\u5f84 \u5bf9\u4e8e Ubuntu 20.04\uff08\u6216\u5176\u4ed6\u4efb\u4f55\u8fd0\u884c systemd 240 \u6216\u4ee5\u4e0a\u7248\u672c\u7684\u7cfb\u7edf\uff09\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u65b0\u7684\u547d\u4ee4 $ systemd-id128 new > etc/machine-id \u4f7f\u7528 systemd-nspawn \u542f\u52a8\u4e00\u4e2a\u5bb9\u5668 \u00b6 \u4e0e chroot \u4e0d\u540c\uff0csystemd-nspawn \u4f5c\u4e3a\u4e00\u4e2a\u5b8c\u6574\u7684\u5bb9\u5668\u5b9e\u73b0\uff0c\u662f\u53ef\u4ee5\u542f\u52a8\u5bb9\u5668\u4e2d\u7684\u64cd\u4f5c\u7cfb\u7edf\u7684\u3002\u65b9\u4fbf\u8d77\u89c1\uff0c\u8fd9\u4e00\u6b65\u63a8\u8350\u4f7f\u7528 LXC \u955c\u50cf \u3002 \u4e3a\u4e86\u786e\u4fdd\u4f60\u80fd\u591f\u767b\u5f55\u8fdb\u5bb9\u5668\u7cfb\u7edf\u4e2d\u7684\u7528\u6237\uff0c\u9996\u5148\u9700\u8981\u4e3a root \u7528\u6237\u8bbe\u7f6e\u5bc6\u7801\uff08\u6216\u8005\u6e05\u9664\u5bc6\u7801\uff09\u3002\u4f7f\u7528 chroot \u6216 systemd-nspawn \u8fdb\u5165\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u8fd0\u884c passwd root \u8bbe\u7f6e\u5bc6\u7801\u6216 passwd -d root \u6e05\u9664\u5bc6\u7801\uff0c\u7136\u540e\u9000\u51fa\u8fd9\u4e2a shell\u3002 \u518d\u6b21\u4f7f\u7528 systemd-nspawn \u5c06\u8fd9\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4f5c\u4e3a\u5bb9\u5668\u8fd0\u884c\uff0c\u4e0d\u8fc7\u8fd9\u4e00\u6b21\u52a0\u4e0a --boot \u53c2\u6570\u3002\u8be5\u53c2\u6570\u4f1a\u8ba9 systemd-nspawn \u5c1d\u8bd5\u8fd0\u884c\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684 init \u7a0b\u5e8f\uff08\u800c\u4e0d\u662f\u4e00\u4e2a shell\uff09\uff0c\u4ece\u800c\u201c\u542f\u52a8\u201d\u8fd9\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002\u770b\u5230\u63d0\u793a\u540e\uff0c\u4f60\u5c31\u53ef\u4ee5\u8f93\u5165\u7528\u6237\u540d root \u548c\u5bc6\u7801\u767b\u5f55\u8fdb\u7cfb\u7edf\u4e86\uff0c\u4f60\u751a\u81f3\u53ef\u4ee5 poweroff \u6216 reboot \u8fd9\u4e2a\u5bb9\u5668\u4e2d\u7684\u7cfb\u7edf\u800c\u4e0d\u7528\u62c5\u5fc3\u4f1a\u5bfc\u81f4\u4e3b\u673a\u88ab\u5173\u673a\u6216\u91cd\u542f\u3002 \u51c6\u5907\u4f60\u7684\u5bb9\u5668 \u00b6 \u5728\u4f60\u51c6\u5907\u597d rootfs \u4e4b\u540e\uff0c\u53ef\u4ee5\u5c06\u672c\u9875\u5e95\u90e8\u52a9\u6559\u7f16\u5199\u7684\u4e00\u4e2a\u793a\u4f8b\u7a0b\u5e8f\u4fdd\u5b58\u4e3a main.c \u5e76\u7f16\u8bd1\u8fd0\u884c\u5b83\uff1a gcc -o lab4 main.c ./lab4 rootfs/ /bin/bash \u8fd9\u65f6\u5019\u4f60\u5c31\u80fd\u770b\u5230\u4e00\u4e2a\u201c\u5bb9\u5668\u201d\u4e2d\u7684 shell \u4e86\u3002\u5f53\u7136\u4e86\uff0c\u8fd9\u91cc\u7684\u201c\u5bb9\u5668\u201d\u52a0\u4e0a\u4e86\u53cc\u5f15\u53f7\u662f\u56e0\u4e3a\u5b83\u4ec5\u4ec5\u662f\u4e00\u4e2a chroot \u7a0b\u5e8f\uff0c\u56e0\u6b64\u63a5\u4e0b\u6765\u7684\u4efb\u52a1\u5c31\u662f\u5bf9\u8fd9\u4e2a\u7a0b\u5e8f\u8fdb\u884c\u4fee\u6539\u5347\u7ea7\uff08\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u81ea\u5df1\u4ece\u5934\u7f16\u5199\u4e00\u4e2a\uff09\u3002 \u53c2\u8003\u8d44\u6599 \u00b6 chroot - Debian Wiki nspawn - Debian Wiki \u793a\u4f8b\u7a0b\u5e8f \u00b6 #include <stdio.h> #include <unistd.h> #include <sys/types.h> // For wait(2) #include <sys/wait.h> // For wait(2) const char * usage = \"Usage: %s <directory> <command> [args...] \\n \" \" \\n \" \" Run <directory> as a container and execute <command>. \\n \" ; void error_exit ( int code , const char * message ) { perror ( message ); _exit ( code ); } int main ( int argc , char ** argv ) { if ( argc < 3 ) { fprintf ( stderr , usage , argv [ 0 ]); return 1 ; } if ( chdir ( argv [ 1 ]) == - 1 ) error_exit ( 1 , argv [ 1 ]); pid_t pid = fork (); if ( pid == 0 ) { // Child goes for target program if ( chroot ( \".\" ) == - 1 ) error_exit ( 1 , \"chroot\" ); execvp ( argv [ 2 ], argv + 2 ); error_exit ( 255 , \"exec\" ); } // Parent waits for child int status , ecode = 0 ; wait ( & status ); if ( WIFEXITED ( status )) { printf ( \"Exited with status %d \\n \" , WEXITSTATUS ( status )); ecode = WEXITSTATUS ( status ); } else if ( WIFSIGNALED ( status )) { printf ( \"Killed by signal %d \\n \" , WTERMSIG ( status )); ecode = - WTERMSIG ( status ); } return ecode ; }","title":"\u51c6\u5907 rootfs"},{"location":"lab-4/rootfs/#_1","text":"","title":"\u51c6\u5907\u4f60\u7684\u5bb9\u5668\u73af\u5883"},{"location":"lab-4/rootfs/#rootfs","text":"\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u548c\u5b8c\u6574\u64cd\u4f5c\u7cfb\u7edf\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u5e76\u65e0\u592a\u5927\u533a\u522b\uff0c\u90fd\u5305\u542b\u4e86\u4e00\u4e2a\u5b8c\u6574\u7684\u64cd\u4f5c\u7cfb\u7edf\u76ee\u5f55\u7ed3\u6784\u548c\u5fc5\u8981\u7684\u6587\u4ef6\u3002\u4e0b\u9762\u4ecb\u7ecd\u4e09\u79cd\u6784\u5efa\u5bb9\u5668\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u65b9\u5f0f\u3002 \u672c\u6b21\u5b9e\u9a8c\u63a8\u8350\u4f7f\u7528 LXC \u955c\u50cf\u3002","title":"\u6784\u5efa\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff08rootfs\uff09"},{"location":"lab-4/rootfs/#init-busybox","text":"\u5b9e\u9a8c\u4e00\u4e2d \u4ecb\u7ecd\u7684\u4e24\u79cd\u6784\u5efa\u521d\u59cb\u5185\u5b58\u76d8\uff08initrd\uff09\u7684\u65b9\u5f0f\u5728\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002\u552f\u4e00\u7684\u533a\u522b\u662f\uff0c\u5728\u5c06\u6587\u4ef6\u653e\u7f6e\u59a5\u5f53\u540e\uff0c\u4f60\u4e0d\u518d\u9700\u8981\u5c06\u5b83\u4eec\u6253\u5305\u4e3a initrd.cpio.gz \u6587\u4ef6\uff0c\u800c\u662f\u53ef\u4ee5\u5728\u5bb9\u5668\u4e2d\u76f4\u63a5\u4f7f\u7528\u3002\u5982\u679c\u4f60\u51c6\u5907\u91c7\u7528\u8fd9\u4e24\u79cd\u65b9\u5f0f\uff0c\u53ef\u4ee5\u76f4\u63a5\u9605\u8bfb\u5b9e\u9a8c\u4e00\u6587\u6863\u7684\u76f8\u5173\u7ae0\u8282\u3002","title":"\u81ea\u5df1\u7f16\u5199 init \u7a0b\u5e8f\u4e0e\u4f7f\u7528 BusyBox \u6784\u5efa\u6839\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab-4/rootfs/#lxc","text":"Linux Containers \uff08LXC\uff09\u662f\u4e00\u4e2a\u7cfb\u7edf\u5bb9\u5668\u5b9e\u73b0\uff0c\u5176\u4f7f\u7528 Linux \u7684\u5bb9\u5668\u6280\u672f\u8fd0\u884c\u5b8c\u6574\u7684 Linux \u5b50\u7cfb\u7edf\u3002\u7531\u4e8e\u5bb9\u5668\u76f4\u63a5\u4f7f\u7528\u4e3b\u673a\u7684\u5185\u6838\uff0c\u6ca1\u6709\u4e86\u865a\u62df\u5316\u4e2d\u95f4\u5c42\uff0c\u4e0e\u4f20\u7edf\u865a\u62df\u673a\uff08KVM, VMware\uff09\u76f8\u6bd4\u66f4\u8f7b\u4fbf\u3002 LXC \u63d0\u4f9b\u4e86\u591a\u79cd\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u4f60\u53ef\u4ee5\u4ece https://images.linuxcontainers.org/images/ \u76f4\u63a5\u9009\u62e9\u4e0b\u8f7d\uff08\u8bf7\u4e0b\u8f7d amd64 \u67b6\u6784\u4e0b default \u4e2d\u7684 rootfs.tar.gz \u6216 rootfs.tar.xz \u6587\u4ef6\uff09\u3002\u4e0d\u540c\u7684 Linux \u53d1\u884c\u7248\u955c\u50cf\u4e0d\u5f71\u54cd\u672c\u5b9e\u9a8c\u7684\u540e\u7eed\u5185\u5bb9\uff0c\u4f46\u5982\u679c\u4f60\u4e0d\u4e86\u89e3\u5b83\u4eec\u7684\u533a\u522b\u7684\u8bdd\uff0c\u6211\u4eec\u63a8\u8350 Ubuntu 18.04 \u3001 Ubuntu 20.04 \u6216 Debian Buster \u7684\u955c\u50cf\u3002 \u4e0b\u8f7d\u5230\u7684\u6253\u5305 rootfs \u6587\u4ef6\u53ea\u9700\u8981\u89e3\u538b\u5230\u4e00\u4e2a\u65b0\u7684\u76ee\u5f55\u5373\u53ef\uff1a mkdir rootfs/ cd rootfs/ tar zxf ../rootfs.tar.gz # \u6216 tar Jxf ../rootfs.tar.xz Vlab \u5e73\u53f0\u7684\u865a\u62df\u673a\u5373\u662f LXC \u7cfb\u7edf\u5bb9\u5668\uff0c\u4f46\u672c\u5b9e\u9a8c\u4e0d\u5bf9 LXC \u7684\u5b9e\u73b0\u4f5c\u8fc7\u591a\u63a2\u7a76\u3002","title":"\u4ece LXC \u955c\u50cf\u5e93\u4e0b\u8f7d\u5bb9\u5668\u955c\u50cf"},{"location":"lab-4/rootfs/#chroot-systemd-nspawn","text":"chroot \u662f\u4e00\u4e2a\u7528\u4e8e\u9650\u5236\u8fdb\u7a0b\u53ef\u4ee5\u770b\u89c1\u7684 root \u76ee\u5f55\uff08\u6839\u76ee\u5f55\uff09\u7684\u673a\u5236\u3002\u5728 chroot \u4e4b\u540e\u4ea7\u751f\u7684\u6240\u6709\u5b50\u8fdb\u7a0b\uff0c\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\u662f\u65e0\u6cd5\u770b\u89c1 chroot \u76ee\u5f55\u4ee5\u5916\u7684\u5185\u5bb9\u7684\u3002\u5c3d\u7ba1\u5b9e\u9645\u7684\u5bb9\u5668\u5e76\u4e0d\u4f7f\u7528 chroot\uff08\u540e\u9762\u4f1a\u8bb2\u5230\uff09\uff0c\u7406\u89e3\u5b83\u4ecd\u7136\u662f\u7406\u89e3\u5bb9\u5668\u539f\u7406\u7684\u91cd\u8981\u7684\u4e00\u6b65\u3002 \u5728\u4f60\u51c6\u5907\u597d\u7684 BusyBox \u6216 LXC \u7cfb\u7edf\u955c\u50cf\u76ee\u5f55\u4e2d\u8fd0\u884c chroot . /bin/sh \u6216 chroot . /bin/bash \uff0c\u5373\u53ef chroot \u8fdb\u5165\u8fd9\u4e2a\u7cfb\u7edf\u955c\u50cf\u5e76\u5bf9\u6587\u4ef6\u7cfb\u7edf\u8fdb\u884c\u4e00\u4e9b\u64cd\u4f5c\u3002\u5982\u679c\u4f60\u4f7f\u7528 LXC \u955c\u50cf\uff0c\u4f60\u751a\u81f3\u53ef\u4ee5\u5728\u8fd9\u91cc\u8fdb\u884c apt update \u7b49\u5305\u7ba1\u7406\u64cd\u4f5c\u3002 \u8fd9\u53ea\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u57fa\u7840\u7684\u9694\u79bb\u3002root \u7528\u6237\u53ef\u4ee5\u8f7b\u6613\u8131\u79bb\u4e0d\u52a0\u989d\u5916\u9650\u5236\u7684 chroot \u76d1\u72f1\uff0c\u5e76\u4e14 chroot \u4e0d\u963b\u6b62\u5176\u4ed6\u8bbf\u95ee\u7cfb\u7edf\u8d44\u6e90\u6216\u5176\u4ed6\u8fdb\u7a0b\u7684\u65b9\u5f0f\uff08\u4f60\u53ef\u4ee5\u8bd5\u8bd5\u5728 chroot \u73af\u5883\u4e0b\u6267\u884c reboot \u2014\u2014\u6ce8\u610f\u4fdd\u5b58\u672a\u5b8c\u6210\u7684\u5de5\u4f5c\uff09\u3002","title":"\u4f7f\u7528 chroot \u4e0e systemd-nspawn \u4f53\u9a8c\u9694\u79bb\u73af\u5883\u4e0e\u5bb9\u5668\u6280\u672f"},{"location":"lab-4/rootfs/#systemd-nspawn","text":"\u4f5c\u4e3a\u4e00\u4e2a\u5bf9\u6bd4\uff0csystemd-nspawn \u662f\u4e00\u4e2a\u6700\u5c0f\u5316\u4f46\u5b8c\u6574\u7684\u5bb9\u5668\u5b9e\u73b0\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u8f6f\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88c5 systemd-container \u6765\u83b7\u5f97 systemd-nspawn \u547d\u4ee4\u3002 systemd-nspawn \u7684\u7528\u6cd5\u4e0e chroot \u7c7b\u4f3c\uff0c\u9996\u5148 cd \u5230\u5b58\u6709\u5bb9\u5668\u7cfb\u7edf\u955c\u50cf\u7684\u76ee\u5f55\uff0c\u7136\u540e\u8fd0\u884c systemd-nspawn \uff0c\u4f60\u5c31\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a shell\u3002\u5c3d\u7ba1\u8fd9\u4e2a shell \u770b\u8d77\u6765\u4e0e chroot \u4e2d\u7684 shell \u6ca1\u6709\u4ec0\u4e48\u533a\u522b\uff0c\u4f46\u662f\u5c1d\u8bd5\u4f7f\u7528\u67d0\u4e9b\u547d\u4ee4\u5c31\u4f1a\u53d1\u884c\u660e\u663e\u7684\u4e0d\u540c\u3002\u4e0b\u9762\u5217\u51fa\u51e0\u4e2a\u4f8b\u5b50\uff0c\u4f60\u53ef\u4ee5\u81ea\u5df1\u5206\u522b\u5728 systemd-nspawn \u4e2d\u548c chroot \u4e2d\u8fd0\u884c\u5e76\u6bd4\u8f83\uff1a reboot mount # \u67e5\u770b\u6302\u8f7d\u70b9 dd if = /dev/sda of = test bs = 64k count = 1 # \u5c1d\u8bd5\u8bbf\u95ee\u8bbe\u5907\u6587\u4ef6 echo $$ # \u68c0\u67e5 shell \u672c\u8eab\u7684 PID \u9519\u8bef\u5904\u7406 \u5982\u679c\u4f60\u4f7f\u7528 systemd-nspawn \u65f6\u9047\u5230\u4e86\u4e0b\u9762\u8fd9\u4e2a\u62a5\u9519: Failed to read machine ID from container image: Invalid argument \u8bf7\u5411\u5bb9\u5668\u955c\u50cf\u4e2d\u7684 /etc/machine-id \u6587\u4ef6\u5199\u5165\u4e00\u4e2a machine ID \u5b57\u7b26\u4e32\uff08\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff09\uff0c\u7136\u540e\u91cd\u65b0\u5c1d\u8bd5\u8fd0\u884c. $ systemd-machine-id-setup --root = \u5bb9\u5668\u7684rootfs\u8def\u5f84 \u5bf9\u4e8e Ubuntu 20.04\uff08\u6216\u5176\u4ed6\u4efb\u4f55\u8fd0\u884c systemd 240 \u6216\u4ee5\u4e0a\u7248\u672c\u7684\u7cfb\u7edf\uff09\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u65b0\u7684\u547d\u4ee4 $ systemd-id128 new > etc/machine-id","title":"systemd-nspawn"},{"location":"lab-4/rootfs/#systemd-nspawn_1","text":"\u4e0e chroot \u4e0d\u540c\uff0csystemd-nspawn \u4f5c\u4e3a\u4e00\u4e2a\u5b8c\u6574\u7684\u5bb9\u5668\u5b9e\u73b0\uff0c\u662f\u53ef\u4ee5\u542f\u52a8\u5bb9\u5668\u4e2d\u7684\u64cd\u4f5c\u7cfb\u7edf\u7684\u3002\u65b9\u4fbf\u8d77\u89c1\uff0c\u8fd9\u4e00\u6b65\u63a8\u8350\u4f7f\u7528 LXC \u955c\u50cf \u3002 \u4e3a\u4e86\u786e\u4fdd\u4f60\u80fd\u591f\u767b\u5f55\u8fdb\u5bb9\u5668\u7cfb\u7edf\u4e2d\u7684\u7528\u6237\uff0c\u9996\u5148\u9700\u8981\u4e3a root \u7528\u6237\u8bbe\u7f6e\u5bc6\u7801\uff08\u6216\u8005\u6e05\u9664\u5bc6\u7801\uff09\u3002\u4f7f\u7528 chroot \u6216 systemd-nspawn \u8fdb\u5165\u5bb9\u5668\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\uff0c\u8fd0\u884c passwd root \u8bbe\u7f6e\u5bc6\u7801\u6216 passwd -d root \u6e05\u9664\u5bc6\u7801\uff0c\u7136\u540e\u9000\u51fa\u8fd9\u4e2a shell\u3002 \u518d\u6b21\u4f7f\u7528 systemd-nspawn \u5c06\u8fd9\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4f5c\u4e3a\u5bb9\u5668\u8fd0\u884c\uff0c\u4e0d\u8fc7\u8fd9\u4e00\u6b21\u52a0\u4e0a --boot \u53c2\u6570\u3002\u8be5\u53c2\u6570\u4f1a\u8ba9 systemd-nspawn \u5c1d\u8bd5\u8fd0\u884c\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684 init \u7a0b\u5e8f\uff08\u800c\u4e0d\u662f\u4e00\u4e2a shell\uff09\uff0c\u4ece\u800c\u201c\u542f\u52a8\u201d\u8fd9\u4e2a\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002\u770b\u5230\u63d0\u793a\u540e\uff0c\u4f60\u5c31\u53ef\u4ee5\u8f93\u5165\u7528\u6237\u540d root \u548c\u5bc6\u7801\u767b\u5f55\u8fdb\u7cfb\u7edf\u4e86\uff0c\u4f60\u751a\u81f3\u53ef\u4ee5 poweroff \u6216 reboot \u8fd9\u4e2a\u5bb9\u5668\u4e2d\u7684\u7cfb\u7edf\u800c\u4e0d\u7528\u62c5\u5fc3\u4f1a\u5bfc\u81f4\u4e3b\u673a\u88ab\u5173\u673a\u6216\u91cd\u542f\u3002","title":"\u4f7f\u7528 systemd-nspawn \u542f\u52a8\u4e00\u4e2a\u5bb9\u5668"},{"location":"lab-4/rootfs/#_2","text":"\u5728\u4f60\u51c6\u5907\u597d rootfs \u4e4b\u540e\uff0c\u53ef\u4ee5\u5c06\u672c\u9875\u5e95\u90e8\u52a9\u6559\u7f16\u5199\u7684\u4e00\u4e2a\u793a\u4f8b\u7a0b\u5e8f\u4fdd\u5b58\u4e3a main.c \u5e76\u7f16\u8bd1\u8fd0\u884c\u5b83\uff1a gcc -o lab4 main.c ./lab4 rootfs/ /bin/bash \u8fd9\u65f6\u5019\u4f60\u5c31\u80fd\u770b\u5230\u4e00\u4e2a\u201c\u5bb9\u5668\u201d\u4e2d\u7684 shell \u4e86\u3002\u5f53\u7136\u4e86\uff0c\u8fd9\u91cc\u7684\u201c\u5bb9\u5668\u201d\u52a0\u4e0a\u4e86\u53cc\u5f15\u53f7\u662f\u56e0\u4e3a\u5b83\u4ec5\u4ec5\u662f\u4e00\u4e2a chroot \u7a0b\u5e8f\uff0c\u56e0\u6b64\u63a5\u4e0b\u6765\u7684\u4efb\u52a1\u5c31\u662f\u5bf9\u8fd9\u4e2a\u7a0b\u5e8f\u8fdb\u884c\u4fee\u6539\u5347\u7ea7\uff08\u4f60\u4e5f\u53ef\u4ee5\u9009\u62e9\u81ea\u5df1\u4ece\u5934\u7f16\u5199\u4e00\u4e2a\uff09\u3002","title":"\u51c6\u5907\u4f60\u7684\u5bb9\u5668"},{"location":"lab-4/rootfs/#_3","text":"chroot - Debian Wiki nspawn - Debian Wiki","title":"\u53c2\u8003\u8d44\u6599"},{"location":"lab-4/rootfs/#_4","text":"#include <stdio.h> #include <unistd.h> #include <sys/types.h> // For wait(2) #include <sys/wait.h> // For wait(2) const char * usage = \"Usage: %s <directory> <command> [args...] \\n \" \" \\n \" \" Run <directory> as a container and execute <command>. \\n \" ; void error_exit ( int code , const char * message ) { perror ( message ); _exit ( code ); } int main ( int argc , char ** argv ) { if ( argc < 3 ) { fprintf ( stderr , usage , argv [ 0 ]); return 1 ; } if ( chdir ( argv [ 1 ]) == - 1 ) error_exit ( 1 , argv [ 1 ]); pid_t pid = fork (); if ( pid == 0 ) { // Child goes for target program if ( chroot ( \".\" ) == - 1 ) error_exit ( 1 , \"chroot\" ); execvp ( argv [ 2 ], argv + 2 ); error_exit ( 255 , \"exec\" ); } // Parent waits for child int status , ecode = 0 ; wait ( & status ); if ( WIFEXITED ( status )) { printf ( \"Exited with status %d \\n \" , WEXITSTATUS ( status )); ecode = WEXITSTATUS ( status ); } else if ( WIFSIGNALED ( status )) { printf ( \"Killed by signal %d \\n \" , WTERMSIG ( status )); ecode = - WTERMSIG ( status ); } return ecode ; }","title":"\u793a\u4f8b\u7a0b\u5e8f"},{"location":"lab-4/seccomp/","text":"\u5bf9\u5bb9\u5668\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\u8fdb\u884c\u767d\u540d\u5355\u8fc7\u6ee4 \u00b6 Linux \u7684 seccomp (seccomp-bpf) \u7279\u6027\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u68c0\u67e5\u3001\u8fc7\u6ee4\u7a0b\u5e8f\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u63d0\u9ad8\u5bb9\u5668\u7684\u5b89\u5168\u6027\u3002 \u4ec0\u4e48\u662f seccomp-bpf? \u00b6 seccomp \u00b6 \u5982\u679c\u9700\u8981\u9650\u5236\u7a0b\u5e8f\u53ef\u4ee5\u6267\u884c\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u4f20\u7edf\u7684\u65b9\u5f0f\u662f\u4f7f\u7528 ptrace\u3002\u4f46\u662f\uff0c\uff08\u5728\u4e2d\u671f\u62a5\u544a\u7684\u65f6\u5019\u5927\u5bb6\u5df2\u7ecf\u77e5\u9053\uff09\uff0c\u8fd9\u79cd\u65b9\u5f0f\u7684\u6027\u80fd\u5e76\u4e0d\u9ad8\uff0c\u6bcf\u6b21\u6267\u884c\u7cfb\u7edf\u8c03\u7528\uff0c\u90fd\u4f1a\u5e26\u6765\u5f88\u5927\u7684\u989d\u5916\u5f00\u9500\u3002 seccomp \u662f \"secure computing mode\" \u7684\u7f29\u5199\u3002\u5728 Linux 2.6.12 \u4e2d\uff0cseccomp \u88ab\u5f15\u5165 Linux \u5185\u6838\u3002\u5728\u7a0b\u5e8f\u8fdb\u5165 seccomp \u6a21\u5f0f\u540e\uff0c\u5b83\u53ea\u80fd\u6267\u884c _exit() , sigreturn() , read() , write() \u8fd9\u56db\u79cd\u7cfb\u7edf\u8c03\u7528\uff0c\u5982\u679c\u5c1d\u8bd5\u6267\u884c\u5176\u5b83\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u7a0b\u5e8f\u4f1a\u88ab SIGKILL \u4fe1\u53f7\u6740\u6b7b\u3002\u663e\u7136\uff0c\u7a0b\u5e8f\u4e00\u65e6\u8fdb\u5165 seccomp \u6a21\u5f0f\uff0c\u5c31\u65e0\u6cd5\u6062\u590d\u5230\u539f\u5148\u7684\u72b6\u6001\u4e86\uff0c\u8fd9\u5c31\u4fdd\u8bc1\u4e86 seccomp \u6a21\u5f0f\u4e0b\u7a0b\u5e8f\u7684\u5b89\u5168\u3002 seccomp-bpf \u00b6 \u4f46\u662f\uff0cseccomp \u7684\u95ee\u9898\u662f\uff1a\u5b83\u7684\u7ba1\u7406\u592a\u4e25\u683c\u4e86\uff0c\u4e14\u65e0\u6cd5\u81ea\u5b9a\u4e49\u3002\u5728 seccomp \u4e2d\u7684\u7a0b\u5e8f\uff0c\u751a\u81f3\u8fde malloc() \uff08\u9700\u8981\u4f7f\u7528 mmap() \u7b49\u7cfb\u7edf\u8c03\u7528\uff09\u90fd\u65e0\u6cd5\u6267\u884c\uff0c\u8fd9\u5bf9\u4e8e\u4e00\u4e2a\u9762\u5411\u5e94\u7528\u7a0b\u5e8f\u7684\u5bb9\u5668\u6765\u8bf4\u663e\u7136\u662f\u4e0d\u80fd\u63a5\u53d7\u7684\u3002\u4e8e\u662f\uff0cseccomp-bpf \u88ab\u5f15\u5165\u3002 BPF (\"Berkeley Packet Filter\") \u662f\u4e00\u4e2a\u5728\u5185\u6838\u6001\u7528\u4e8e\u8fc7\u6ee4\u7f51\u7edc\u6570\u636e\u5305\u7684\u673a\u5236\uff0c\u5185\u6838\u4e2d\u7684\u89e3\u91ca\u5668\u4f1a\u89e3\u6790 BPF \u6307\u4ee4\uff0c\u5728 BPF\u300c\u865a\u62df\u673a\u300d\u4e0a\u6267\u884c\u3002\u5b83\u5728\u8fd9\u91cc\u4e5f\u88ab\u7528\u4e8e\u4e0e seccomp \u7ed3\u5408\uff0c\u8fc7\u6ee4\u7cfb\u7edf\u8c03\u7528\u3002 \u597d\u6d88\u606f\u662f\uff0c\u8fd9\u91cc\u6211\u4eec\u4e0d\u9700\u8981\u624b\u5199 BPF \u6307\u4ee4\u4ee3\u7801\u3002\u4f7f\u7528 libseccomp \u5e93\u5c31\u53ef\u4ee5\u65b9\u4fbf\u5730\u4f7f\u7528 seccomp-bpf \u4e86\u3002\u76f8\u5173\u7684\u5f00\u53d1\u6587\u4ef6\u53ef\u4ee5\u4f7f\u7528 apt install libseccomp-dev \u5b89\u88c5\uff0c\u540c\u65f6\u5728\u7f16\u8bd1\u94fe\u63a5\u65f6\u9700\u8981\u52a0\u4e0a -lseccomp \u53c2\u6570\u3002 \u4f60\u53ef\u80fd\u4f1a\u4f7f\u7528\u5230\u4ee5\u4e0b\u5e93\u51fd\u6570\uff08\u4e0d\u9650\u4e8e\u6b64\uff09\uff1a scmp_filter_ctx seccomp_init ( uint32_t def_action ); int seccomp_rule_add ( scmp_filter_ctx ctx , uint32_t action , int syscall , unsigned int arg_cnt , ...); int seccomp_load ( scmp_filter_ctx ctx ); void seccomp_release ( scmp_filter_ctx ctx ); \u8bf7\u67e5\u8be2\u5b83\u4eec\u7684\u6587\u6863\uff0c\u4e86\u89e3\u4f7f\u7528\u65b9\u6cd5\u3002 \u6211\u9700\u8981\u8fc7\u6ee4\u54ea\u4e9b\u7cfb\u7edf\u8c03\u7528\uff1f \u00b6 \u4e0e\u4e0a\u4e00\u8282\u4e2d\u7684\u300c\u80fd\u529b\u300d\u4e00\u6837\uff0c\u6211\u4eec\u4f7f\u7528 \u767d\u540d\u5355 \u7684\u65b9\u5f0f\u6765\u9650\u5236\u3002\u4f60\u53ef\u4ee5\u53c2\u8003 Docker \u7684\u9ed8\u8ba4\u914d\u7f6e \u6765\u914d\u7f6e seccomp-bpf\u3002 \u5efa\u8bae\uff1a \u901a\u8fc7\u7b2c 54 \u884c \"names\" \u6570\u7ec4\u4e2d\u7684\u6240\u6709\u7cfb\u7edf\u8c03\u7528 - \u5982\u679c\u4f60\u5728\u7f16\u8bd1\u65f6\u9047\u5230\u4e86\u95ee\u9898\uff0c\u53ef\u4ee5\u653e\u5fc3\u5730\u4ece\u5217\u8868\u4e2d\u5220\u9664 io_uring \u5f00\u5934\u7684\u4e09\u4e2a\u7cfb\u7edf\u8c03\u7528\uff0c\u5b83\u4eec\u662f Linux 5.1 \u65b0\u589e\u7684 \u901a\u8fc7 arch_prctl \u7cfb\u7edf\u8c03\u7528\uff08\u5b83\u51fa\u73b0\u5728\u7b2c 524 \u884c\u7684\u6570\u7ec4\u4e2d\uff0c\u662f x86 \u5e73\u53f0\u7279\u6709\u7684\u8c03\u7528\uff09 \u901a\u8fc7 modify_ldt \u7cfb\u7edf\u8c03\u7528\uff08\u5b83\u51fa\u73b0\u5728\u7b2c 539 \u884c\u7684\u6570\u7ec4\u4e2d\uff0c\u662f x86 \u5e73\u53f0\u7279\u6709\u7684\u8c03\u7528\uff09 \u901a\u8fc7\u7b2c 586 \u884c \"names\" \u6570\u7ec4\u4e2d\u7684\u6240\u6709\u7cfb\u7edf\u8c03\u7528\uff08\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\u662f\u8fdb\u884c\u4e00\u7cfb\u5217\u7cfb\u7edf\u7ef4\u62a4\u64cd\u4f5c\u9700\u8981\u7528\u5230\u7684\uff09 \u4f60\u53ef\u4ee5\u5728\u4fdd\u8bc1\u7a0b\u5e8f\u6b63\u5e38\u8fd0\u884c\u7684\u60c5\u51b5\u4e0b\u4fee\u6539\u767d\u540d\u5355\u3002\u5b89\u5168\u6027\u4e0d\u662f\u6211\u4eec\u8003\u6838\u7684\u6838\u5fc3\u3002","title":"\u8fc7\u6ee4\u7cfb\u7edf\u8c03\u7528"},{"location":"lab-4/seccomp/#_1","text":"Linux \u7684 seccomp (seccomp-bpf) \u7279\u6027\uff0c\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u68c0\u67e5\u3001\u8fc7\u6ee4\u7a0b\u5e8f\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u63d0\u9ad8\u5bb9\u5668\u7684\u5b89\u5168\u6027\u3002","title":"\u5bf9\u5bb9\u5668\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\u8fdb\u884c\u767d\u540d\u5355\u8fc7\u6ee4"},{"location":"lab-4/seccomp/#seccomp-bpf","text":"","title":"\u4ec0\u4e48\u662f seccomp-bpf?"},{"location":"lab-4/seccomp/#seccomp","text":"\u5982\u679c\u9700\u8981\u9650\u5236\u7a0b\u5e8f\u53ef\u4ee5\u6267\u884c\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u4f20\u7edf\u7684\u65b9\u5f0f\u662f\u4f7f\u7528 ptrace\u3002\u4f46\u662f\uff0c\uff08\u5728\u4e2d\u671f\u62a5\u544a\u7684\u65f6\u5019\u5927\u5bb6\u5df2\u7ecf\u77e5\u9053\uff09\uff0c\u8fd9\u79cd\u65b9\u5f0f\u7684\u6027\u80fd\u5e76\u4e0d\u9ad8\uff0c\u6bcf\u6b21\u6267\u884c\u7cfb\u7edf\u8c03\u7528\uff0c\u90fd\u4f1a\u5e26\u6765\u5f88\u5927\u7684\u989d\u5916\u5f00\u9500\u3002 seccomp \u662f \"secure computing mode\" \u7684\u7f29\u5199\u3002\u5728 Linux 2.6.12 \u4e2d\uff0cseccomp \u88ab\u5f15\u5165 Linux \u5185\u6838\u3002\u5728\u7a0b\u5e8f\u8fdb\u5165 seccomp \u6a21\u5f0f\u540e\uff0c\u5b83\u53ea\u80fd\u6267\u884c _exit() , sigreturn() , read() , write() \u8fd9\u56db\u79cd\u7cfb\u7edf\u8c03\u7528\uff0c\u5982\u679c\u5c1d\u8bd5\u6267\u884c\u5176\u5b83\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u7a0b\u5e8f\u4f1a\u88ab SIGKILL \u4fe1\u53f7\u6740\u6b7b\u3002\u663e\u7136\uff0c\u7a0b\u5e8f\u4e00\u65e6\u8fdb\u5165 seccomp \u6a21\u5f0f\uff0c\u5c31\u65e0\u6cd5\u6062\u590d\u5230\u539f\u5148\u7684\u72b6\u6001\u4e86\uff0c\u8fd9\u5c31\u4fdd\u8bc1\u4e86 seccomp \u6a21\u5f0f\u4e0b\u7a0b\u5e8f\u7684\u5b89\u5168\u3002","title":"seccomp"},{"location":"lab-4/seccomp/#seccomp-bpf_1","text":"\u4f46\u662f\uff0cseccomp \u7684\u95ee\u9898\u662f\uff1a\u5b83\u7684\u7ba1\u7406\u592a\u4e25\u683c\u4e86\uff0c\u4e14\u65e0\u6cd5\u81ea\u5b9a\u4e49\u3002\u5728 seccomp \u4e2d\u7684\u7a0b\u5e8f\uff0c\u751a\u81f3\u8fde malloc() \uff08\u9700\u8981\u4f7f\u7528 mmap() \u7b49\u7cfb\u7edf\u8c03\u7528\uff09\u90fd\u65e0\u6cd5\u6267\u884c\uff0c\u8fd9\u5bf9\u4e8e\u4e00\u4e2a\u9762\u5411\u5e94\u7528\u7a0b\u5e8f\u7684\u5bb9\u5668\u6765\u8bf4\u663e\u7136\u662f\u4e0d\u80fd\u63a5\u53d7\u7684\u3002\u4e8e\u662f\uff0cseccomp-bpf \u88ab\u5f15\u5165\u3002 BPF (\"Berkeley Packet Filter\") \u662f\u4e00\u4e2a\u5728\u5185\u6838\u6001\u7528\u4e8e\u8fc7\u6ee4\u7f51\u7edc\u6570\u636e\u5305\u7684\u673a\u5236\uff0c\u5185\u6838\u4e2d\u7684\u89e3\u91ca\u5668\u4f1a\u89e3\u6790 BPF \u6307\u4ee4\uff0c\u5728 BPF\u300c\u865a\u62df\u673a\u300d\u4e0a\u6267\u884c\u3002\u5b83\u5728\u8fd9\u91cc\u4e5f\u88ab\u7528\u4e8e\u4e0e seccomp \u7ed3\u5408\uff0c\u8fc7\u6ee4\u7cfb\u7edf\u8c03\u7528\u3002 \u597d\u6d88\u606f\u662f\uff0c\u8fd9\u91cc\u6211\u4eec\u4e0d\u9700\u8981\u624b\u5199 BPF \u6307\u4ee4\u4ee3\u7801\u3002\u4f7f\u7528 libseccomp \u5e93\u5c31\u53ef\u4ee5\u65b9\u4fbf\u5730\u4f7f\u7528 seccomp-bpf \u4e86\u3002\u76f8\u5173\u7684\u5f00\u53d1\u6587\u4ef6\u53ef\u4ee5\u4f7f\u7528 apt install libseccomp-dev \u5b89\u88c5\uff0c\u540c\u65f6\u5728\u7f16\u8bd1\u94fe\u63a5\u65f6\u9700\u8981\u52a0\u4e0a -lseccomp \u53c2\u6570\u3002 \u4f60\u53ef\u80fd\u4f1a\u4f7f\u7528\u5230\u4ee5\u4e0b\u5e93\u51fd\u6570\uff08\u4e0d\u9650\u4e8e\u6b64\uff09\uff1a scmp_filter_ctx seccomp_init ( uint32_t def_action ); int seccomp_rule_add ( scmp_filter_ctx ctx , uint32_t action , int syscall , unsigned int arg_cnt , ...); int seccomp_load ( scmp_filter_ctx ctx ); void seccomp_release ( scmp_filter_ctx ctx ); \u8bf7\u67e5\u8be2\u5b83\u4eec\u7684\u6587\u6863\uff0c\u4e86\u89e3\u4f7f\u7528\u65b9\u6cd5\u3002","title":"seccomp-bpf"},{"location":"lab-4/seccomp/#_2","text":"\u4e0e\u4e0a\u4e00\u8282\u4e2d\u7684\u300c\u80fd\u529b\u300d\u4e00\u6837\uff0c\u6211\u4eec\u4f7f\u7528 \u767d\u540d\u5355 \u7684\u65b9\u5f0f\u6765\u9650\u5236\u3002\u4f60\u53ef\u4ee5\u53c2\u8003 Docker \u7684\u9ed8\u8ba4\u914d\u7f6e \u6765\u914d\u7f6e seccomp-bpf\u3002 \u5efa\u8bae\uff1a \u901a\u8fc7\u7b2c 54 \u884c \"names\" \u6570\u7ec4\u4e2d\u7684\u6240\u6709\u7cfb\u7edf\u8c03\u7528 - \u5982\u679c\u4f60\u5728\u7f16\u8bd1\u65f6\u9047\u5230\u4e86\u95ee\u9898\uff0c\u53ef\u4ee5\u653e\u5fc3\u5730\u4ece\u5217\u8868\u4e2d\u5220\u9664 io_uring \u5f00\u5934\u7684\u4e09\u4e2a\u7cfb\u7edf\u8c03\u7528\uff0c\u5b83\u4eec\u662f Linux 5.1 \u65b0\u589e\u7684 \u901a\u8fc7 arch_prctl \u7cfb\u7edf\u8c03\u7528\uff08\u5b83\u51fa\u73b0\u5728\u7b2c 524 \u884c\u7684\u6570\u7ec4\u4e2d\uff0c\u662f x86 \u5e73\u53f0\u7279\u6709\u7684\u8c03\u7528\uff09 \u901a\u8fc7 modify_ldt \u7cfb\u7edf\u8c03\u7528\uff08\u5b83\u51fa\u73b0\u5728\u7b2c 539 \u884c\u7684\u6570\u7ec4\u4e2d\uff0c\u662f x86 \u5e73\u53f0\u7279\u6709\u7684\u8c03\u7528\uff09 \u901a\u8fc7\u7b2c 586 \u884c \"names\" \u6570\u7ec4\u4e2d\u7684\u6240\u6709\u7cfb\u7edf\u8c03\u7528\uff08\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\u662f\u8fdb\u884c\u4e00\u7cfb\u5217\u7cfb\u7edf\u7ef4\u62a4\u64cd\u4f5c\u9700\u8981\u7528\u5230\u7684\uff09 \u4f60\u53ef\u4ee5\u5728\u4fdd\u8bc1\u7a0b\u5e8f\u6b63\u5e38\u8fd0\u884c\u7684\u60c5\u51b5\u4e0b\u4fee\u6539\u767d\u540d\u5355\u3002\u5b89\u5168\u6027\u4e0d\u662f\u6211\u4eec\u8003\u6838\u7684\u6838\u5fc3\u3002","title":"\u6211\u9700\u8981\u8fc7\u6ee4\u54ea\u4e9b\u7cfb\u7edf\u8c03\u7528\uff1f"},{"location":"x/","text":"\u5927\u4f5c\u4e1a \u00b6 \u8bf7\u5404\u4f4d\u540c\u5b66\u70b9\u51fb Link \u521b\u5efa\u6216\u8005\u52a0\u5165\u5927\u4f5c\u4e1a\u9879\u76ee\uff0c\u5c06\u5927\u4f5c\u4e1a\u6709\u5173\u7684\u5404\u79cd\u8bb0\u5f55\u3001\u6587\u6863\u5b58\u653e\u5728\u4ed3\u5e93\u4e2d\u3002 \u6bcf\u4e2a\u7ec4\u7684\u4ed3\u5e93\u9700\u5305\u542b README.md \u6587\u4ef6\uff0c\u5305\u542b\u7ec4\u5458\u540d\u5355\uff0c\u5177\u4f53\u683c\u5f0f\u53ca\u5176\u4f59\u5185\u5bb9\u81ea\u5b9a\u3002 \u8c03\u7814\u62a5\u544a \u00b6 \u8c03\u7814\u62a5\u544a \u4e00\u822c \u5305\u542b\u4ee5\u4e0b\u65b9\u9762\u7684\u5185\u5bb9\uff1a \u5c0f\u7ec4\u6210\u5458 \u9879\u76ee\u7b80\u4ecb \u9879\u76ee\u80cc\u666f \u7acb\u9879\u4f9d\u636e \u91cd\u8981\u6027 / \u524d\u77bb\u6027\u5206\u6790 \u76f8\u5173\u5de5\u4f5c \u53c2\u8003\u6587\u732e \u8bf7\u5404\u7ec4\u5728\u89c4\u5b9a\u65f6\u95f4\uff08\u5f85\u5b9a\uff09\u5185\u5c06\u8c03\u7814\u62a5\u544a research.pdf \uff08\u6216\u8005 research.md \uff09\u63d0\u4ea4\u5230\u5927\u4f5c\u4e1a\u4ed3\u5e93\uff1a \u6240\u6709\u9700\u8981\u63d0\u4ea4\u7684\u6587\u6863\u8bf7\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u63d0\u4ea4\u5230 docs \u6587\u6863\u76ee\u5f55\u4e0b\u3002 (Git) # \u5927\u4f5c\u4e1a\u4ed3\u5e93\u6839\u76ee\u5f55 \u251c\u2500\u2500 docs # \u6587\u6863\u76ee\u5f55 \u2502 \u251c\u2500\u2500 research.md # \u8c03\u7814\u62a5\u544a\uff08\u6216 research.pdf \u7b49\uff09 \u2502 \u2514\u2500\u2500 files # \u5b58\u653e\u8d44\u6e90\u6587\u4ef6\uff08\u5982\uff1a\u62a5\u544a\u4e2d\u7684\u56fe\u7247\uff09 \u251c\u2500\u2500 README.md # \u4e0a\u9762\u8981\u6c42\u7684 README \u6587\u4ef6 \u2514\u2500\u2500 ... # \u5176\u4ed6\u6587\u4ef6\uff08\u5982\uff1a\u6e90\u4ee3\u7801\u7b49\uff09 \u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a \u00b6 \u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a \u4e00\u822c \u5305\u542b\u4ee5\u4e0b\u65b9\u9762\u7684\u5185\u5bb9\uff1a \u9879\u76ee\u4ecb\u7ecd \u7406\u8bba\u4f9d\u636e \u6280\u672f\u4f9d\u636e \u6280\u672f\u8def\u7ebf \u53c2\u8003\u6587\u732e \u8bf7\u5404\u7ec4\u5728\u89c4\u5b9a\u65f6\u95f4\u5185\u5c06\u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a feasibility.pdf \uff08\u6216\u8005 feasibility.md \uff09\u63d0\u4ea4\u5230\u5927\u4f5c\u4e1a\u4ed3\u5e93\uff1a \u6240\u6709\u9700\u8981\u63d0\u4ea4\u7684\u6587\u6863\u8bf7\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u63d0\u4ea4\u5230 docs \u6587\u6863\u76ee\u5f55\u4e0b\u3002 (Git) # \u5927\u4f5c\u4e1a\u4ed3\u5e93\u6839\u76ee\u5f55 \u251c\u2500\u2500 docs # \u6587\u6863\u76ee\u5f55 \u2502 \u251c\u2500\u2500 research.md # \u8c03\u7814\u62a5\u544a\uff08\u6216 research.pdf \u7b49\uff09 \u2502 \u251c\u2500\u2500 feasibility.md # \u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a\uff08\u6216 feasibility.pdf \u7b49\uff09 \u2502 \u2514\u2500\u2500 files # \u5b58\u653e\u8d44\u6e90\u6587\u4ef6\uff08\u5982\uff1a\u62a5\u544a\u4e2d\u7684\u56fe\u7247\uff09 \u251c\u2500\u2500 README.md # \u4e0a\u9762\u8981\u6c42\u7684 README \u6587\u4ef6 \u2514\u2500\u2500 ... # \u5176\u4ed6\u6587\u4ef6\uff08\u5982\uff1a\u6e90\u4ee3\u7801\u7b49\uff09 \u7ed3\u9898\u62a5\u544a \u00b6 \u8bf7\u5404\u7ec4\u5728\u89c4\u5b9a\u65f6\u95f4\u5185\u5c06\u7ed3\u9898\u62a5\u544a conclusion.pdf \uff08\u6216\u8005 conclusion.md \uff09\u4ee5\u53ca\u5728\u7b54\u8fa9\u4e0a\u5c55\u793a\u7684 slides \u63d0\u4ea4\u5230\u5927\u4f5c\u4e1a\u4ed3\u5e93\uff1a \u6240\u6709\u9700\u8981\u63d0\u4ea4\u7684\u6587\u6863\u8bf7\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u63d0\u4ea4\u5230 docs \u6587\u6863\u76ee\u5f55\u4e0b\u3002 (Git) # \u5927\u4f5c\u4e1a\u4ed3\u5e93\u6839\u76ee\u5f55 \u251c\u2500\u2500 docs # \u6587\u6863\u76ee\u5f55 \u2502 \u251c\u2500\u2500 research.md # \u8c03\u7814\u62a5\u544a\uff08\u6216 research.pdf \u7b49\uff09 \u2502 \u251c\u2500\u2500 feasibility.md # \u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a\uff08\u6216 feasibility.pdf \u7b49\uff09 \u2502 \u251c\u2500\u2500 conclusion.md # \u7ed3\u9898\u62a5\u544a\uff08\u6216 conclusion.pdf \u7b49\uff09 \u2502 \u251c\u2500\u2500 *.pdf # \u7ed3\u9898\u7b54\u8fa9\u5c55\u793a\u7684 slides\uff08\u6216 *.ppt(x) \u683c\u5f0f\uff09 \u2502 \u2514\u2500\u2500 files # \u5b58\u653e\u8d44\u6e90\u6587\u4ef6\uff08\u5982\uff1a\u62a5\u544a\u4e2d\u7684\u56fe\u7247\uff09 \u251c\u2500\u2500 README.md # \u4e0a\u9762\u8981\u6c42\u7684 README \u6587\u4ef6 \u2514\u2500\u2500 ... # \u5176\u4ed6\u6587\u4ef6\uff08\u5982\uff1a\u6e90\u4ee3\u7801\u7b49\uff09","title":"\u5927\u4f5c\u4e1a"},{"location":"x/#_1","text":"\u8bf7\u5404\u4f4d\u540c\u5b66\u70b9\u51fb Link \u521b\u5efa\u6216\u8005\u52a0\u5165\u5927\u4f5c\u4e1a\u9879\u76ee\uff0c\u5c06\u5927\u4f5c\u4e1a\u6709\u5173\u7684\u5404\u79cd\u8bb0\u5f55\u3001\u6587\u6863\u5b58\u653e\u5728\u4ed3\u5e93\u4e2d\u3002 \u6bcf\u4e2a\u7ec4\u7684\u4ed3\u5e93\u9700\u5305\u542b README.md \u6587\u4ef6\uff0c\u5305\u542b\u7ec4\u5458\u540d\u5355\uff0c\u5177\u4f53\u683c\u5f0f\u53ca\u5176\u4f59\u5185\u5bb9\u81ea\u5b9a\u3002","title":"\u5927\u4f5c\u4e1a"},{"location":"x/#_2","text":"\u8c03\u7814\u62a5\u544a \u4e00\u822c \u5305\u542b\u4ee5\u4e0b\u65b9\u9762\u7684\u5185\u5bb9\uff1a \u5c0f\u7ec4\u6210\u5458 \u9879\u76ee\u7b80\u4ecb \u9879\u76ee\u80cc\u666f \u7acb\u9879\u4f9d\u636e \u91cd\u8981\u6027 / \u524d\u77bb\u6027\u5206\u6790 \u76f8\u5173\u5de5\u4f5c \u53c2\u8003\u6587\u732e \u8bf7\u5404\u7ec4\u5728\u89c4\u5b9a\u65f6\u95f4\uff08\u5f85\u5b9a\uff09\u5185\u5c06\u8c03\u7814\u62a5\u544a research.pdf \uff08\u6216\u8005 research.md \uff09\u63d0\u4ea4\u5230\u5927\u4f5c\u4e1a\u4ed3\u5e93\uff1a \u6240\u6709\u9700\u8981\u63d0\u4ea4\u7684\u6587\u6863\u8bf7\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u63d0\u4ea4\u5230 docs \u6587\u6863\u76ee\u5f55\u4e0b\u3002 (Git) # \u5927\u4f5c\u4e1a\u4ed3\u5e93\u6839\u76ee\u5f55 \u251c\u2500\u2500 docs # \u6587\u6863\u76ee\u5f55 \u2502 \u251c\u2500\u2500 research.md # \u8c03\u7814\u62a5\u544a\uff08\u6216 research.pdf \u7b49\uff09 \u2502 \u2514\u2500\u2500 files # \u5b58\u653e\u8d44\u6e90\u6587\u4ef6\uff08\u5982\uff1a\u62a5\u544a\u4e2d\u7684\u56fe\u7247\uff09 \u251c\u2500\u2500 README.md # \u4e0a\u9762\u8981\u6c42\u7684 README \u6587\u4ef6 \u2514\u2500\u2500 ... # \u5176\u4ed6\u6587\u4ef6\uff08\u5982\uff1a\u6e90\u4ee3\u7801\u7b49\uff09","title":"\u8c03\u7814\u62a5\u544a"},{"location":"x/#_3","text":"\u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a \u4e00\u822c \u5305\u542b\u4ee5\u4e0b\u65b9\u9762\u7684\u5185\u5bb9\uff1a \u9879\u76ee\u4ecb\u7ecd \u7406\u8bba\u4f9d\u636e \u6280\u672f\u4f9d\u636e \u6280\u672f\u8def\u7ebf \u53c2\u8003\u6587\u732e \u8bf7\u5404\u7ec4\u5728\u89c4\u5b9a\u65f6\u95f4\u5185\u5c06\u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a feasibility.pdf \uff08\u6216\u8005 feasibility.md \uff09\u63d0\u4ea4\u5230\u5927\u4f5c\u4e1a\u4ed3\u5e93\uff1a \u6240\u6709\u9700\u8981\u63d0\u4ea4\u7684\u6587\u6863\u8bf7\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u63d0\u4ea4\u5230 docs \u6587\u6863\u76ee\u5f55\u4e0b\u3002 (Git) # \u5927\u4f5c\u4e1a\u4ed3\u5e93\u6839\u76ee\u5f55 \u251c\u2500\u2500 docs # \u6587\u6863\u76ee\u5f55 \u2502 \u251c\u2500\u2500 research.md # \u8c03\u7814\u62a5\u544a\uff08\u6216 research.pdf \u7b49\uff09 \u2502 \u251c\u2500\u2500 feasibility.md # \u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a\uff08\u6216 feasibility.pdf \u7b49\uff09 \u2502 \u2514\u2500\u2500 files # \u5b58\u653e\u8d44\u6e90\u6587\u4ef6\uff08\u5982\uff1a\u62a5\u544a\u4e2d\u7684\u56fe\u7247\uff09 \u251c\u2500\u2500 README.md # \u4e0a\u9762\u8981\u6c42\u7684 README \u6587\u4ef6 \u2514\u2500\u2500 ... # \u5176\u4ed6\u6587\u4ef6\uff08\u5982\uff1a\u6e90\u4ee3\u7801\u7b49\uff09","title":"\u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a"},{"location":"x/#_4","text":"\u8bf7\u5404\u7ec4\u5728\u89c4\u5b9a\u65f6\u95f4\u5185\u5c06\u7ed3\u9898\u62a5\u544a conclusion.pdf \uff08\u6216\u8005 conclusion.md \uff09\u4ee5\u53ca\u5728\u7b54\u8fa9\u4e0a\u5c55\u793a\u7684 slides \u63d0\u4ea4\u5230\u5927\u4f5c\u4e1a\u4ed3\u5e93\uff1a \u6240\u6709\u9700\u8981\u63d0\u4ea4\u7684\u6587\u6863\u8bf7\u6309\u7167\u4ee5\u4e0b\u683c\u5f0f\u63d0\u4ea4\u5230 docs \u6587\u6863\u76ee\u5f55\u4e0b\u3002 (Git) # \u5927\u4f5c\u4e1a\u4ed3\u5e93\u6839\u76ee\u5f55 \u251c\u2500\u2500 docs # \u6587\u6863\u76ee\u5f55 \u2502 \u251c\u2500\u2500 research.md # \u8c03\u7814\u62a5\u544a\uff08\u6216 research.pdf \u7b49\uff09 \u2502 \u251c\u2500\u2500 feasibility.md # \u53ef\u884c\u6027\u7814\u7a76\u62a5\u544a\uff08\u6216 feasibility.pdf \u7b49\uff09 \u2502 \u251c\u2500\u2500 conclusion.md # \u7ed3\u9898\u62a5\u544a\uff08\u6216 conclusion.pdf \u7b49\uff09 \u2502 \u251c\u2500\u2500 *.pdf # \u7ed3\u9898\u7b54\u8fa9\u5c55\u793a\u7684 slides\uff08\u6216 *.ppt(x) \u683c\u5f0f\uff09 \u2502 \u2514\u2500\u2500 files # \u5b58\u653e\u8d44\u6e90\u6587\u4ef6\uff08\u5982\uff1a\u62a5\u544a\u4e2d\u7684\u56fe\u7247\uff09 \u251c\u2500\u2500 README.md # \u4e0a\u9762\u8981\u6c42\u7684 README \u6587\u4ef6 \u2514\u2500\u2500 ... # \u5176\u4ed6\u6587\u4ef6\uff08\u5982\uff1a\u6e90\u4ee3\u7801\u7b49\uff09","title":"\u7ed3\u9898\u62a5\u544a"}]}